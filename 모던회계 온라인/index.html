<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes, viewport-fit=cover">
    <title>모던 테니스 [Online] 🎾</title>
    
     <link rel="icon" type="image/png" href="moder.png?v=3.3">
     <link rel="apple-touch-icon" href="moder.png?v=3.3">
    
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&display=swap" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root {
            --primary: #2d3436;
            --primary-grad: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --accent: #00d2d3;
            --accent-grad: linear-gradient(135deg, #1dd1a1 0%, #00d2d3 100%);
            --bg-color: #f4f7f6;
            --card-bg: rgba(255, 255, 255, 0.85);
            --card-border: 1px solid rgba(255, 255, 255, 0.6);
            --shadow-soft: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            --text-main: #2d3436;
            --text-sub: #636e72;
            --income: #0984e3; 
            --expense: #d63031;
            --income-bg: #eff6ff;
            --expense-bg: #fef2f2;
            --holiday-text: #e74c3c;
            --sat-text: #0984e3;
            --holiday-bg: #fff0f1;
            --sat-bg: #f0f8ff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Pretendard Variable', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; 
            background: var(--bg-color); 
            margin: 0; 
            color: var(--text-main); 
            padding-bottom: 90px; 
            -webkit-font-smoothing: antialiased; 
            letter-spacing: -0.02em;
            line-height: 1.5;
        }

        .app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; position: relative; }

        /* Header */
        header {
            background: var(--primary-grad);
            color: white; 
            padding: 25px 20px; 
            border-bottom-left-radius: 30px; 
            border-bottom-right-radius: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: ''; position: absolute; top: -50%; right: -20%; width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(0, 210, 211, 0.2) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%; pointer-events: none;
        }

        .header-top { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 20px; position: relative; z-index: 2;}
        .club-title { font-size: 1.6rem; font-weight: 800; display: flex; align-items: center; gap: 8px; letter-spacing: -0.5px; position: relative; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .ver-tag { font-size: 0.65rem; background: rgba(255,255,255,0.2); backdrop-filter: blur(4px); padding: 4px 10px; border-radius: 20px; color: #74ffff; font-weight: 700; transform: translateY(1px); border: 1px solid rgba(255,255,255,0.1); }
        .signature-ver { font-family: 'Nanum Pen Script', cursive !important; font-size: 1.8rem; color: #ffeaa7 !important; margin-left: 8px; transform: rotate(-8deg) translateY(-3px); display: inline-block; text-shadow: 2px 2px 4px rgba(0,0,0,0.6); font-weight: normal; letter-spacing: 1px; position: relative; z-index: 10; }

        .backup-btns { display: flex; gap: 6px; align-items: center; }
        .btn-backup { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 14px; border-radius: 12px; font-size: 0.75rem; cursor: pointer; height: 34px; display: flex; align-items: center; justify-content: center; white-space: nowrap; backdrop-filter: blur(5px); transition: all 0.2s; }
        .btn-backup:active { transform: scale(0.95); background: rgba(255,255,255,0.25); }
        
        /* 저장하고 나가기 버튼 */
        .btn-save-exit { background: #e74c3c; border: 1px solid #c0392b; color: white; font-weight:bold; padding: 8px 12px; border-radius: 12px; font-size: 0.75rem; cursor: pointer; height: 34px; display: flex; align-items: center; backdrop-filter: blur(5px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); margin-left: 5px; }
        
        .admin-login-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; width: 34px; height: 34px; font-size: 1rem; cursor: pointer; color: #dfe6e9; transition: 0.3s; display: flex; align-items: center; justify-content: center; padding: 0; backdrop-filter: blur(5px); }
        .admin-login-btn.logged-in { color: #f1c40f; background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); box-shadow: 0 0 10px rgba(241, 196, 15, 0.3); } 

        .total-asset-box { text-align: center; margin-bottom: 25px; position: relative; z-index: 2;}
        .balance-label { font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px; font-weight: 300;}
        .balance-amount { font-size: 2.6rem; font-weight: 800; color: #fff; letter-spacing: -1px; text-shadow: 0 4px 10px rgba(0,0,0,0.2); line-height: 1.2; }
        .balance-total-with-unpaid { font-size: 1rem; color: #ffeaa7; font-weight: 600; margin-top: 5px; opacity: 0.9; }

        .stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; position: relative; z-index: 2;}
        .stat-card { background: rgba(255,255,255,0.1); padding: 12px 5px; border-radius: 16px; text-align: center; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stat-label { font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px; display: block; color: #dfe6e9; }
        .stat-val { display: block; font-weight: 700; font-size: 1.05rem; color: #fff; }

        /* Page Layout */
        .page { display: none; padding: 20px; animation: fadeInUp 0.3s ease-out; }
        .page.active { display: block; }
        @keyframes fadeInUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }

        .card { background: var(--card-bg); border-radius: 20px; padding: 20px; box-shadow: var(--shadow-soft); margin-bottom: 18px; border: var(--card-border); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
        .section-title { font-size: 1.25rem; font-weight: 800; color: #2d3436; letter-spacing: -0.5px; }

        input, select { width: 100%; padding: 14px; border: 1px solid #e1e1e1; border-radius: 14px; font-size: 15px; margin-bottom: 10px; background: #fff; outline: none; transition: 0.2s; color: #333; font-family: 'Pretendard Variable', sans-serif; }
        input:focus, select:focus { border-color: #00b894; box-shadow: 0 0 0 3px rgba(0, 184, 148, 0.1); }
        
        .btn-main { width: 100%; background: var(--primary-grad); color: white; border: none; padding: 15px; border-radius: 14px; font-weight: 700; font-size: 1.1rem; margin-top: 5px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(44, 62, 80, 0.2); }
        .btn-main:active { transform: scale(0.98); }
        .btn-main.saved { background: var(--accent-grad); box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3); }
        
        .btn-sub { background: #fff; border: 1px solid #dfe6e9; padding: 8px 14px; border-radius: 12px; font-size: 0.8rem; color: #636e72; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .btn-sub:hover { background: #f8f9fa; transform: translateY(-1px); }
        
        .admin-only { display: none !important; }
        .admin-flex { display: none !important; }

        /* Report Styles */
        .report-filter-bar { display: flex; gap: 8px; flex-wrap: wrap; background: #fff; padding: 15px; border-radius: 16px; margin-bottom: 20px; box-shadow: var(--shadow-soft); border: 1px solid #eee; align-items: center; }
        .report-filter-bar select { margin-bottom: 0; font-size: 0.85rem; padding: 10px; flex: 1; min-width: 100px; }
        .btn-report-search { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        /* Ledger */
        .filter-container { background: var(--card-bg); padding: 18px; border-radius: 20px; margin-bottom: 18px; box-shadow: var(--shadow-soft); border: var(--card-border); backdrop-filter: blur(10px); }
        .filter-label { font-size: 0.75rem; font-weight: 700; margin-bottom: 10px; color: #b2bec3; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
        .chip-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .filter-chip { padding: 8px 14px; border-radius: 30px; font-size: 0.8rem; background: #f1f3f5; color: #636e72; border: 1px solid transparent; cursor: pointer; transition: all 0.2s; font-weight: 600; }
        .filter-chip.active { background: #2d3436; color: white; box-shadow: 0 4px 10px rgba(45, 52, 54, 0.2); transform: translateY(-1px); }
        .filter-chip.group-btn { background: #e3f2fd; color: var(--income); } 

        .ledger-summary-box { background: linear-gradient(to right, #f8f9fa, #fff); border-radius: 16px; padding: 18px; margin-bottom: 18px; border: 1px solid #eee; font-size: 0.95rem; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .summary-row.total { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ced6e0; font-weight: 800; font-size: 1.05rem; }
        
        .trans-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid #f1f2f6; cursor: pointer; }
        .ti-date { font-size: 0.75rem; color: #b2bec3; margin-bottom: 3px; font-weight: 500; }
        .ti-desc { font-weight: 600; color: var(--text-main); font-size: 1rem; }
        .ti-cat { font-size: 0.65rem; background: #dfe6e9; padding: 3px 8px; border-radius: 6px; color: #636e72; margin-left: 6px; vertical-align: middle;}
        .ti-amt { font-weight: 800; font-size: 1.05rem; }

        /* Table */
        .member-table-wrap { overflow-x: auto; background: white; border-radius: 16px; border: 1px solid rgba(0,0,0,0.05); box-shadow: var(--shadow-soft); -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 380px; }
        th { background: #f8f9fa; color: #636e72; padding: 12px 6px; font-size: 0.8rem; text-align: center; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #dfe6e9; white-space: nowrap; cursor: pointer; font-weight: 700; }
        td { padding: 12px 6px; border-bottom: 1px solid #f1f2f6; text-align: center; vertical-align: middle; font-size: 0.85rem; white-space: nowrap; }
        /* [수정] 너비와 최소 너비를 160px -> 115px로 변경하여 공간 최소화 */
th:first-child, td:first-child { 
    position: sticky; 
    left: 0; 
    background: white; 
    z-index: 20; 
    border-right: 1px solid #f1f2f6; 
    
    /* ▼ 여기를 65px로 수정하세요 ▼ */
    width: 65px;      
    min-width: 65px;  
    
    /* ▼ 안쪽 여백도 최소화 ▼ */
    padding-left: 2px;
    padding-right: 0px; 
    
    text-align: left; 
    box-shadow: 2px 0 5px rgba(0,0,0,0.02); 
}        
        .m-cell { display: flex; align-items: center; gap: 8px; } 
        .m-idx { font-size: 0.7rem; color: #b2bec3; width: 22px; text-align: right; display: inline-block; flex-shrink: 0; }
        .m-name-box { display: flex; flex-direction: column; justify-content: center; min-width: 0; flex: 1; }
        .m-name { font-weight: 800; font-size: 0.95rem; color: var(--text-main); cursor: pointer; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .m-role { 
            font-size: 0.65rem; color: #fff; font-weight: bold; margin-top: 4px; display: inline-block; 
            background: linear-gradient(135deg, #6c5ce7, #a29bfe); padding: 2px 8px; border-radius: 10px;
            box-shadow: 0 2px 4px rgba(108, 92, 231, 0.3); text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        .m-status { font-size: 0.65rem; padding: 3px 6px; border-radius: 6px; color: white; display: inline-block; white-space: nowrap; margin-left: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .act-btn { width: 26px; height: 26px; border-radius: 50%; background: #f1f2f6; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; text-decoration: none; color: #636e72; border: 1px solid #dfe6e9; flex-shrink: 0; margin-left:6px; transition:0.2s;}
        
        .money-cell { font-size: 0.9rem !important; font-weight: 700 !important; letter-spacing: -0.5px; white-space: nowrap; font-family: 'Pretendard Variable', sans-serif;}
        .last-paid-cell { font-weight: 600; color: #74b9ff; font-size: 0.8rem; white-space: nowrap; }
        .last-paid-cell.done { color: #00b894; font-weight: 800; }

        /* Unpaid & Calendar & Receipts */
        .unpaid-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #f1f2f6; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .u-top { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .u-name { font-weight: 700; font-size: 1rem; color:#2d3436; }
        .u-badge { font-size: 0.65rem; padding: 3px 6px; border-radius: 6px; color: white; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        .u-amt { font-weight: 800; color: var(--expense); font-size: 1rem; background: #fff5f5; padding: 4px 8px; border-radius: 8px; letter-spacing: -0.5px;}
        .u-months { font-size: 0.8rem; color: #b2bec3; }

        .year-view-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .mini-month { background: white; border: 1px solid #eee; border-radius: 12px; padding: 6px; cursor: pointer; transition:0.2s; }
        .mini-title { text-align: center; font-weight: bold; font-size: 0.8rem; margin-bottom: 4px; color: #2d3436; }
        .mini-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .mini-cell { aspect-ratio: 1/1; display: flex; justify-content: center; align-items: center; font-size: 0.45rem; color: #dfe6e9; position:relative;}
        .mini-cell.has-event::after { content:''; width:5px; height:5px; background:red; border-radius:50%; position:absolute; bottom:2px; box-shadow: 0 0 4px rgba(255,0,0,0.5); }
        .mini-cell.sun, .mini-cell.holiday { color: var(--holiday-text); background: var(--holiday-bg); border-radius: 4px; font-weight:bold;}
        .mini-cell.sat { color: var(--sat-text); background: var(--sat-bg); border-radius: 4px; font-weight:bold;}

        .date-cell { height: 65px; background: white; border-radius: 12px; border: 1px solid #f4f4f4; padding: 5px; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition:0.2s; }
        .date-cell.today { border: 2px solid var(--accent); background: #f0fffe; }
        .date-cell.sun, .date-cell.holiday { color: var(--holiday-text) !important; background-color: var(--holiday-bg) !important; }
        .date-cell.sat { color: var(--sat-text) !important; background-color: var(--sat-bg) !important; }
        .event-dot { width: 8px; height: 8px; background: red; border-radius: 50%; margin-top: 5px; box-shadow: 0 0 5px rgba(255,0,0,0.6); }
        
        .receipt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .receipt-item { background: white; border-radius: 16px; overflow: hidden; border: 1px solid #eee; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .r-img-box { width: 100%; height: 130px; background: #f8f9fa; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .r-img { width: 100%; height: 100%; object-fit: cover; }
        .r-info { padding: 10px; font-size: 0.85rem; }

        /* Nav & FAB */
        .nav-bar { position: fixed; bottom: 0; width: 100%; max-width: 600px; left:0; right:0; margin:0 auto; background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); border-top: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-around; padding: 10px 0 calc(10px + env(safe-area-inset-bottom)); z-index: 100; box-shadow: 0 -5px 20px rgba(0,0,0,0.03); }
        .nav-item { text-align: center; color: #b2bec3; flex: 1; font-size: 0.7rem; transition:0.2s; }
        .nav-item.active { color: #2d3436; font-weight: 700; transform: translateY(-2px); }
        .nav-icon { display: block; font-size: 1.5rem; margin-bottom: 4px; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1)); }
        
        .fab { position: fixed; bottom: calc(85px + env(safe-area-inset-bottom)); right: 20px; width: 58px; height: 58px; background: var(--accent-grad); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; box-shadow: 0 8px 20px rgba(0, 210, 211, 0.4); z-index: 90; transition: 0.2s; }
        .fab:active { transform: scale(0.9); }
        
        .bulk-sms-btn { position: fixed; bottom: calc(85px + env(safe-area-inset-bottom)); left: 20px; right: 20px; margin: auto; max-width: 300px; background: #2d3436; color: white; padding: 14px 20px; border-radius: 30px; font-weight: bold; box-shadow: 0 8px 25px rgba(0,0,0,0.25); z-index: 95; display: none; font-size: 0.95rem; border:none; cursor:pointer; text-align: center;}

        /* Modals */
        .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 24px; width: 90%; max-width: 400px; max-height: 85vh; overflow-y: auto; box-shadow: 0 15px 40px rgba(0,0,0,0.2); position: relative; border: 1px solid rgba(255,255,255,0.5); }
        .modal-close-x { position: absolute; top: 18px; right: 18px; background: none; border: none; font-size: 1.6rem; color: #b2bec3; cursor: pointer; z-index: 10; }

        #loadingOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width:45px; height:45px; border:4px solid #f3f3f3; border-top:4px solid var(--accent); border-radius:50%; animation:spin 1s linear infinite; box-shadow: 0 0 10px rgba(0,210,211,0.2); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* A4 Viewer */
        .full-page-viewer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #555; z-index: 3000; display: none; 
            overflow-y: scroll; -webkit-overflow-scrolling: touch;
        }
        
        .a4-paper {
            width: 210mm; min-height: 297mm; background: white; 
            margin: 20px auto; padding: 15mm; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); position: relative; color: #111;
        }
        
        .a4-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
        .a4-title { font-size: 22pt; font-weight: 800; font-family: serif; letter-spacing: 2px; }
        .a4-subtitle { font-size: 12pt; margin-top: 5px; color:#555; }
        
        .audit-section { margin-bottom: 30px; }
        .audit-h3 { font-size: 13pt; font-weight: 800; border-left: 4px solid #333; padding-left: 10px; margin-bottom: 10px; background: #f8f9fa; padding-top:8px; padding-bottom:8px; }
        
        .audit-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 10pt; table-layout: fixed; }
        .audit-table th, .audit-table td { border: 1px solid #444; padding: 8px 5px; text-align: center; white-space: nowrap; }
        .audit-table th { background: #f0f0f0 !important; font-weight: 700; color:#333; }
        .audit-table td.money { text-align: right; font-family: 'Pretendard Variable', sans-serif; padding-right: 10px; font-weight:600;}
        
        .signature-area { margin-top: 40px; text-align: right; padding: 0 10px; }
        .signature-box { display: inline-block; text-align: left; margin-top: 15px; position:relative; vertical-align: bottom; }
        .signature-pad { border: 1px solid #999; background: #fff; width: 250px; height: 120px; display: block; margin-top: 10px; cursor: crosshair; touch-action: none; border-radius: 4px; }
        .signature-pad.locked { background: #f9f9f9; border: 1px dashed #ccc; cursor: default; }
        .check-area input[type=checkbox] { width: 20px; height: 20px; vertical-align: middle; }
        .audit-input-name { border:none; border-bottom:1px solid #333; width:120px; text-align:center; font-size:14pt; background:transparent; outline:none; font-weight:bold;}

        /* [수정] 감사/리포트 버튼 및 인쇄 스타일 정리 (크기 2배 확대) */
        .viewer-close-btn { 
            position: fixed; top: 20px; right: 20px; 
            background: #2d3436; color: white; border: none; 
            padding: 18px 36px; /* 크기 확대 */
            border-radius: 50px; cursor: pointer; font-weight: bold; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.5); z-index:5001; 
            font-size: 1.5rem; /* 폰트 확대 */
        }

        .audit-sign-btn { 
            position: fixed; top: 20px; left: 20px; 
            background: #6c5ce7; color: white; border: none; 
            padding: 18px 36px; /* 크기 확대 */
            border-radius: 50px; cursor: pointer; font-weight: bold; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.5); z-index:5001; 
            font-size: 1.5rem; /* 폰트 확대 */
        }

        .viewer-print-btn { 
             position: fixed; top: 20px; right: 180px; /* 위치 조정 */
             background: #636e72; color: white; border: none; 
             padding: 18px 36px; /* 크기 확대 */
             border-radius: 50px; cursor: pointer; font-weight: bold; 
             box-shadow: 0 8px 20px rgba(0,0,0,0.5); z-index:5001; 
             font-size: 1.5rem; /* 폰트 확대 */
        }
        
    /* ▼▼▼ 기존 .big-action-btn 부터 끝까지 지우고 이걸 붙여넣으세요 ▼▼▼ */
        .big-action-btn {
            pointer-events: auto; 
            background: var(--accent-grad); 
            width: auto; 
            padding: 18px 36px;
            display: inline-block; 
            margin-right: 15px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            border-radius: 50px;
            font-size: 1.5rem !important;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        /* 📱 [모바일 전용] '회원 명부' 제목만 아주 크게 키우기 (다른건 안 건드림) */
        @media screen and (max-width: 768px) {
            /* 회원명부 페이지의 제목 부분만 레이아웃 변경 */
            #page-members .section-header {
                display: block !important;       /* 한 줄 정렬 해제 */
                text-align: center !important;   /* 가운데 정렬 */
                margin-bottom: 20px !important;
            }

            /* '회원 명부' 글자 스타일 */
            #page-members .section-title {
                display: block !important;
                width: 100% !important;          /* 한 줄 꽉 차게 */
                font-size: 2.0rem !important;    /* 글자 크기 2.5배 확대 */
                margin-bottom: 15px !important;  /* 버튼들과 간격 벌리기 */
                text-align: center !important;
            }
            
            #page-members .section-title span {
                font-weight: 900 !important;
            }

            /* 버튼들은 제목 아래 가운데로 오게 */
            #page-members .section-header > div:last-child {
                display: flex !important;
                justify-content: center !important;
                width: 100% !important;
            }
        }

        /* 🖨️ [인쇄 전용] 인쇄 기능 오류 수정 및 A4 최적화 */
        @media print {
            @page { size: A4; margin: 10mm; }
            html, body { width: 100%; height: auto; margin: 0; padding: 0; background: white !important; }
            body * { visibility: hidden; } /* 배경 숨김 */

            /* 현재 열린 보고서만 표시 */
            .full-page-viewer {
                position: absolute !important; top: 0 !important; left: 0 !important;
                width: 100% !important; height: auto !important;
                visibility: visible !important; overflow: visible !important;
                background: white !important; z-index: 9999 !important;
                display: block !important;
            }
            .full-page-viewer * { visibility: visible !important; }

            /* 인쇄 시 버튼 등 숨김 */
            .viewer-close-btn, .viewer-print-btn, .audit-sign-btn, .big-action-btn, 
            .btn-main, .signature-pad, .audit-controls { display: none !important; }
            
            /* 표 스타일 초기화 (깨짐 방지) */
            table { width: 100% !important; border-collapse: collapse !important; }
            tr { page-break-inside: avoid; }
            .a4-paper { box-shadow: none !important; border: none !important; margin: 0 !important; width: 100% !important; }
            
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style> </head>
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="margin-top:15px; font-weight:bold; color:#555; font-size:0.9rem;" id="loadingMsg">데이터 동기화 중...</div>
</div>

<div class="app-container">
    <header>
        <div class="header-top">
            <div class="club-title">
                모던 테니스 <span class="ver-tag">Online</span>
                <span class="signature-ver">상영ver</span>
            </div>
            
            <div class="backup-btns">
    <button class="btn-backup admin-only" onclick="changeAdminPassword()">🔑PW변경</button>
    <button class="btn-backup admin-only" onclick="exportData()">💾 백업</button>
    <button class="btn-backup admin-only" onclick="document.getElementById('loadFile').click()">📂 복구</button>
    <button class="btn-save-exit admin-only" onclick="saveAndExit()">저장하고 나가기 🚪</button>
    <button id="btnLogin" class="admin-login-btn" onclick="toggleAdminLogin()">🔒</button>
    <input type="file" id="loadFile" accept=".json" style="display:none" onchange="importData(this)">
</div>
        </div>
        <div class="total-asset-box">
            <div class="balance-label">현재 총 자산</div>
            <div class="balance-amount" id="dispTotal">0원</div>
            <div class="balance-total-with-unpaid" id="dispTotalWithUnpaid"></div>
        </div>
        <div class="stats-row">
            <div class="stat-card"><span class="stat-label">수입</span><span class="stat-val" style="color:#74b9ff;" id="dispInc">0원</span></div>
            <div class="stat-card"><span class="stat-label">지출</span><span class="stat-val" style="color:#ff7675;" id="dispExp">0원</span></div>
            <div class="stat-card"><span class="stat-label" style="color:var(--accent);">찬조금</span><span class="stat-val" style="color:var(--accent);" id="dispDon">0원</span></div>
        </div>
    </header>

    <div id="page-ledger" class="page active">
        <div class="section-header">
            <div class="section-title"><span>📝 수입/지출 관리</span></div>
            <div style="display:flex; gap:5px;">
                <button class="btn-sub" style="background:#fff; color:var(--primary); border:1px solid var(--primary);" onclick="goTab('report')">📊 결산및 감사보고</button>
            </div>
        </div>
<div class="card admin-only">
            <div style="display:flex; gap:8px;">
                <input type="date" id="tDate" style="flex:1;">
                <select id="tType" onchange="setCategories()" style="flex:1; font-weight:bold;">
                    <option value="income">수입 (+)</option>
                    <option value="expense">지출 (-)</option>
                </select>
            </div>
            <div style="display:flex; gap:8px;">
                <select id="tCat" style="flex:1;"></select>
                <input type="number" id="tAmt" placeholder="금액" style="flex:1; font-weight:bold;">
            </div>
            <input type="text" id="tDesc" placeholder="내용 (예: 홍길동 1~6월 회비)">
            <button class="btn-main" id="btnAdd" onclick="addTrans()">입력 완료</button>
        </div>

        <div class="filter-container">
            <label class="filter-label">월 선택</label>
            <div class="chip-group" id="monthChips">
                <button class="filter-chip active" onclick="toggleMonth(this, 'all')">전체</button>
            </div>
            <label class="filter-label" style="margin-top:10px;">항목 선택</label>
            <div class="chip-group" id="catChips">
                <button class="filter-chip active" onclick="toggleCat(this, 'all')">전체</button>
                <button class="filter-chip group-btn" onclick="toggleCat(this, 'income_all')">수입 전체</button>
                <button class="filter-chip group-btn" style="color:var(--expense); background:#ffebee; border-color:#ffcdd2;" onclick="toggleCat(this, 'expense_all')">지출 전체</button>
            </div>
        </div>

        <div class="ledger-summary-box" id="ledgerSummary"></div>
        <div class="card" style="padding: 0 15px;"><div id="ledgerList"></div></div>
    </div>

    <div id="page-report" class="page">
        <div class="section-header">
            <div class="section-title"><span>📊 결산 보고서</span></div>
            <button class="btn-sub" onclick="goTab('ledger')">돌아가기</button>
        </div>
        
        <div class="report-filter-bar" style="display:flex; gap:5px; margin-bottom:15px; padding:10px;">
            <select id="reportYear" style="flex:1; min-width:80px;"></select>
            <select id="reportMonth" style="flex:1; min-width:80px;">
                <option value="all">전체 월</option>
                <option value="01">1월</option><option value="02">2월</option><option value="03">3월</option>
                <option value="04">4월</option><option value="05">5월</option><option value="06">6월</option>
                <option value="07">7월</option><option value="08">8월</option><option value="09">9월</option>
                <option value="10">10월</option><option value="11">11월</option><option value="12">12월</option>
            </select>
            <select id="reportCatFilter" style="flex:1; min-width:100px;">
                <option value="all">전체 항목</option>
                <optgroup label="수입">
                    <option value="월회비">월회비</option><option value="찬조금">찬조금</option>
                    <option value="가입비">가입비</option><option value="기타수입">기타수입</option>
                </optgroup>
                <optgroup label="지출">
                    <option value="식대">식대</option><option value="간식">간식</option>
                    <option value="비품">비품</option><option value="볼구입">볼구입</option>
                    <option value="코트비">코트비</option><option value="시합비">시합비</option>
                    <option value="기타지출">기타지출</option>
                </optgroup>
            </select>
        </div>

        <div style="display:flex; gap:5px; margin-bottom:20px;">
            <button class="btn-main" onclick="updateReport()" style="flex:1; background:var(--primary-grad); font-size:0.8rem;">
                📊 결산통계 보고서 조회
            </button>
            <button class="btn-main" onclick="openAuditReport()" style="flex:1; background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); font-size:0.8rem;">
                📑 감사보고서 작성 및 조회
            </button>
        </div>

        <div style="text-align:center; padding:20px; color:#999; font-size:0.9rem;">
            ☝️ 위 조건(연도/월) 선택 후 버튼을 누르면<br>A4 서식으로 깔끔하게 출력됩니다.
        </div>
    </div>

    <div id="settlementReportPage" class="full-page-viewer">
        <button class="viewer-close-btn" onclick="closeSettlementReport()">닫기</button>
        <button class="viewer-print-btn" onclick="window.print()">🖨 인쇄</button>
        <div class="a4-paper" id="settlementReportPaper">
            </div>
    </div>

    <div id="auditReportPage" class="full-page-viewer">
        <button class="viewer-close-btn" onclick="closeAuditReport()">닫기</button>
        <button class="viewer-print-btn" onclick="window.print()">🖨 인쇄</button>
        <button class="audit-sign-btn" id="btnUnlockAudit" onclick="unlockAuditMode()">🔐 감사 승인 모드</button>
        
        <div class="a4-paper">
            <div class="a4-header">
                <div class="a4-title" id="auditTitle">2024년도 감사 보고서</div>
                <div class="a4-subtitle">모던 테니스 클럽</div>
            </div>

            <div class="audit-section">
                <div class="audit-h3">1. 총괄 결산</div>
                <table class="audit-table">
                    <tr><th style="width:30%">구분</th><th style="width:40%">금액</th><th>비고</th></tr>
                    <tr><td>총 수입</td><td class="money" id="auditTotalInc">0원</td><td></td></tr>
                    <tr><td>총 지출</td><td class="money" id="auditTotalExp">0원</td><td></td></tr>
                    <tr style="background:#f0f8ff;"><td><b>잔액 (최종 자산)</b></td><td class="money" style="font-weight:bold; color:blue;" id="auditTotalBal">0원</td><td>이월금 포함</td></tr>
                </table>
            </div>

            <div class="audit-section">
                <div class="audit-h3">2. 월별 수지 현황</div>
                <table class="audit-table">
                    <thead><tr><th style="width:15%">월</th><th style="width:28%">수입</th><th style="width:28%">지출</th><th>잔액</th></tr></thead>
                    <tbody id="auditMonthlyBody"></tbody>
                </table>
            </div>

            <div class="audit-section">
                <div class="audit-h3">3. 항목별 결산 (세부 내역)</div>
                <table class="audit-table">
                    <thead>
                        <tr style="background:#f0f0f0;">
                            <th colspan="2" style="border-right: 2px solid #ccc; width:50%;">수입 내역 (+)</th>
                            <th colspan="2" style="width:50%;">지출 내역 (-)</th>
                        </tr>
                        <tr>
                            <th style="width:25%">항목</th>
                            <th style="width:25%; border-right: 2px solid #ccc;">금액</th>
                            <th style="width:25%">항목</th>
                            <th style="width:25%">금액</th>
                        </tr>
                    </thead>
                    <tbody id="auditCatMergedBody"></tbody>
                </table>
            </div>

            <div class="signature-area">
                <p style="margin-bottom:15px; font-size:12pt;">위와 같이 <b>모던 테니스 클럽</b>의 회계 감사를 보고합니다.</p>
                <div class="check-area">
                    <label>
                        <input type="checkbox" id="auditCheckReceipt" disabled>
                        위 결산 내용과 영수증 등 증빙서류가 일치함을 확인하였습니다.
                    </label>
                </div>
                <p id="auditDateLine" style="margin-bottom:20px;">2024년 00월 00일</p>
                
                <div class="signature-box">
                    <span style="font-size:14pt; font-weight:bold;">감 사 : </span>
                    <input type="text" id="auditNameInput" class="audit-input-name" placeholder="이름" disabled>
                    <span style="font-size:14pt; font-weight:bold;"> (인)</span>
                    
                    <canvas id="sigCanvas" class="signature-pad locked" width="180" height="90"></canvas>
                    
                    <div id="auditControlsArea" class="audit-controls" style="text-align:center; margin-top:5px; display:none;">
                        <button class="btn-sub" style="font-size:0.7rem; color:red;" onclick="clearSignature()">지우기</button>
                        <button class="btn-sub" style="font-size:0.7rem; background:blue; color:white;" onclick="saveAuditData()">승인 저장</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="memberReportPage" class="full-page-viewer">
        <button class="viewer-close-btn" onclick="closeMemberReport()">닫기</button>
        <button class="viewer-print-btn" onclick="window.print()">🖨 인쇄</button>
        
        <div class="a4-paper" id="memReportCapture">
            <div class="a4-header">
                <div class="a4-title">모던 테니스 회원 명부</div>
                <div class="a4-subtitle" id="memReportDate"></div>
            </div>
             <div class="audit-section">
                <table class="audit-table" style="font-size: 9pt;">
                    <thead> 
                        <tr> 
                            <th style="width:5%">No</th>
                            <th style="width:15%">이름</th>
                            <th style="width:10%">직책</th>
                            <th style="width:10%">구분</th> 
                            <th style="width:15%; color:var(--income)">납부액</th>
                            <th style="width:15%; color:red">미납액</th> 
                            <th style="width:15%; color:var(--accent)">찬조금</th>
                            <th style="width:10%">최종</th> 
                        </tr> 
                    </thead>
                    <tbody id="memReportBodyNew"></tbody>
                </table>
            </div>
        </div>
        
        <div style="position:fixed; bottom:20px; left:0; right:0; text-align:center; pointer-events:none; z-index:9999;">
            <button class="big-action-btn" onclick="captureElement('memReportCapture', '회원명부')">📸 이미지 저장</button>
            <button class="big-action-btn" onclick="exportTableToExcel('memReportTable', '회원명부')" style="background:#27ae60;">📊 엑셀 저장</button>
        </div>
    </div>

    <div id="page-members" class="page">
        <div class="section-header">
            <div class="section-title"><span>👥 회원 명부</span></div>
            <div style="display:flex; gap:5px;">
                <button class="btn-sub admin-only" style="background:#6c5ce7; color:white; border:none;" onclick="openFeeSettings()">⚙️회비설정</button>
                <button class="btn-sub admin-only" style="background:var(--primary); color:white; border:none;" onclick="openModal()">+ 추가</button>
                <button class="btn-sub" style="background:var(--accent); color:white; border:none;" onclick="openMemberReport()">💾 다른 형식의 파일로 저장하기</button>
            </div>
        </div>
       <div style="margin-bottom:10px;">
    <div class="chip-group" id="roleFilterChips" style="margin-bottom:8px;">
        <span style="font-size:0.8rem; font-weight:bold; margin-right:5px; align-self:center;">직책:</span>
        <button class="filter-chip" onclick="toggleRoleGroup(this, 'executive')">현 집행부</button>
        <button class="filter-chip" onclick="toggleRoleGroup(this, 'advisor')">고문/전년회장</button>
        <button class="filter-chip" onclick="toggleRoleGroup(this, 'auditor')">감사</button>
    </div>
    
    <div class="chip-group" id="statusChips" style="flex-wrap:nowrap; overflow-x:auto; padding-bottom:5px;">
        </div>
</div>
        <input type="text" id="searchMem" placeholder="이름 검색..." onkeyup="renderMembers()">
        <div class="member-table-wrap" id="memTableArea">
            <table id="memTable">
                <thead>
                    <tr>
                        <th onclick="toggleMemSort('name')"><input type="checkbox" onchange="toggleAllMemCheck(this)" style="width:auto; margin:0 4px 0 0; vertical-align: middle;">SMS <span id="sort_name"></span></th>
                        <th style="color:var(--income);" onclick="toggleMemSort('dues')">납부 <span id="sort_dues"></span></th>
                        <th style="color:red;" onclick="toggleMemSort('unpaid')">미납 <span id="sort_unpaid"></span></th>
                        <th style="color:var(--accent);" onclick="toggleMemSort('don')">찬조 <span id="sort_don"></span></th>
                        <th onclick="toggleMemSort('lastPaid')">최종납부 <span id="sort_lastPaid"></span></th>
                    </tr>
                </thead>
               <tbody id="memBody"></tbody>
    <tfoot id="memFoot" style="background:#e3f2fd; font-weight:800; border-top:2px solid #aaa;"></tfoot>
</table>
        </div>
    </div>

    <div id="page-analysis" class="page">
        <div class="section-header">
            <div class="section-title"><span>📊 미납 관리</span></div>
        </div>
        <div class="chip-group" style="margin-bottom:15px;">
            <button id="btnSortUnpaidName" class="filter-chip active" onclick="setUnpaidSort('name')">이름순</button>
            <button id="btnSortUnpaidAmt" class="filter-chip" onclick="setUnpaidSort('amount')">금액순</button>
        </div>
        <div id="totalUnpaidDisplay" style="margin-bottom:15px;"></div>
        <div class="card" style="background:transparent; border:none; box-shadow:none; padding:0;">
            <div id="unpaidList"></div>
        </div>
    </div>
    
    <div id="page-receipts" class="page">
        <div class="section-title" style="margin-bottom:15px;"><span>🧾 영수증 관리</span></div>
        <div class="card admin-only">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <label style="font-size:0.8rem; color:#666;">(집행일자)</label>
                <input type="date" id="rDateInput" style="width:65%;">
            </div>
            <input type="file" id="rFile" accept="image/*" style="margin-bottom:10px;">
            <input type="text" id="rDesc" placeholder="설명 입력">
            <button class="btn-main" onclick="uploadReceipt()">사진 저장</button>
        </div>
        
        <div class="filter-box" style="display:flex; gap:10px; margin-bottom:15px;">
            <select id="rFilterMonth" onchange="renderReceipts()" style="flex:1;">
                <option value="all">전체 월</option>
                <option value="01">1월</option><option value="02">2월</option><option value="03">3월</option>
                <option value="04">4월</option><option value="05">5월</option><option value="06">6월</option>
                <option value="07">7월</option><option value="08">8월</option><option value="09">9월</option>
                <option value="10">10월</option><option value="11">11월</option><option value="12">12월</option>
            </select>
            <input type="text" id="rSearchInput" placeholder="내용 검색" style="flex:1; margin-bottom:0;" onkeyup="renderReceipts()">
        </div>
        <div id="receiptList" class="receipt-grid"></div>
    </div>

    <div id="page-calendar" class="page">
        <div class="section-header">
            <div class="section-title"><span>📅 행사 일정</span></div>
            <button class="btn-sub" onclick="toggleCalView()">연간/월간 전환</button>
        </div>
        <div id="yearView" style="display:none;">
            <div style="text-align:center; font-weight:bold; font-size:1.1rem; margin-bottom:10px; color:var(--primary);"><span id="yearTitle"></span></div>
            <div id="yearGrid" class="year-view-grid"></div>
        </div>
        <div id="monthView" class="card">
             <div class="section-header" style="margin-bottom:10px;">
                <button class="btn-sub" onclick="changeMonth(-1)">◀</button>
                <span id="calTitle" style="font-weight:bold; font-size:1.1rem;"></span>
                <button class="btn-sub" onclick="changeMonth(1)">▶</button>
            </div>
            <div id="monthGrid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:5px; text-align:center;"></div>
        </div>
        <div class="card" style="margin-top:10px;">
            <h4 style="margin:0 0 10px 0; font-size:0.9rem;">📝 전체 일정 목록 (클릭하여 수정)</h4>
            <div id="allEventsContainer"></div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="goTab('ledger', this)"><span class="nav-icon">📒</span>장부</div>
        <div class="nav-item" onclick="goTab('members', this)"><span class="nav-icon">👥</span>명부</div>
        <div class="nav-item" onclick="goTab('analysis', this)"><span class="nav-icon">📊</span>미납</div>
        <div class="nav-item" onclick="goTab('receipts', this)"><span class="nav-icon">🧾</span>영수증</div>
        <div class="nav-item" onclick="goTab('calendar', this)"><span class="nav-icon">📅</span>일정</div>
    </div>
    
    <div class="fab admin-only" onclick="goTab('ledger', document.querySelector('.nav-item')); document.getElementById('tAmt').focus()">+</div>
    <button id="btnBulkSMS" class="bulk-sms-btn" onclick="sendBulkSMS()">📩 선택 문자발송</button>

    <div class="modal-wrap" id="eventModal">
        <div class="modal">
            <h3>일정 관리</h3>
            <div id="eventDateDisplay" style="margin-bottom:10px; color:var(--primary); font-weight:bold;"></div>
            <input type="hidden" id="eventDateVal">
            <div class="admin-only" style="display:block;">
                <input type="text" id="eventInput" placeholder="일정 내용을 입력하세요">
                <button class="btn-main" onclick="addEvent()">추가</button>
            </div>
            <div id="dayEventList" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;"></div>
            <button onclick="document.getElementById('eventModal').style.display='none'" style="width:100%; margin-top:10px; border:none; background:none; text-decoration:underline;">닫기</button>
        </div>
    </div>
    <div class="modal-wrap" id="transModal">
        <div class="modal">
            <h3>내역 수정</h3>
            <div id="editTransFormBox" style="display:none;">
                <input type="hidden" id="editTransId">
                <input type="date" id="editTransDate">
                <select id="editTransType" onchange="updateEditCategories()"><option value="income">수입</option><option value="expense">지출</option></select>
                <select id="editTransCat"></select>
                <input type="number" id="editTransAmt">
                <input type="text" id="editTransDesc">
                <div style="display:flex; gap:10px;">
                    <button class="btn-main" onclick="saveTransEdit()">수정</button>
                    <button class="btn-main" style="background:#eee; color:#333;" onclick="closeTransModal()">취소</button>
                </div>
                <button onclick="delTransFromModal()" style="width:100%; margin-top:10px; border:none; background:none; color:red; text-decoration:underline;">삭제하기</button>
            </div>
            <div id="viewTransOnly" style="display:none;">
                <p>관리자만 수정할 수 있습니다.</p>
                <button class="btn-main" onclick="closeTransModal()">닫기</button>
            </div>
        </div>
    </div>
    <div class="modal-wrap" id="memModal">
        <div class="modal">
            <button class="modal-close-x" onclick="closeModal()">×</button>
            <h3 id="modalTitle">회원 정보</h3>
            <input type="hidden" id="editId">
            <input type="text" id="editName" placeholder="이름">
            <select id="editRole" style="margin-bottom:10px;">
    <option value="">직책 없음 (일반 회원)</option>

    <optgroup label="=== 현 집행부 ===">
        <option value="회장">회장</option>
        <option value="부회장">부회장</option>
        <option value="총무">총무</option>
        <option value="경기이사">경기이사</option>
        <option value="시설이사">시설이사</option>
        <option value="여성이사">여성이사</option>
        <option value="홍보이사">홍보이사</option>
    </optgroup>

    <optgroup label="=== 고문 및 전년회장 ===">
        <option value="고문">고문</option>
        <option value="전년회장">전년회장</option>
    </optgroup>

    <optgroup label="=== 감사 ===">
        <option value="감사">감사</option>
    </optgroup>
</select>
            <input type="text" id="editPhone" placeholder="연락처 (예: 010-1234-5678)">
            <label style="font-size:0.75rem; color:#888;">회비구분(상태)</label>
            <select id="editStatus">
                <option value="남성">남성</option>
                <option value="여성">여성</option>
                <option value="부부(남)">부부(남)</option>
                <option value="부부(여)">부부(여)</option>
                <option value="휴회">휴회</option>
                <option value="탈회">탈회</option>
            </select>
            <input type="text" id="editSpouse" placeholder="배우자 이름">
            <div id="adminMemBtns" class="admin-flex" style="gap:10px;">
                <button class="btn-main" onclick="saveMember()">저장</button>
                <button class="btn-main" style="background:#eee; color:#333;" onclick="closeModal()">취소(닫기)</button>
            </div>
            <button id="btnDelMem" class="admin-only" onclick="delMember()" style="width:100%; margin-top:10px; border:none; background:none; color:red; text-decoration:underline;">삭제</button>
            <button class="btn-main" id="btnCloseMemView" onclick="closeModal()" style="display:none; background:#eee; color:#333;">닫기</button>
        </div>
    </div>
    <div class="modal-wrap" id="feeSettingsModal">
        <div class="modal">
            <h3>⚙️ 월 회비 설정</h3>
            <div style="margin-bottom:10px;"><label style="font-size:0.8rem;">남성</label><input type="number" id="fee_reg"></div>
            <div style="margin-bottom:10px;"><label style="font-size:0.8rem;">여성</label><input type="number" id="fee_fem"></div>
            <div style="margin-bottom:10px;"><label style="font-size:0.8rem;">부부(남)</label><input type="number" id="fee_cpl_m"></div>
            <div style="margin-bottom:10px;"><label style="font-size:0.8rem;">부부(여)</label><input type="number" id="fee_cpl_f"></div>
            <div style="margin-bottom:10px;"><label style="font-size:0.8rem;">휴회 / 탈회 (고정 0원)</label><input type="number" value="0" disabled style="background:#eee;"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-main" onclick="saveFeeSettings()">저장</button>
                <button class="btn-main" style="background:#eee; color:#333;" onclick="document.getElementById('feeSettingsModal').style.display='none'">취소</button>
            </div>
        </div>
    </div>
    <div class="modal-wrap" id="imgModal">
        <div class="modal" style="background:transparent; box-shadow:none; text-align:center;">
            <img id="bigImg" src="" style="max-width:100%; max-height:80vh; border-radius:10px;">
            <br>
            <button class="admin-only" onclick="deleteReceipt(window.curReceiptId)" style="margin-top:10px; background:white; padding:10px; border-radius:10px; color:red; font-weight:bold; border:none;">이 영수증 삭제</button>
            <button onclick="document.getElementById('imgModal').style.display='none'" style="margin-top:10px; background:white; padding:10px; border-radius:10px; border:none;">닫기</button>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBDdJpn7gkb_8mnHaQpp3olHuE_Un_Aj7A",
      authDomain: "lsytennis.firebaseapp.com",
      databaseURL: "https://lsytennis-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "lsytennis",
      storageBucket: "lsytennis.firebasestorage.app",
      messagingSenderId: "1020734955594",
      appId: "1:1020734955594:web:e458c058cad48f313ec6b3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.trans = []; window.members = []; window.receipts = []; window.events = []; window.settings = null;
    window.auditState = { checked: false, name: "", sig: null }; 

    window.sortState = { key: 'name', order: 'asc' };
    window.memFilters = { statuses: new Set(['all']), onlyRole: false };
   // [추가] 직책 그룹 정의 및 선택 상태 변수
const ROLE_GROUPS_DEF = {
    'executive': ['회장', '부회장', '총무', '부총무', '경기이사', '부경기이사', '시설이사', '여성이사', '홍보이사'],
    'advisor': ['고문', '전년회장', '전회장'],
    'auditor': ['감사']
};
    window.selectedRoleGroups = new Set(); 
    window.unpaidSort = 'name'; 
    window.calViewMode = 'month';
    window.curCalDate = new Date();
    window.selectedMonths = new Set(['all']); 
    window.selectedCats = new Set(['all']);
    window.isAdmin = false; 
    window.isAuditMode = false; 

    const CATS = { 
        income: ['월회비', '찬조금', '가입비', '기타수입'], 
        expense: ['식대', '간식', '비품', '볼구입', '코트비', '시합비', '기타지출'] 
    };
    
    const ROLE_RANK = [ '회장', '부회장', '(부)회장', '총무', '부총무', '(부)총무', '경기이사', '부경기이사', '(부)경기이사', '시설이사', '여성이사', '홍보이사', '고문', '전년회장', '(전년)회장', '(전년회장)', '전회장', '(전)회장', '(전회장)', '감사' ];
    const STATUS_LIST = ['직책', '남성', '여성', '부부(남)', '부부(여)', '휴회', '탈회'];
    const BADGE_COLOR = { '남성': '#00b894', '여성': '#e84393', '부부(남)': '#0984e3', '부부(여)': '#fd79a8', '휴회': '#b2bec3', '탈회': '#636e72' };
    
    let DEFAULT_FEES = { '남성': 40000, '여성': 20000, '부부(남)': 50000, '부부(여)': 20000, '휴회':0, '탈회':0 };
    let currentFees = { ...DEFAULT_FEES };
    const EXCLUDED_STATUSES = ['휴회', '탈회'];
    
    const FIXED_HOLIDAYS = ['01-01', '03-01', '05-05', '06-06', '08-15', '10-03', '10-09', '12-25'];
    const SPECIFIC_HOLIDAYS = ['2024-02-09', '2024-02-10', '2024-02-11', '2024-02-12', '2024-04-10', '2024-05-06', '2024-05-15', '2024-09-16', '2024-09-17', '2024-09-18', '2024-10-01', '2025-01-28', '2025-01-29', '2025-01-30', '2025-03-03', '2025-05-05', '2025-05-06', '2025-10-03', '2025-10-05', '2025-10-06', '2025-10-07', '2025-10-08', '2025-10-09', '2026-02-17', '2026-02-18', '2026-02-19', '2026-03-02', '2026-05-24', '2026-05-25', '2026-09-24', '2026-09-25', '2026-09-26', '2026-09-27'];

    function isHoliday(yyyy_mm_dd) {
        const mm_dd = yyyy_mm_dd.substring(5);
        return FIXED_HOLIDAYS.includes(mm_dd) || SPECIFIC_HOLIDAYS.includes(yyyy_mm_dd);
    }

    history.pushState(null, null, location.href);
    window.onpopstate = function () {
        history.pushState(null, null, location.href); 
        alert("⚠️ 뒤로가기를 누르시면 앱이 종료 됩니다.");
    };
    window.addEventListener('beforeunload', (event) => {
        event.preventDefault(); event.returnValue = '';
    });

    window.onload = () => {
        const savedAuth = localStorage.getItem('tennisAdminAuth');
        if(savedAuth === 'true') { window.isAdmin = true; updateAdminUI(); }

        document.getElementById('tDate').valueAsDate = new Date();
        document.getElementById('rDateInput').valueAsDate = new Date();
        createFilterChips();
        createMemberStatusChips();
        initReportYears();
        initSignaturePad();

        const clubRef = ref(db, 'clubData');
        onValue(clubRef, (snapshot) => {
            document.getElementById('loadingOverlay').style.display = 'none';
            const data = snapshot.val();
            if (data) {
                window.trans = data.trans || [];
                window.members = data.members || [];
                window.receipts = data.receipts || [];
                window.events = data.events || [];
                window.settings = data.settings || {};
                
                if(data.auditState) window.auditState = data.auditState;
            } else {
                saveToFirebase();
            }
            if(window.settings && window.settings.fees) {
                currentFees = { ...DEFAULT_FEES, ...window.settings.fees };
            }
            setCategories();
            renderAll();
        });
    };

    function saveToFirebase() {
        if(!window.isAdmin && !window.isAuditMode && window.trans.length > 0) return Promise.resolve();
        
        let updateData = {
            trans: window.trans, members: window.members, receipts: window.receipts, events: window.events, settings: window.settings
        };
        if(window.auditState) updateData.auditState = window.auditState;

        return set(ref(db, 'clubData'), updateData);
    }

window.saveAndExit = () => {
        if(!confirm('데이터를 저장하고 종료하시겠습니까?')) return;
        
        document.getElementById('loadingMsg').innerText = '데이터 동기화 중...';
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('시간 초과 (인터넷 상태를 확인하세요)')), 15000)
        );

        Promise.race([saveToFirebase(), timeoutPromise])
            .then(() => {
                 alert('✅ 안전하게 저장되었습니다.\n\n앱을 종료하거나 창을 닫으셔도 좋습니다.');
                 document.body.innerHTML = "<div style='display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column; text-align:center; background:#f4f7f6;'><h1>👋 저장 완료</h1><p>이제 앱을 종료하셔도 됩니다.</p></div>";
                 window.close();
            }).catch(err => {
                 document.getElementById('loadingOverlay').style.display = 'none';
                 if(confirm(`저장에 시간이 오래 걸리거나 실패했습니다.\n(${err})\n\n그래도 종료하시겠습니까?`)) {
                     document.body.innerHTML = "<div style='display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column; text-align:center;'><h1>종료됨</h1></div>";
                 }
            });
    }

    // --- 관리자/인증 ---
    window.toggleAdminLogin = () => {
        if(window.isAdmin) {
            if(confirm('로그아웃 하시겠습니까?')) {
                window.isAdmin = false;
                localStorage.removeItem('tennisAdminAuth');
                updateAdminUI();
                alert('로그아웃 되었습니다.');
                location.reload();
            }
        } else {
            const pwd = prompt('관리자 비밀번호를 입력하세요:');
            const currentPw = (window.settings && window.settings.adminPwd) ? window.settings.adminPwd : '1234';
            if(pwd === currentPw) { 
                window.isAdmin = true;
                localStorage.setItem('tennisAdminAuth', 'true');
                updateAdminUI();
                alert('관리자 모드로 전환되었습니다.');
                renderAll(); 
            } else if (pwd !== null) alert('비밀번호가 틀렸습니다.');
        }
    }
    
    window.changeAdminPassword = () => {
        if(!window.isAdmin) return;
        const newPw = prompt("새로운 비밀번호를 입력하세요:");
        if(newPw && newPw.trim() !== "") {
            const confirmPw = prompt("비밀번호 확인을 위해 한 번 더 입력하세요:");
            if(newPw === confirmPw) {
                if(!window.settings) window.settings = {};
                window.settings.adminPwd = newPw;
                saveToFirebase();
                alert("비밀번호가 변경되었습니다.");
            } else alert("비밀번호가 일치하지 않습니다.");
        }
    }

    function updateAdminUI() {
        const btn = document.getElementById('btnLogin');
        const adminEls = document.querySelectorAll('.admin-only');
        const adminFlexEls = document.querySelectorAll('.admin-flex');
        
        if(window.isAdmin) {
            btn.classList.add('logged-in'); btn.innerHTML = '🔓';
            adminEls.forEach(el => el.style.setProperty('display', 'block', 'important'));
            adminFlexEls.forEach(el => el.style.setProperty('display', 'flex', 'important'));
            document.querySelector('.fab').style.display = 'flex';
            document.querySelectorAll('.btn-backup').forEach(b => b.style.setProperty('display', 'block', 'important'));
            document.querySelector('.btn-save-exit').style.setProperty('display', 'flex', 'important');
        } else {
            btn.classList.remove('logged-in'); btn.innerHTML = '🔒';
            adminEls.forEach(el => el.style.setProperty('display', 'none', 'important'));
            adminFlexEls.forEach(el => el.style.setProperty('display', 'none', 'important'));
        }
    }

    function formatShort(amount) {
        if (!amount || amount === 0) return '-';
        if (amount >= 10000) {
            const man = Math.floor(amount / 10000);
            const remainder = amount % 10000;
            return man + '만' + (remainder > 0 ? (remainder/1000).toFixed(0) : ''); 
        }
        return amount.toLocaleString(); 
    }
    
    function formatStandard(amount) {
        return amount ? amount.toLocaleString() + "원" : '0원';
    }

    // --- 장부 ---
    window.setCategories = () => {
        const type = document.getElementById('tType').value;
        const el = document.getElementById('tCat');
        el.innerHTML = '';
        CATS[type].forEach(c => { const op = document.createElement('option'); op.value=c; op.innerText=c; el.appendChild(op); });
    }

    window.addTrans = () => {
        if(!window.isAdmin) return alert('관리자만 입력 가능합니다.');
        const date = document.getElementById('tDate').value;
        const type = document.getElementById('tType').value;
        const cat = document.getElementById('tCat').value;
        const amt = parseInt(document.getElementById('tAmt').value);
        const desc = document.getElementById('tDesc').value.trim();
        if(!date || !amt) return alert('금액 입력하세요.');

        const transMonth = parseInt(date.split('-')[1]); 
        if(type === 'income' && cat === '가입비') {
            const mIdx = transMonth - 1;
            if(mIdx >= 0 && mIdx < 12) window.members.forEach(m => { if(desc.includes(m.name)) m.paid[mIdx] = true; });
        }
        if(type === 'income' && cat === '월회비' && desc) {
            const rangeMatch = desc.match(/(\d+)[~-](\d+)월/);
            if(rangeMatch) {
                const start = parseInt(rangeMatch[1]); const end = parseInt(rangeMatch[2]);
                if(start>=1 && end<=12 && start<=end) window.members.forEach(m => { if(desc.includes(m.name)) for(let i=start-1; i<end; i++) m.paid[i]=true; });
            } else {
                const mMatch = desc.match(/(\d+)월/);
                if(mMatch) {
                    const idx = parseInt(mMatch[1])-1;
                    if(idx>=0 && idx<12) window.members.forEach(m=>{ if(desc.includes(m.name)) m.paid[idx]=true; });
                }
            }
        }
        window.trans.unshift({ id:Date.now(), date, type, cat, amt, desc });
        saveToFirebase();
        const btn = document.getElementById('btnAdd'); btn.innerText = "저장 완료!"; btn.classList.add('saved');
        setTimeout(() => { btn.innerText = "입력 완료"; btn.classList.remove('saved'); }, 1000);
        document.getElementById('tAmt').value=''; document.getElementById('tDesc').value='';
    }

    function createFilterChips() {
        const mCon = document.getElementById('monthChips');
        for(let i=1; i<=12; i++) {
            const btn = document.createElement('button'); btn.className = 'filter-chip'; btn.innerText = i+'월';
            btn.onclick = () => toggleMonth(btn, String(i).padStart(2,'0')); mCon.appendChild(btn);
        }
        const cCon = document.getElementById('catChips');
        [...CATS.income, ...CATS.expense].forEach(c => {
            const btn = document.createElement('button'); btn.className = 'filter-chip'; btn.innerText = c;
            btn.onclick = () => toggleCat(btn, c); cCon.appendChild(btn);
        });
    }

    window.toggleMonth = (btn, val) => {
        if(val==='all') { window.selectedMonths.clear(); window.selectedMonths.add('all'); document.querySelectorAll('#monthChips .filter-chip').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
        else {
            if(window.selectedMonths.has('all')) { window.selectedMonths.delete('all'); document.querySelector('#monthChips .filter-chip').classList.remove('active'); }
            if(window.selectedMonths.has(val)) { window.selectedMonths.delete(val); btn.classList.remove('active'); }
            else { window.selectedMonths.add(val); btn.classList.add('active'); }
            if(window.selectedMonths.size===0) { window.selectedMonths.add('all'); document.querySelector('#monthChips .filter-chip').classList.add('active'); }
        } renderLedger();
    }
    window.toggleCat = (btn, val) => {
        if(val==='all') { window.selectedCats.clear(); window.selectedCats.add('all'); document.querySelectorAll('#catChips .filter-chip').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
        else if(val==='income_all') {
            CATS.income.forEach(c => window.selectedCats.add(c)); window.selectedCats.delete('all');
            document.querySelector('#catChips .filter-chip').classList.remove('active');
            updateCatChipVisuals();
        } else if(val==='expense_all') {
            CATS.expense.forEach(c => window.selectedCats.add(c)); window.selectedCats.delete('all');
            document.querySelector('#catChips .filter-chip').classList.remove('active');
            updateCatChipVisuals();
        } else {
            if(window.selectedCats.has('all')) { window.selectedCats.delete('all'); document.querySelector('#catChips .filter-chip').classList.remove('active'); }
            if(window.selectedCats.has(val)) window.selectedCats.delete(val); else window.selectedCats.add(val);
            if(window.selectedCats.size===0) { window.selectedCats.add('all'); document.querySelector('#catChips .filter-chip').classList.add('active'); }
            updateCatChipVisuals();
        } renderLedger();
    }

    function updateCatChipVisuals() {
        document.querySelectorAll('#catChips .filter-chip').forEach(b => {
            if(b.classList.contains('group-btn') || b.innerText === '전체') return;
            if(window.selectedCats.has(b.innerText)) b.classList.add('active'); else b.classList.remove('active');
        });
    }

    window.renderLedger = () => {
        const list = document.getElementById('ledgerList'); list.innerHTML = '';
        let filtered = window.trans.filter(t => {
            const m = t.date.split('-')[1];
            return (window.selectedMonths.has('all') || window.selectedMonths.has(m)) && (window.selectedCats.has('all') || window.selectedCats.has(t.cat));
        });

        let sumInc=0, sumExp=0; filtered.forEach(t=>{if(t.type==='income')sumInc+=t.amt;else sumExp+=t.amt;});
        document.getElementById('ledgerSummary').innerHTML = `
            <div class="summary-row"><span style="color:var(--income)">수입</span><span>${formatStandard(sumInc)}</span></div>
            <div class="summary-row"><span style="color:var(--expense)">지출</span><span>${formatStandard(sumExp)}</span></div>
            <div class="summary-row total"><span>합계</span><span>${formatStandard(sumInc-sumExp)}</span></div>
        `;

        filtered.forEach(t => {
            const div = document.createElement('div'); div.className='trans-item'; div.onclick=()=>openEditTrans(t.id);
            div.innerHTML=`<div style="flex:1;"><div class="ti-date">${t.date}</div><div class="ti-desc">${t.desc} <span class="ti-cat">${t.cat}</span></div></div><div class="ti-amt" style="color:${t.type==='income'?'var(--income)':'var(--expense)'}">${t.type==='income'?'+':'-'}${formatStandard(t.amt)}</div>`;
            list.appendChild(div);
        });
    }

    // --- 회원 명부 ---
    function syncPaymentsFromLedger() {
        window.members.forEach(m => { m.paid = Array(12).fill(false); });
        window.trans.forEach(t => {
            if (t.type !== 'income') return; 
            if (t.cat === '가입비') {
                const dateMonth = parseInt(t.date.split('-')[1]); 
                const mIdx = dateMonth - 1;
                if (mIdx >= 0 && mIdx < 12) window.members.forEach(m => { if (t.desc.includes(m.name)) m.paid[mIdx] = true; });
            }
            if (t.cat === '월회비') {
                const rangeMatch = t.desc.match(/(\d+)[~-](\d+)월/);
                if (rangeMatch) {
                    const start = parseInt(rangeMatch[1]); const end = parseInt(rangeMatch[2]);
                    if (start >= 1 && end <= 12 && start <= end) window.members.forEach(m => { if (t.desc.includes(m.name)) { for (let i = start - 1; i < end; i++) m.paid[i] = true; } });
                } else {
                    const monthMatch = t.desc.match(/(\d+)월/);
                    if (monthMatch) {
                        const idx = parseInt(monthMatch[1]) - 1;
                        if (idx >= 0 && idx < 12) window.members.forEach(m => { if (t.desc.includes(m.name)) m.paid[idx] = true; });
                    }
                }
            }
        });
    }

    function createMemberStatusChips() {
        const con = document.getElementById('statusChips'); con.innerHTML = '';
        ['전체', ...STATUS_LIST].forEach(txt => {
            const btn = document.createElement('button'); btn.className = 'filter-chip'; btn.id = 'chip-' + txt; btn.innerText = txt; 
            if(txt === '전체') btn.classList.add('active');
            btn.onclick = () => toggleMemFilter(btn, 'status', txt);
            con.appendChild(btn);
        });
    }
    
    function updateChipCounts() {
        const counts = { '전체': window.members.length, '직책': 0 };
        STATUS_LIST.forEach(s => { if(s!=='직책') counts[s] = 0; });
        window.members.forEach(m => { if(m.role && m.role.trim() !== '') counts['직책']++; if(counts[m.status] !== undefined) counts[m.status]++; });
        const chips = document.getElementById('statusChips').children;
        for(let btn of chips) { const rawTxt = btn.id.replace('chip-',''); if(counts[rawTxt] !== undefined) btn.innerText = `${rawTxt}(${counts[rawTxt]})`; }
    }

    window.toggleMemFilter = (btn, type, val) => {
        if (type === 'status') {
            if (val === '전체') { window.memFilters.statuses.clear(); window.memFilters.statuses.add('all'); window.memFilters.onlyRole = false; }
            else if (val === '직책') { window.memFilters.onlyRole = !window.memFilters.onlyRole; }
            else {
                if (window.memFilters.statuses.has('all')) window.memFilters.statuses.delete('all');
                if (window.memFilters.statuses.has(val)) window.memFilters.statuses.delete(val); else window.memFilters.statuses.add(val);
                if (window.memFilters.statuses.size === 0 && !window.memFilters.onlyRole) window.memFilters.statuses.add('all');
            }
        }
        updateMemFilterVisuals(); renderMembers(); 
    }

    function updateMemFilterVisuals() {
        const chips = document.getElementById('statusChips').children;
        for (let btn of chips) {
            const rawTxt = btn.id.replace('chip-','');
            let isActive = false;
            if (rawTxt === '전체') isActive = window.memFilters.statuses.has('all');
            else if (rawTxt === '직책') isActive = window.memFilters.onlyRole;
            else isActive = window.memFilters.statuses.has(rawTxt);
            if(isActive) btn.classList.add('active'); else btn.classList.remove('active');
        }
    }
// [추가] 직책 그룹 버튼 클릭 시 토글 처리 함수
    window.toggleRoleGroup = (btn, groupKey) => {
        if (window.selectedRoleGroups.has(groupKey)) {
            window.selectedRoleGroups.delete(groupKey);
            btn.classList.remove('active');
        } else {
            window.selectedRoleGroups.add(groupKey);
            btn.classList.add('active');
        }
        renderMembers(); // 명부 다시 그리기
    }

    // [추가] 회원의 직책이 해당 그룹에 속하는지 확인하는 헬퍼 함수
  // [수정] 직책 매칭 헬퍼 함수 (집행부 조회 시 전년회장/고문 제외 로직 추가)
function checkRoleMatch(memberRole, groupKey) {
    if (!memberRole) return false;

    // 현 집행부('executive')를 찾을 때는, 'advisor'(고문/전년회장) 키워드가 포함된 경우 제외
    // (예: '전년회장'에는 '회장' 글자가 들어가 있어 집행부로 오인될 수 있음 방지)
    if (groupKey === 'executive') {
        const isAdvisor = ROLE_GROUPS_DEF['advisor'].some(k => memberRole.includes(k));
        if (isAdvisor) return false;
    }

    // 해당 그룹의 키워드가 포함되어 있는지 확인
    return ROLE_GROUPS_DEF[groupKey].some(keyword => memberRole.includes(keyword));
}
    
    window.toggleMemSort = (key) => {
        if(window.sortState.key === key) window.sortState.order = window.sortState.order==='asc'?'desc':'asc';
        else { window.sortState.key = key; window.sortState.order = 'asc'; }
        ['name','dues','unpaid','don','lastPaid'].forEach(k => document.getElementById('sort_'+k).innerText = '');
        document.getElementById('sort_'+key).innerText = window.sortState.order==='asc'?'▲':'▼';
        renderMembers();
    }
    
   function getRoleRank(roleName) {
        if(!roleName) return 999;
        let bestIndex = -1;
        ROLE_RANK.forEach((rankName, index) => { if (roleName.includes(rankName)) { if (index > bestIndex) bestIndex = index; } });
        return bestIndex === -1 ? 999 : bestIndex;
    }

    function getLastPaidIndex(m) { for(let i=11; i>=0; i--) { if(m.paid[i]) return i; } return -1; }

    // [1] 회원 명부 렌더링 (합계 포함)
    // [수정됨] 회원 명부 렌더링 함수
    window.renderMembers = () => {
        syncPaymentsFromLedger(); 
        updateChipCounts(); 
        const tb = document.getElementById('memBody'); tb.innerHTML = '';
        const tf = document.getElementById('memFoot'); tf.innerHTML = '';

        const key = document.getElementById('searchMem').value;
        let list = [...window.members];

        // 1. 이름 검색
        if(key) list = list.filter(m => m.name.includes(key));
        
        // 2. 상태(남성/여성/휴회 등) 필터
        if (!window.memFilters.statuses.has('all')) list = list.filter(m => window.memFilters.statuses.has(m.status));
        
        // 3. (기존) 직책만 보기 필터
        if (window.memFilters.onlyRole) list = list.filter(m => m.role && m.role.trim() !== "");

        // [추가됨] 4. 직책 그룹(집행부/고문/감사) 필터
        if (window.selectedRoleGroups.size > 0) {
            list = list.filter(m => {
                let isMatch = false;
                if (window.selectedRoleGroups.has('executive') && checkRoleMatch(m.role, 'executive')) isMatch = true;
                if (window.selectedRoleGroups.has('advisor') && checkRoleMatch(m.role, 'advisor')) isMatch = true;
                if (window.selectedRoleGroups.has('auditor') && checkRoleMatch(m.role, 'auditor')) isMatch = true;
                return isMatch;
            });
        }
        
        // 정렬 로직
// [수정된 정렬 로직]
        list.sort((a,b) => {
            let vA, vB; const k = window.sortState.key;
            
            // 1. "직책만 보기"가 켜져 있거나 OR "직책 그룹 버튼(집행부 등)"이 하나라도 눌려있다면
            //    AND 정렬 기준이 '이름(name)'이라면 -> 이름을 무시하고 '직책 순서'로 우선 정렬
            if ((window.memFilters.onlyRole || window.selectedRoleGroups.size > 0) && k === 'name') { 
                vA = getRoleRank(a.role); 
                vB = getRoleRank(b.role); 
                // 직책 순위가 다르면 직책 순서대로, 같으면 아래 이름 정렬로 넘어감
                if (vA !== vB) return vA - vB; 
            }

            // 2. 기존 정렬 로직 (이름, 납부액, 미납액 등)
            if(k === 'name') return window.sortState.order==='asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
            if(k === 'dues') { vA=getMemberSums(a.name).dues; vB=getMemberSums(b.name).dues; }
            if(k === 'unpaid') { vA=getUnpaidInfo(a).amount; vB=getUnpaidInfo(b).amount; }
            if(k === 'don') { vA=getMemberSums(a.name).donation; vB=getMemberSums(b.name).donation; }
            if(k === 'lastPaid') { vA=getLastPaidIndex(a); vB=getLastPaidIndex(b); }
            return window.sortState.order==='asc' ? vA-vB : vB-vA;
        });
        
        let sumDues = 0, sumUnpaid = 0, sumDon = 0;

        list.forEach((m, idx) => {
            const sums = getMemberSums(m.name);
            const unpaidInfo = getUnpaidInfo(m);
            const lpIdx = getLastPaidIndex(m);
            
            sumDues += sums.dues;
            sumUnpaid += unpaidInfo.amount;
            sumDon += sums.donation;

            const tr = document.createElement('tr');
            let lastPaidText = lpIdx !== -1 ? (lpIdx===11 ? "완납" : (lpIdx+1)+"월") : "-";
            let lpClass = lastPaidText === "완납" ? "last-paid-cell done" : "last-paid-cell";

           let nameHtml = `
            <div class="m-cell">
                <input type="checkbox" class="mem-chk" value="${m.phone}" style="width:auto; margin-right:2px; vertical-align:middle;" onclick="checkBulkBtnVisibility()">
                <span class="m-idx">${idx + 1}</span>
                <div class="m-name-box"><span class="m-name" onclick="openModal(${m.id})">${m.name}</span>${m.role ? `<span class="m-role">${m.role}</span>` : ''}</div>
                <a href="tel:${m.phone}" class="act-btn">📞</a>
                <span class="m-status" style="background:${BADGE_COLOR[m.status]||'#999'}">${m.status}</span>
            </div>`;
            
            tr.innerHTML = `<td>${nameHtml}</td>
                <td class="money-cell" style="color:var(--income);">${sums.dues > 0 ? formatShort(sums.dues) : '-'}</td>
                <td class="money-cell" style="color:red;">${unpaidInfo.amount > 0 ? formatShort(unpaidInfo.amount) : '-'}</td>
                <td class="money-cell" style="color:var(--accent);">${sums.donation > 0 ? formatShort(sums.donation) : '-'}</td>
                <td><span class="${lpClass}">${lastPaidText}</span></td>`;
            tb.appendChild(tr);
        });

        tf.innerHTML = `<tr>
            <td style="text-align:center; font-size:0.9rem;">총 ${list.length}명 합계</td>
            <td class="money-cell" style="color:blue;">${formatShort(sumDues)}</td>
            <td class="money-cell" style="color:red;">${formatShort(sumUnpaid)}</td>
            <td class="money-cell" style="color:green;">${formatShort(sumDon)}</td>
            <td></td>
        </tr>`;

        checkBulkBtnVisibility();
    }

    // [2] 회원명부 저장 뷰어 (이미지/엑셀)
    window.openMemberReport = () => {
         const metaViewport = document.querySelector('meta[name="viewport"]');
         if (metaViewport) metaViewport.setAttribute('content', 'width=1024, user-scalable=yes'); 
        const area = document.getElementById('memReportBodyNew');
        document.getElementById('memReportDate').innerText = `기준일: ${new Date().toLocaleDateString()}`;
        
        let html = '';
        let list = [...window.members];
        if (!window.memFilters.statuses.has('all')) list = list.filter(m => window.memFilters.statuses.has(m.status));
        if (window.memFilters.onlyRole) list = list.filter(m => m.role && m.role.trim() !== "");
        
         list.sort((a,b) => {
            let vA, vB; const k = window.sortState.key;
            if (window.memFilters.onlyRole && k === 'name') { vA = getRoleRank(a.role); vB = getRoleRank(b.role); if (vA !== vB) return vA - vB; }
            if(k === 'name') return window.sortState.order==='asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
            if(k === 'dues') { vA=getMemberSums(a.name).dues; vB=getMemberSums(b.name).dues; }
            if(k === 'unpaid') { vA=getUnpaidInfo(a).amount; vB=getUnpaidInfo(b).amount; }
            if(k === 'don') { vA=getMemberSums(a.name).donation; vB=getMemberSums(b.name).donation; }
            if(k === 'lastPaid') { vA=getLastPaidIndex(a); vB=getLastPaidIndex(b); }
            return window.sortState.order==='asc' ? vA-vB : vB-vA;
        });

        let sumDues = 0, sumUnpaid = 0, sumDon = 0;
        list.forEach((m, i) => {
            const sums = getMemberSums(m.name); const unpaidInfo = getUnpaidInfo(m); const lpIdx = getLastPaidIndex(m);
            sumDues += sums.dues; sumUnpaid += unpaidInfo.amount; sumDon += sums.donation;
            html += `<tr><td>${i+1}</td><td style="font-weight:bold;">${m.name}</td><td>${m.role || '-'}</td><td>${m.status}</td><td class="money" style="color:blue;">${formatStandard(sums.dues)}</td><td class="money" style="color:red;">${formatStandard(unpaidInfo.amount)}</td><td class="money" style="color:green;">${formatStandard(sums.donation)}</td><td>${lpIdx === -1 ? '-' : (lpIdx+1) + '월'}</td></tr>`;
        });
        html += `<tr style="background:#e3f2fd; font-weight:800; border-top:2px solid #666;"><td colspan="4" style="text-align:center;">전체 합계 (${list.length}명)</td><td class="money" style="color:blue;">${formatStandard(sumDues)}</td><td class="money" style="color:red;">${formatStandard(sumUnpaid)}</td><td class="money" style="color:green;">${formatStandard(sumDon)}</td><td></td></tr>`;
        
        area.innerHTML = html;
        const table = area.closest('table'); if(table) table.id = 'memReportTable';
        document.getElementById('memberReportPage').style.display = 'block';
    }

    // [3] 회원명부 뷰어 닫기
    window.closeMemberReport = () => {
        document.getElementById('memberReportPage').style.display = 'none';
        const metaViewport = document.querySelector('meta[name="viewport"]');
        if (metaViewport) metaViewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes, viewport-fit=cover');
    }

    window.toggleAllMemCheck = (source) => { document.querySelectorAll('.mem-chk').forEach(chk => chk.checked = source.checked); checkBulkBtnVisibility(); }
    window.checkBulkBtnVisibility = () => {
        const checked = document.querySelectorAll('.mem-chk:checked').length;
        const btn = document.getElementById('btnBulkSMS');
        if(checked > 0) { btn.style.display = 'block'; btn.innerText = `📩 선택 문자발송 (${checked}명)`; } else btn.style.display = 'none';
    }
    window.sendBulkSMS = () => {
        const checked = document.querySelectorAll('.mem-chk:checked');
        if(checked.length === 0) return;
        let phones = []; checked.forEach(chk => { const p = chk.value.replace(/-/g, '').trim(); if(p) phones.push(p); });
        location.href = `sms:${phones.join(',')}`;
    }

    window.getMemberSums = (name) => { 
        let dues=0, donation=0; 
        window.trans.forEach(t=>{ if(t.type==='income' && t.desc.includes(name)) { if(t.cat==='월회비' || t.cat==='가입비') dues+=t.amt; if(t.cat==='찬조금') donation+=t.amt; } }); 
        return { dues, donation }; 
    }
    
    window.getUnpaidInfo = (m) => {
        if(EXCLUDED_STATUSES.includes(m.status)) return { amount:0, months:[] };
        if(m.role === '총무') return { amount:0, months:[] };
        let startCheckMonth = 0; 
        const joinTrans = window.trans.find(t => t.cat === '가입비' && t.desc.includes(m.name));
        if(joinTrans) startCheckMonth = parseInt(joinTrans.date.split('-')[1]); 
        let count=0, months=[];
        const currentMonthIdx = new Date().getMonth(); 
        for(let i=startCheckMonth; i < currentMonthIdx; i++) { 
            if(!m.paid[i]) { count++; months.push((i+1)+'월'); } 
        }
        let monthlyFee = currentFees[m.status] || 0;
        return { amount: count * monthlyFee, months };
    }

    window.openFeeSettings = () => {
        if(!window.isAdmin) return;
        document.getElementById('feeSettingsModal').style.display = 'flex';
        document.getElementById('fee_reg').value = currentFees['남성'];
        document.getElementById('fee_fem').value = currentFees['여성'];
        document.getElementById('fee_cpl_m').value = currentFees['부부(남)'];
        document.getElementById('fee_cpl_f').value = currentFees['부부(여)'];
    }

    window.saveFeeSettings = () => {
        if(!window.isAdmin) return;
        const newFees = { ...currentFees };
        newFees['남성'] = parseInt(document.getElementById('fee_reg').value);
        newFees['여성'] = parseInt(document.getElementById('fee_fem').value);
        newFees['부부(남)'] = parseInt(document.getElementById('fee_cpl_m').value);
        newFees['부부(여)'] = parseInt(document.getElementById('fee_cpl_f').value);
        if(!window.settings) window.settings = {}; window.settings.fees = newFees; currentFees = newFees;
        saveToFirebase(); document.getElementById('feeSettingsModal').style.display='none'; renderMembers();
    }

    // [4] 일정(달력) 로직
    window.toggleCalView = () => { window.calViewMode = window.calViewMode==='month'?'year':'month'; renderCalendar(); }
    window.renderCalendar = () => {
        const yView = document.getElementById('yearView'); const mView = document.getElementById('monthView'); const year = window.curCalDate.getFullYear();
        if(window.calViewMode === 'year') {
            yView.style.display='block'; mView.style.display='none';
            document.getElementById('yearTitle').innerText = year+'년';
            const yGrid = document.getElementById('yearGrid'); yGrid.innerHTML='';
            for(let m=0; m<12; m++) {
                const mini = document.createElement('div'); mini.className='mini-month';
                mini.onclick = () => { window.curCalDate.setMonth(m); window.calViewMode='month'; renderCalendar(); };
                let html = `<div class="mini-title">${m+1}월</div><div class="mini-grid">`;
                const last = new Date(year, m+1, 0).getDate(); const start = new Date(year, m, 1).getDay();
                for(let k=0; k<start; k++) html+='<div></div>';
                for(let d=1; d<=last; d++) {
                    const full = `${year}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const hasEv = window.events.some(e=>e.date===full); const day = new Date(year, m, d).getDay(); const isHol = isHoliday(full);
                    let cls = ''; if(isHol || day === 0) cls = 'sun holiday'; else if(day === 6) cls = 'sat'; 
                    if(hasEv) cls += ' has-event'; 
                    html += `<div class="mini-cell ${cls}">${d}</div>`;
                }
                html+='</div>'; mini.innerHTML=html; yGrid.appendChild(mini);
            }
        } else {
            yView.style.display='none'; mView.style.display='block';
            const month = window.curCalDate.getMonth();
            document.getElementById('calTitle').innerText = `${year}년 ${month+1}월`;
            const mGrid = document.getElementById('monthGrid'); mGrid.innerHTML='';
            ['일','월','화','수','목','금','토'].forEach(d=>mGrid.innerHTML+=`<div style="font-size:0.7rem; color:#888;">${d}</div>`);
            const last = new Date(year, month+1, 0).getDate(); const start = new Date(year, month, 1).getDay();
            for(let i=0; i<start; i++) mGrid.appendChild(document.createElement('div'));
            for(let d=1; d<=last; d++) {
                const div = document.createElement('div'); div.className='date-cell';
                const full = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const day = new Date(year, month, d).getDay(); const isHol = isHoliday(full);
                if(isHol || day === 0) div.classList.add('sun', 'holiday'); else if(day === 6) div.classList.add('sat');
                const today = new Date(); if(today.getFullYear()===year && today.getMonth()===month && today.getDate()===d) div.classList.add('today');
                const dayEvents = window.events.filter(e => e.date === full); let dot = ''; if(dayEvents.length > 0) dot = `<div class="event-dot"></div>`;
                div.innerHTML = `<span style="font-size:0.8rem;">${d}</span>${dot}`; div.onclick = () => openEventModal(full); mGrid.appendChild(div);
            }
        }
        renderAllEventsList();
    }
    
    window.changeMonth = (d) => { window.curCalDate.setMonth(window.curCalDate.getMonth()+d); renderCalendar(); }
    window.openEventModal = (date) => { document.getElementById('eventModal').style.display='flex'; document.getElementById('eventDateDisplay').innerText = date; document.getElementById('eventDateVal').value = date; document.getElementById('eventInput').value = ''; renderDayEvents(date); }
    window.addEvent = () => {
        if(!window.isAdmin) return;
        const date = document.getElementById('eventDateVal').value; const title = document.getElementById('eventInput').value;
        if(!title) return; window.events.push({ id:Date.now(), date, title }); saveToFirebase(); document.getElementById('eventInput').value=''; renderDayEvents(date); renderCalendar(); 
    }
    window.deleteEvent = (id) => { if(!window.isAdmin) return; if(confirm('삭제?')) { window.events = window.events.filter(e => e.id !== id); saveToFirebase(); const date = document.getElementById('eventDateVal').value; renderDayEvents(date); renderCalendar(); } }
    window.renderDayEvents = (date) => {
        const list = document.getElementById('dayEventList'); list.innerHTML = '';
        const evs = window.events.filter(e => e.date === date);
        if(evs.length === 0) list.innerHTML = '<div style="color:#aaa; font-size:0.8rem;">일정이 없습니다.</div>';
        evs.forEach(e => {
            const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.padding='5px 0';
            const delBtn = window.isAdmin ? `<button onclick="deleteEvent(${e.id})" style="border:none; background:none; color:red;">&times;</button>` : '';
            d.innerHTML = `<span>${e.title}</span>${delBtn}`; list.appendChild(d);
        });
    }
    
    window.renderAllEventsList = () => {
        const c = document.getElementById('allEventsContainer'); c.innerHTML = '';
        const sorted = window.events.sort((a,b) => new Date(a.date) - new Date(b.date));
        if (sorted.length === 0) { c.innerHTML = '<div style="text-align:center; padding:30px; color:#aaa; font-size:0.85rem;">등록된 일정이 없습니다.</div>'; return; }
        sorted.forEach(e => {
            const d = document.createElement('div'); d.style.padding = '12px 10px'; d.style.borderBottom = '1px solid #f1f2f6'; d.style.fontSize = '0.9rem'; d.style.display = 'flex'; d.style.justifyContent = 'space-between'; d.style.alignItems = 'center'; d.style.background = 'white'; d.style.cursor='pointer';
            const dateObj = new Date(e.date); const dayNames = ['일', '월', '화', '수', '목', '금', '토']; const dayName = dayNames[dateObj.getDay()];
            let dateColor = 'var(--primary)'; if(dateObj.getDay() === 0) dateColor = 'var(--holiday-text)'; else if(dateObj.getDay() === 6) dateColor = 'var(--sat-text)';
            d.innerHTML = `<div style="flex:1;"><div style="display:flex; align-items:center;"><span style="font-weight:800; color:${dateColor}; margin-right:10px; font-size:0.85rem; width:85px;">${e.date} (${dayName})</span> <span style="font-weight:600; color:#333;">${e.title}</span></div></div>`;
            d.onclick = () => openEventModal(e.date); 
            c.appendChild(d);
        });
    }

    // [5] 결산/감사 보고서
    function initReportYears() {
        const ySel = document.getElementById('reportYear'); ySel.innerHTML = '';
        const currentYear = new Date().getFullYear();
        for(let y=currentYear; y>=2023; y--) { ySel.innerHTML += `<option value="${y}">${y}년</option>`; }
    }

// Google Charts 라이브러리 로드 (메모리 미리 적재)
    google.charts.load("current", {packages:["corechart"]});

    window.updateReport = () => {
        // [설정] 핀치 줌 허용
        const metaViewport = document.querySelector('meta[name="viewport"]');
        if (metaViewport) metaViewport.setAttribute('content', 'width=1024, user-scalable=yes'); 

        const year = document.getElementById('reportYear').value;
        const targetMonth = document.getElementById('reportMonth').value; 
        const targetCat = document.getElementById('reportCatFilter').value;
        
        const paper = document.getElementById('settlementReportPaper');
        paper.innerHTML = '';

        // --- 1. 데이터 집계 ---
        let filtered = window.trans.filter(t => t.date.startsWith(year));
        let summary = {}; 
        
        // 차트용 데이터 배열 (Google Charts 형식: ['항목', '금액'])
        let chartDataInc = [['항목', '금액']];
        let chartDataExp = [['항목', '금액']];
        
        // 데이터 집계용 임시 객체
        let tempIncObj = {};
        let tempExpObj = {};

        let totalInc = 0;
        let totalExp = 0;

        filtered.forEach(t => {
            const m = t.date.substring(5, 7);
            
            // 필터링
            if (targetMonth !== 'all' && m !== targetMonth) return;
            if (targetCat !== 'all' && t.cat !== targetCat) return;

            // [월별] 집계
            if (!summary[m]) summary[m] = {};
            if (!summary[m][t.cat]) summary[m][t.cat] = 0;
            summary[m][t.cat] += t.amt;

            // [전체] 집계 (차트용)
            if (t.type === 'income') {
                totalInc += t.amt;
                if (!tempIncObj[t.cat]) tempIncObj[t.cat] = 0;
                tempIncObj[t.cat] += t.amt;
            } else {
                totalExp += t.amt;
                if (!tempExpObj[t.cat]) tempExpObj[t.cat] = 0;
                tempExpObj[t.cat] += t.amt;
            }
        });

        // 차트 데이터 변환 (Object -> Array)
        for (const [key, val] of Object.entries(tempIncObj)) chartDataInc.push([key, val]);
        for (const [key, val] of Object.entries(tempExpObj)) chartDataExp.push([key, val]);

        // --- 2. [전체 통계] 3D 차트 영역 HTML ---
        let chartSectionHtml = '';
        if (targetCat === 'all' && (totalInc > 0 || totalExp > 0)) {
            chartSectionHtml = `
            <div class="audit-section" style="page-break-inside: avoid; margin-bottom: 30px;">
                <div class="audit-h3">📊 ${year}년 전체 통계 (3D 분석)</div>
                <div style="display:flex; justify-content:space-around; flex-wrap:wrap; gap:10px;">
                    <div style="width:48%; min-width:300px; text-align:center;">
                        <h4 style="color:#0984e3; margin-bottom:5px;">수입 구성</h4>
                        <div id="piechart_income" style="width: 100%; height: 300px;"></div>
                    </div>
                    <div style="width:48%; min-width:300px; text-align:center;">
                        <h4 style="color:#d63031; margin-bottom:5px;">지출 구성</h4>
                        <div id="piechart_expense" style="width: 100%; height: 300px;"></div>
                    </div>
                </div>
            </div>`;
        }

        // --- 3. [월별] 테이블 HTML 생성 ---
        let monthlyTablesHtml = '';
        const sortedMonths = Object.keys(summary).sort();

        if (sortedMonths.length === 0) {
            monthlyTablesHtml = '<div style="text-align:center; padding:50px;">내역이 없습니다.</div>';
        } else {
            sortedMonths.forEach(m => {
                const cats = summary[m];
                
                const incomeKeys = Object.keys(cats).filter(c => CATS.income.includes(c)).sort();
                const expenseKeys = Object.keys(cats).filter(c => CATS.expense.includes(c)).sort();

                let mTotalInc = 0; incomeKeys.forEach(k => mTotalInc += cats[k]);
                let mTotalExp = 0; expenseKeys.forEach(k => mTotalExp += cats[k]);
                // 월별 순수익(잔액) 계산
                let mBalance = mTotalInc - mTotalExp;

                let rows = '';

                // (1) 수입 렌더링 (제목 옆에 합계 표시)
                if (incomeKeys.length > 0) {
                    rows += `<tr style="background:#f0f8ff; border-bottom:1px solid #cce4ff;">
                        <td style="font-weight:bold; color:#0984e3; padding:10px 10px;">🔵 수입 내역</td>
                        <td style="font-weight:bold; color:#0984e3; text-align:right; font-size:1rem;">+${formatStandard(mTotalInc)}</td>
                        <td></td>
                    </tr>`;
                    
                    incomeKeys.forEach(cat => {
                        const amt = cats[cat];
                        const percent = mTotalInc > 0 ? ((amt / mTotalInc) * 100).toFixed(1) : 0;
                        
                        // 그래프 스타일
                        const barStyle = `width:${percent}%; height:100%; background: linear-gradient(180deg, #74b9ff 0%, #0984e3 50%, #00cec9 100%); box-shadow: 2px 2px 5px rgba(0,0,0,0.2); border-radius: 4px;`;
                        
                        rows += `<tr>
                            <td style="padding-left:20px;">${cat}</td>
                            <td class="money" style="color:blue; text-align:right;">${formatStandard(amt)}</td>
                            <td style="width:30%; padding:6px 10px; vertical-align:middle;">
                                <div style="display:flex; align-items:center; font-size:0.75rem; color:#0984e3; height:12px;">
                                    <div style="flex:1; background:#dfe6e9; height:100%; border-radius:4px; margin-right:8px; overflow:visible; box-shadow:inset 1px 1px 3px rgba(0,0,0,0.1);">
                                        <div style="${barStyle}"></div>
                                    </div>
                                    <span style="font-weight:bold;">${percent}%</span>
                                </div>
                            </td>
                        </tr>`;
                    });
                }

                // (2) 지출 렌더링 (제목 옆에 합계 표시)
                if (expenseKeys.length > 0) {
                    const borderStyle = incomeKeys.length > 0 ? "border-top:1px solid #eee;" : "";
                    rows += `<tr style="background:#fff5f5; border-bottom:1px solid #ffccd2; ${borderStyle}">
                        <td style="font-weight:bold; color:#d63031; padding:10px 10px;">🔴 지출 내역</td>
                        <td style="font-weight:bold; color:#d63031; text-align:right; font-size:1rem;">-${formatStandard(mTotalExp)}</td>
                        <td></td>
                    </tr>`;

                    expenseKeys.forEach(cat => {
                        const amt = cats[cat];
                        const percent = mTotalExp > 0 ? ((amt / mTotalExp) * 100).toFixed(1) : 0;
                        
                        // 그래프 스타일
                        const barStyle = `width:${percent}%; height:100%; background: linear-gradient(180deg, #ff7675 0%, #d63031 50%, #e17055 100%); box-shadow: 2px 2px 5px rgba(0,0,0,0.2); border-radius: 4px;`;
                        
                        rows += `<tr>
                            <td style="padding-left:20px;">${cat}</td>
                            <td class="money" style="color:red; text-align:right;">${formatStandard(amt)}</td>
                            <td style="width:30%; padding:6px 10px; vertical-align:middle;">
                                <div style="display:flex; align-items:center; font-size:0.75rem; color:#d63031; height:12px;">
                                    <div style="flex:1; background:#dfe6e9; height:100%; border-radius:4px; margin-right:8px; overflow:visible; box-shadow:inset 1px 1px 3px rgba(0,0,0,0.1);">
                                        <div style="${barStyle}"></div>
                                    </div>
                                    <span style="font-weight:bold;">${percent}%</span>
                                </div>
                            </td>
                        </tr>`;
                    });
                }

                // 월별 테이블 조립 (Footer에는 최종 잔액만 표시)
                monthlyTablesHtml += `
                <div class="audit-section" style="break-inside: avoid; margin-bottom: 30px;">
                    <div class="audit-h3" style="border-left: 5px solid #2d3436; background:#f1f2f6; padding:8px 10px;">
                        ${m}월 상세 현황
                    </div>
                    <table class="audit-table">
                        <thead>
                            <tr style="background:#fff;">
                                <th style="width:35%; border-bottom:2px solid #333;">항목</th>
                                <th style="width:35%; border-bottom:2px solid #333;">금액</th>
                                <th style="width:30%; border-bottom:2px solid #333;">비중(%)</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                        <tfoot>
                            <tr style="background:#e3f2fd; border-top:2px solid #aaa;">
                                <td style="text-align:center; font-weight:800; color:#2d3436; padding:10px 0;">${m}월 최종 잔액</td>
                                <td style="text-align:right; font-weight:800; color:${mBalance >= 0 ? 'blue' : 'red'}; padding:10px 0; font-size:1.1rem;">
                                    ${formatStandard(mBalance)}
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>`;
            });
        }
        // --- 4. 최종 HTML 삽입 ---
        paper.innerHTML = `
            <div class="a4-header">
                <div class="a4-title" style="font-size:1.8rem;">${year}년도 결산 통계 보고서</div>
                <div class="a4-subtitle">출력일: ${new Date().toLocaleDateString()}</div>
            </div>
            
            <div class="audit-section" style="border-bottom: 2px dashed #ccc; padding-bottom: 20px; margin-bottom: 20px;">
                <table class="audit-table" style="table-layout: fixed; width: 100%;">
                    <colgroup>
                        <col style="width: 33%">
                        <col style="width: 33%">
                        <col style="width: 34%">
                    </colgroup>
                    <thead>
                        <tr style="background:#f1f2f6;">
                            <th style="padding:12px; font-size:1rem; border:1px solid #ddd;">총 수입</th>
                            <th style="padding:12px; font-size:1rem; border:1px solid #ddd;">총 지출</th>
                            <th style="padding:12px; font-size:1rem; border:1px solid #ddd;">총 잔액</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="color:blue; font-size:1.4rem; font-weight:800; text-align:center; padding:20px 0; border:1px solid #ddd;">
                                ${formatStandard(totalInc)}
                            </td>
                            <td style="color:red; font-size:1.4rem; font-weight:800; text-align:center; padding:20px 0; border:1px solid #ddd;">
                                ${formatStandard(totalExp)}
                            </td>
                            <td style="color:#2d3436; font-size:1.4rem; font-weight:900; text-align:center; padding:20px 0; border:1px solid #ddd; background-color:#fdfdfd;">
                                ${formatStandard(totalInc - totalExp)}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            ${chartSectionHtml}
            ${monthlyTablesHtml}
        `;

        // 뷰어 열기
        document.getElementById('settlementReportPage').style.display = 'block';

        // --- 5. Google Charts 그리기 (3D 옵션 적용) ---
        if (targetCat === 'all' && (totalInc > 0 || totalExp > 0)) {
            google.charts.setOnLoadCallback(draw3DCharts);

            function draw3DCharts() {
                // 수입 차트
                if(chartDataInc.length > 1) {
                    var dataInc = google.visualization.arrayToDataTable(chartDataInc);
                    var optionsInc = {
                        is3D: true, // [핵심] 3D 효과 켜기
                        fontSize: 12,
                        legend: { position: 'labeled' }, // 항목 이름을 차트 옆에 선으로 연결하여 표시
                        chartArea: { width: '90%', height: '80%' },
                        slices: { 0: {offset: 0.1}, 1: {offset: 0.05} }, // 1, 2등 항목 살짝 떼어내기 (강조)
                        colors: ['#0984e3', '#00b894', '#6c5ce7', '#74b9ff', '#81ecec']
                    };
                    var chartInc = new google.visualization.PieChart(document.getElementById('piechart_income'));
                    chartInc.draw(dataInc, optionsInc);
                }

                // 지출 차트
                if(chartDataExp.length > 1) {
                    var dataExp = google.visualization.arrayToDataTable(chartDataExp);
                    var optionsExp = {
                        is3D: true, // [핵심] 3D 효과 켜기
                        fontSize: 12,
                        legend: { position: 'labeled' }, // 항목 이름을 차트 옆에 선으로 연결하여 표시
                        chartArea: { width: '90%', height: '80%' },
                        slices: { 0: {offset: 0.1}, 1: {offset: 0.05} }, // 1, 2등 항목 살짝 떼어내기
                        colors: ['#d63031', '#e17055', '#fab1a0', '#fd79a8', '#636e72']
                    };
                    var chartExp = new google.visualization.PieChart(document.getElementById('piechart_expense'));
                    chartExp.draw(dataExp, optionsExp);
                }
            }
        }
    }
 // [신규] 결산보고서 뷰어 닫기
    window.closeSettlementReport = () => {
        document.getElementById('settlementReportPage').style.display = 'none';
        const metaViewport = document.querySelector('meta[name="viewport"]');
        if (metaViewport) metaViewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes, viewport-fit=cover');
    }

    window.openAuditReport = () => {
        const metaViewport = document.querySelector('meta[name="viewport"]');
        if (metaViewport) metaViewport.setAttribute('content', 'width=1024, user-scalable=yes'); 
        const year = document.getElementById('reportYear').value;
        const now = new Date();
        document.getElementById('auditTitle').innerText = `${year}년도 감사 보고서`;
        document.getElementById('auditDateLine').innerText = `${now.getFullYear()}년 ${now.getMonth()+1}월 ${now.getDate()}일`;

        const filtered = window.trans.filter(t => t.date.startsWith(year));
        let totalInc = 0, totalExp = 0;
        let monthly = {}, catsInc = {}, catsExp = {};
        for(let i=1; i<=12; i++) monthly[String(i).padStart(2,'0')] = { inc:0, exp:0 };

        filtered.forEach(t => {
            if(t.type === 'income') {
                totalInc += t.amt; const m = t.date.substring(5,7);
                if(monthly[m]) monthly[m].inc += t.amt; if(!catsInc[t.cat]) catsInc[t.cat] = 0; catsInc[t.cat] += t.amt;
            } else {
                totalExp += t.amt; const m = t.date.substring(5,7);
                if(monthly[m]) monthly[m].exp += t.amt; if(!catsExp[t.cat]) catsExp[t.cat] = 0; catsExp[t.cat] += t.amt;
            }
        });

        document.getElementById('auditTotalInc').innerText = formatStandard(totalInc);
        document.getElementById('auditTotalExp').innerText = formatStandard(totalExp);
        document.getElementById('auditTotalBal').innerText = formatStandard(totalInc - totalExp);

        let mHtml = ''; let acc = 0;
        Object.keys(monthly).sort().forEach(m => {
            const d = monthly[m]; acc += (d.inc - d.exp);
            if(d.inc > 0 || d.exp > 0) mHtml += `<tr><td>${m}월</td><td class="money" style="color:blue;">${formatStandard(d.inc)}</td><td class="money" style="color:red;">${formatStandard(d.exp)}</td><td class="money" style="font-weight:bold;">${formatStandard(acc)}</td></tr>`;
        });
        document.getElementById('auditMonthlyBody').innerHTML = mHtml || '<tr><td colspan="4">내역 없음</td></tr>';

        const incKeys = Object.keys(catsInc); const expKeys = Object.keys(catsExp);
        const maxRows = Math.max(incKeys.length, expKeys.length);
        let mergedHtml = '';
        if (maxRows === 0) mergedHtml = '<tr><td colspan="4">내역 없음</td></tr>';
        else {
            for(let i=0; i<maxRows; i++) {
                const iKey = incKeys[i] || ''; const iVal = iKey ? formatStandard(catsInc[iKey]) : '';
                const eKey = expKeys[i] || ''; const eVal = eKey ? formatStandard(catsExp[eKey]) : '';
                mergedHtml += `<tr><td style="background:#f9f9f9;">${iKey}</td><td class="money" style="color:blue; border-right: 2px solid #ccc;">${iVal}</td><td style="background:#f9f9f9;">${eKey}</td><td class="money" style="color:red;">${eVal}</td></tr>`;
            }
            mergedHtml += `<tr style="background:#e3f2fd; font-weight:bold; border-top:2px solid #aaa;"><td style="text-align:center;">수입 합계</td><td class="money" style="color:blue; border-right: 2px solid #ccc;">${formatStandard(totalInc)}</td><td style="text-align:center;">지출 합계</td><td class="money" style="color:red;">${formatStandard(totalExp)}</td></tr>`;
        }
        document.getElementById('auditCatMergedBody').innerHTML = mergedHtml;

        const audit = window.auditState || { checked: false, name: "", sig: null };
        document.getElementById('auditCheckReceipt').checked = audit.checked;
        document.getElementById('auditNameInput').value = audit.name;
        const ctx = document.getElementById('sigCanvas').getContext('2d');
        ctx.clearRect(0, 0, 250, 120); 
        if(audit.sig) { const img = new Image(); img.onload = () => ctx.drawImage(img, 0, 0); img.src = audit.sig; }

        window.isAuditMode = false; disableAuditInputs();
        document.getElementById('auditReportPage').style.display = 'block';
    }

    window.closeAuditReport = () => { 
        document.getElementById('auditReportPage').style.display = 'none'; 
        const metaViewport = document.querySelector('meta[name="viewport"]');
        if (metaViewport) metaViewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes, viewport-fit=cover');
    }

    window.unlockAuditMode = () => {
        const pwd = prompt('감사(관리자) 비밀번호를 입력하세요:');
        const currentPw = (window.settings && window.settings.adminPwd) ? window.settings.adminPwd : '1234';
        if(pwd === currentPw) { alert("인증되었습니다."); window.isAuditMode = true; enableAuditInputs(); } 
        else if (pwd !== null) alert("비밀번호가 틀렸습니다.");
    }

    function enableAuditInputs() {
        document.getElementById('auditCheckReceipt').disabled = false;
        document.getElementById('auditNameInput').disabled = false;
        document.getElementById('sigCanvas').classList.remove('locked');
        document.getElementById('auditControlsArea').style.display = 'block';
        document.getElementById('btnUnlockAudit').style.display = 'none';
    }

    function disableAuditInputs() {
        document.getElementById('auditCheckReceipt').disabled = true;
        document.getElementById('auditNameInput').disabled = true;
        document.getElementById('sigCanvas').classList.add('locked');
        document.getElementById('auditControlsArea').style.display = 'none';
        document.getElementById('btnUnlockAudit').style.display = 'block';
    }

    let canvas, ctx, isDrawing = false;
    function initSignaturePad() {
        canvas = document.getElementById('sigCanvas'); ctx = canvas.getContext('2d');
        ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';
        canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mouseup', endDraw);
        canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseout', endDraw);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e.touches[0]); }, {passive: false});
        canvas.addEventListener('touchend', (e) => { e.preventDefault(); endDraw(); }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); }, {passive: false});
    }
    function startDraw(e) { if(!window.isAuditMode) return; isDrawing = true; const rect = canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top); }
    function draw(e) { if (!isDrawing) return; const rect = canvas.getBoundingClientRect(); ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top); ctx.stroke(); }
    function endDraw() { isDrawing = false; ctx.beginPath(); }

    window.clearSignature = () => { if(!window.isAuditMode) return; ctx.clearRect(0, 0, canvas.width, canvas.height); }
    window.saveAuditData = () => {
        if(!window.isAuditMode) return;
        const checked = document.getElementById('auditCheckReceipt').checked;
        const name = document.getElementById('auditNameInput').value;
        const sig = canvas.toDataURL(); 
        if(!checked) return alert("영수증 확인 항목에 체크해주세요.");
        if(!name) return alert("감사 이름을 입력해주세요.");
        window.auditState = { checked, name, sig, date: new Date().toISOString() };
        saveToFirebase(); alert("승인 완료."); disableAuditInputs(); window.isAuditMode = false;
    }
    window.setUnpaidSort = (type) => {
        window.unpaidSort = type;
        document.getElementById('btnSortUnpaidName').classList.toggle('active', type==='name');
        document.getElementById('btnSortUnpaidAmt').classList.toggle('active', type==='amount');
        renderUnpaid();
    }

    window.renderUnpaid = () => {
        const list = document.getElementById('unpaidList'); list.innerHTML = '';
        const totalDisplay = document.getElementById('totalUnpaidDisplay');
        let target = window.members.filter(m => !EXCLUDED_STATUSES.includes(m.status));
        let data = target.map(m => { return { member: m, info: getUnpaidInfo(m) }; }).filter(i => i.info.amount > 0);
        
        data.sort((a,b) => {
            if(window.unpaidSort === 'amount') return b.info.amount - a.info.amount;
            if(window.unpaidSort === 'name') return a.member.name.localeCompare(b.member.name);
        });

        let total = data.reduce((s, i) => s + i.info.amount, 0);
        totalDisplay.innerHTML = `<div style="background:#e74c3c; color:white; padding:12px; border-radius:12px; text-align:center; box-shadow:0 4px 10px rgba(231, 76, 60, 0.3);">💰 총 미납액: <b>${formatStandard(total)}</b></div>`;
        data.forEach(item => {
            const m = item.member; const div = document.createElement('div'); div.className = 'unpaid-card';
            div.innerHTML = `<div class="u-info"><div class="u-top"><span class="u-name">${m.name}</span><span class="u-badge" style="background:${BADGE_COLOR[m.status]}">${m.status}</span></div><div class="u-months">${item.info.months.join(', ')} 미납</div></div><div style="text-align:right;"><span class="u-amt">${formatStandard(item.info.amount)}</span><div class="u-sms-btn" onclick="location.href='sms:${m.phone}'">📩</div></div>`;
            list.appendChild(div);
        });
    }

window.uploadReceipt = () => {
        if(!window.isAdmin) return alert('관리자만 가능합니다.');
        
        const f = document.getElementById('rFile').files[0]; 
        const d = document.getElementById('rDesc').value; 
        const dt = document.getElementById('rDateInput').value;

        if(!f) return alert("파일을 선택해주세요.");

        document.getElementById('loadingMsg').innerText = '이미지 최적화 및 업로드 중...';
        document.getElementById('loadingOverlay').style.display = 'flex';

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                // 1. 이미지 리사이징 (최대 너비 800px로 제한)
                const MAX_WIDTH = 800; 
                let width = img.width;
                let height = img.height;

                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }

                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // 2. 이미지 압축 (JPEG 포맷, 품질 0.6)
                // 이렇게 하면 5MB 사진이 약 50~100KB로 줄어들어 모바일에서도 즉시 저장됩니다.
                const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.6);

                // 3. 데이터 저장
                window.receipts.unshift({ id: Date.now(), date: dt, img: compressedDataUrl, desc: d });
                
                saveToFirebase().then(() => {
                    document.getElementById('rDesc').value='';
                    // 파일 입력창 초기화
                    document.getElementById('rFile').value = ''; 
                    renderReceipts();
                    document.getElementById('loadingOverlay').style.display = 'none';
                    alert('✅ 영수증이 안전하게 저장되었습니다!');
                }).catch(err => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    alert('저장 실패(네트워크 오류): ' + err);
                });
            }
            img.src = e.target.result;
        };
        reader.readAsDataURL(f);
    }
    
    window.renderReceipts = () => {
        const g = document.getElementById('receiptList'); g.innerHTML='';
        const monthFilter = document.getElementById('rFilterMonth').value; const searchTxt = document.getElementById('rSearchInput').value;
        let filtered = window.receipts.filter(r => { const m = r.date.split('-')[1]; return (monthFilter==='all' || m===monthFilter) && (r.desc.includes(searchTxt) || r.date.includes(searchTxt)); });
        filtered.forEach(r => {
            const d = document.createElement('div'); d.className='receipt-item';
            d.onclick=()=>{ document.getElementById('bigImg').src=r.img; document.getElementById('imgModal').style.display='flex'; window.curReceiptId=r.id; };
            d.innerHTML=`<div class="r-img-box"><img src="${r.img}" class="r-img"></div><div class="r-info"><div class="r-date">${r.date}</div><div class="r-desc">${r.desc}</div></div>`;
            g.appendChild(d);
        });
    }
    window.deleteReceipt = (id) => { if(confirm('삭제?')) { window.receipts=window.receipts.filter(r=>r.id!==id); saveToFirebase(); renderReceipts(); document.getElementById('imgModal').style.display='none'; }}

    window.captureElement = (id, name) => {
        const el = document.getElementById(id);
        const originOverflow = el.style.overflow; const originHeight = el.style.height; const originMaxHeight = el.style.maxHeight;
        el.style.overflow = 'visible'; el.style.height = 'auto'; el.style.maxHeight = 'none';
        html2canvas(el, { scrollY: -window.scrollY }).then(canvas => {
            const a = document.createElement('a'); a.download = `${name}_${new Date().toLocaleDateString()}.png`; a.href = canvas.toDataURL(); a.click();
            el.style.overflow = originOverflow; el.style.height = originHeight; el.style.maxHeight = originMaxHeight;
        });
    }
    window.exportTableToExcel = (tableId, filename) => { const table = document.getElementById(tableId); const wb = XLSX.utils.table_to_book(table, {sheet: "Sheet1"}); XLSX.writeFile(wb, `${filename}_${new Date().toLocaleDateString()}.xlsx`); }

    // [수정] 자산 표시 로직 (미납 포함 금액 계산)
    window.renderStats = () => { 
        let i=0,e=0,d=0; 
        window.trans.forEach(t=>{if(t.type==='income'){i+=t.amt; if(t.cat==='찬조금')d+=t.amt;}else e+=t.amt;}); 
        
        let currentAsset = i-e;
        document.getElementById('dispInc').innerText=formatStandard(i); 
        document.getElementById('dispExp').innerText=formatStandard(e); 
        document.getElementById('dispTotal').innerText=formatStandard(currentAsset); 
        document.getElementById('dispDon').innerText=formatStandard(d); 
        
        // 미납 포함 자산 계산
        let totalUnpaid = 0;
        window.members.forEach(m => { totalUnpaid += getUnpaidInfo(m).amount; });
        document.getElementById('dispTotalWithUnpaid').innerText = `(미납포함: ${formatStandard(currentAsset + totalUnpaid)})`;
    }
    
    window.goTab = (id, el) => { 
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); 
        document.getElementById('page-'+id).classList.add('active'); 
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); 
        if(el) el.classList.add('active'); 
        else {
            if(id === 'ledger') document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            if(id === 'members') document.querySelector('.nav-item:nth-child(2)').classList.add('active');
        }
        updateAdminUI(); 
        if(id==='members') renderMembers(); 
        if(id==='analysis') renderUnpaid(); 
        if(id==='receipts') renderReceipts(); 
        if(id==='calendar') renderCalendar(); 
        if(id==='report') {
            // 리포트 탭으로 갈 때는 기존 뷰어를 닫고 초기화
            closeSettlementReport(); 
            closeAuditReport();
        }
    }
    window.renderAll = () => { renderLedger(); renderStats(); renderMembers(); renderUnpaid(); renderReceipts(); renderCalendar(); updateAdminUI(); }
    window.exportData = () => { const d={trans:window.trans, members:window.members, receipts:window.receipts, events:window.events, settings:window.settings}; const b=new Blob([JSON.stringify(d)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='backup.json'; a.click(); }
    window.importData = (input) => { const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=function(e){const d=JSON.parse(e.target.result); window.trans=d.trans||[]; window.members=d.members||[]; window.receipts=d.receipts||[]; window.events=d.events||[]; window.settings=d.settings||null; saveToFirebase(); alert('복구 완료'); location.reload();}; r.readAsText(f); }

    
    window.openEditTrans = (id) => { 
        const t = window.trans.find(x => x.id === id); if(!t) return; 
        document.getElementById('transModal').style.display='flex'; 
        if(window.isAdmin) {
            document.getElementById('editTransFormBox').style.display = 'block'; document.getElementById('viewTransOnly').style.display = 'none';
            document.getElementById('editTransId').value = t.id; document.getElementById('editTransDate').value = t.date; document.getElementById('editTransType').value = t.type; updateEditCategories(t.cat); document.getElementById('editTransAmt').value = t.amt; document.getElementById('editTransDesc').value = t.desc; 
        } else {
            document.getElementById('editTransFormBox').style.display = 'none'; document.getElementById('viewTransOnly').style.display = 'block';
        }
    }
    window.updateEditCategories = (sel) => { 
        const type = document.getElementById('editTransType').value; const el = document.getElementById('editTransCat'); el.innerHTML=''; 
        CATS[type].forEach(c => { const op = document.createElement('option'); op.value = c; op.innerText = c; if(c === sel) op.selected = true; el.appendChild(op); }); 
    }
    window.saveTransEdit = () => { 
        const id = Number(document.getElementById('editTransId').value); const t = window.trans.find(x => x.id === id); 
        if(t) { t.date = document.getElementById('editTransDate').value; t.type = document.getElementById('editTransType').value; t.cat = document.getElementById('editTransCat').value; t.amt = parseInt(document.getElementById('editTransAmt').value); t.desc = document.getElementById('editTransDesc').value; saveToFirebase(); renderAll(); closeTransModal(); }
    }
    window.delTransFromModal = () => { if(confirm('삭제하시겠습니까?')){ const id = Number(document.getElementById('editTransId').value); window.trans = window.trans.filter(x => x.id !== id); saveToFirebase(); renderAll(); closeTransModal(); } }
    window.closeTransModal = () => { document.getElementById('transModal').style.display='none'; }
    
    window.openModal = (id) => { 
        document.getElementById('memModal').style.display='flex'; 
        if(window.isAdmin) { document.querySelector('#memModal .admin-flex').style.setProperty('display', 'flex', 'important'); document.getElementById('btnCloseMemView').style.display = 'none'; document.getElementById('btnDelMem').style.setProperty('display', id ? 'block' : 'none', 'important'); }
        else { document.querySelector('#memModal .admin-flex').style.setProperty('display', 'none', 'important'); document.getElementById('btnDelMem').style.setProperty('display', 'none', 'important'); document.getElementById('btnCloseMemView').style.display = 'block'; }
        if(id){ const m=window.members.find(x=>x.id===id); document.getElementById('modalTitle').innerText = m.name + " 정보"; document.getElementById('editId').value=m.id; document.getElementById('editName').value=m.name; document.getElementById('editRole').value=m.role||''; document.getElementById('editPhone').value=m.phone; document.getElementById('editStatus').value=m.status; document.getElementById('editSpouse').value=m.spouse||''; }
        else{ document.getElementById('modalTitle').innerText = "새 회원 추가"; document.getElementById('editId').value=''; document.getElementById('editName').value=''; document.getElementById('editRole').value=''; document.getElementById('editPhone').value=''; document.getElementById('editStatus').value='남성'; document.getElementById('editSpouse').value=''; } 
    }
    window.closeModal = () => document.getElementById('memModal').style.display='none';
    window.saveMember = () => { if(!window.isAdmin) return; const id = document.getElementById('editId').value; const name = document.getElementById('editName').value; const role = document.getElementById('editRole').value; const phone = document.getElementById('editPhone').value; const status = document.getElementById('editStatus').value; const spouse = document.getElementById('editSpouse').value; if(id){const m=window.members.find(x=>x.id==id); m.name=name; m.role=role; m.phone=phone; m.status=status; m.spouse=spouse;}else{window.members.push({id:Date.now(), name, role, phone, status, spouse, paid:Array(12).fill(false)});} saveToFirebase(); closeModal(); }
    window.delMember = () => { if(!window.isAdmin) return; if(confirm('삭제?')){const id=document.getElementById('editId').value; window.members=window.members.filter(x=>x.id!=id); saveToFirebase(); closeModal();} }
 // ==========================================
    // [신규 기능] PC 버전 / 모바일 버전 토글 로직
    // ==========================================
    </script>
</body>
</html>
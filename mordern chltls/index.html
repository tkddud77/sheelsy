<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes, viewport-fit=cover">
    <title>ëª¨ë˜ í…Œë‹ˆìŠ¤ [Online] ğŸ¾</title>
    
     {
  "name": "ëª¨ë˜ í…Œë‹ˆìŠ¤ [Online]",
  "short_name": "ëª¨ë˜í…Œë‹ˆìŠ¤",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#2d3436",
  "icons": [
    {
      "src": "modern.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "modern.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root {
            --primary: #2d3436;
            --primary-grad: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --accent: #00d2d3;
            --accent-grad: linear-gradient(135deg, #1dd1a1 0%, #00d2d3 100%);
            --bg-color: #f4f7f6;
            --card-bg: rgba(255, 255, 255, 0.85);
            --card-border: 1px solid rgba(255, 255, 255, 0.6);
            --shadow-soft: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            --text-main: #2d3436;
            --text-sub: #636e72;
            --income: #0984e3; 
            --expense: #d63031;
            --income-bg: #eff6ff;
            --expense-bg: #fef2f2;
            --holiday-text: #e74c3c;
            --sat-text: #0984e3;
            --holiday-bg: #fff0f1;
            --sat-bg: #f0f8ff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Pretendard Variable', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; 
            background: var(--bg-color); 
            margin: 0; 
            color: var(--text-main); 
            padding-bottom: 90px; 
            -webkit-font-smoothing: antialiased; 
            letter-spacing: -0.02em;
            line-height: 1.5;
        }

        .app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; position: relative; }

        /* Header */
        header {
            background: var(--primary-grad);
            color: white; 
            padding: 25px 20px; 
            border-bottom-left-radius: 30px; 
            border-bottom-right-radius: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: ''; position: absolute; top: -50%; right: -20%; width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(0, 210, 211, 0.2) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%; pointer-events: none;
        }

        .header-top { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 20px; position: relative; z-index: 2;}
        .club-title { font-size: 1.6rem; font-weight: 800; display: flex; align-items: center; gap: 8px; letter-spacing: -0.5px; position: relative; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .ver-tag { font-size: 0.65rem; background: rgba(255,255,255,0.2); backdrop-filter: blur(4px); padding: 4px 10px; border-radius: 20px; color: #74ffff; font-weight: 700; transform: translateY(1px); border: 1px solid rgba(255,255,255,0.1); }
        .signature-ver { font-family: 'Nanum Pen Script', cursive !important; font-size: 1.8rem; color: #ffeaa7 !important; margin-left: 8px; transform: rotate(-8deg) translateY(-3px); display: inline-block; text-shadow: 2px 2px 4px rgba(0,0,0,0.6); font-weight: normal; letter-spacing: 1px; position: relative; z-index: 10; }

        .backup-btns { display: flex; gap: 6px; align-items: center; }
        .btn-backup { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 14px; border-radius: 12px; font-size: 0.75rem; cursor: pointer; height: 34px; display: flex; align-items: center; justify-content: center; white-space: nowrap; backdrop-filter: blur(5px); transition: all 0.2s; }
        .btn-backup:active { transform: scale(0.95); background: rgba(255,255,255,0.25); }
        
        /* ì €ì¥í•˜ê³  ë‚˜ê°€ê¸° ë²„íŠ¼ */
        .btn-save-exit { background: #e74c3c; border: 1px solid #c0392b; color: white; font-weight:bold; padding: 8px 12px; border-radius: 12px; font-size: 0.75rem; cursor: pointer; height: 34px; display: flex; align-items: center; backdrop-filter: blur(5px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); margin-left: 5px; }
        
        .admin-login-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; width: 34px; height: 34px; font-size: 1rem; cursor: pointer; color: #dfe6e9; transition: 0.3s; display: flex; align-items: center; justify-content: center; padding: 0; backdrop-filter: blur(5px); }
        .admin-login-btn.logged-in { color: #f1c40f; background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); box-shadow: 0 0 10px rgba(241, 196, 15, 0.3); } 

        .total-asset-box { text-align: center; margin-bottom: 25px; position: relative; z-index: 2;}
        .balance-label { font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px; font-weight: 300;}
        .balance-amount { font-size: 2.6rem; font-weight: 800; color: #fff; letter-spacing: -1px; text-shadow: 0 4px 10px rgba(0,0,0,0.2); line-height: 1.2; }
        .balance-total-with-unpaid { font-size: 1rem; color: #ffeaa7; font-weight: 600; margin-top: 5px; opacity: 0.9; }

        .stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; position: relative; z-index: 2;}
        .stat-card { background: rgba(255,255,255,0.1); padding: 12px 5px; border-radius: 16px; text-align: center; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stat-label { font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px; display: block; color: #dfe6e9; }
        .stat-val { display: block; font-weight: 700; font-size: 1.05rem; color: #fff; }

        /* Page Layout */
        .page { display: none; padding: 20px; animation: fadeInUp 0.3s ease-out; }
        .page.active { display: block; }
        @keyframes fadeInUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }

        .card { background: var(--card-bg); border-radius: 20px; padding: 20px; box-shadow: var(--shadow-soft); margin-bottom: 18px; border: var(--card-border); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
        .section-title { font-size: 1.25rem; font-weight: 800; color: #2d3436; letter-spacing: -0.5px; }

        input, select { width: 100%; padding: 14px; border: 1px solid #e1e1e1; border-radius: 14px; font-size: 15px; margin-bottom: 10px; background: #fff; outline: none; transition: 0.2s; color: #333; font-family: 'Pretendard Variable', sans-serif; }
        input:focus, select:focus { border-color: #00b894; box-shadow: 0 0 0 3px rgba(0, 184, 148, 0.1); }
        
        .btn-main { width: 100%; background: var(--primary-grad); color: white; border: none; padding: 15px; border-radius: 14px; font-weight: 700; font-size: 1.1rem; margin-top: 5px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 15px rgba(44, 62, 80, 0.2); }
        .btn-main:active { transform: scale(0.98); }
        .btn-main.saved { background: var(--accent-grad); box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3); }
        
        .btn-sub { background: #fff; border: 1px solid #dfe6e9; padding: 8px 14px; border-radius: 12px; font-size: 0.8rem; color: #636e72; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .btn-sub:hover { background: #f8f9fa; transform: translateY(-1px); }
        
        .admin-only { display: none !important; }
        .admin-flex { display: none !important; }

        /* Report Styles */
        .report-filter-bar { display: flex; gap: 8px; flex-wrap: wrap; background: #fff; padding: 15px; border-radius: 16px; margin-bottom: 20px; box-shadow: var(--shadow-soft); border: 1px solid #eee; align-items: center; }
        .report-filter-bar select { margin-bottom: 0; font-size: 0.85rem; padding: 10px; flex: 1; min-width: 100px; }
        .btn-report-search { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        /* Ledger */
        .filter-container { background: var(--card-bg); padding: 18px; border-radius: 20px; margin-bottom: 18px; box-shadow: var(--shadow-soft); border: var(--card-border); backdrop-filter: blur(10px); }
        .filter-label { font-size: 0.75rem; font-weight: 700; margin-bottom: 10px; color: #b2bec3; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
        .chip-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .filter-chip { padding: 8px 14px; border-radius: 30px; font-size: 0.8rem; background: #f1f3f5; color: #636e72; border: 1px solid transparent; cursor: pointer; transition: all 0.2s; font-weight: 600; }
        .filter-chip.active { background: #2d3436; color: white; box-shadow: 0 4px 10px rgba(45, 52, 54, 0.2); transform: translateY(-1px); }
        .filter-chip.group-btn { background: #e3f2fd; color: var(--income); } 

        .ledger-summary-box { background: linear-gradient(to right, #f8f9fa, #fff); border-radius: 16px; padding: 18px; margin-bottom: 18px; border: 1px solid #eee; font-size: 0.95rem; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .summary-row.total { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ced6e0; font-weight: 800; font-size: 1.05rem; }
        
        .trans-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid #f1f2f6; cursor: pointer; }
        .ti-date { font-size: 0.75rem; color: #b2bec3; margin-bottom: 3px; font-weight: 500; }
        .ti-desc { font-weight: 600; color: var(--text-main); font-size: 1rem; }
        .ti-cat { font-size: 0.65rem; background: #dfe6e9; padding: 3px 8px; border-radius: 6px; color: #636e72; margin-left: 6px; vertical-align: middle;}
        .ti-amt { font-weight: 800; font-size: 1.05rem; }

        /* Table */
        .member-table-wrap { overflow-x: auto; background: white; border-radius: 16px; border: 1px solid rgba(0,0,0,0.05); box-shadow: var(--shadow-soft); -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 380px; }
        th { background: #f8f9fa; color: #636e72; padding: 12px 6px; font-size: 0.8rem; text-align: center; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #dfe6e9; white-space: nowrap; cursor: pointer; font-weight: 700; }
        td { padding: 12px 6px; border-bottom: 1px solid #f1f2f6; text-align: center; vertical-align: middle; font-size: 0.85rem; white-space: nowrap; }
        /* [ìˆ˜ì •] ë„ˆë¹„ì™€ ìµœì†Œ ë„ˆë¹„ë¥¼ 160px -> 115pxë¡œ ë³€ê²½í•˜ì—¬ ê³µê°„ ìµœì†Œí™” */
th:first-child, td:first-child { 
    position: sticky; 
    left: 0; 
    background: white; 
    z-index: 20; 
    border-right: 1px solid #f1f2f6; 
    
    /* â–¼ ì—¬ê¸°ë¥¼ 65pxë¡œ ìˆ˜ì •í•˜ì„¸ìš” â–¼ */
    width: 65px;      
    min-width: 65px;  
    
    /* â–¼ ì•ˆìª½ ì—¬ë°±ë„ ìµœì†Œí™” â–¼ */
    padding-left: 2px;
    padding-right: 0px; 
    
    text-align: left; 
    box-shadow: 2px 0 5px rgba(0,0,0,0.02); 
}        
        .m-cell { display: flex; align-items: center; gap: 8px; } 
        .m-idx { font-size: 0.7rem; color: #b2bec3; width: 22px; text-align: right; display: inline-block; flex-shrink: 0; }
        .m-name-box { display: flex; flex-direction: column; justify-content: center; min-width: 0; flex: 1; }
        .m-name { font-weight: 800; font-size: 0.95rem; color: var(--text-main); cursor: pointer; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .m-role { 
            font-size: 0.65rem; color: #fff; font-weight: bold; margin-top: 4px; display: inline-block; 
            background: linear-gradient(135deg, #6c5ce7, #a29bfe); padding: 2px 8px; border-radius: 10px;
            box-shadow: 0 2px 4px rgba(108, 92, 231, 0.3); text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        .m-status { font-size: 0.65rem; padding: 3px 6px; border-radius: 6px; color: white; display: inline-block; white-space: nowrap; margin-left: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .act-btn { width: 26px; height: 26px; border-radius: 50%; background: #f1f2f6; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; text-decoration: none; color: #636e72; border: 1px solid #dfe6e9; flex-shrink: 0; margin-left:6px; transition:0.2s;}
        
        .money-cell { font-size: 0.9rem !important; font-weight: 700 !important; letter-spacing: -0.5px; white-space: nowrap; font-family: 'Pretendard Variable', sans-serif;}
        .last-paid-cell { font-weight: 600; color: #74b9ff; font-size: 0.8rem; white-space: nowrap; }
        .last-paid-cell.done { color: #00b894; font-weight: 800; }

        /* Unpaid & Calendar & Receipts */
        .unpaid-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #f1f2f6; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .u-top { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .u-name { font-weight: 700; font-size: 1rem; color:#2d3436; }
        .u-badge { font-size: 0.65rem; padding: 3px 6px; border-radius: 6px; color: white; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        .u-amt { font-weight: 800; color: var(--expense); font-size: 1rem; background: #fff5f5; padding: 4px 8px; border-radius: 8px; letter-spacing: -0.5px;}
        .u-months { font-size: 0.8rem; color: #b2bec3; }

        .year-view-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .mini-month { background: white; border: 1px solid #eee; border-radius: 12px; padding: 6px; cursor: pointer; transition:0.2s; }
        .mini-title { text-align: center; font-weight: bold; font-size: 0.8rem; margin-bottom: 4px; color: #2d3436; }
        .mini-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .mini-cell { aspect-ratio: 1/1; display: flex; justify-content: center; align-items: center; font-size: 0.45rem; color: #dfe6e9; position:relative;}
        .mini-cell.has-event::after { content:''; width:5px; height:5px; background:red; border-radius:50%; position:absolute; bottom:2px; box-shadow: 0 0 4px rgba(255,0,0,0.5); }
        .mini-cell.sun, .mini-cell.holiday { color: var(--holiday-text); background: var(--holiday-bg); border-radius: 4px; font-weight:bold;}
        .mini-cell.sat { color: var(--sat-text); background: var(--sat-bg); border-radius: 4px; font-weight:bold;}

        .date-cell { height: 65px; background: white; border-radius: 12px; border: 1px solid #f4f4f4; padding: 5px; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition:0.2s; }
        .date-cell.today { border: 2px solid var(--accent); background: #f0fffe; }
        .date-cell.sun, .date-cell.holiday { color: var(--holiday-text) !important; background-color: var(--holiday-bg) !important; }
        .date-cell.sat { color: var(--sat-text) !important; background-color: var(--sat-bg) !important; }
        .event-dot { width: 8px; height: 8px; background: red; border-radius: 50%; margin-top: 5px; box-shadow: 0 0 5px rgba(255,0,0,0.6); }
        
        .receipt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .receipt-item { background: white; border-radius: 16px; overflow: hidden; border: 1px solid #eee; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .r-img-box { width: 100%; height: 130px; background: #f8f9fa; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .r-img { width: 100%; height: 100%; object-fit: cover; }
        .r-info { padding: 10px; font-size: 0.85rem; }

        /* Nav & FAB */
        .nav-bar { position: fixed; bottom: 0; width: 100%; max-width: 600px; left:0; right:0; margin:0 auto; background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); border-top: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-around; padding: 10px 0 calc(10px + env(safe-area-inset-bottom)); z-index: 100; box-shadow: 0 -5px 20px rgba(0,0,0,0.03); }
        .nav-item { text-align: center; color: #b2bec3; flex: 1; font-size: 0.7rem; transition:0.2s; }
        .nav-item.active { color: #2d3436; font-weight: 700; transform: translateY(-2px); }
        .nav-icon { display: block; font-size: 1.5rem; margin-bottom: 4px; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1)); }
        
        .fab { position: fixed; bottom: calc(85px + env(safe-area-inset-bottom)); right: 20px; width: 58px; height: 58px; background: var(--accent-grad); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; box-shadow: 0 8px 20px rgba(0, 210, 211, 0.4); z-index: 90; transition: 0.2s; }
        .fab:active { transform: scale(0.9); }
        
        .bulk-sms-btn { position: fixed; bottom: calc(85px + env(safe-area-inset-bottom)); left: 20px; right: 20px; margin: auto; max-width: 300px; background: #2d3436; color: white; padding: 14px 20px; border-radius: 30px; font-weight: bold; box-shadow: 0 8px 25px rgba(0,0,0,0.25); z-index: 95; display: none; font-size: 0.95rem; border:none; cursor:pointer; text-align: center;}

        /* Modals */
        .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 24px; width: 90%; max-width: 400px; max-height: 85vh; overflow-y: auto; box-shadow: 0 15px 40px rgba(0,0,0,0.2); position: relative; border: 1px solid rgba(255,255,255,0.5); }
        .modal-close-x { position: absolute; top: 18px; right: 18px; background: none; border: none; font-size: 1.6rem; color: #b2bec3; cursor: pointer; z-index: 10; }

        #loadingOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width:45px; height:45px; border:4px solid #f3f3f3; border-top:4px solid var(--accent); border-radius:50%; animation:spin 1s linear infinite; box-shadow: 0 0 10px rgba(0,210,211,0.2); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* A4 Viewer */
        .full-page-viewer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #555; z-index: 3000; display: none; 
            overflow-y: scroll; -webkit-overflow-scrolling: touch;
        }
        
        .a4-paper {
            width: 210mm; min-height: 297mm; background: white; 
            margin: 20px auto; padding: 15mm; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); position: relative; color: #111;
        }
        
        .a4-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
        .a4-title { font-size: 22pt; font-weight: 800; font-family: serif; letter-spacing: 2px; }
        .a4-subtitle { font-size: 12pt; margin-top: 5px; color:#555; }
        
        .audit-section { margin-bottom: 30px; }
        .audit-h3 { font-size: 13pt; font-weight: 800; border-left: 4px solid #333; padding-left: 10px; margin-bottom: 10px; background: #f8f9fa; padding-top:8px; padding-bottom:8px; }
        
        .audit-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 10pt; table-layout: fixed; }
        .audit-table th, .audit-table td { border: 1px solid #444; padding: 8px 5px; text-align: center; white-space: nowrap; }
        .audit-table th { background: #f0f0f0 !important; font-weight: 700; color:#333; }
        .audit-table td.money { text-align: right; font-family: 'Pretendard Variable', sans-serif; padding-right: 10px; font-weight:600;}
        
        .signature-area { margin-top: 40px; text-align: right; padding: 0 10px; }
        .signature-box { display: inline-block; text-align: left; margin-top: 15px; position:relative; vertical-align: bottom; }
        .signature-pad { border: 1px solid #999; background: #fff; width: 250px; height: 120px; display: block; margin-top: 10px; cursor: crosshair; touch-action: none; border-radius: 4px; }
        .signature-pad.locked { background: #f9f9f9; border: 1px dashed #ccc; cursor: default; }
        .check-area input[type=checkbox] { width: 20px; height: 20px; vertical-align: middle; }
        .audit-input-name { border:none; border-bottom:1px solid #333; width:120px; text-align:center; font-size:14pt; background:transparent; outline:none; font-weight:bold;}

        /* [ìˆ˜ì •] ê°ì‚¬/ë¦¬í¬íŠ¸ ë²„íŠ¼ ë° ì¸ì‡„ ìŠ¤íƒ€ì¼ ì •ë¦¬ (í¬ê¸° 2ë°° í™•ëŒ€) */
        .viewer-close-btn { 
            position: fixed; top: 20px; right: 20px; 
            background: #2d3436; color: white; border: none; 
            padding: 18px 36px; /* í¬ê¸° í™•ëŒ€ */
            border-radius: 50px; cursor: pointer; font-weight: bold; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.5); z-index:5001; 
            font-size: 1.5rem; /* í°íŠ¸ í™•ëŒ€ */
        }

        .audit-sign-btn { 
            position: fixed; top: 20px; left: 20px; 
            background: #6c5ce7; color: white; border: none; 
            padding: 18px 36px; /* í¬ê¸° í™•ëŒ€ */
            border-radius: 50px; cursor: pointer; font-weight: bold; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.5); z-index:5001; 
            font-size: 1.5rem; /* í°íŠ¸ í™•ëŒ€ */
        }

        .viewer-print-btn { 
             position: fixed; top: 20px; right: 180px; /* ìœ„ì¹˜ ì¡°ì • */
             background: #636e72; color: white; border: none; 
             padding: 18px 36px; /* í¬ê¸° í™•ëŒ€ */
             border-radius: 50px; cursor: pointer; font-weight: bold; 
             box-shadow: 0 8px 20px rgba(0,0,0,0.5); z-index:5001; 
             font-size: 1.5rem; /* í°íŠ¸ í™•ëŒ€ */
        }
        
    /* â–¼â–¼â–¼ ê¸°ì¡´ .big-action-btn ë¶€í„° ëê¹Œì§€ ì§€ìš°ê³  ì´ê±¸ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” â–¼â–¼â–¼ */
        .big-action-btn {
            pointer-events: auto; 
            background: var(--accent-grad); 
            width: auto; 
            padding: 18px 36px;
            display: inline-block; 
            margin-right: 15px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            border-radius: 50px;
            font-size: 1.5rem !important;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        /* ğŸ“± [ëª¨ë°”ì¼ ì „ìš©] 'íšŒì› ëª…ë¶€' ì œëª©ë§Œ ì•„ì£¼ í¬ê²Œ í‚¤ìš°ê¸° (ë‹¤ë¥¸ê±´ ì•ˆ ê±´ë“œë¦¼) */
        @media screen and (max-width: 768px) {
            /* íšŒì›ëª…ë¶€ í˜ì´ì§€ì˜ ì œëª© ë¶€ë¶„ë§Œ ë ˆì´ì•„ì›ƒ ë³€ê²½ */
            #page-members .section-header {
                display: block !important;       /* í•œ ì¤„ ì •ë ¬ í•´ì œ */
                text-align: center !important;   /* ê°€ìš´ë° ì •ë ¬ */
                margin-bottom: 20px !important;
            }

            /* 'íšŒì› ëª…ë¶€' ê¸€ì ìŠ¤íƒ€ì¼ */
            #page-members .section-title {
                display: block !important;
                width: 100% !important;          /* í•œ ì¤„ ê½‰ ì°¨ê²Œ */
                font-size: 2.0rem !important;    /* ê¸€ì í¬ê¸° 2.5ë°° í™•ëŒ€ */
                margin-bottom: 15px !important;  /* ë²„íŠ¼ë“¤ê³¼ ê°„ê²© ë²Œë¦¬ê¸° */
                text-align: center !important;
            }
            
            #page-members .section-title span {
                font-weight: 900 !important;
            }

            /* ë²„íŠ¼ë“¤ì€ ì œëª© ì•„ë˜ ê°€ìš´ë°ë¡œ ì˜¤ê²Œ */
            #page-members .section-header > div:last-child {
                display: flex !important;
                justify-content: center !important;
                width: 100% !important;
            }
        }

        /* ğŸ–¨ï¸ [ì¸ì‡„ ì „ìš©] ì¸ì‡„ ê¸°ëŠ¥ ì˜¤ë¥˜ ìˆ˜ì • ë° A4 ìµœì í™” */
        @media print {
            @page { size: A4; margin: 10mm; }
            html, body { width: 100%; height: auto; margin: 0; padding: 0; background: white !important; }
            body * { visibility: hidden; } /* ë°°ê²½ ìˆ¨ê¹€ */

            /* í˜„ì¬ ì—´ë¦° ë³´ê³ ì„œë§Œ í‘œì‹œ */
            .full-page-viewer {
                position: absolute !important; top: 0 !important; left: 0 !important;
                width: 100% !important; height: auto !important;
                visibility: visible !important; overflow: visible !important;
                background: white !important; z-index: 9999 !important;
                display: block !important;
            }
            .full-page-viewer * { visibility: visible !important; }

            /* ì¸ì‡„ ì‹œ ë²„íŠ¼ ë“± ìˆ¨ê¹€ */
            .viewer-close-btn, .viewer-print-btn, .audit-sign-btn, .big-action-btn, 
            .btn-main, .signature-pad, .audit-controls { display: none !important; }
            
            /* í‘œ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” (ê¹¨ì§ ë°©ì§€) */
            table { width: 100% !important; border-collapse: collapse !important; }
            tr { page-break-inside: avoid; }
            .a4-paper { box-shadow: none !important; border: none !important; margin: 0 !important; width: 100% !important; }
            
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style> </head>
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="margin-top:15px; font-weight:bold; color:#555; font-size:0.9rem;" id="loadingMsg">ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>
</div>

<div class="app-container">
    <header>
        <div class="header-top">
            <div class="club-title">
                ëª¨ë˜ í…Œë‹ˆìŠ¤ <span class="ver-tag">Online</span>
                <span class="signature-ver">ìƒì˜ver</span>
            </div>
            
            <div class="backup-btns">
    <button class="btn-backup admin-only" onclick="changeAdminPassword()">ğŸ”‘PWë³€ê²½</button>
    <button class="btn-backup admin-only" onclick="exportData()">ğŸ’¾ ë°±ì—…</button>
    <button class="btn-backup admin-only" onclick="document.getElementById('loadFile').click()">ğŸ“‚ ë³µêµ¬</button>
    <button class="btn-save-exit admin-only" onclick="saveAndExit()">ì €ì¥í•˜ê³  ë‚˜ê°€ê¸° ğŸšª</button>
    <button id="btnLogin" class="admin-login-btn" onclick="toggleAdminLogin()">ğŸ”’</button>
    <input type="file" id="loadFile" accept=".json" style="display:none" onchange="importData(this)">
</div>
        </div>
        <div class="total-asset-box">
            <div class="balance-label">í˜„ì¬ ì´ ìì‚°</div>
            <div class="balance-amount" id="dispTotal">0ì›</div>
            <div class="balance-total-with-unpaid" id="dispTotalWithUnpaid"></div>
        </div>
        <div class="stats-row">
            <div class="stat-card"><span class="stat-label">ìˆ˜ì…</span><span class="stat-val" style="color:#74b9ff;" id="dispInc">0ì›</span></div>
            <div class="stat-card"><span class="stat-label">ì§€ì¶œ</span><span class="stat-val" style="color:#ff7675;" id="dispExp">0ì›</span></div>
            <div class="stat-card"><span class="stat-label" style="color:var(--accent);">ì°¬ì¡°ê¸ˆ</span><span class="stat-val" style="color:var(--accent);" id="dispDon">0ì›</span></div>
        </div>
    </header>

    <div id="page-ledger" class="page active">
        <div class="section-header">
            <div class="section-title"><span>ğŸ“ ìˆ˜ì…/ì§€ì¶œ ê´€ë¦¬</span></div>
            <div style="display:flex; gap:5px;">
                <button class="btn-sub" style="background:#fff; color:var(--primary); border:1px solid var(--primary);" onclick="goTab('report')">ğŸ“Š ê²°ì‚°ë° ê°ì‚¬ë³´ê³ </button>
            </div>
        </div>
<div class="card admin-only">
            <div style="display:flex; gap:8px;">
                <input type="date" id="tDate" style="flex:1;">
                <select id="tType" onchange="setCategories()" style="flex:1; font-weight:bold;">
                    <option value="income">ìˆ˜ì… (+)</option>
                    <option value="expense">ì§€ì¶œ (-)</option>
                </select>
            </div>
            <div style="display:flex; gap:8px;">
                <select id="tCat" style="flex:1;"></select>
                <input type="number" id="tAmt" placeholder="ê¸ˆì•¡" style="flex:1; font-weight:bold;">
            </div>
            <input type="text" id="tDesc" placeholder="ë‚´ìš© (ì˜ˆ: í™ê¸¸ë™ 1~6ì›” íšŒë¹„)">
            <button class="btn-main" id="btnAdd" onclick="addTrans()">ì…ë ¥ ì™„ë£Œ</button>
        </div>

        <div class="filter-container">
            <label class="filter-label">ì›” ì„ íƒ</label>
            <div class="chip-group" id="monthChips">
                <button class="filter-chip active" onclick="toggleMonth(this, 'all')">ì „ì²´</button>
            </div>
            <label class="filter-label" style="margin-top:10px;">í•­ëª© ì„ íƒ</label>
            <div class="chip-group" id="catChips">
                <button class="filter-chip active" onclick="toggleCat(this, 'all')">ì „ì²´</button>
                <button class="filter-chip group-btn" onclick="toggleCat(this, 'income_all')">ìˆ˜ì… ì „ì²´</button>
                <button class="filter-chip group-btn" style="color:var(--expense); background:#ffebee; border-color:#ffcdd2;" onclick="toggleCat(this, 'expense_all')">ì§€ì¶œ ì „ì²´</button>
            </div>
        </div>

        <div class="ledger-summary-box" id="ledgerSummary"></div>
        <div class="card" style="padding: 0 15px;"><div id="ledgerList"></div></div>
    </div>

    <div id="page-report" class="page">
        <div class="section-header">
            <div class="section-title"><span>ğŸ“Š ê²°ì‚° ë³´ê³ ì„œ</span></div>
            <button class="btn-sub" onclick="goTab('ledger')">ëŒì•„ê°€ê¸°</button>
        </div>
        
        <div class="report-filter-bar" style="display:flex; gap:5px; margin-bottom:15px; padding:10px;">
            <select id="reportYear" style="flex:1; min-width:80px;"></select>
            <select id="reportMonth" style="flex:1; min-width:80px;">
                <option value="all">ì „ì²´ ì›”</option>
                <option value="01">1ì›”</option><option value="02">2ì›”</option><option value="03">3ì›”</option>
                <option value="04">4ì›”</option><option value="05">5ì›”</option><option value="06">6ì›”</option>
                <option value="07">7ì›”</option><option value="08">8ì›”</option><option value="09">9ì›”</option>
                <option value="10">10ì›”</option><option value="11">11ì›”</option><option value="12">12ì›”</option>
            </select>
            <select id="reportCatFilter" style="flex:1; min-width:100px;">
                <option value="all">ì „ì²´ í•­ëª©</option>
                <optgroup label="ìˆ˜ì…">
                    <option value="ì›”íšŒë¹„">ì›”íšŒë¹„</option><option value="ì°¬ì¡°ê¸ˆ">ì°¬ì¡°ê¸ˆ</option>
                    <option value="ê°€ì…ë¹„">ê°€ì…ë¹„</option><option value="ê¸°íƒ€ìˆ˜ì…">ê¸°íƒ€ìˆ˜ì…</option>
                </optgroup>
                <optgroup label="ì§€ì¶œ">
                    <option value="ì‹ëŒ€">ì‹ëŒ€</option><option value="ê°„ì‹">ê°„ì‹</option>
                    <option value="ë¹„í’ˆ">ë¹„í’ˆ</option><option value="ë³¼êµ¬ì…">ë³¼êµ¬ì…</option>
                    <option value="ì½”íŠ¸ë¹„">ì½”íŠ¸ë¹„</option><option value="ì‹œí•©ë¹„">ì‹œí•©ë¹„</option>
                    <option value="ê¸°íƒ€ì§€ì¶œ">ê¸°íƒ€ì§€ì¶œ</option>
                </optgroup>
            </select>
        </div>

        <div style="display:flex; gap:5px; margin-bottom:20px;">
            <button class="btn-main" onclick="updateReport()" style="flex:1; background:var(--primary-grad); font-size:0.8rem;">
                ğŸ“Š ê²°ì‚°í†µê³„ ë³´ê³ ì„œ ì¡°íšŒ
            </button>
            <button class="btn-main" onclick="openAuditReport()" style="flex:1; background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); font-size:0.8rem;">
                ğŸ“‘ ê°ì‚¬ë³´ê³ ì„œ ì‘ì„± ë° ì¡°íšŒ
            </button>
        </div>

        <div style="text-align:center; padding:20px; color:#999; font-size:0.9rem;">
            â˜ï¸ ìœ„ ì¡°ê±´(ì—°ë„/ì›”) ì„ íƒ í›„ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´<br>A4 ì„œì‹ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ ì¶œë ¥ë©ë‹ˆë‹¤.
        </div>
    </div>

    <div id="settlementReportPage" class="full-page-viewer">
        <button class="viewer-close-btn" onclick="closeSettlementReport()">ë‹«ê¸°</button>
        <button class="viewer-print-btn" onclick="window.print()">ğŸ–¨ ì¸ì‡„</button>
        <div class="a4-paper" id="settlementReportPaper">
            </div>
    </div>

    <div id="auditReportPage" class="full-page-viewer">
        <button class="viewer-close-btn" onclick="closeAuditReport()">ë‹«ê¸°</button>
        <button class="viewer-print-btn" onclick="window.print()">ğŸ–¨ ì¸ì‡„</button>
        <button class="audit-sign-btn" id="btnUnlockAudit" onclick="unlockAuditMode()">ğŸ” ê°ì‚¬ ìŠ¹ì¸ ëª¨ë“œ</button>
        
        <div class="a4-paper">
            <div class="a4-header">
                <div class="a4-title" id="auditTitle">2024ë…„ë„ ê°ì‚¬ ë³´ê³ ì„œ</div>
                <div class="a4-subtitle">ëª¨ë˜ í…Œë‹ˆìŠ¤ í´ëŸ½</div>
            </div>

            <div class="audit-section">
                <div class="audit-h3">1. ì´ê´„ ê²°ì‚°</div>
                <table class="audit-table">
                    <tr><th style="width:30%">êµ¬ë¶„</th><th style="width:40%">ê¸ˆì•¡</th><th>ë¹„ê³ </th></tr>
                    <tr><td>ì´ ìˆ˜ì…</td><td class="money" id="auditTotalInc">0ì›</td><td></td></tr>
                    <tr><td>ì´ ì§€ì¶œ</td><td class="money" id="auditTotalExp">0ì›</td><td></td></tr>
                    <tr style="background:#f0f8ff;"><td><b>ì”ì•¡ (ìµœì¢… ìì‚°)</b></td><td class="money" style="font-weight:bold; color:blue;" id="auditTotalBal">0ì›</td><td>ì´ì›”ê¸ˆ í¬í•¨</td></tr>
                </table>
            </div>

            <div class="audit-section">
                <div class="audit-h3">2. ì›”ë³„ ìˆ˜ì§€ í˜„í™©</div>
                <table class="audit-table">
                    <thead><tr><th style="width:15%">ì›”</th><th style="width:28%">ìˆ˜ì…</th><th style="width:28%">ì§€ì¶œ</th><th>ì”ì•¡</th></tr></thead>
                    <tbody id="auditMonthlyBody"></tbody>
                </table>
            </div>

            <div class="audit-section">
                <div class="audit-h3">3. í•­ëª©ë³„ ê²°ì‚° (ì„¸ë¶€ ë‚´ì—­)</div>
                <table class="audit-table">
                    <thead>
                        <tr style="background:#f0f0f0;">
                            <th colspan="2" style="border-right: 2px solid #ccc; width:50%;">ìˆ˜ì… ë‚´ì—­ (+)</th>
                            <th colspan="2" style="width:50%;">ì§€ì¶œ ë‚´ì—­ (-)</th>
                        </tr>
                        <tr>
                            <th style="width:25%">í•­ëª©</th>
                            <th style="width:25%; border-right: 2px solid #ccc;">ê¸ˆì•¡</th>
                            <th style="width:25%">í•­ëª©</th>
                            <th style="width:25%">ê¸ˆì•¡</th>
                        </tr>
                    </thead>
                    <tbody id="auditCatMergedBody"></tbody>
                </table>
            </div>

            <div class="signature-area">
                <p style="margin-bottom:15px; font-size:12pt;">ìœ„ì™€ ê°™ì´ <b>ëª¨ë˜ í…Œë‹ˆìŠ¤ í´ëŸ½</b>ì˜ íšŒê³„ ê°ì‚¬ë¥¼ ë³´ê³ í•©ë‹ˆë‹¤.</p>
                <div class="check-area">
                    <label>
                        <input type="checkbox" id="auditCheckReceipt" disabled>
                        ìœ„ ê²°ì‚° ë‚´ìš©ê³¼ ì˜ìˆ˜ì¦ ë“± ì¦ë¹™ì„œë¥˜ê°€ ì¼ì¹˜í•¨ì„ í™•ì¸í•˜ì˜€ìŠµë‹ˆë‹¤.
                    </label>
                </div>
                <p id="auditDateLine" style="margin-bottom:20px;">2024ë…„ 00ì›” 00ì¼</p>
                
                <div class="signature-box">
                    <span style="font-size:14pt; font-weight:bold;">ê° ì‚¬ : </span>
                    <input type="text" id="auditNameInput" class="audit-input-name" placeholder="ì´ë¦„" disabled>
                    <span style="font-size:14pt; font-weight:bold;"> (ì¸)</span>
                    
                    <canvas id="sigCanvas" class="signature-pad locked" width="180" height="90"></canvas>
                    
                    <div id="auditControlsArea" class="audit-controls" style="text-align:center; margin-top:5px; display:none;">
                        <button class="btn-sub" style="font-size:0.7rem; color:red;" onclick="clearSignature()">ì§€ìš°ê¸°</button>
                        <button class="btn-sub" style="font-size:0.7rem; background:blue; color:white;" onclick="saveAuditData()">ìŠ¹ì¸ ì €ì¥</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="memberReportPage" class="full-page-viewer">
        <button class="viewer-close-btn" onclick="closeMemberReport()">ë‹«ê¸°</button>
        <button class="viewer-print-btn" onclick="window.print()">ğŸ–¨ ì¸ì‡„</button>
        
        <div class="a4-paper" id="memReportCapture">
            <div class="a4-header">
                <div class="a4-title">ëª¨ë˜ í…Œë‹ˆìŠ¤ íšŒì› ëª…ë¶€</div>
                <div class="a4-subtitle" id="memReportDate"></div>
            </div>
             <div class="audit-section">
                <table class="audit-table" style="font-size: 9pt;">
                    <thead> 
                        <tr> 
                            <th style="width:5%">No</th>
                            <th style="width:15%">ì´ë¦„</th>
                            <th style="width:10%">ì§ì±…</th>
                            <th style="width:10%">êµ¬ë¶„</th> 
                            <th style="width:15%; color:var(--income)">ë‚©ë¶€ì•¡</th>
                            <th style="width:15%; color:red">ë¯¸ë‚©ì•¡</th> 
                            <th style="width:15%; color:var(--accent)">ì°¬ì¡°ê¸ˆ</th>
                            <th style="width:10%">ìµœì¢…</th> 
                        </tr> 
                    </thead>
                    <tbody id="memReportBodyNew"></tbody>
                </table>
            </div>
        </div>
        
        <div style="position:fixed; bottom:20px; left:0; right:0; text-align:center; pointer-events:none; z-index:9999;">
            <button class="big-action-btn" onclick="captureElement('memReportCapture', 'íšŒì›ëª…ë¶€')">ğŸ“¸ ì´ë¯¸ì§€ ì €ì¥</button>
            <button class="big-action-btn" onclick="exportTableToExcel('memReportTable', 'íšŒì›ëª…ë¶€')" style="background:#27ae60;">ğŸ“Š ì—‘ì…€ ì €ì¥</button>
        </div>
    </div>

    <div id="page-members" class="page">
        <div class="section-header">
            <div class="section-title"><span>ğŸ‘¥ íšŒì› ëª…ë¶€</span></div>
            <div style="display:flex; gap:5px;">
                <button class="btn-sub admin-only" style="background:#6c5ce7; color:white; border:none;" onclick="openFeeSettings()">âš™ï¸íšŒë¹„ì„¤ì •</button>
                <button class="btn-sub admin-only" style="background:var(--primary); color:white; border:none;" onclick="openModal()">+ ì¶”ê°€</button>
                <button class="btn-sub" style="background:var(--accent); color:white; border:none;" onclick="openMemberReport()">ğŸ’¾ ë‹¤ë¥¸ í˜•ì‹ì˜ íŒŒì¼ë¡œ ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
       <div style="margin-bottom:10px;">
    <div class="chip-group" id="roleFilterChips" style="margin-bottom:8px;">
        <span style="font-size:0.8rem; font-weight:bold; margin-right:5px; align-self:center;">ì§ì±…:</span>
        <button class="filter-chip" onclick="toggleRoleGroup(this, 'executive')">í˜„ ì§‘í–‰ë¶€</button>
        <button class="filter-chip" onclick="toggleRoleGroup(this, 'advisor')">ê³ ë¬¸/ì „ë…„íšŒì¥</button>
        <button class="filter-chip" onclick="toggleRoleGroup(this, 'auditor')">ê°ì‚¬</button>
    </div>
    
    <div class="chip-group" id="statusChips" style="flex-wrap:nowrap; overflow-x:auto; padding-bottom:5px;">
        </div>
</div>
        <input type="text" id="searchMem" placeholder="ì´ë¦„ ê²€ìƒ‰..." onkeyup="renderMembers()">
        <div class="member-table-wrap" id="memTableArea">
            <table id="memTable">
                <thead>
                    <tr>
                        <th onclick="toggleMemSort('name')"><input type="checkbox" onchange="toggleAllMemCheck(this)" style="width:auto; margin:0 4px 0 0; vertical-align: middle;">SMS <span id="sort_name"></span></th>
                        <th style="color:var(--income);" onclick="toggleMemSort('dues')">ë‚©ë¶€ <span id="sort_dues"></span></th>
                        <th style="color:red;" onclick="toggleMemSort('unpaid')">ë¯¸ë‚© <span id="sort_unpaid"></span></th>
                        <th style="color:var(--accent);" onclick="toggleMemSort('don')">ì°¬ì¡° <span id="sort_don"></span></th>
                        <th onclick="toggleMemSort('lastPaid')">ìµœì¢…ë‚©ë¶€ <span id="sort_lastPaid"></span></th>
                    </tr>
                </thead>
               <tbody id="memBody"></tbody>
    <tfoot id="memFoot" style="background:#e3f2fd; font-weight:800; border-top:2px solid #aaa;"></tfoot>
</table>
        </div>
    </div>

    <div id="page-analysis" class="page">
        <div class="section-header">
            <div class="section-title"><span>ğŸ“Š ë¯¸ë‚© ê´€ë¦¬</span></div>
        </div>
        <div class="chip-group" style="margin-bottom:15px;">
            <button id="btnSortUnpaidName" class="filter-chip active" onclick="setUnpaidSort('name')">ì´ë¦„ìˆœ</button>
            <button id="btnSortUnpaidAmt" class="filter-chip" onclick="setUnpaidSort('amount')">ê¸ˆì•¡ìˆœ</button>
        </div>
        <div id="totalUnpaidDisplay" style="margin-bottom:15px;"></div>
        <div class="card" style="background:transparent; border:none; box-shadow:none; padding:0;">
            <div id="unpaidList"></div>
        </div>
    </div>
    
    <div id="page-receipts" class="page">
        <div class="section-title" style="margin-bottom:15px;"><span>ğŸ§¾ ì˜ìˆ˜ì¦ ê´€ë¦¬</span></div>
        <div class="card admin-only">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <label style="font-size:0.8rem; color:#666;">(ì§‘í–‰ì¼ì)</label>
                <input type="date" id="rDateInput" style="width:65%;">
            </div>
            <input type="file" id="rFile" accept="image/*" style="margin-bottom:10px;">
            <input type="text" id="rDesc" placeholder="ì„¤ëª… ì…ë ¥">
            <button class="btn-main" onclick="uploadReceipt()">ì‚¬ì§„ ì €ì¥</button>
        </div>
        
        <div class="filter-box" style="display:flex; gap:10px; margin-bottom:15px;">
            <select id="rFilterMonth" onchange="renderReceipts()" style="flex:1;">
                <option value="all">ì „ì²´ ì›”</option>
                <option value="01">1ì›”</option><option value="02">2ì›”</option><option value="03">3ì›”</option>
                <option value="04">4ì›”</option><option value="05">5ì›”</option><option value="06">6ì›”</option>
                <option value="07">7ì›”</option><option value="08">8ì›”</option><option value="09">9ì›”</option>
                <option value="10">10ì›”</option><option value="11">11ì›”</option><option value="12">12ì›”</option>
            </select>
            <input type="text" id="rSearchInput" placeholder="ë‚´ìš© ê²€ìƒ‰" style="flex:1; margin-bottom:0;" onkeyup="renderReceipts()">
        </div>
        <div id="receiptList" class="receipt-grid"></div>
    </div>

    <div id="page-calendar" class="page">
        <div class="section-header">
            <div class="section-title"><span>ğŸ“… í–‰ì‚¬ ì¼ì •</span></div>
            <button class="btn-sub" onclick="toggleCalView()">ì—°ê°„/ì›”ê°„ ì „í™˜</button>
        </div>
        <div id="yearView" style="display:none;">
            <div style="text-align:center; font-weight:bold; font-size:1.1rem; margin-bottom:10px; color:var(--primary);"><span id="yearTitle"></span></div>
            <div id="yearGrid" class="year-view-grid"></div>
        </div>
        <div id="monthView" class="card">
             <div class="section-header" style="margin-bottom:10px;">
                <button class="btn-sub" onclick="changeMonth(-1)">â—€</button>
                <span id="calTitle" style="font-weight:bold; font-size:1.1rem;"></span>
                <button class="btn-sub" onclick="changeMonth(1)">â–¶</button>
            </div>
            <div id="monthGrid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:5px; text-align:center;"></div>
        </div>
<div class="card" style="margin-top:10px;">
            <h4 style="margin:0 0 10px 0; font-size:0.9rem;">ğŸ“ ì „ì²´ ì¼ì • ëª©ë¡ (í´ë¦­í•˜ì—¬ ìˆ˜ì •)</h4>
            
            <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <select id="eventListYear" onchange="renderAllEventsList()" style="width:100px; margin-bottom:0; padding:5px; font-size:0.85rem;">
                </select>
                <div style="text-align:right;">
                    <label style="font-size:0.85rem; cursor:pointer; margin-right:12px;">
                        <input type="checkbox" id="showPastEventsToggle" onchange="renderAllEventsList()" style="width:auto; vertical-align:middle;"> âª ì§€ë‚œ ë‹¬ ë³´ê¸°
                    </label>
                    <label style="font-size:0.85rem; cursor:pointer;">
                        <input type="checkbox" id="showBirthdayToggle" checked onchange="renderAllEventsList()" style="width:auto; vertical-align:middle;"> ğŸ‚ ìƒì¼ í‘œì‹œ
                    </label>
                </div>
            </div>

            <div id="allEventsContainer"></div> </div>
        </div>
    <div class="nav-bar">
        <div class="nav-item active" onclick="goTab('ledger', this)"><span class="nav-icon">ğŸ“’</span>ì¥ë¶€</div>
        <div class="nav-item" onclick="goTab('members', this)"><span class="nav-icon">ğŸ‘¥</span>ëª…ë¶€</div>
        <div class="nav-item" onclick="goTab('analysis', this)"><span class="nav-icon">ğŸ“Š</span>ë¯¸ë‚©</div>
        <div class="nav-item" onclick="goTab('receipts', this)"><span class="nav-icon">ğŸ§¾</span>ì˜ìˆ˜ì¦</div>
        <div class="nav-item" onclick="goTab('calendar', this)"><span class="nav-icon">ğŸ“…</span>ì¼ì •</div>
    </div>
    
    <div class="fab admin-only" onclick="goTab('ledger', document.querySelector('.nav-item')); document.getElementById('tAmt').focus()">+</div>
    <button id="btnBulkSMS" class="bulk-sms-btn" onclick="sendBulkSMS()">ğŸ“© ì„ íƒ ë¬¸ìë°œì†¡</button>

    <div class="modal-wrap" id="eventModal">
        <div class="modal">
            <h3>ì¼ì • ê´€ë¦¬</h3>
            <div id="eventDateDisplay" style="margin-bottom:10px; color:var(--primary); font-weight:bold;"></div>
            <input type="hidden" id="eventDateVal">
            <div class="admin-only" style="display:block;">
                <input type="text" id="eventInput" placeholder="ì¼ì • ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
                <button class="btn-main" onclick="addEvent()">ì¶”ê°€</button>
            </div>
            <div id="dayEventList" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;"></div>
            <button onclick="document.getElementById('eventModal').style.display='none'" style="width:100%; margin-top:10px; border:none; background:none; text-decoration:underline;">ë‹«ê¸°</button>
        </div>
    </div>
    <div class="modal-wrap" id="transModal">
        <div class="modal">
            <h3>ë‚´ì—­ ìˆ˜ì •</h3>
            <div id="editTransFormBox" style="display:none;">
                <input type="hidden" id="editTransId">
                <input type="date" id="editTransDate">
                <select id="editTransType" onchange="updateEditCategories()"><option value="income">ìˆ˜ì…</option><option value="expense">ì§€ì¶œ</option></select>
                <select id="editTransCat"></select>
                <input type="number" id="editTransAmt">
                <input type="text" id="editTransDesc">
                <div style="display:flex; gap:10px;">
                    <button class="btn-main" onclick="saveTransEdit()">ìˆ˜ì •</button>
                    <button class="btn-main" style="background:#eee; color:#333;" onclick="closeTransModal()">ì·¨ì†Œ</button>
                </div>
                <button onclick="delTransFromModal()" style="width:100%; margin-top:10px; border:none; background:none; color:red; text-decoration:underline;">ì‚­ì œí•˜ê¸°</button>
            </div>
            <div id="viewTransOnly" style="display:none;">
                <p>ê´€ë¦¬ìë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <button class="btn-main" onclick="closeTransModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    <div class="modal-wrap" id="memModal">
        <div class="modal">
            <button class="modal-close-x" onclick="closeModal()">Ã—</button>
            <h3 id="modalTitle">íšŒì› ì •ë³´</h3>
            <input type="hidden" id="editId">
            <input type="text" id="editName" placeholder="ì´ë¦„">
            <select id="editRole" style="margin-bottom:10px;">
    <option value="">ì§ì±… ì—†ìŒ (ì¼ë°˜ íšŒì›)</option>

    <optgroup label="=== í˜„ ì§‘í–‰ë¶€ ===">
        <option value="íšŒì¥">íšŒì¥</option>
        <option value="ë¶€íšŒì¥">ë¶€íšŒì¥</option>
        <option value="ì´ë¬´">ì´ë¬´</option>
        <option value="ê²½ê¸°ì´ì‚¬">ê²½ê¸°ì´ì‚¬</option>
        <option value="ì‹œì„¤ì´ì‚¬">ì‹œì„¤ì´ì‚¬</option>
        <option value="ì—¬ì„±ì´ì‚¬">ì—¬ì„±ì´ì‚¬</option>
        <option value="í™ë³´ì´ì‚¬">í™ë³´ì´ì‚¬</option>
    </optgroup>

    <optgroup label="=== ê³ ë¬¸ ë° ì „ë…„íšŒì¥ ===">
        <option value="ê³ ë¬¸">ê³ ë¬¸</option>
        <option value="ì „ë…„íšŒì¥">ì „ë…„íšŒì¥</option>
    </optgroup>

    <optgroup label="=== ê°ì‚¬ ===">
        <option value="ê°ì‚¬">ê°ì‚¬</option>
    </optgroup>
</select>
            <input type="text" id="editPhone" placeholder="ì—°ë½ì²˜ (ì˜ˆ: 010-1234-5678)">
            <label style="font-size:0.75rem; color:#888;">íšŒë¹„êµ¬ë¶„(ìƒíƒœ)</label>
            <select id="editStatus">
                <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                <option value="ì—¬ì„±">ì—¬ì„±</option>
                <option value="ë¶€ë¶€(ë‚¨)">ë¶€ë¶€(ë‚¨)</option>
                <option value="ë¶€ë¶€(ì—¬)">ë¶€ë¶€(ì—¬)</option>
                <option value="íœ´íšŒ">íœ´íšŒ</option>
                <option value="íƒˆíšŒ">íƒˆíšŒ</option>
            </select>
            <input type="text" id="editSpouse" placeholder="ë°°ìš°ì ì´ë¦„">
<label style="font-size:0.75rem; color:#888;">ìƒì¼ (ì—°ë„-ì›”-ì¼)</label>
<input type="date" id="editBirthday" style="margin-bottom:10px;">
            <div id="adminMemBtns" class="admin-flex" style="gap:10px;">
                <button class="btn-main" onclick="saveMember()">ì €ì¥</button>
                <button class="btn-main" style="background:#eee; color:#333;" onclick="closeModal()">ì·¨ì†Œ(ë‹«ê¸°)</button>
            </div>
            <button id="btnDelMem" class="admin-only" onclick="delMember()" style="width:100%; margin-top:10px; border:none; background:none; color:red; text-decoration:underline;">ì‚­ì œ</button>
            <button class="btn-main" id="btnCloseMemView" onclick="closeModal()" style="display:none; background:#eee; color:#333;">ë‹«ê¸°</button>
        </div>
    </div>
    <div class="modal-wrap" id="feeSettingsModal">
        <div class="modal">
            <h3>âš™ï¸ ì›” íšŒë¹„ ì„¤ì •</h3>
            <div style="margin-bottom:10px;"><label style="font-size:0.8rem;">ë‚¨ì„±</label><input type="number" id="fee_reg"></div>
            <div style="margin-bottom:10px;"><label style="font-size:0.8rem;">ì—¬ì„±</label><input type="number" id="fee_fem"></div>
            <div style="margin-bottom:10px;"><label style="font-size:0.8rem;">ë¶€ë¶€(ë‚¨)</label><input type="number" id="fee_cpl_m"></div>
            <div style="margin-bottom:10px;"><label style="font-size:0.8rem;">ë¶€ë¶€(ì—¬)</label><input type="number" id="fee_cpl_f"></div>
            <div style="margin-bottom:10px;"><label style="font-size:0.8rem;">íœ´íšŒ / íƒˆíšŒ (ê³ ì • 0ì›)</label><input type="number" value="0" disabled style="background:#eee;"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-main" onclick="saveFeeSettings()">ì €ì¥</button>
                <button class="btn-main" style="background:#eee; color:#333;" onclick="document.getElementById('feeSettingsModal').style.display='none'">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    <div class="modal-wrap" id="imgModal">
        <div class="modal" style="background:transparent; box-shadow:none; text-align:center;">
            <img id="bigImg" src="" style="max-width:100%; max-height:80vh; border-radius:10px;">
            <br>
            <button class="admin-only" onclick="deleteReceipt(window.curReceiptId)" style="margin-top:10px; background:white; padding:10px; border-radius:10px; color:red; font-weight:bold; border:none;">ì´ ì˜ìˆ˜ì¦ ì‚­ì œ</button>
            <button onclick="document.getElementById('imgModal').style.display='none'" style="margin-top:10px; background:white; padding:10px; border-radius:10px; border:none;">ë‹«ê¸°</button>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBDdJpn7gkb_8mnHaQpp3olHuE_Un_Aj7A",
      authDomain: "lsytennis.firebaseapp.com",
      databaseURL: "https://lsytennis-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "lsytennis",
      storageBucket: "lsytennis.firebasestorage.app",
      messagingSenderId: "1020734955594",
      appId: "1:1020734955594:web:e458c058cad48f313ec6b3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.trans = []; window.members = []; window.receipts = []; window.events = []; window.settings = null;
    window.auditState = { checked: false, name: "", sig: null }; 

    window.sortState = { key: 'name', order: 'asc' };
    window.memFilters = { statuses: new Set(['all']), onlyRole: false };
   // [ì¶”ê°€] ì§ì±… ê·¸ë£¹ ì •ì˜ ë° ì„ íƒ ìƒíƒœ ë³€ìˆ˜
const ROLE_GROUPS_DEF = {
    'executive': ['íšŒì¥', 'ë¶€íšŒì¥', 'ì´ë¬´', 'ë¶€ì´ë¬´', 'ê²½ê¸°ì´ì‚¬', 'ë¶€ê²½ê¸°ì´ì‚¬', 'ì‹œì„¤ì´ì‚¬', 'ì—¬ì„±ì´ì‚¬', 'í™ë³´ì´ì‚¬'],
    'advisor': ['ê³ ë¬¸', 'ì „ë…„íšŒì¥', 'ì „íšŒì¥'],
    'auditor': ['ê°ì‚¬']
};
    window.selectedRoleGroups = new Set(); 
    window.unpaidSort = 'name'; 
    window.calViewMode = 'month';
    window.curCalDate = new Date();
    window.selectedMonths = new Set(['all']); 
    window.selectedCats = new Set(['all']);
    window.isAdmin = false; 
    window.isAuditMode = false; 

    const CATS = { 
        income: ['ì›”íšŒë¹„', 'ì°¬ì¡°ê¸ˆ', 'ê°€ì…ë¹„', 'ê¸°íƒ€ìˆ˜ì…'], 
        expense: ['ì‹ëŒ€', 'ê°„ì‹', 'ë¹„í’ˆ', 'ë³¼êµ¬ì…', 'ì½”íŠ¸ë¹„', 'ì‹œí•©ë¹„', 'ê¸°íƒ€ì§€ì¶œ'] 
    };
    
    const ROLE_RANK = [ 'íšŒì¥', 'ë¶€íšŒì¥', '(ë¶€)íšŒì¥', 'ì´ë¬´', 'ë¶€ì´ë¬´', '(ë¶€)ì´ë¬´', 'ê²½ê¸°ì´ì‚¬', 'ë¶€ê²½ê¸°ì´ì‚¬', '(ë¶€)ê²½ê¸°ì´ì‚¬', 'ì‹œì„¤ì´ì‚¬', 'ì—¬ì„±ì´ì‚¬', 'í™ë³´ì´ì‚¬', 'ê³ ë¬¸', 'ì „ë…„íšŒì¥', '(ì „ë…„)íšŒì¥', '(ì „ë…„íšŒì¥)', 'ì „íšŒì¥', '(ì „)íšŒì¥', '(ì „íšŒì¥)', 'ê°ì‚¬' ];
    const STATUS_LIST = ['ì§ì±…', 'ë‚¨ì„±', 'ì—¬ì„±', 'ë¶€ë¶€(ë‚¨)', 'ë¶€ë¶€(ì—¬)', 'íœ´íšŒ', 'íƒˆíšŒ'];
    const BADGE_COLOR = { 'ë‚¨ì„±': '#00b894', 'ì—¬ì„±': '#e84393', 'ë¶€ë¶€(ë‚¨)': '#0984e3', 'ë¶€ë¶€(ì—¬)': '#fd79a8', 'íœ´íšŒ': '#b2bec3', 'íƒˆíšŒ': '#636e72' };
    
    let DEFAULT_FEES = { 'ë‚¨ì„±': 40000, 'ì—¬ì„±': 20000, 'ë¶€ë¶€(ë‚¨)': 50000, 'ë¶€ë¶€(ì—¬)': 20000, 'íœ´íšŒ':0, 'íƒˆíšŒ':0 };
    let currentFees = { ...DEFAULT_FEES };
    const EXCLUDED_STATUSES = ['íœ´íšŒ', 'íƒˆíšŒ'];
    
    const FIXED_HOLIDAYS = ['01-01', '03-01', '05-05', '06-06', '08-15', '10-03', '10-09', '12-25'];
    const SPECIFIC_HOLIDAYS = ['2024-02-09', '2024-02-10', '2024-02-11', '2024-02-12', '2024-04-10', '2024-05-06', '2024-05-15', '2024-09-16', '2024-09-17', '2024-09-18', '2024-10-01', '2025-01-28', '2025-01-29', '2025-01-30', '2025-03-03', '2025-05-05', '2025-05-06', '2025-10-03', '2025-10-05', '2025-10-06', '2025-10-07', '2025-10-08', '2025-10-09', '2026-02-17', '2026-02-18', '2026-02-19', '2026-03-02', '2026-05-24', '2026-05-25', '2026-09-24', '2026-09-25', '2026-09-26', '2026-09-27'];

    function isHoliday(yyyy_mm_dd) {
        const mm_dd = yyyy_mm_dd.substring(5);
        return FIXED_HOLIDAYS.includes(mm_dd) || SPECIFIC_HOLIDAYS.includes(yyyy_mm_dd);
    }

    history.pushState(null, null, location.href);
    window.onpopstate = function () {
        history.pushState(null, null, location.href); 
        alert("âš ï¸ ë’¤ë¡œê°€ê¸°ë¥¼ ëˆ„ë¥´ì‹œë©´ ì•±ì´ ì¢…ë£Œ ë©ë‹ˆë‹¤.");
    };
    window.addEventListener('beforeunload', (event) => {
        event.preventDefault(); event.returnValue = '';
    });

    window.onload = () => {
        const savedAuth = localStorage.getItem('tennisAdminAuth');
        if(savedAuth === 'true') { window.isAdmin = true; updateAdminUI(); }

        document.getElementById('tDate').valueAsDate = new Date();
        document.getElementById('rDateInput').valueAsDate = new Date();
        createFilterChips();
        createMemberStatusChips();
        initReportYears();
        initSignaturePad();

        const clubRef = ref(db, 'clubData');
        onValue(clubRef, (snapshot) => {
            document.getElementById('loadingOverlay').style.display = 'none';
            const data = snapshot.val();
            if (data) {
                window.trans = data.trans || [];
                window.members = data.members || [];
                window.receipts = data.receipts || [];
                window.events = data.events || [];
                window.settings = data.settings || {};
                
                if(data.auditState) window.auditState = data.auditState;
            } else {
                saveToFirebase();
            }
            if(window.settings && window.settings.fees) {
                currentFees = { ...DEFAULT_FEES, ...window.settings.fees };
            }
            setCategories();
            renderAll();
        });
    };

    function saveToFirebase() {
        if(!window.isAdmin && !window.isAuditMode && window.trans.length > 0) return Promise.resolve();
        
        let updateData = {
            trans: window.trans, members: window.members, receipts: window.receipts, events: window.events, settings: window.settings
        };
        if(window.auditState) updateData.auditState = window.auditState;

        return set(ref(db, 'clubData'), updateData);
    }

window.saveAndExit = () => {
        if(!confirm('ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        document.getElementById('loadingMsg').innerText = 'ë°ì´í„° ë™ê¸°í™” ì¤‘...';
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('ì‹œê°„ ì´ˆê³¼ (ì¸í„°ë„· ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”)')), 15000)
        );

        Promise.race([saveToFirebase(), timeoutPromise])
            .then(() => {
                 alert('âœ… ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì•±ì„ ì¢…ë£Œí•˜ê±°ë‚˜ ì°½ì„ ë‹«ìœ¼ì…”ë„ ì¢‹ìŠµë‹ˆë‹¤.');
                 document.body.innerHTML = "<div style='display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column; text-align:center; background:#f4f7f6;'><h1>ğŸ‘‹ ì €ì¥ ì™„ë£Œ</h1><p>ì´ì œ ì•±ì„ ì¢…ë£Œí•˜ì…”ë„ ë©ë‹ˆë‹¤.</p></div>";
                 window.close();
            }).catch(err => {
                 document.getElementById('loadingOverlay').style.display = 'none';
                 if(confirm(`ì €ì¥ì— ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ê±°ë‚˜ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n(${err})\n\nê·¸ë˜ë„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                     document.body.innerHTML = "<div style='display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column; text-align:center;'><h1>ì¢…ë£Œë¨</h1></div>";
                 }
            });
    }

    // --- ê´€ë¦¬ì/ì¸ì¦ ---
    window.toggleAdminLogin = () => {
        if(window.isAdmin) {
            if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.isAdmin = false;
                localStorage.removeItem('tennisAdminAuth');
                updateAdminUI();
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            }
        } else {
            const pwd = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            const currentPw = (window.settings && window.settings.adminPwd) ? window.settings.adminPwd : '1234';
            if(pwd === currentPw) { 
                window.isAdmin = true;
                localStorage.setItem('tennisAdminAuth', 'true');
                updateAdminUI();
                alert('ê´€ë¦¬ì ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
                renderAll(); 
            } else if (pwd !== null) alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        }
    }
    
    window.changeAdminPassword = () => {
        if(!window.isAdmin) return;
        const newPw = prompt("ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if(newPw && newPw.trim() !== "") {
            const confirmPw = prompt("ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì„ ìœ„í•´ í•œ ë²ˆ ë” ì…ë ¥í•˜ì„¸ìš”:");
            if(newPw === confirmPw) {
                if(!window.settings) window.settings = {};
                window.settings.adminPwd = newPw;
                saveToFirebase();
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
    }

    function updateAdminUI() {
        const btn = document.getElementById('btnLogin');
        const adminEls = document.querySelectorAll('.admin-only');
        const adminFlexEls = document.querySelectorAll('.admin-flex');
        
        if(window.isAdmin) {
            btn.classList.add('logged-in'); btn.innerHTML = 'ğŸ”“';
            adminEls.forEach(el => el.style.setProperty('display', 'block', 'important'));
            adminFlexEls.forEach(el => el.style.setProperty('display', 'flex', 'important'));
            document.querySelector('.fab').style.display = 'flex';
            document.querySelectorAll('.btn-backup').forEach(b => b.style.setProperty('display', 'block', 'important'));
            document.querySelector('.btn-save-exit').style.setProperty('display', 'flex', 'important');
        } else {
            btn.classList.remove('logged-in'); btn.innerHTML = 'ğŸ”’';
            adminEls.forEach(el => el.style.setProperty('display', 'none', 'important'));
            adminFlexEls.forEach(el => el.style.setProperty('display', 'none', 'important'));
        }
    }

    function formatShort(amount) {
        if (!amount || amount === 0) return '-';
        if (amount >= 10000) {
            const man = Math.floor(amount / 10000);
            const remainder = amount % 10000;
            return man + 'ë§Œ' + (remainder > 0 ? (remainder/1000).toFixed(0) : ''); 
        }
        return amount.toLocaleString(); 
    }
    
    function formatStandard(amount) {
        return amount ? amount.toLocaleString() + "ì›" : '0ì›';
    }

    // --- ì¥ë¶€ ---
    window.setCategories = () => {
        const type = document.getElementById('tType').value;
        const el = document.getElementById('tCat');
        el.innerHTML = '';
        CATS[type].forEach(c => { const op = document.createElement('option'); op.value=c; op.innerText=c; el.appendChild(op); });
    }

    window.addTrans = () => {
        if(!window.isAdmin) return alert('ê´€ë¦¬ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        const date = document.getElementById('tDate').value;
        const type = document.getElementById('tType').value;
        const cat = document.getElementById('tCat').value;
        const amt = parseInt(document.getElementById('tAmt').value);
        const desc = document.getElementById('tDesc').value.trim();
        if(!date || !amt) return alert('ê¸ˆì•¡ ì…ë ¥í•˜ì„¸ìš”.');

        const transMonth = parseInt(date.split('-')[1]); 
        if(type === 'income' && cat === 'ê°€ì…ë¹„') {
            const mIdx = transMonth - 1;
            if(mIdx >= 0 && mIdx < 12) window.members.forEach(m => { if(desc.includes(m.name)) m.paid[mIdx] = true; });
        }
        if(type === 'income' && cat === 'ì›”íšŒë¹„' && desc) {
            const rangeMatch = desc.match(/(\d+)[~-](\d+)ì›”/);
            if(rangeMatch) {
                const start = parseInt(rangeMatch[1]); const end = parseInt(rangeMatch[2]);
                if(start>=1 && end<=12 && start<=end) window.members.forEach(m => { if(desc.includes(m.name)) for(let i=start-1; i<end; i++) m.paid[i]=true; });
            } else {
                const mMatch = desc.match(/(\d+)ì›”/);
                if(mMatch) {
                    const idx = parseInt(mMatch[1])-1;
                    if(idx>=0 && idx<12) window.members.forEach(m=>{ if(desc.includes(m.name)) m.paid[idx]=true; });
                }
            }
        }
        window.trans.unshift({ id:Date.now(), date, type, cat, amt, desc });
        saveToFirebase();
        const btn = document.getElementById('btnAdd'); btn.innerText = "ì €ì¥ ì™„ë£Œ!"; btn.classList.add('saved');
        setTimeout(() => { btn.innerText = "ì…ë ¥ ì™„ë£Œ"; btn.classList.remove('saved'); }, 1000);
        document.getElementById('tAmt').value=''; document.getElementById('tDesc').value='';
    }

    function createFilterChips() {
        const mCon = document.getElementById('monthChips');
        for(let i=1; i<=12; i++) {
            const btn = document.createElement('button'); btn.className = 'filter-chip'; btn.innerText = i+'ì›”';
            btn.onclick = () => toggleMonth(btn, String(i).padStart(2,'0')); mCon.appendChild(btn);
        }
        const cCon = document.getElementById('catChips');
        [...CATS.income, ...CATS.expense].forEach(c => {
            const btn = document.createElement('button'); btn.className = 'filter-chip'; btn.innerText = c;
            btn.onclick = () => toggleCat(btn, c); cCon.appendChild(btn);
        });
    }

    window.toggleMonth = (btn, val) => {
        if(val==='all') { window.selectedMonths.clear(); window.selectedMonths.add('all'); document.querySelectorAll('#monthChips .filter-chip').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
        else {
            if(window.selectedMonths.has('all')) { window.selectedMonths.delete('all'); document.querySelector('#monthChips .filter-chip').classList.remove('active'); }
            if(window.selectedMonths.has(val)) { window.selectedMonths.delete(val); btn.classList.remove('active'); }
            else { window.selectedMonths.add(val); btn.classList.add('active'); }
            if(window.selectedMonths.size===0) { window.selectedMonths.add('all'); document.querySelector('#monthChips .filter-chip').classList.add('active'); }
        } renderLedger();
    }
    window.toggleCat = (btn, val) => {
        if(val==='all') { window.selectedCats.clear(); window.selectedCats.add('all'); document.querySelectorAll('#catChips .filter-chip').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
        else if(val==='income_all') {
            CATS.income.forEach(c => window.selectedCats.add(c)); window.selectedCats.delete('all');
            document.querySelector('#catChips .filter-chip').classList.remove('active');
            updateCatChipVisuals();
        } else if(val==='expense_all') {
            CATS.expense.forEach(c => window.selectedCats.add(c)); window.selectedCats.delete('all');
            document.querySelector('#catChips .filter-chip').classList.remove('active');
            updateCatChipVisuals();
        } else {
            if(window.selectedCats.has('all')) { window.selectedCats.delete('all'); document.querySelector('#catChips .filter-chip').classList.remove('active'); }
            if(window.selectedCats.has(val)) window.selectedCats.delete(val); else window.selectedCats.add(val);
            if(window.selectedCats.size===0) { window.selectedCats.add('all'); document.querySelector('#catChips .filter-chip').classList.add('active'); }
            updateCatChipVisuals();
        } renderLedger();
    }

    function updateCatChipVisuals() {
        document.querySelectorAll('#catChips .filter-chip').forEach(b => {
            if(b.classList.contains('group-btn') || b.innerText === 'ì „ì²´') return;
            if(window.selectedCats.has(b.innerText)) b.classList.add('active'); else b.classList.remove('active');
        });
    }

    window.renderLedger = () => {
        const list = document.getElementById('ledgerList'); list.innerHTML = '';
        let filtered = window.trans.filter(t => {
            const m = t.date.split('-')[1];
            return (window.selectedMonths.has('all') || window.selectedMonths.has(m)) && (window.selectedCats.has('all') || window.selectedCats.has(t.cat));
        });

        let sumInc=0, sumExp=0; filtered.forEach(t=>{if(t.type==='income')sumInc+=t.amt;else sumExp+=t.amt;});
        document.getElementById('ledgerSummary').innerHTML = `
            <div class="summary-row"><span style="color:var(--income)">ìˆ˜ì…</span><span>${formatStandard(sumInc)}</span></div>
            <div class="summary-row"><span style="color:var(--expense)">ì§€ì¶œ</span><span>${formatStandard(sumExp)}</span></div>
            <div class="summary-row total"><span>í•©ê³„</span><span>${formatStandard(sumInc-sumExp)}</span></div>
        `;

        filtered.forEach(t => {
            const div = document.createElement('div'); div.className='trans-item'; div.onclick=()=>openEditTrans(t.id);
            div.innerHTML=`<div style="flex:1;"><div class="ti-date">${t.date}</div><div class="ti-desc">${t.desc} <span class="ti-cat">${t.cat}</span></div></div><div class="ti-amt" style="color:${t.type==='income'?'var(--income)':'var(--expense)'}">${t.type==='income'?'+':'-'}${formatStandard(t.amt)}</div>`;
            list.appendChild(div);
        });
    }

    // --- íšŒì› ëª…ë¶€ ---
    function syncPaymentsFromLedger() {
        window.members.forEach(m => { m.paid = Array(12).fill(false); });
        window.trans.forEach(t => {
            if (t.type !== 'income') return; 
            if (t.cat === 'ê°€ì…ë¹„') {
                const dateMonth = parseInt(t.date.split('-')[1]); 
                const mIdx = dateMonth - 1;
                if (mIdx >= 0 && mIdx < 12) window.members.forEach(m => { if (t.desc.includes(m.name)) m.paid[mIdx] = true; });
            }
            if (t.cat === 'ì›”íšŒë¹„') {
                const rangeMatch = t.desc.match(/(\d+)[~-](\d+)ì›”/);
                if (rangeMatch) {
                    const start = parseInt(rangeMatch[1]); const end = parseInt(rangeMatch[2]);
                    if (start >= 1 && end <= 12 && start <= end) window.members.forEach(m => { if (t.desc.includes(m.name)) { for (let i = start - 1; i < end; i++) m.paid[i] = true; } });
                } else {
                    const monthMatch = t.desc.match(/(\d+)ì›”/);
                    if (monthMatch) {
                        const idx = parseInt(monthMatch[1]) - 1;
                        if (idx >= 0 && idx < 12) window.members.forEach(m => { if (t.desc.includes(m.name)) m.paid[idx] = true; });
                    }
                }
            }
        });
    }

    function createMemberStatusChips() {
        const con = document.getElementById('statusChips'); con.innerHTML = '';
        ['ì „ì²´', ...STATUS_LIST].forEach(txt => {
            const btn = document.createElement('button'); btn.className = 'filter-chip'; btn.id = 'chip-' + txt; btn.innerText = txt; 
            if(txt === 'ì „ì²´') btn.classList.add('active');
            btn.onclick = () => toggleMemFilter(btn, 'status', txt);
            con.appendChild(btn);
        });
    }
    
    function updateChipCounts() {
        const counts = { 'ì „ì²´': window.members.length, 'ì§ì±…': 0 };
        STATUS_LIST.forEach(s => { if(s!=='ì§ì±…') counts[s] = 0; });
        window.members.forEach(m => { if(m.role && m.role.trim() !== '') counts['ì§ì±…']++; if(counts[m.status] !== undefined) counts[m.status]++; });
        const chips = document.getElementById('statusChips').children;
        for(let btn of chips) { const rawTxt = btn.id.replace('chip-',''); if(counts[rawTxt] !== undefined) btn.innerText = `${rawTxt}(${counts[rawTxt]})`; }
    }

    window.toggleMemFilter = (btn, type, val) => {
        if (type === 'status') {
            if (val === 'ì „ì²´') { window.memFilters.statuses.clear(); window.memFilters.statuses.add('all'); window.memFilters.onlyRole = false; }
            else if (val === 'ì§ì±…') { window.memFilters.onlyRole = !window.memFilters.onlyRole; }
            else {
                if (window.memFilters.statuses.has('all')) window.memFilters.statuses.delete('all');
                if (window.memFilters.statuses.has(val)) window.memFilters.statuses.delete(val); else window.memFilters.statuses.add(val);
                if (window.memFilters.statuses.size === 0 && !window.memFilters.onlyRole) window.memFilters.statuses.add('all');
            }
        }
        updateMemFilterVisuals(); renderMembers(); 
    }

    function updateMemFilterVisuals() {
        const chips = document.getElementById('statusChips').children;
        for (let btn of chips) {
            const rawTxt = btn.id.replace('chip-','');
            let isActive = false;
            if (rawTxt === 'ì „ì²´') isActive = window.memFilters.statuses.has('all');
            else if (rawTxt === 'ì§ì±…') isActive = window.memFilters.onlyRole;
            else isActive = window.memFilters.statuses.has(rawTxt);
            if(isActive) btn.classList.add('active'); else btn.classList.remove('active');
        }
    }
// [ì¶”ê°€] ì§ì±… ê·¸ë£¹ ë²„íŠ¼ í´ë¦­ ì‹œ í† ê¸€ ì²˜ë¦¬ í•¨ìˆ˜
    window.toggleRoleGroup = (btn, groupKey) => {
        if (window.selectedRoleGroups.has(groupKey)) {
            window.selectedRoleGroups.delete(groupKey);
            btn.classList.remove('active');
        } else {
            window.selectedRoleGroups.add(groupKey);
            btn.classList.add('active');
        }
        renderMembers(); // ëª…ë¶€ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    }

    // [ì¶”ê°€] íšŒì›ì˜ ì§ì±…ì´ í•´ë‹¹ ê·¸ë£¹ì— ì†í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
  // [ìˆ˜ì •] ì§ì±… ë§¤ì¹­ í—¬í¼ í•¨ìˆ˜ (ì§‘í–‰ë¶€ ì¡°íšŒ ì‹œ ì „ë…„íšŒì¥/ê³ ë¬¸ ì œì™¸ ë¡œì§ ì¶”ê°€)
function checkRoleMatch(memberRole, groupKey) {
    if (!memberRole) return false;

    // í˜„ ì§‘í–‰ë¶€('executive')ë¥¼ ì°¾ì„ ë•ŒëŠ”, 'advisor'(ê³ ë¬¸/ì „ë…„íšŒì¥) í‚¤ì›Œë“œê°€ í¬í•¨ëœ ê²½ìš° ì œì™¸
    // (ì˜ˆ: 'ì „ë…„íšŒì¥'ì—ëŠ” 'íšŒì¥' ê¸€ìê°€ ë“¤ì–´ê°€ ìˆì–´ ì§‘í–‰ë¶€ë¡œ ì˜¤ì¸ë  ìˆ˜ ìˆìŒ ë°©ì§€)
    if (groupKey === 'executive') {
        const isAdvisor = ROLE_GROUPS_DEF['advisor'].some(k => memberRole.includes(k));
        if (isAdvisor) return false;
    }

    // í•´ë‹¹ ê·¸ë£¹ì˜ í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    return ROLE_GROUPS_DEF[groupKey].some(keyword => memberRole.includes(keyword));
}
    
    window.toggleMemSort = (key) => {
        if(window.sortState.key === key) window.sortState.order = window.sortState.order==='asc'?'desc':'asc';
        else { window.sortState.key = key; window.sortState.order = 'asc'; }
        ['name','dues','unpaid','don','lastPaid'].forEach(k => document.getElementById('sort_'+k).innerText = '');
        document.getElementById('sort_'+key).innerText = window.sortState.order==='asc'?'â–²':'â–¼';
        renderMembers();
    }
    
   function getRoleRank(roleName) {
        if(!roleName) return 999;
        let bestIndex = -1;
        ROLE_RANK.forEach((rankName, index) => { if (roleName.includes(rankName)) { if (index > bestIndex) bestIndex = index; } });
        return bestIndex === -1 ? 999 : bestIndex;
    }

    function getLastPaidIndex(m) { for(let i=11; i>=0; i--) { if(m.paid[i]) return i; } return -1; }

    // [1] íšŒì› ëª…ë¶€ ë Œë”ë§ (í•©ê³„ í¬í•¨)
    // [ìˆ˜ì •ë¨] íšŒì› ëª…ë¶€ ë Œë”ë§ í•¨ìˆ˜
    window.renderMembers = () => {
        syncPaymentsFromLedger(); 
        updateChipCounts(); 
        const tb = document.getElementById('memBody'); tb.innerHTML = '';
        const tf = document.getElementById('memFoot'); tf.innerHTML = '';

        const key = document.getElementById('searchMem').value;
        let list = [...window.members];

        // 1. ì´ë¦„ ê²€ìƒ‰
        if(key) list = list.filter(m => m.name.includes(key));
        
        // 2. ìƒíƒœ(ë‚¨ì„±/ì—¬ì„±/íœ´íšŒ ë“±) í•„í„°
        if (!window.memFilters.statuses.has('all')) list = list.filter(m => window.memFilters.statuses.has(m.status));
        
        // 3. (ê¸°ì¡´) ì§ì±…ë§Œ ë³´ê¸° í•„í„°
        if (window.memFilters.onlyRole) list = list.filter(m => m.role && m.role.trim() !== "");

        // [ì¶”ê°€ë¨] 4. ì§ì±… ê·¸ë£¹(ì§‘í–‰ë¶€/ê³ ë¬¸/ê°ì‚¬) í•„í„°
        if (window.selectedRoleGroups.size > 0) {
            list = list.filter(m => {
                let isMatch = false;
                if (window.selectedRoleGroups.has('executive') && checkRoleMatch(m.role, 'executive')) isMatch = true;
                if (window.selectedRoleGroups.has('advisor') && checkRoleMatch(m.role, 'advisor')) isMatch = true;
                if (window.selectedRoleGroups.has('auditor') && checkRoleMatch(m.role, 'auditor')) isMatch = true;
                return isMatch;
            });
        }
        
        // ì •ë ¬ ë¡œì§
// [ìˆ˜ì •ëœ ì •ë ¬ ë¡œì§]
        list.sort((a,b) => {
            let vA, vB; const k = window.sortState.key;
            
            // 1. "ì§ì±…ë§Œ ë³´ê¸°"ê°€ ì¼œì ¸ ìˆê±°ë‚˜ OR "ì§ì±… ê·¸ë£¹ ë²„íŠ¼(ì§‘í–‰ë¶€ ë“±)"ì´ í•˜ë‚˜ë¼ë„ ëˆŒë ¤ìˆë‹¤ë©´
            //    AND ì •ë ¬ ê¸°ì¤€ì´ 'ì´ë¦„(name)'ì´ë¼ë©´ -> ì´ë¦„ì„ ë¬´ì‹œí•˜ê³  'ì§ì±… ìˆœì„œ'ë¡œ ìš°ì„  ì •ë ¬
            if ((window.memFilters.onlyRole || window.selectedRoleGroups.size > 0) && k === 'name') { 
                vA = getRoleRank(a.role); 
                vB = getRoleRank(b.role); 
                // ì§ì±… ìˆœìœ„ê°€ ë‹¤ë¥´ë©´ ì§ì±… ìˆœì„œëŒ€ë¡œ, ê°™ìœ¼ë©´ ì•„ë˜ ì´ë¦„ ì •ë ¬ë¡œ ë„˜ì–´ê°
                if (vA !== vB) return vA - vB; 
            }

            // 2. ê¸°ì¡´ ì •ë ¬ ë¡œì§ (ì´ë¦„, ë‚©ë¶€ì•¡, ë¯¸ë‚©ì•¡ ë“±)
            if(k === 'name') return window.sortState.order==='asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
            if(k === 'dues') { vA=getMemberSums(a.name).dues; vB=getMemberSums(b.name).dues; }
            if(k === 'unpaid') { vA=getUnpaidInfo(a).amount; vB=getUnpaidInfo(b).amount; }
            if(k === 'don') { vA=getMemberSums(a.name).donation; vB=getMemberSums(b.name).donation; }
            if(k === 'lastPaid') { vA=getLastPaidIndex(a); vB=getLastPaidIndex(b); }
            return window.sortState.order==='asc' ? vA-vB : vB-vA;
        });
        
        let sumDues = 0, sumUnpaid = 0, sumDon = 0;

        list.forEach((m, idx) => {
            const sums = getMemberSums(m.name);
            const unpaidInfo = getUnpaidInfo(m);
            const lpIdx = getLastPaidIndex(m);
            
            sumDues += sums.dues;
            sumUnpaid += unpaidInfo.amount;
            sumDon += sums.donation;

            const tr = document.createElement('tr');
            let lastPaidText = lpIdx !== -1 ? (lpIdx===11 ? "ì™„ë‚©" : (lpIdx+1)+"ì›”") : "-";
            let lpClass = lastPaidText === "ì™„ë‚©" ? "last-paid-cell done" : "last-paid-cell";

           let nameHtml = `
            <div class="m-cell">
                <input type="checkbox" class="mem-chk" value="${m.phone}" style="width:auto; margin-right:2px; vertical-align:middle;" onclick="checkBulkBtnVisibility()">
                <span class="m-idx">${idx + 1}</span>
                <div class="m-name-box"><span class="m-name" onclick="openModal('${m.id}', '${m.name}')">${m.name}</span>${m.role ? `<span class="m-role">${m.role}</span>` : ''}</div>
                <a href="tel:${m.phone}" class="act-btn">ğŸ“</a>
                <span class="m-status" style="background:${BADGE_COLOR[m.status]||'#999'}">${m.status}</span>
            </div>`;
            
            tr.innerHTML = `<td>${nameHtml}</td>
                <td class="money-cell" style="color:var(--income);">${sums.dues > 0 ? formatShort(sums.dues) : '-'}</td>
                <td class="money-cell" style="color:red;">${unpaidInfo.amount > 0 ? formatShort(unpaidInfo.amount) : '-'}</td>
                <td class="money-cell" style="color:var(--accent);">${sums.donation > 0 ? formatShort(sums.donation) : '-'}</td>
                <td><span class="${lpClass}">${lastPaidText}</span></td>`;
            tb.appendChild(tr);
        });

        tf.innerHTML = `<tr>
            <td style="text-align:center; font-size:0.9rem;">ì´ ${list.length}ëª… í•©ê³„</td>
            <td class="money-cell" style="color:blue;">${formatShort(sumDues)}</td>
            <td class="money-cell" style="color:red;">${formatShort(sumUnpaid)}</td>
            <td class="money-cell" style="color:green;">${formatShort(sumDon)}</td>
            <td></td>
        </tr>`;

        checkBulkBtnVisibility();
    }

    // [2] íšŒì›ëª…ë¶€ ì €ì¥ ë·°ì–´ (ì´ë¯¸ì§€/ì—‘ì…€)
    window.openMemberReport = () => {
         const metaViewport = document.querySelector('meta[name="viewport"]');
         if (metaViewport) metaViewport.setAttribute('content', 'width=1024, user-scalable=yes'); 
        const area = document.getElementById('memReportBodyNew');
        document.getElementById('memReportDate').innerText = `ê¸°ì¤€ì¼: ${new Date().toLocaleDateString()}`;
        
        let html = '';
        let list = [...window.members];
        if (!window.memFilters.statuses.has('all')) list = list.filter(m => window.memFilters.statuses.has(m.status));
        if (window.memFilters.onlyRole) list = list.filter(m => m.role && m.role.trim() !== "");
        
         list.sort((a,b) => {
            let vA, vB; const k = window.sortState.key;
            if (window.memFilters.onlyRole && k === 'name') { vA = getRoleRank(a.role); vB = getRoleRank(b.role); if (vA !== vB) return vA - vB; }
            if(k === 'name') return window.sortState.order==='asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
            if(k === 'dues') { vA=getMemberSums(a.name).dues; vB=getMemberSums(b.name).dues; }
            if(k === 'unpaid') { vA=getUnpaidInfo(a).amount; vB=getUnpaidInfo(b).amount; }
            if(k === 'don') { vA=getMemberSums(a.name).donation; vB=getMemberSums(b.name).donation; }
            if(k === 'lastPaid') { vA=getLastPaidIndex(a); vB=getLastPaidIndex(b); }
            return window.sortState.order==='asc' ? vA-vB : vB-vA;
        });

        let sumDues = 0, sumUnpaid = 0, sumDon = 0;
        list.forEach((m, i) => {
            const sums = getMemberSums(m.name); const unpaidInfo = getUnpaidInfo(m); const lpIdx = getLastPaidIndex(m);
            sumDues += sums.dues; sumUnpaid += unpaidInfo.amount; sumDon += sums.donation;
            html += `<tr><td>${i+1}</td><td style="font-weight:bold;">${m.name}</td><td>${m.role || '-'}</td><td>${m.status}</td><td class="money" style="color:blue;">${formatStandard(sums.dues)}</td><td class="money" style="color:red;">${formatStandard(unpaidInfo.amount)}</td><td class="money" style="color:green;">${formatStandard(sums.donation)}</td><td>${lpIdx === -1 ? '-' : (lpIdx+1) + 'ì›”'}</td></tr>`;
        });
        html += `<tr style="background:#e3f2fd; font-weight:800; border-top:2px solid #666;"><td colspan="4" style="text-align:center;">ì „ì²´ í•©ê³„ (${list.length}ëª…)</td><td class="money" style="color:blue;">${formatStandard(sumDues)}</td><td class="money" style="color:red;">${formatStandard(sumUnpaid)}</td><td class="money" style="color:green;">${formatStandard(sumDon)}</td><td></td></tr>`;
        
        area.innerHTML = html;
        const table = area.closest('table'); if(table) table.id = 'memReportTable';
        document.getElementById('memberReportPage').style.display = 'block';
    }

    // [3] íšŒì›ëª…ë¶€ ë·°ì–´ ë‹«ê¸°
    window.closeMemberReport = () => {
        document.getElementById('memberReportPage').style.display = 'none';
        const metaViewport = document.querySelector('meta[name="viewport"]');
        if (metaViewport) metaViewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes, viewport-fit=cover');
    }

    window.toggleAllMemCheck = (source) => { document.querySelectorAll('.mem-chk').forEach(chk => chk.checked = source.checked); checkBulkBtnVisibility(); }
    window.checkBulkBtnVisibility = () => {
        const checked = document.querySelectorAll('.mem-chk:checked').length;
        const btn = document.getElementById('btnBulkSMS');
        if(checked > 0) { btn.style.display = 'block'; btn.innerText = `ğŸ“© ì„ íƒ ë¬¸ìë°œì†¡ (${checked}ëª…)`; } else btn.style.display = 'none';
    }
    window.sendBulkSMS = () => {
        const checked = document.querySelectorAll('.mem-chk:checked');
        if(checked.length === 0) return;
        let phones = []; checked.forEach(chk => { const p = chk.value.replace(/-/g, '').trim(); if(p) phones.push(p); });
        location.href = `sms:${phones.join(',')}`;
    }

    window.getMemberSums = (name) => { 
        let dues=0, donation=0; 
        window.trans.forEach(t=>{ if(t.type==='income' && t.desc.includes(name)) { if(t.cat==='ì›”íšŒë¹„' || t.cat==='ê°€ì…ë¹„') dues+=t.amt; if(t.cat==='ì°¬ì¡°ê¸ˆ') donation+=t.amt; } }); 
        return { dues, donation }; 
    }
    
    window.getUnpaidInfo = (m) => {
        if(EXCLUDED_STATUSES.includes(m.status)) return { amount:0, months:[] };
        if(m.role === 'ì´ë¬´') return { amount:0, months:[] };
        let startCheckMonth = 0; 
        const joinTrans = window.trans.find(t => t.cat === 'ê°€ì…ë¹„' && t.desc.includes(m.name));
        if(joinTrans) startCheckMonth = parseInt(joinTrans.date.split('-')[1]); 
        let count=0, months=[];
        const currentMonthIdx = new Date().getMonth(); 
        for(let i=startCheckMonth; i < currentMonthIdx; i++) { 
            if(!m.paid[i]) { count++; months.push((i+1)+'ì›”'); } 
        }
        let monthlyFee = currentFees[m.status] || 0;
        return { amount: count * monthlyFee, months };
    }

    window.openFeeSettings = () => {
        if(!window.isAdmin) return;
        document.getElementById('feeSettingsModal').style.display = 'flex';
        document.getElementById('fee_reg').value = currentFees['ë‚¨ì„±'];
        document.getElementById('fee_fem').value = currentFees['ì—¬ì„±'];
        document.getElementById('fee_cpl_m').value = currentFees['ë¶€ë¶€(ë‚¨)'];
        document.getElementById('fee_cpl_f').value = currentFees['ë¶€ë¶€(ì—¬)'];
    }

    window.saveFeeSettings = () => {
        if(!window.isAdmin) return;
        const newFees = { ...currentFees };
        newFees['ë‚¨ì„±'] = parseInt(document.getElementById('fee_reg').value);
        newFees['ì—¬ì„±'] = parseInt(document.getElementById('fee_fem').value);
        newFees['ë¶€ë¶€(ë‚¨)'] = parseInt(document.getElementById('fee_cpl_m').value);
        newFees['ë¶€ë¶€(ì—¬)'] = parseInt(document.getElementById('fee_cpl_f').value);
        if(!window.settings) window.settings = {}; window.settings.fees = newFees; currentFees = newFees;
        saveToFirebase(); document.getElementById('feeSettingsModal').style.display='none'; renderMembers();
    }

    // [4] ì¼ì •(ë‹¬ë ¥) ë¡œì§
    window.toggleCalView = () => { window.calViewMode = window.calViewMode==='month'?'year':'month'; renderCalendar(); }
   window.renderCalendar = () => {
        const yView = document.getElementById('yearView'); const mView = document.getElementById('monthView'); const year = window.curCalDate.getFullYear();
        
        if(window.calViewMode === 'year') {
            yView.style.display='block'; mView.style.display='none';
            document.getElementById('yearTitle').innerText = year+'ë…„';
            const yGrid = document.getElementById('yearGrid'); yGrid.innerHTML='';
            
            for(let m=0; m<12; m++) {
                const mini = document.createElement('div'); mini.className='mini-month';
                mini.onclick = () => { window.curCalDate.setMonth(m); window.calViewMode='month'; renderCalendar(); };
                let html = `<div class="mini-title">${m+1}ì›”</div><div class="mini-grid">`;
                const last = new Date(year, m+1, 0).getDate(); const start = new Date(year, m, 1).getDay();
                for(let k=0; k<start; k++) html+='<div></div>';
                
                for(let d=1; d<=last; d++) {
                    const full = `${year}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const hasEv = window.events.some(e => e.date === full); 
                    const hasBday = window.members.some(mem => mem.birthday && mem.birthday.substring(5) === full.substring(5));
                    const day = new Date(year, m, d).getDay(); const isHol = isHoliday(full);
                    
                    let cls = ''; 
                    if(isHol || day === 0) cls = 'sun holiday'; else if(day === 6) cls = 'sat'; 
                    if(hasEv || hasBday) cls += ' has-event'; 
                    
                    html += `<div class="mini-cell ${cls}">${d}</div>`;
                }
                html+='</div>'; mini.innerHTML=html; yGrid.appendChild(mini);
            }
        } else {
            yView.style.display='none'; mView.style.display='block';
            const month = window.curCalDate.getMonth();
            document.getElementById('calTitle').innerText = `${year}ë…„ ${month+1}ì›”`;
            const mGrid = document.getElementById('monthGrid'); mGrid.innerHTML='';
            ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d=>mGrid.innerHTML+=`<div style="font-size:0.7rem; color:#888;">${d}</div>`);
            
            const last = new Date(year, month+1, 0).getDate(); const start = new Date(year, month, 1).getDay();
            for(let i=0; i<start; i++) mGrid.appendChild(document.createElement('div'));
            
            for(let d=1; d<=last; d++) {
                const div = document.createElement('div'); div.className='date-cell';
                const full = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const day = new Date(year, month, d).getDay(); const isHol = isHoliday(full);
                if(isHol || day === 0) div.classList.add('sun', 'holiday'); else if(day === 6) div.classList.add('sat');
                
                const today = new Date(); 
                if(today.getFullYear()===year && today.getMonth()===month && today.getDate()===d) div.classList.add('today');

                const dayEvents = window.events.filter(e => e.date === full); 
                const mmdd = full.substring(5); 
                const birthdayMembers = window.members.filter(m => m.birthday && m.birthday.substring(5) === mmdd);

                let dot = ''; 
                if(dayEvents.length > 0) dot += `<div class="event-dot"></div>`;
                if(birthdayMembers.length > 0) dot += `<div class="event-dot" style="background:#ff7675; box-shadow: 0 0 5px rgba(255,118,117,0.6);"></div>`;

                div.innerHTML = `<span style="font-size:0.8rem;">${d}</span>${dot}`; 
                div.onclick = () => openEventModal(full); 
                mGrid.appendChild(div);
            }
        }
        renderAllEventsList();
    }
    
    window.changeMonth = (d) => { window.curCalDate.setMonth(window.curCalDate.getMonth()+d); renderCalendar(); }
    window.openEventModal = (date) => { document.getElementById('eventModal').style.display='flex'; document.getElementById('eventDateDisplay').innerText = date; document.getElementById('eventDateVal').value = date; document.getElementById('eventInput').value = ''; renderDayEvents(date); }
    window.addEvent = () => {
        if(!window.isAdmin) return;
        const date = document.getElementById('eventDateVal').value; const title = document.getElementById('eventInput').value;
        if(!title) return; window.events.push({ id:Date.now(), date, title }); saveToFirebase(); document.getElementById('eventInput').value=''; renderDayEvents(date); renderCalendar(); 
    }
// window.addEvent ë°”ë¡œ ì•„ë˜ì— ì´ í•¨ìˆ˜ë¥¼ ë„£ì–´ì£¼ì„¸ìš”
window.deleteEvent = (id) => { 
    if(!window.isAdmin) return; 
    if(confirm('ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { 
        window.events = window.events.filter(e => e.id !== id); 
        saveToFirebase(); 
        const date = document.getElementById('eventDateVal').value; 
        renderDayEvents(date); 
        renderCalendar(); 
    } 
}

    window.renderDayEvents = (date) => {
        const list = document.getElementById('dayEventList'); list.innerHTML = '';
const mmdd = date.substring(5);
    const birthdays = window.members.filter(m => m.birthday && m.birthday.substring(5) === mmdd);
    birthdays.forEach(m => {
        list.innerHTML += `<div style="padding:5px 0; color:#d63031; font-weight:bold;">ğŸ‚ ${m.name}ë‹˜ ìƒì¼</div>`;
    });
        const evs = window.events.filter(e => e.date === date);
        if(evs.length === 0) list.innerHTML = '<div style="color:#aaa; font-size:0.8rem;">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        evs.forEach(e => {
            const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.padding='5px 0';
            const delBtn = window.isAdmin ? `<button onclick="deleteEvent(${e.id})" style="border:none; background:none; color:red;">&times;</button>` : '';
            d.innerHTML = `<span>${e.title}</span>${delBtn}`; list.appendChild(d);
        });
    }
    
 window.renderAllEventsList = () => {
    const c = document.getElementById('allEventsContainer'); 
    if(!c) return; // ì»¨í…Œì´ë„ˆê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨
    c.innerHTML = '';
    
    const showBirthday = document.getElementById('showBirthdayToggle').checked;
    const showPast = document.getElementById('showPastEventsToggle').checked; 
    const selectedYear = document.getElementById('eventListYear').value; 
    
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1; 

    let displayList = window.events
        .filter(e => e.date.startsWith(selectedYear))
        .map(e => ({ ...e, isBirthday: false }));
    
    if (showBirthday) {
        window.members.forEach(m => {
            if (m.birthday) {
                displayList.push({
                    id: 'bday-' + m.id,
                    date: selectedYear + '-' + m.birthday.substring(5),
                    title: `ğŸ‚ ${m.name}ë‹˜ ìƒì¼`,
                    isBirthday: true
                });
            }
        });
    }

    if (selectedYear == currentYear && !showPast) {
        displayList = displayList.filter(e => {
            const evMonth = parseInt(e.date.substring(5, 7));
            return evMonth >= currentMonth;
        });
    }

    displayList.sort((a, b) => new Date(a.date) - new Date(b.date));

    if (displayList.length === 0) {
        c.innerHTML = `<div style="text-align:center; padding:30px; color:#aaa; font-size:0.85rem;">${selectedYear}ë…„ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
    }

    displayList.forEach(e => {
        const d = document.createElement('div');
        d.className = 'trans-item';
        d.style.padding = '12px 10px';
        d.style.background = e.isBirthday ? '#fff5f5' : 'white';
        d.style.cursor = e.isBirthday ? 'default' : 'pointer';

        const dateObj = new Date(e.date);
        const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const dayName = dayNames[dateObj.getDay()];
        
        let dateColor = 'var(--primary)';
        if(dateObj.getDay() === 0) dateColor = 'var(--holiday-text)';
        else if(dateObj.getDay() === 6) dateColor = 'var(--sat-text)';

        d.innerHTML = `
            <div style="flex:1;">
                <span style="font-weight:800; color:${dateColor}; margin-right:10px; font-size:0.85rem;">${e.date} (${dayName})</span> 
                <span style="font-weight:600; color:${e.isBirthday ? '#d63031' : '#333'};">${e.title}</span>
            </div>`;
        
        if(!e.isBirthday) d.onclick = () => openEventModal(e.date); 
        c.appendChild(d);
    });
}

    // [5] ê²°ì‚°/ê°ì‚¬ ë³´ê³ ì„œ
function initReportYears() {
    const ySel = document.getElementById('reportYear');
    const eSel = document.getElementById('eventListYear'); 
    ySel.innerHTML = ''; eSel.innerHTML = '';
    
    const currentYear = new Date().getFullYear();
    // 2023ë…„ë¶€í„° í˜„ì¬+2ë…„ê¹Œì§€ ëª©ë¡ ìƒì„±
    for(let y = currentYear + 2; y >= 2023; y--) { 
        const opt = `<option value="${y}">${y}ë…„</option>`;
        ySel.innerHTML += opt;
        eSel.innerHTML += opt;
    }
    eSel.value = currentYear;
}

// Google Charts ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ (ë©”ëª¨ë¦¬ ë¯¸ë¦¬ ì ì¬)
    google.charts.load("current", {packages:["corechart"]});

    window.updateReport = () => {
        // [ì„¤ì •] í•€ì¹˜ ì¤Œ í—ˆìš©
        const metaViewport = document.querySelector('meta[name="viewport"]');
        if (metaViewport) metaViewport.setAttribute('content', 'width=1024, user-scalable=yes'); 

        const year = document.getElementById('reportYear').value;
        const targetMonth = document.getElementById('reportMonth').value; 
        const targetCat = document.getElementById('reportCatFilter').value;
        
        const paper = document.getElementById('settlementReportPaper');
        paper.innerHTML = '';

        // --- 1. ë°ì´í„° ì§‘ê³„ ---
        let filtered = window.trans.filter(t => t.date.startsWith(year));
        let summary = {}; 
        
        // ì°¨íŠ¸ìš© ë°ì´í„° ë°°ì—´ (Google Charts í˜•ì‹: ['í•­ëª©', 'ê¸ˆì•¡'])
        let chartDataInc = [['í•­ëª©', 'ê¸ˆì•¡']];
        let chartDataExp = [['í•­ëª©', 'ê¸ˆì•¡']];
        
        // ë°ì´í„° ì§‘ê³„ìš© ì„ì‹œ ê°ì²´
        let tempIncObj = {};
        let tempExpObj = {};

        let totalInc = 0;
        let totalExp = 0;

        filtered.forEach(t => {
            const m = t.date.substring(5, 7);
            
            // í•„í„°ë§
            if (targetMonth !== 'all' && m !== targetMonth) return;
            if (targetCat !== 'all' && t.cat !== targetCat) return;

            // [ì›”ë³„] ì§‘ê³„
            if (!summary[m]) summary[m] = {};
            if (!summary[m][t.cat]) summary[m][t.cat] = 0;
            summary[m][t.cat] += t.amt;

            // [ì „ì²´] ì§‘ê³„ (ì°¨íŠ¸ìš©)
            if (t.type === 'income') {
                totalInc += t.amt;
                if (!tempIncObj[t.cat]) tempIncObj[t.cat] = 0;
                tempIncObj[t.cat] += t.amt;
            } else {
                totalExp += t.amt;
                if (!tempExpObj[t.cat]) tempExpObj[t.cat] = 0;
                tempExpObj[t.cat] += t.amt;
            }
        });

        // ì°¨íŠ¸ ë°ì´í„° ë³€í™˜ (Object -> Array)
        for (const [key, val] of Object.entries(tempIncObj)) chartDataInc.push([key, val]);
        for (const [key, val] of Object.entries(tempExpObj)) chartDataExp.push([key, val]);

        // --- 2. [ì „ì²´ í†µê³„] 3D ì°¨íŠ¸ ì˜ì—­ HTML ---
        let chartSectionHtml = '';
        if (targetCat === 'all' && (totalInc > 0 || totalExp > 0)) {
            chartSectionHtml = `
            <div class="audit-section" style="page-break-inside: avoid; margin-bottom: 30px;">
                <div class="audit-h3">ğŸ“Š ${year}ë…„ ì „ì²´ í†µê³„ (3D ë¶„ì„)</div>
                <div style="display:flex; justify-content:space-around; flex-wrap:wrap; gap:10px;">
                    <div style="width:48%; min-width:300px; text-align:center;">
                        <h4 style="color:#0984e3; margin-bottom:5px;">ìˆ˜ì… êµ¬ì„±</h4>
                        <div id="piechart_income" style="width: 100%; height: 300px;"></div>
                    </div>
                    <div style="width:48%; min-width:300px; text-align:center;">
                        <h4 style="color:#d63031; margin-bottom:5px;">ì§€ì¶œ êµ¬ì„±</h4>
                        <div id="piechart_expense" style="width: 100%; height: 300px;"></div>
                    </div>
                </div>
            </div>`;
        }

        // --- 3. [ì›”ë³„] í…Œì´ë¸” HTML ìƒì„± ---
        let monthlyTablesHtml = '';
        const sortedMonths = Object.keys(summary).sort();

        if (sortedMonths.length === 0) {
            monthlyTablesHtml = '<div style="text-align:center; padding:50px;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        } else {
            sortedMonths.forEach(m => {
                const cats = summary[m];
                
                const incomeKeys = Object.keys(cats).filter(c => CATS.income.includes(c)).sort();
                const expenseKeys = Object.keys(cats).filter(c => CATS.expense.includes(c)).sort();

                let mTotalInc = 0; incomeKeys.forEach(k => mTotalInc += cats[k]);
                let mTotalExp = 0; expenseKeys.forEach(k => mTotalExp += cats[k]);
                // ì›”ë³„ ìˆœìˆ˜ìµ(ì”ì•¡) ê³„ì‚°
                let mBalance = mTotalInc - mTotalExp;

                let rows = '';

                // (1) ìˆ˜ì… ë Œë”ë§ (ì œëª© ì˜†ì— í•©ê³„ í‘œì‹œ)
                if (incomeKeys.length > 0) {
                    rows += `<tr style="background:#f0f8ff; border-bottom:1px solid #cce4ff;">
                        <td style="font-weight:bold; color:#0984e3; padding:10px 10px;">ğŸ”µ ìˆ˜ì… ë‚´ì—­</td>
                        <td style="font-weight:bold; color:#0984e3; text-align:right; font-size:1rem;">+${formatStandard(mTotalInc)}</td>
                        <td></td>
                    </tr>`;
                    
                    incomeKeys.forEach(cat => {
                        const amt = cats[cat];
                        const percent = mTotalInc > 0 ? ((amt / mTotalInc) * 100).toFixed(1) : 0;
                        
                        // ê·¸ë˜í”„ ìŠ¤íƒ€ì¼
                        const barStyle = `width:${percent}%; height:100%; background: linear-gradient(180deg, #74b9ff 0%, #0984e3 50%, #00cec9 100%); box-shadow: 2px 2px 5px rgba(0,0,0,0.2); border-radius: 4px;`;
                        
                        rows += `<tr>
                            <td style="padding-left:20px;">${cat}</td>
                            <td class="money" style="color:blue; text-align:right;">${formatStandard(amt)}</td>
                            <td style="width:30%; padding:6px 10px; vertical-align:middle;">
                                <div style="display:flex; align-items:center; font-size:0.75rem; color:#0984e3; height:12px;">
                                    <div style="flex:1; background:#dfe6e9; height:100%; border-radius:4px; margin-right:8px; overflow:visible; box-shadow:inset 1px 1px 3px rgba(0,0,0,0.1);">
                                        <div style="${barStyle}"></div>
                                    </div>
                                    <span style="font-weight:bold;">${percent}%</span>
                                </div>
                            </td>
                        </tr>`;
                    });
                }

                // (2) ì§€ì¶œ ë Œë”ë§ (ì œëª© ì˜†ì— í•©ê³„ í‘œì‹œ)
                if (expenseKeys.length > 0) {
                    const borderStyle = incomeKeys.length > 0 ? "border-top:1px solid #eee;" : "";
                    rows += `<tr style="background:#fff5f5; border-bottom:1px solid #ffccd2; ${borderStyle}">
                        <td style="font-weight:bold; color:#d63031; padding:10px 10px;">ğŸ”´ ì§€ì¶œ ë‚´ì—­</td>
                        <td style="font-weight:bold; color:#d63031; text-align:right; font-size:1rem;">-${formatStandard(mTotalExp)}</td>
                        <td></td>
                    </tr>`;

                    expenseKeys.forEach(cat => {
                        const amt = cats[cat];
                        const percent = mTotalExp > 0 ? ((amt / mTotalExp) * 100).toFixed(1) : 0;
                        
                        // ê·¸ë˜í”„ ìŠ¤íƒ€ì¼
                        const barStyle = `width:${percent}%; height:100%; background: linear-gradient(180deg, #ff7675 0%, #d63031 50%, #e17055 100%); box-shadow: 2px 2px 5px rgba(0,0,0,0.2); border-radius: 4px;`;
                        
                        rows += `<tr>
                            <td style="padding-left:20px;">${cat}</td>
                            <td class="money" style="color:red; text-align:right;">${formatStandard(amt)}</td>
                            <td style="width:30%; padding:6px 10px; vertical-align:middle;">
                                <div style="display:flex; align-items:center; font-size:0.75rem; color:#d63031; height:12px;">
                                    <div style="flex:1; background:#dfe6e9; height:100%; border-radius:4px; margin-right:8px; overflow:visible; box-shadow:inset 1px 1px 3px rgba(0,0,0,0.1);">
                                        <div style="${barStyle}"></div>
                                    </div>
                                    <span style="font-weight:bold;">${percent}%</span>
                                </div>
                            </td>
                        </tr>`;
                    });
                }

                // ì›”ë³„ í…Œì´ë¸” ì¡°ë¦½ (Footerì—ëŠ” ìµœì¢… ì”ì•¡ë§Œ í‘œì‹œ)
                monthlyTablesHtml += `
                <div class="audit-section" style="break-inside: avoid; margin-bottom: 30px;">
                    <div class="audit-h3" style="border-left: 5px solid #2d3436; background:#f1f2f6; padding:8px 10px;">
                        ${m}ì›” ìƒì„¸ í˜„í™©
                    </div>
                    <table class="audit-table">
                        <thead>
                            <tr style="background:#fff;">
                                <th style="width:35%; border-bottom:2px solid #333;">í•­ëª©</th>
                                <th style="width:35%; border-bottom:2px solid #333;">ê¸ˆì•¡</th>
                                <th style="width:30%; border-bottom:2px solid #333;">ë¹„ì¤‘(%)</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                        <tfoot>
                            <tr style="background:#e3f2fd; border-top:2px solid #aaa;">
                                <td style="text-align:center; font-weight:800; color:#2d3436; padding:10px 0;">${m}ì›” ìµœì¢… ì”ì•¡</td>
                                <td style="text-align:right; font-weight:800; color:${mBalance >= 0 ? 'blue' : 'red'}; padding:10px 0; font-size:1.1rem;">
                                    ${formatStandard(mBalance)}
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>`;
            });
        }
        // --- 4. ìµœì¢… HTML ì‚½ì… ---
        paper.innerHTML = `
            <div class="a4-header">
                <div class="a4-title" style="font-size:1.8rem;">${year}ë…„ë„ ê²°ì‚° í†µê³„ ë³´ê³ ì„œ</div>
                <div class="a4-subtitle">ì¶œë ¥ì¼: ${new Date().toLocaleDateString()}</div>
            </div>
            
            <div class="audit-section" style="border-bottom: 2px dashed #ccc; padding-bottom: 20px; margin-bottom: 20px;">
                <table class="audit-table" style="table-layout: fixed; width: 100%;">
                    <colgroup>
                        <col style="width: 33%">
                        <col style="width: 33%">
                        <col style="width: 34%">
                    </colgroup>
                    <thead>
                        <tr style="background:#f1f2f6;">
                            <th style="padding:12px; font-size:1rem; border:1px solid #ddd;">ì´ ìˆ˜ì…</th>
                            <th style="padding:12px; font-size:1rem; border:1px solid #ddd;">ì´ ì§€ì¶œ</th>
                            <th style="padding:12px; font-size:1rem; border:1px solid #ddd;">ì´ ì”ì•¡</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="color:blue; font-size:1.4rem; font-weight:800; text-align:center; padding:20px 0; border:1px solid #ddd;">
                                ${formatStandard(totalInc)}
                            </td>
                            <td style="color:red; font-size:1.4rem; font-weight:800; text-align:center; padding:20px 0; border:1px solid #ddd;">
                                ${formatStandard(totalExp)}
                            </td>
                            <td style="color:#2d3436; font-size:1.4rem; font-weight:900; text-align:center; padding:20px 0; border:1px solid #ddd; background-color:#fdfdfd;">
                                ${formatStandard(totalInc - totalExp)}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            ${chartSectionHtml}
            ${monthlyTablesHtml}
        `;

        // ë·°ì–´ ì—´ê¸°
        document.getElementById('settlementReportPage').style.display = 'block';

        // --- 5. Google Charts ê·¸ë¦¬ê¸° (3D ì˜µì…˜ ì ìš©) ---
        if (targetCat === 'all' && (totalInc > 0 || totalExp > 0)) {
            google.charts.setOnLoadCallback(draw3DCharts);

            function draw3DCharts() {
                // ìˆ˜ì… ì°¨íŠ¸
                if(chartDataInc.length > 1) {
                    var dataInc = google.visualization.arrayToDataTable(chartDataInc);
                    var optionsInc = {
                        is3D: true, // [í•µì‹¬] 3D íš¨ê³¼ ì¼œê¸°
                        fontSize: 12,
                        legend: { position: 'labeled' }, // í•­ëª© ì´ë¦„ì„ ì°¨íŠ¸ ì˜†ì— ì„ ìœ¼ë¡œ ì—°ê²°í•˜ì—¬ í‘œì‹œ
                        chartArea: { width: '90%', height: '80%' },
                        slices: { 0: {offset: 0.1}, 1: {offset: 0.05} }, // 1, 2ë“± í•­ëª© ì‚´ì§ ë–¼ì–´ë‚´ê¸° (ê°•ì¡°)
                        colors: ['#0984e3', '#00b894', '#6c5ce7', '#74b9ff', '#81ecec']
                    };
                    var chartInc = new google.visualization.PieChart(document.getElementById('piechart_income'));
                    chartInc.draw(dataInc, optionsInc);
                }

                // ì§€ì¶œ ì°¨íŠ¸
                if(chartDataExp.length > 1) {
                    var dataExp = google.visualization.arrayToDataTable(chartDataExp);
                    var optionsExp = {
                        is3D: true, // [í•µì‹¬] 3D íš¨ê³¼ ì¼œê¸°
                        fontSize: 12,
                        legend: { position: 'labeled' }, // í•­ëª© ì´ë¦„ì„ ì°¨íŠ¸ ì˜†ì— ì„ ìœ¼ë¡œ ì—°ê²°í•˜ì—¬ í‘œì‹œ
                        chartArea: { width: '90%', height: '80%' },
                        slices: { 0: {offset: 0.1}, 1: {offset: 0.05} }, // 1, 2ë“± í•­ëª© ì‚´ì§ ë–¼ì–´ë‚´ê¸°
                        colors: ['#d63031', '#e17055', '#fab1a0', '#fd79a8', '#636e72']
                    };
                    var chartExp = new google.visualization.PieChart(document.getElementById('piechart_expense'));
                    chartExp.draw(dataExp, optionsExp);
                }
            }
        }
    }
 // [ì‹ ê·œ] ê²°ì‚°ë³´ê³ ì„œ ë·°ì–´ ë‹«ê¸°
    window.closeSettlementReport = () => {
        document.getElementById('settlementReportPage').style.display = 'none';
        const metaViewport = document.querySelector('meta[name="viewport"]');
        if (metaViewport) metaViewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes, viewport-fit=cover');
    }

    window.openAuditReport = () => {
        const metaViewport = document.querySelector('meta[name="viewport"]');
        if (metaViewport) metaViewport.setAttribute('content', 'width=1024, user-scalable=yes'); 
        const year = document.getElementById('reportYear').value;
        const now = new Date();
        document.getElementById('auditTitle').innerText = `${year}ë…„ë„ ê°ì‚¬ ë³´ê³ ì„œ`;
        document.getElementById('auditDateLine').innerText = `${now.getFullYear()}ë…„ ${now.getMonth()+1}ì›” ${now.getDate()}ì¼`;

        const filtered = window.trans.filter(t => t.date.startsWith(year));
        let totalInc = 0, totalExp = 0;
        let monthly = {}, catsInc = {}, catsExp = {};
        for(let i=1; i<=12; i++) monthly[String(i).padStart(2,'0')] = { inc:0, exp:0 };

        filtered.forEach(t => {
            if(t.type === 'income') {
                totalInc += t.amt; const m = t.date.substring(5,7);
                if(monthly[m]) monthly[m].inc += t.amt; if(!catsInc[t.cat]) catsInc[t.cat] = 0; catsInc[t.cat] += t.amt;
            } else {
                totalExp += t.amt; const m = t.date.substring(5,7);
                if(monthly[m]) monthly[m].exp += t.amt; if(!catsExp[t.cat]) catsExp[t.cat] = 0; catsExp[t.cat] += t.amt;
            }
        });

        document.getElementById('auditTotalInc').innerText = formatStandard(totalInc);
        document.getElementById('auditTotalExp').innerText = formatStandard(totalExp);
        document.getElementById('auditTotalBal').innerText = formatStandard(totalInc - totalExp);

        let mHtml = ''; let acc = 0;
        Object.keys(monthly).sort().forEach(m => {
            const d = monthly[m]; acc += (d.inc - d.exp);
            if(d.inc > 0 || d.exp > 0) mHtml += `<tr><td>${m}ì›”</td><td class="money" style="color:blue;">${formatStandard(d.inc)}</td><td class="money" style="color:red;">${formatStandard(d.exp)}</td><td class="money" style="font-weight:bold;">${formatStandard(acc)}</td></tr>`;
        });
        document.getElementById('auditMonthlyBody').innerHTML = mHtml || '<tr><td colspan="4">ë‚´ì—­ ì—†ìŒ</td></tr>';

        const incKeys = Object.keys(catsInc); const expKeys = Object.keys(catsExp);
        const maxRows = Math.max(incKeys.length, expKeys.length);
        let mergedHtml = '';
        if (maxRows === 0) mergedHtml = '<tr><td colspan="4">ë‚´ì—­ ì—†ìŒ</td></tr>';
        else {
            for(let i=0; i<maxRows; i++) {
                const iKey = incKeys[i] || ''; const iVal = iKey ? formatStandard(catsInc[iKey]) : '';
                const eKey = expKeys[i] || ''; const eVal = eKey ? formatStandard(catsExp[eKey]) : '';
                mergedHtml += `<tr><td style="background:#f9f9f9;">${iKey}</td><td class="money" style="color:blue; border-right: 2px solid #ccc;">${iVal}</td><td style="background:#f9f9f9;">${eKey}</td><td class="money" style="color:red;">${eVal}</td></tr>`;
            }
            mergedHtml += `<tr style="background:#e3f2fd; font-weight:bold; border-top:2px solid #aaa;"><td style="text-align:center;">ìˆ˜ì… í•©ê³„</td><td class="money" style="color:blue; border-right: 2px solid #ccc;">${formatStandard(totalInc)}</td><td style="text-align:center;">ì§€ì¶œ í•©ê³„</td><td class="money" style="color:red;">${formatStandard(totalExp)}</td></tr>`;
        }
        document.getElementById('auditCatMergedBody').innerHTML = mergedHtml;

        const audit = window.auditState || { checked: false, name: "", sig: null };
        document.getElementById('auditCheckReceipt').checked = audit.checked;
        document.getElementById('auditNameInput').value = audit.name;
        const ctx = document.getElementById('sigCanvas').getContext('2d');
        ctx.clearRect(0, 0, 250, 120); 
        if(audit.sig) { const img = new Image(); img.onload = () => ctx.drawImage(img, 0, 0); img.src = audit.sig; }

        window.isAuditMode = false; disableAuditInputs();
        document.getElementById('auditReportPage').style.display = 'block';
    }

    window.closeAuditReport = () => { 
        document.getElementById('auditReportPage').style.display = 'none'; 
        const metaViewport = document.querySelector('meta[name="viewport"]');
        if (metaViewport) metaViewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes, viewport-fit=cover');
    }

    window.unlockAuditMode = () => {
        const pwd = prompt('ê°ì‚¬(ê´€ë¦¬ì) ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        const currentPw = (window.settings && window.settings.adminPwd) ? window.settings.adminPwd : '1234';
        if(pwd === currentPw) { alert("ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤."); window.isAuditMode = true; enableAuditInputs(); } 
        else if (pwd !== null) alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    }

    function enableAuditInputs() {
        document.getElementById('auditCheckReceipt').disabled = false;
        document.getElementById('auditNameInput').disabled = false;
        document.getElementById('sigCanvas').classList.remove('locked');
        document.getElementById('auditControlsArea').style.display = 'block';
        document.getElementById('btnUnlockAudit').style.display = 'none';
    }

    function disableAuditInputs() {
        document.getElementById('auditCheckReceipt').disabled = true;
        document.getElementById('auditNameInput').disabled = true;
        document.getElementById('sigCanvas').classList.add('locked');
        document.getElementById('auditControlsArea').style.display = 'none';
        document.getElementById('btnUnlockAudit').style.display = 'block';
    }

    let canvas, ctx, isDrawing = false;
    function initSignaturePad() {
        canvas = document.getElementById('sigCanvas'); ctx = canvas.getContext('2d');
        ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';
        canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mouseup', endDraw);
        canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseout', endDraw);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e.touches[0]); }, {passive: false});
        canvas.addEventListener('touchend', (e) => { e.preventDefault(); endDraw(); }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); }, {passive: false});
    }
    function startDraw(e) { if(!window.isAuditMode) return; isDrawing = true; const rect = canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top); }
    function draw(e) { if (!isDrawing) return; const rect = canvas.getBoundingClientRect(); ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top); ctx.stroke(); }
    function endDraw() { isDrawing = false; ctx.beginPath(); }

    window.clearSignature = () => { if(!window.isAuditMode) return; ctx.clearRect(0, 0, canvas.width, canvas.height); }
    window.saveAuditData = () => {
        if(!window.isAuditMode) return;
        const checked = document.getElementById('auditCheckReceipt').checked;
        const name = document.getElementById('auditNameInput').value;
        const sig = canvas.toDataURL(); 
        if(!checked) return alert("ì˜ìˆ˜ì¦ í™•ì¸ í•­ëª©ì— ì²´í¬í•´ì£¼ì„¸ìš”.");
        if(!name) return alert("ê°ì‚¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        window.auditState = { checked, name, sig, date: new Date().toISOString() };
        saveToFirebase(); alert("ìŠ¹ì¸ ì™„ë£Œ."); disableAuditInputs(); window.isAuditMode = false;
    }
    window.setUnpaidSort = (type) => {
        window.unpaidSort = type;
        document.getElementById('btnSortUnpaidName').classList.toggle('active', type==='name');
        document.getElementById('btnSortUnpaidAmt').classList.toggle('active', type==='amount');
        renderUnpaid();
    }

    window.renderUnpaid = () => {
        const list = document.getElementById('unpaidList'); list.innerHTML = '';
        const totalDisplay = document.getElementById('totalUnpaidDisplay');
        let target = window.members.filter(m => !EXCLUDED_STATUSES.includes(m.status));
        let data = target.map(m => { return { member: m, info: getUnpaidInfo(m) }; }).filter(i => i.info.amount > 0);
        
        data.sort((a,b) => {
            if(window.unpaidSort === 'amount') return b.info.amount - a.info.amount;
            if(window.unpaidSort === 'name') return a.member.name.localeCompare(b.member.name);
        });

        let total = data.reduce((s, i) => s + i.info.amount, 0);
        totalDisplay.innerHTML = `<div style="background:#e74c3c; color:white; padding:12px; border-radius:12px; text-align:center; box-shadow:0 4px 10px rgba(231, 76, 60, 0.3);">ğŸ’° ì´ ë¯¸ë‚©ì•¡: <b>${formatStandard(total)}</b></div>`;
       data.forEach(item => {
        const m = item.member; 
        const div = document.createElement('div'); 
        div.className = 'unpaid-card';
        
        // ë³´ë‚¼ ë©”ì‹œì§€ ë‚´ìš© ì‘ì„±
        const msg = `[ëª¨ë˜ í…Œë‹ˆìŠ¤ í´ëŸ½]\n${m.name}ë‹˜, ë¯¸ë‚© íšŒë¹„ ì•ˆë‚´ì…ë‹ˆë‹¤.\në¯¸ë‚©ì›”: ${item.info.months.join(', ')}\nê¸ˆì•¡: ${formatStandard(item.info.amount)}\nì…ê¸ˆ ë¶€íƒë“œë¦½ë‹ˆë‹¤. ğŸ¾`;
        const encodedMsg = encodeURIComponent(msg); // í•œê¸€ ê¹¨ì§ ë°©ì§€

        div.innerHTML = `
            <div class="u-info">
                <div class="u-top">
                    <span class="u-name">${m.name}</span>
                    <span class="u-badge" style="background:${BADGE_COLOR[m.status]}">${m.status}</span>
                </div>
                <div class="u-months">${item.info.months.join(', ')} ë¯¸ë‚©</div>
            </div>
            <div style="text-align:right;">
                <span class="u-amt">${formatStandard(item.info.amount)}</span>
                <div class="u-sms-btn" onclick="location.href='sms:${m.phone}?body=${encodedMsg}'">ğŸ“©</div>
            </div>`;
        list.appendChild(div);
    });
}

window.uploadReceipt = () => {
        if(!window.isAdmin) return alert('ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        
        const f = document.getElementById('rFile').files[0]; 
        const d = document.getElementById('rDesc').value; 
        const dt = document.getElementById('rDateInput').value;

        if(!f) return alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

        document.getElementById('loadingMsg').innerText = 'ì´ë¯¸ì§€ ìµœì í™” ë° ì—…ë¡œë“œ ì¤‘...';
        document.getElementById('loadingOverlay').style.display = 'flex';

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                // 1. ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• (ìµœëŒ€ ë„ˆë¹„ 800pxë¡œ ì œí•œ)
                const MAX_WIDTH = 800; 
                let width = img.width;
                let height = img.height;

                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }

                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // 2. ì´ë¯¸ì§€ ì••ì¶• (JPEG í¬ë§·, í’ˆì§ˆ 0.6)
                // ì´ë ‡ê²Œ í•˜ë©´ 5MB ì‚¬ì§„ì´ ì•½ 50~100KBë¡œ ì¤„ì–´ë“¤ì–´ ëª¨ë°”ì¼ì—ì„œë„ ì¦‰ì‹œ ì €ì¥ë©ë‹ˆë‹¤.
                const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.6);

                // 3. ë°ì´í„° ì €ì¥
                window.receipts.unshift({ id: Date.now(), date: dt, img: compressedDataUrl, desc: d });
                
                saveToFirebase().then(() => {
                    document.getElementById('rDesc').value='';
                    // íŒŒì¼ ì…ë ¥ì°½ ì´ˆê¸°í™”
                    document.getElementById('rFile').value = ''; 
                    renderReceipts();
                    document.getElementById('loadingOverlay').style.display = 'none';
                    alert('âœ… ì˜ìˆ˜ì¦ì´ ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }).catch(err => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    alert('ì €ì¥ ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜): ' + err);
                });
            }
            img.src = e.target.result;
        };
        reader.readAsDataURL(f);
    }
    
    window.renderReceipts = () => {
        const g = document.getElementById('receiptList'); g.innerHTML='';
        const monthFilter = document.getElementById('rFilterMonth').value; const searchTxt = document.getElementById('rSearchInput').value;
        let filtered = window.receipts.filter(r => { const m = r.date.split('-')[1]; return (monthFilter==='all' || m===monthFilter) && (r.desc.includes(searchTxt) || r.date.includes(searchTxt)); });
        filtered.forEach(r => {
            const d = document.createElement('div'); d.className='receipt-item';
            d.onclick=()=>{ document.getElementById('bigImg').src=r.img; document.getElementById('imgModal').style.display='flex'; window.curReceiptId=r.id; };
            d.innerHTML=`<div class="r-img-box"><img src="${r.img}" class="r-img"></div><div class="r-info"><div class="r-date">${r.date}</div><div class="r-desc">${r.desc}</div></div>`;
            g.appendChild(d);
        });
    }
    window.deleteReceipt = (id) => { if(confirm('ì‚­ì œ?')) { window.receipts=window.receipts.filter(r=>r.id!==id); saveToFirebase(); renderReceipts(); document.getElementById('imgModal').style.display='none'; }}

    window.captureElement = (id, name) => {
        const el = document.getElementById(id);
        const originOverflow = el.style.overflow; const originHeight = el.style.height; const originMaxHeight = el.style.maxHeight;
        el.style.overflow = 'visible'; el.style.height = 'auto'; el.style.maxHeight = 'none';
        html2canvas(el, { scrollY: -window.scrollY }).then(canvas => {
            const a = document.createElement('a'); a.download = `${name}_${new Date().toLocaleDateString()}.png`; a.href = canvas.toDataURL(); a.click();
            el.style.overflow = originOverflow; el.style.height = originHeight; el.style.maxHeight = originMaxHeight;
        });
    }
    window.exportTableToExcel = (tableId, filename) => { const table = document.getElementById(tableId); const wb = XLSX.utils.table_to_book(table, {sheet: "Sheet1"}); XLSX.writeFile(wb, `${filename}_${new Date().toLocaleDateString()}.xlsx`); }

    // [ìˆ˜ì •] ìì‚° í‘œì‹œ ë¡œì§ (ë¯¸ë‚© í¬í•¨ ê¸ˆì•¡ ê³„ì‚°)
    window.renderStats = () => { 
        let i=0,e=0,d=0; 
        window.trans.forEach(t=>{if(t.type==='income'){i+=t.amt; if(t.cat==='ì°¬ì¡°ê¸ˆ')d+=t.amt;}else e+=t.amt;}); 
        
        let currentAsset = i-e;
        document.getElementById('dispInc').innerText=formatStandard(i); 
        document.getElementById('dispExp').innerText=formatStandard(e); 
        document.getElementById('dispTotal').innerText=formatStandard(currentAsset); 
        document.getElementById('dispDon').innerText=formatStandard(d); 
        
        // ë¯¸ë‚© í¬í•¨ ìì‚° ê³„ì‚°
        let totalUnpaid = 0;
        window.members.forEach(m => { totalUnpaid += getUnpaidInfo(m).amount; });
        document.getElementById('dispTotalWithUnpaid').innerText = `(ë¯¸ë‚©í¬í•¨: ${formatStandard(currentAsset + totalUnpaid)})`;
    }
    
    window.goTab = (id, el) => { 
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); 
        document.getElementById('page-'+id).classList.add('active'); 
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); 
        if(el) el.classList.add('active'); 
        else {
            if(id === 'ledger') document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            if(id === 'members') document.querySelector('.nav-item:nth-child(2)').classList.add('active');
        }
        updateAdminUI(); 
        if(id==='members') renderMembers(); 
        if(id==='analysis') renderUnpaid(); 
        if(id==='receipts') renderReceipts(); 
        if(id==='calendar') renderCalendar(); 
        if(id==='report') {
            // ë¦¬í¬íŠ¸ íƒ­ìœ¼ë¡œ ê°ˆ ë•ŒëŠ” ê¸°ì¡´ ë·°ì–´ë¥¼ ë‹«ê³  ì´ˆê¸°í™”
            closeSettlementReport(); 
            closeAuditReport();
        }
    }
    window.renderAll = () => { renderLedger(); renderStats(); renderMembers(); renderUnpaid(); renderReceipts(); renderCalendar(); updateAdminUI(); }
    window.exportData = () => { const d={trans:window.trans, members:window.members, receipts:window.receipts, events:window.events, settings:window.settings}; const b=new Blob([JSON.stringify(d)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='backup.json'; a.click(); }
    window.importData = (input) => { const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=function(e){const d=JSON.parse(e.target.result); window.trans=d.trans||[]; window.members=d.members||[]; window.receipts=d.receipts||[]; window.events=d.events||[]; window.settings=d.settings||null; saveToFirebase(); alert('ë³µêµ¬ ì™„ë£Œ'); location.reload();}; r.readAsText(f); }

    
    window.openEditTrans = (id) => { 
        const t = window.trans.find(x => x.id === id); if(!t) return; 
        document.getElementById('transModal').style.display='flex'; 
        if(window.isAdmin) {
            document.getElementById('editTransFormBox').style.display = 'block'; document.getElementById('viewTransOnly').style.display = 'none';
            document.getElementById('editTransId').value = t.id; document.getElementById('editTransDate').value = t.date; document.getElementById('editTransType').value = t.type; updateEditCategories(t.cat); document.getElementById('editTransAmt').value = t.amt; document.getElementById('editTransDesc').value = t.desc; 
        } else {
            document.getElementById('editTransFormBox').style.display = 'none'; document.getElementById('viewTransOnly').style.display = 'block';
        }
    }
    window.updateEditCategories = (sel) => { 
        const type = document.getElementById('editTransType').value; const el = document.getElementById('editTransCat'); el.innerHTML=''; 
        CATS[type].forEach(c => { const op = document.createElement('option'); op.value = c; op.innerText = c; if(c === sel) op.selected = true; el.appendChild(op); }); 
    }
    window.saveTransEdit = () => { 
        const id = Number(document.getElementById('editTransId').value); const t = window.trans.find(x => x.id === id); 
        if(t) { t.date = document.getElementById('editTransDate').value; t.type = document.getElementById('editTransType').value; t.cat = document.getElementById('editTransCat').value; t.amt = parseInt(document.getElementById('editTransAmt').value); t.desc = document.getElementById('editTransDesc').value; saveToFirebase(); renderAll(); closeTransModal(); }
    }
    window.delTransFromModal = () => { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ const id = Number(document.getElementById('editTransId').value); window.trans = window.trans.filter(x => x.id !== id); saveToFirebase(); renderAll(); closeTransModal(); } }
    // --- ë‚´ì—­ ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸° ---
    window.closeTransModal = () => { document.getElementById('transModal').style.display='none'; }
    
   // --- íšŒì› ì •ë³´ ëª¨ë‹¬ ì—´ê¸° (IDê°€ ì—†ì–´ë„ ì´ë¦„ìœ¼ë¡œ ì°¾ëŠ” ë²„ì „) ---
    window.openModal = (id, name) => { 
        document.getElementById('memModal').style.display='flex'; 
        
        if(window.isAdmin) { 
            document.querySelector('#memModal .admin-flex').style.setProperty('display', 'flex', 'important'); 
            document.getElementById('btnCloseMemView').style.display = 'none'; 
            // ì´ë¦„ì´ë‚˜ ID ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì‚­ì œ ë²„íŠ¼ì„ ë¬´ì¡°ê±´ í‘œì‹œí•©ë‹ˆë‹¤.
            document.getElementById('btnDelMem').style.setProperty('display', 'block', 'important'); 
        } else { 
            document.querySelector('#memModal .admin-flex').style.setProperty('display', 'none', 'important'); 
            document.getElementById('btnDelMem').style.setProperty('display', 'none', 'important'); 
            document.getElementById('btnCloseMemView').style.display = 'block'; 
        }
        
        // 1ìˆœìœ„: IDë¡œ ì°¾ê¸°, 2ìˆœìœ„: ì´ë¦„ìœ¼ë¡œ ì°¾ê¸°
        let m = window.members.find(x => String(x.id) === String(id)); 
        if(!m && name) m = window.members.find(x => x.name === name);

        if(m) {
            document.getElementById('modalTitle').innerText = m.name + " ì •ë³´"; 
            document.getElementById('editId').value = m.id || ''; // IDê°€ ì—†ìœ¼ë©´ ë¹ˆê°’
            document.getElementById('editName').value = m.name; 
            document.getElementById('editRole').value = m.role || ''; 
            document.getElementById('editPhone').value = m.phone || ''; 
            document.getElementById('editStatus').value = m.status || 'ë‚¨ì„±'; 
            document.getElementById('editSpouse').value = m.spouse || ''; 
            document.getElementById('editBirthday').value = m.birthday || '';
        } else { 
            // ì‹ ê·œ ì¶”ê°€ ëª¨ë“œ
            document.getElementById('modalTitle').innerText = "ìƒˆ íšŒì› ì¶”ê°€"; 
            document.getElementById('btnDelMem').style.display = 'none';
            document.getElementById('editId').value=''; 
            document.getElementById('editName').value=''; 
            document.getElementById('editRole').value=''; 
            document.getElementById('editPhone').value=''; 
            document.getElementById('editStatus').value='ë‚¨ì„±'; 
            document.getElementById('editSpouse').value=''; 
            document.getElementById('editBirthday').value = '';
        } 
    }

    window.closeModal = () => document.getElementById('memModal').style.display='none';
    
    // --- íšŒì› ì €ì¥ (ìˆ˜ì •/ì¶”ê°€ ê³µìš©) ---
    window.saveMember = () => { 
        if(!window.isAdmin) return; 
        const id = document.getElementById('editId').value; 
        const name = document.getElementById('editName').value; 
const birthday = document.getElementById('editBirthday').value;        
const role = document.getElementById('editRole').value; 
        const phone = document.getElementById('editPhone').value; 
        const status = document.getElementById('editStatus').value; 
        const spouse = document.getElementById('editSpouse').value; 
        
        let m = window.members.find(x => id && String(x.id) === String(id));
        if(!m) m = window.members.find(x => x.name === name);

        if(m){
            // ê¸°ì¡´ íšŒì› ìˆ˜ì •
             m.role=role; m.phone=phone; m.status=status; m.spouse=spouse; m.name=name; m.birthday=birthday;
            if(!m.id) m.id = Date.now(); // IDê°€ ì—†ë˜ íšŒì›ì—ê²Œ ì‹ ê·œ ID ë¶€ì—¬
        } else {
            // ì‹ ê·œ íšŒì› ì¶”ê°€
            window.members.push({id:Date.now(), name, birthday, role, phone, status, spouse, paid:Array(12).fill(false)});
    }
        saveToFirebase().then(() => { renderAll(); closeModal(); });
    }

    // --- íšŒì› ì‚­ì œ (IDì™€ ì´ë¦„ì„ ë™ì‹œì— ì²´í¬í•˜ì—¬ í™•ì‹¤íˆ ì‚­ì œ) ---
    window.delMember = () => { 
        if(!window.isAdmin) return; 
        const name = document.getElementById('editName').value;
        const id = document.getElementById('editId').value;

        if(confirm(`[${name}] íšŒì›ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)){
            // IDê°€ ì¼ì¹˜í•˜ê±°ë‚˜, ì´ë¦„ì´ ì¼ì¹˜í•˜ëŠ” íšŒì›ì„ ëª©ë¡ì—ì„œ ì œê±°
            window.members = window.members.filter(x => {
                const idMatch = id && String(x.id) === String(id);
                const nameMatch = x.name === name;
                return !(idMatch || nameMatch);
            });
            saveToFirebase().then(() => { renderAll(); closeModal(); });
        } 
    }

        </script>
</body>

</html>

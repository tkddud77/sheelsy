<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë²”ì„œ í´ëŸ½ ë§¤ë‹ˆì € 4.9 (ìƒë¯¼ver)</title>
    
    <meta name="theme-color" content="#68A658">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="icon" type="image/png" href="ten.png?v=2">
    <link rel="apple-touch-icon" href="ten.png?v=2">
    
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Nanum+Pen+Script&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --court-green: #68A658;
            --court-dark: #3E7C38;
            --ball-yellow: #E9F438;
            --danger: #ff5252;
            --blue-mark: #448aff;
            --bg-color: #f0f2f5;
            --seed-color: #f57f17;
            
            /* ë“±ê¸‰ë³„ ìƒ‰ìƒ */
            --tier-a: #ef5350; --bg-tier-a: #ffebee;
            --tier-am: #ffccbc; --bg-tier-am: #fff3e0;
            --tier-b: #fbc02d; --bg-tier-b: #fffde7;
            --tier-bm: #fff59d; --bg-tier-bm: #fff8e1;
            --tier-c: #66bb6a; --bg-tier-c: #e8f5e9;
            --tier-cm: #a5d6a7; --bg-tier-cm: #f1f8e9;
            --tier-d: #42a5f5; --bg-tier-d: #e3f2fd;
            
            --rank-1: #FFD700; --rank-2: #87CEEB; --rank-3: #D3D3D3;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Jua', sans-serif; background: var(--bg-color); margin: 0; padding-bottom: 80px; color: #333; }

        header {
            background: var(--court-green); color: white; padding: 12px 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        .app-title { font-size: 1.1rem; display: flex; align-items: center; gap: 5px; flex-wrap: wrap;}
        .ver-sign { font-family: 'Nanum Pen Script', cursive; font-size: 1.6rem; color: var(--ball-yellow); margin: 0 4px; }
        .header-btns { display: flex; gap: 5px; }
        .btn-icon { background: rgba(255,255,255,0.25); border: none; color: white; width: 36px; height: 36px; border-radius: 10px; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; }

        .container { max-width: 800px; margin: 0 auto; padding: 10px; }
        .page-section { display: none; animation: fadeIn 0.3s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform: translateY(5px);} to{opacity:1; transform: translateY(0);} }

        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .card-title { font-size: 1.2rem; margin-bottom: 5px; border-bottom: 2px solid #eee; padding-bottom: 8px; color: var(--court-dark); display: flex; justify-content: space-between; align-items: center;}
        .card-subtitle { font-size: 0.85rem; color: #888; margin-bottom: 12px; font-weight: normal; }

        .tier-board { display: flex; overflow-x: auto; gap: 4px; padding-bottom: 5px; scrollbar-width: none; }
        .tier-board::-webkit-scrollbar { display: none; }
        
        .tier-column { 
            min-width: 95px; flex: 1; border-radius: 10px; 
            border: 2px solid rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .tier-header { 
            padding: 8px 2px; text-align: center; color: white; font-size: 0.95rem; 
            text-shadow: 1px 1px 0 rgba(0,0,0,0.1); cursor: pointer; 
        }
        .tier-header:active { opacity: 0.8; }
        .player-list { padding: 4px; flex: 1; min-height: 80px; }

        /* ì¡°ë³„ ìƒ‰ìƒ */
        .col-A { background: var(--bg-tier-a); border-color: var(--tier-a); } .col-A .tier-header { background: var(--tier-a); }
        .col-Am { background: var(--bg-tier-am); border-color: var(--tier-am); } .col-Am .tier-header { background: var(--tier-am); }
        .col-B { background: var(--bg-tier-b); border-color: var(--tier-b); } .col-B .tier-header { background: var(--tier-b); }
        .col-Bm { background: var(--bg-tier-bm); border-color: var(--tier-bm); } .col-Bm .tier-header { background: var(--tier-bm); }
        .col-C { background: var(--bg-tier-c); border-color: var(--tier-c); } .col-C .tier-header { background: var(--tier-c); }
        .col-Cm { background: var(--bg-tier-cm); border-color: var(--tier-cm); } .col-Cm .tier-header { background: var(--tier-cm); }
        .col-D { background: var(--bg-tier-d); border-color: var(--tier-d); } .col-D .tier-header { background: var(--tier-d); }

        .player-card {
            background: rgba(255,255,255,0.85); 
            padding: 6px 5px; margin-bottom: 4px; border-radius: 8px;
            display: flex; align-items: center; gap: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; border: 1px solid rgba(0,0,0,0.05);
            min-height: 40px; position: relative;
        }
        /* ìŠ¹ê°•ê¸‰ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .player-card.promo-target { border: 2px solid var(--danger); background: #fff0f0; }
        .player-card.demo-target { border: 2px solid var(--blue-mark); background: #e3f2fd; }

        .player-img-small { width: 26px; height: 26px; border-radius: 50%; object-fit: cover; background: #ddd; border:1px solid #fff; flex-shrink: 0; }
        
        .player-name-wrap { 
            font-size: 0.85rem; color: #333; font-weight: 500; 
            flex: 1; display: flex; align-items: center; justify-content: space-between;
            overflow: visible; white-space: normal; line-height: 1.1;
        }
        .p-name { word-break: break-all; margin-right: 2px; }
        .rank-sign { font-size: 0.8rem; font-weight: bold; margin-left: 2px; }

        .folder-item {
            background: #fff8e1; border: 1px solid #ffe082; border-radius: 12px; padding: 15px 12px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer;
        }
        .folder-guest { background: #e0f7fa; border: 2px solid #4dd0e1; }
        .input-full { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 10px; font-family: 'Jua'; font-size: 1.1rem; margin-bottom: 8px; outline: none; }
        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; color: white; font-family: 'Jua'; margin-top: 5px; }
        
        .bg-green { background: var(--court-green); }
        .bg-blue { background: #42a5f5; }
        .bg-yellow { background: var(--ball-yellow); color: var(--court-dark); }
        .bg-gray { background: #bdbdbd; }
        .bg-red { background: var(--danger); }
        .bg-teal { background: #009688; }
        .bg-purple { background: #9c27b0; }

        .match-card { background: white; border: 2px solid #eee; border-radius: 12px; padding: 10px; margin-bottom: 10px; }
        .match-card.played { background: #f1f8e9; border-color: var(--court-green); }
        .score-select { border: 2px solid #ddd; border-radius: 8px; font-family: 'Jua'; font-size: 1.3rem; width: 45px; text-align: center; height: 45px; background: white; -webkit-appearance: none; }
        .played .score-select { border-color: var(--court-green); color: var(--court-dark); font-weight: bold; }

        .result-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 0.85rem; }
        .result-table th { background: var(--court-green); color: white; padding: 6px; font-weight: normal; }
        .result-table td { padding: 6px 3px; border-bottom: 1px solid #eee; }
        .rank-1 td { background-color: var(--rank-1) !important; font-weight: bold; }
        .rank-2 td { background-color: var(--rank-2) !important; font-weight: bold; }
        .rank-3 td { background-color: var(--rank-3) !important; font-weight: bold; }

        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 2px solid #eee; display: flex; height: 65px; z-index: 90; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #ccc; cursor: pointer; }
        .nav-item.active { color: var(--court-dark); transform: translateY(-2px); }
        .nav-icon { font-size: 1.6rem; margin-bottom: 2px; }
        .nav-text { font-size: 0.8rem; }

        .admin-only { display: none !important; }
        .admin-show { display: block !important; }
        
        /* ëª¨ë‹¬ ìš°ì„ ìˆœìœ„ ì„¤ì • */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: white; width: 90%; max-width: 450px; padding: 20px; border-radius: 15px; max-height: 85vh; overflow-y: auto; border: 3px solid var(--court-green); box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; z-index: 3001; }
        
        #fullPhotoModal { z-index: 9999 !important; }
        #detailStatsModal { z-index: 3010 !important; }

        .seed-section { background: #fff9c4; border: 2px dashed #fbc02d; padding: 15px; border-radius: 12px; margin-bottom: 10px; }
        .player-tags .tag {
            background: white; border: 1px solid #ddd;
            padding: 8px 12px; border-radius: 20px; 
            display: inline-flex; align-items: center; margin-right: 5px; margin-bottom: 5px;
            font-size: 1rem; cursor: pointer; transition: all 0.2s;
        }
        .player-tags .tag.is-seed { border-color: var(--seed-color); background-color: #fffde7; font-weight: bold; color: #e65100; }
        
        .ladder-group { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .ladder-group-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        
        .ladder-slot { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border: 1px solid #eee; margin-bottom: 8px; padding: 12px; border-radius: 8px; font-size: 1.1rem; }
        .ladder-slot.seed-slot { border-left: 5px solid var(--seed-color); background: #fff8e1; }
        .ladder-slot.normal-slot { border-left: 5px solid #4facfe; }
        .slot-num { font-weight: bold; color: #555; width: 30px; }
        .slot-name { font-weight: bold; flex-grow: 1; text-align: center; }
        
        .spinning { color: #aaa; animation: blurText 0.1s infinite; }
        @keyframes blurText { 0% { opacity: 0.5; transform: translateY(-2px); } 50% { opacity: 1; transform: translateY(2px); } 100% { opacity: 0.5; transform: translateY(-2px); } }

        .profile-large { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 5px; border: 3px solid var(--court-green); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .photo-edit-overlay { position: absolute; bottom: 0; right: 0; background: var(--court-green); color: white; border-radius: 50%; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .tie-breaker-box { background: #fff3e0; border: 2px solid #ffb74d; padding: 10px; border-radius: 10px; margin-top: 10px; animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { border-color: #ffb74d; } to { border-color: #ff9800; } }
        .tie-input { width: 50px; text-align: center; border: 1px solid #ccc; border-radius: 5px; padding: 5px; margin-left: 5px; font-family: 'Jua'; font-size:0.9rem; }
        
        .member-selector { display:grid; grid-template-columns: repeat(4, 1fr); gap:5px; max-height: 150px; overflow-y:auto; margin-bottom:10px; border:1px solid #eee; padding:5px; border-radius:8px; background:#fafafa; }
        .select-chip { font-size:0.85rem; padding:6px; background:white; border:1px solid #ddd; border-radius:6px; text-align:center; cursor:pointer; }
        .select-chip:active { background:#eee; }

        .hist-changes-container { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .hist-badge { padding: 5px 10px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .hist-badge-up { background-color: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; }
        .hist-badge-down { background-color: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
        
        /* ë§¤ì¹˜ í”Œë ˆì´ì–´ ë¼ì¸ ì •ë ¬ ìŠ¤íƒ€ì¼ (ì‹œë“œ ì•„ì´ì½˜ ê³ ì •) */
        .match-p-line { display: flex; align-items: center; height: 24px; margin-bottom: 2px; }
        .p-left { justify-content: flex-start; }
        .p-right { justify-content: flex-end; }
        .seed-box { width: 24px; height: 24px; text-align: center; display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .name-box { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 2px; }

        /* 3D ì…ì²´ ë””ìì¸ ìŠ¤íƒ€ì¼ */
        .chart-3d-box {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 15px;
            box-shadow: 5px 5px 10px #d9d9d9, -5px -5px 10px #ffffff;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(0,0,0,0.02);
        }
        
        /* ì…ì²´ì ì¸ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .history-item-3d {
            background: #ffffff;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            border: 1px solid #f0f0f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .history-item-3d:active {
            transform: scale(0.98);
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.05);
        }
        .history-date { font-size: 0.8rem; color: #888; margin-bottom: 2px; }
        .history-title { font-weight: bold; font-size: 0.95rem; color: #333; }
        .history-score { font-weight: bold; font-size: 1rem; color: var(--court-dark); }
        
        /* í”„ë¡œí•„ìš© ë±ƒì§€ */
        .p-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; display:inline-block; font-weight:bold;}
        .p-badge.up { background:#ffebee; color:red; border:1px solid red; }
        .p-badge.down { background:#e3f2fd; color:blue; border:1px solid blue; }

        /* [ìˆ˜ì •] ë‹¨ì²´ì „ ë° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ */
        .team-folder {
            border: 1px solid #ddd; border-radius: 12px; padding: 15px; margin-bottom: 10px;
            background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            transition: transform 0.1s;
        }
        .team-folder:active { transform: scale(0.98); background: #f9f9f9; }

        .div-box { background:#f5f5f5; border-radius:8px; padding:10px; margin-bottom:12px; border:1px solid #eee; }
        .div-title { font-weight:bold; color:#3E7C38; display:flex; justify-content:space-between; margin-bottom:5px; align-items:center; }
        .pair-row { display:flex; align-items:center; margin-bottom:4px; font-size:0.9rem; background:white; padding:4px; border-radius:5px; border:1px solid #ddd; }
        .pair-badge { background:#666; color:white; font-size:0.7rem; padding:2px 5px; border-radius:4px; margin-right:5px; width:35px; text-align:center; }
        .pair-player { flex:1; cursor:pointer; font-weight:bold; color:#333; }
        .pair-player:hover { color:blue; text-decoration:underline; }

        /* ì˜ˆë¹„ì¸ì› ì¹¸ ìŠ¤íƒ€ì¼ */
        .reserve-row { display:flex; gap:5px; margin-top:5px; padding-top:5px; border-top:1px dashed #ddd; }
        .res-input { flex:1; font-size:0.85rem; padding:5px; border:1px solid #ddd; border-radius:4px; background:#fffbe6; }

        .res-sel { border:1px solid #ccc; border-radius:4px; font-size:0.8rem; padding:2px; }
        .win { background:#e8f5e9; color:green; }
        .loss { background:#ffebee; color:red; }

        /* [ì‹ ê·œ] ì„ ìˆ˜ ì„ íƒê¸° ê·¸ë£¹ í—¤ë” (ë“±ê¸‰ í‘œì‹œìš©) */
        .selector-group-title { grid-column: 1/-1; font-size:0.9rem; font-weight:bold; color:#fff; background:var(--court-green); padding:5px 8px; border-radius:4px; margin-top:8px; margin-bottom:3px; }
/* [ìˆ˜ì •] ë‹¨ì²´ì „ 3D ë° ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ */
.stat-badge-3d {
    background: white; border-radius: 12px; padding: 10px; display: flex; align-items: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05), inset 0 -2px 0 rgba(0,0,0,0.1);
    border: 1px solid #f0f0f0; transition: transform 0.2s;
}
.stat-badge-3d:hover { transform: translateY(-2px); }
.sb-icon { font-size: 1.8rem; margin-right: 10px; }
.sb-content { flex: 1; }
.sb-label { font-size: 0.75rem; color: #888; margin-bottom: 2px; }
.sb-val { font-size: 1rem; font-weight: bold; color: #333; }

.team-folder {
    border: 1px solid #ddd; border-radius: 12px; padding: 15px; margin-bottom: 10px;
    background: white; box-shadow: 0 4px 0 #eee; cursor: pointer; /* 3D ë²„íŠ¼ íš¨ê³¼ */
    display: flex; justify-content: space-between; align-items: center;
    transition: all 0.1s;
}
.team-folder:active { transform: translateY(2px); box-shadow: 0 2px 0 #eee; }

.div-box { background:#f5f5f5; border-radius:8px; padding:10px; margin-bottom:12px; border:1px solid #eee; }
.div-title { font-weight:bold; color:#3E7C38; display:flex; justify-content:space-between; margin-bottom:5px; align-items:center; }
.pair-row { display:flex; align-items:center; margin-bottom:4px; font-size:0.9rem; background:white; padding:4px; border-radius:5px; border:1px solid #ddd; }
.pair-badge { background:#666; color:white; font-size:0.7rem; padding:2px 5px; border-radius:4px; margin-right:5px; width:35px; text-align:center; }
.pair-player { flex:1; cursor:pointer; font-weight:bold; color:#333; }
.reserve-row { display:flex; gap:5px; margin-top:5px; padding-top:5px; border-top:1px dashed #ddd; }
.res-input { flex:1; font-size:0.85rem; padding:5px; border:1px solid #ddd; border-radius:4px; background:#fffbe6; }
.res-sel { border:1px solid #ccc; border-radius:4px; font-size:0.8rem; padding:2px; }
.win { background:#e8f5e9; color:green; }
.loss { background:#ffebee; color:red; }
.selector-group-title { grid-column: 1/-1; font-size:0.9rem; font-weight:bold; color:#fff; background:var(--court-green); padding:5px 8px; border-radius:4px; margin-top:8px; margin-bottom:3px; }

/* í”„ë¦¬ì…‹ í¸ì§‘ê¸° ìŠ¤íƒ€ì¼ */
.preset-card { background:#fff3e0; border:1px solid #ffb74d; padding:10px; margin-bottom:10px; border-radius:8px; }
.preset-div-row { display:flex; gap:5px; margin-bottom:5px; align-items:center; }    
/* ================= MVP ìŠ¤íƒ€ì¼ ì¶”ê°€ (ì—¬ê¸°ì„œë¶€í„°) ================= */
        .mvp-btn { background:var(--ball-yellow); color:var(--court-dark); border:none; padding:5px 10px; border-radius:15px; font-size:0.8rem; font-weight:bold; cursor:pointer; margin-left:auto; }
        
        /* MVP ëª¨ë‹¬ ë‚´ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .mvp-row { display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #eee; cursor:pointer; transition:0.1s; }
        .mvp-row:active { background:#f5f5f5; }
        
        .mvp-rank-badge { width:30px; height:30px; display:flex; align-items:center; justify-content:center; border-radius:50%; font-weight:bold; margin-right:10px; font-size:1.1rem; }
        
        /* 1, 2, 3ë“± íŠ¹ë³„ ë””ìì¸ */
        .mvp-1 { background:linear-gradient(to right, #fff, #fff8e1); border-left:4px solid #ffd700; }
        .mvp-1 .mvp-rank-badge { background:#ffd700; color:white; box-shadow:0 2px 5px rgba(255, 215, 0, 0.4); }
        
        .mvp-2 { border-left:4px solid #c0c0c0; }
        .mvp-2 .mvp-rank-badge { background:#c0c0c0; color:white; }
        
        .mvp-3 { border-left:4px solid #cd7f32; }
        .mvp-3 .mvp-rank-badge { background:#cd7f32; color:white; }
        
        .mvp-score { font-weight:bold; color:#d32f2f; font-size:1.1rem; }
        .mvp-detail-item { font-size:0.85rem; padding:8px 0; border-bottom:1px dashed #ddd; display:flex; justify-content:space-between; }
/* MVP ì „ì²´ ë³´ê³ ì„œ ìŠ¤íƒ€ì¼ */
        .mvp-full-table { width:100%; border-collapse:collapse; font-size:0.9rem; margin-top:10px; }
        .mvp-full-table th { background:#f5f5f5; padding:8px; border:1px solid #ddd; text-align:center; }
        .mvp-full-table td { padding:8px; border:1px solid #ddd; vertical-align:top; }
        .mvp-sub-log { font-size:0.8rem; color:#666; margin-bottom:2px; display:flex; justify-content:space-between; }
        
        /* ìŠ¹ê°•ê¸‰ ë¶„ì„ ì´ë¦„ í´ë¦­ ìŠ¤íƒ€ì¼ */
        .clickable-name { color: blue; text-decoration: underline; cursor: pointer; }
        .clickable-name:hover { color: darkblue; }
        /* ================= MVP ìŠ¤íƒ€ì¼ ë ================= */
/* === [ì‹ ê·œ] A4 ë³´ê³ ì„œ ë° ì¸ì‡„ ìŠ¤íƒ€ì¼ === */
        .report-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #555; z-index: 5000; display: none; 
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .a4-paper { 
            width: 210mm; min-height: 297mm; background: white; 
            margin: 20px auto; padding: 15mm; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); position: relative; 
        }
        .report-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
        .report-title { font-size: 24pt; font-weight: 800; color: #333; margin-bottom: 5px; }
        .report-date { font-size: 11pt; color: #666; text-align: right; }
        
        .report-table { width: 100%; border-collapse: collapse; font-size: 11pt; }
        .report-table th { background: #f0f0f0; border: 1px solid #444; padding: 8px; text-align: center; font-weight: bold; }
        .report-table td { border: 1px solid #444; padding: 6px 8px; text-align: center; }
        .report-table tr { page-break-inside: avoid; }

        .report-btns { position: fixed; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 5001; }
        .btn-rep { padding: 10px 20px; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); color: white; font-size: 1rem; }
        .btn-close { background: #2d3436; }
        .btn-print { background: #0984e3; }

        /* ì œëª© í¸ì§‘ ê°€ëŠ¥ í‘œì‹œ */
        .editable-title { cursor: pointer; border-bottom: 1px dashed rgba(255,255,255,0.3); }
        .editable-title:hover { background: rgba(255,255,255,0.1); }

        @media print {
            body * { visibility: hidden; }
            .report-modal, .report-modal * { visibility: visible; }
            .report-modal { position: absolute; left: 0; top: 0; background: white; width: 100%; height: auto; overflow: visible; }
            .a4-paper { margin: 0; padding: 0; box-shadow: none; width: 100%; }
            .report-btns { display: none !important; }
            @page { size: A4; margin: 10mm; }
        }

</style>
</head>
<body>

<header>
    <div class="app-title">
        <span id="appTitleText" class="editable-title" onclick="editAppTitle()">ëª¨ë˜ í…Œë‹ˆìŠ¤ í´ëŸ½</span> 
        <span class="ver-sign">(4.9)</span>
    </div>
    <div class="header-btns">
        <button class="btn-icon admin-only" onclick="openMemberManager()" title="íšŒì›ê´€ë¦¬">ğŸ‘¥</button>
        <button class="btn-icon admin-only" onclick="openBackupModal()" title="ë°±ì—…">ğŸ’¾</button>
        <button class="btn-icon admin-only" onclick="openAdminSettings()" title="ì„¤ì •">âš™ï¸</button>
        <button id="btnLogin" class="btn-icon" onclick="toggleAdmin()">ğŸ”’</button>
    </div>
</header>
<div id="page-rank" class="container page-section active">
<div class="card" id="boardCaptureArea"> 
        <div class="card-title">
            <div style="display:flex; align-items:center; gap:10px;">
                <span>ğŸ“Š ë“±ê¸‰ í˜„í™©íŒ</span>
                <button class="mvp-btn" onclick="openMVPModal()" style="margin-left:0;">ğŸ† MVP ë­í‚¹</button>
            </div>
            <span style="font-size:0.85rem; color:#555; font-weight:normal;" id="realTimeClock"></span>
        </div>
        <div class="card-subtitle">ë§¤ì›” ì—…ë°ì´íŠ¸ë˜ëŠ” ìš°ë¦¬ë“¤ì˜ ëœ¨ê±°ìš´ ì½”íŠ¸ ì—´ì •! <span style="font-size:0.8rem; color:var(--court-green);" id="totalMemberCnt"></span></div>
        <div style="font-size:0.8rem; color:#999; text-align:center; margin-bottom:5px;">(ê° ì¡° ì´ë¦„ì„ ëˆ„ë¥´ë©´ ë“±ê¸‰ ë³€ë™ ë‚´ì—­ì´ ë‚˜ì˜µë‹ˆë‹¤)</div>
        <div id="unassignedArea" style="margin-bottom:10px; display:none;">
            <div style="background:#fff0f0; padding:10px; border-radius:10px; border:2px solid #ffcdd2; text-align: center;">
                <b style="color:var(--danger); font-size:1rem;">âš ï¸ ë¯¸ë°°ì •</b>
                <div id="unassignedList" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px; justify-content: center;"></div>
            </div>
        </div>
        <div class="tier-board" id="tierBoard"></div>
    </div>
    
    <div class="card admin-only" style="background:#fffde7; border:2px solid var(--ball-yellow);">
        <div class="card-title" style="border-bottom-color:#fbc02d;">ğŸ“… ìŠ¹ê°•ê¸‰ ê´€ë¦¬ (í´ë” ì„ íƒ)</div>
        <div style="margin-bottom:10px;">
            <label style="font-size:0.9rem; margin-bottom:3px; display:block;">ëŒ€ìƒ ëŒ€íšŒ(í´ë”) ì„ íƒ:</label>
            <select id="targetFolderSelect" class="input-full"></select>
        </div>
        <button class="btn-action bg-green" onclick="analyzeFolder()">ğŸ” ìŠ¹ê°• ëŒ€ìƒ ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>
    
    <div id="analysisResult" class="card" style="display:none; border:3px solid var(--ball-yellow);">
        <div class="card-title">ğŸ“ˆ ìŠ¹ê°•ê¸‰ ì˜ˆìƒ ëª…ë‹¨</div>
        <div style="font-size:0.8rem; color:#666; margin-bottom:10px;">
            ìë™ìœ¼ë¡œ 1ìœ„ëŠ” ìŠ¹ê¸‰(â–²), ìµœí•˜ìœ„ëŠ” ê°•ë“±(â–¼)ì´ ì²´í¬ë©ë‹ˆë‹¤.<br>
            * 2ëª… ë¯¸ë§Œì¸ ì¡°ëŠ” ì œì™¸ë©ë‹ˆë‹¤.
        </div>
        <div id="analysisContent"></div>
        <div style="margin-top:10px; display:flex; gap:5px;">
            <button class="btn-action bg-green" onclick="applyPromotion()">âœ… í™•ì • ë° ë°˜ì˜</button>
            <button class="btn-action bg-gray" onclick="cancelAnalysis()">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="page-match" class="container page-section">
    <div id="match-folders">
        <div class="card">
            <div class="card-title">
                <span>ğŸ“‚ ë§¤ì¹˜ ê¸°ë¡ì‹¤</span>
                <button id="btnNewFolder" class="btn-action bg-yellow admin-only" style="width:auto; padding:6px 12px; margin:0; font-size:0.9rem;" onclick="createNewFolderMatch()">+ ìƒˆ ë§¤ì¹˜</button>
            </div>
            <div class="card-subtitle">ììœ ë¡œìš´ ê²ŒìŠ¤íŠ¸ ë§¤ì¹˜ì™€ ì›”ë¡€ëŒ€íšŒ ê³µì‹ ê¸°ë¡</div>
            <div class="folder-item folder-guest" onclick="openFolder('Guest Zone')">
                <div style="display:flex; align-items:center;">
                    <span style="font-size:1.8rem; margin-right:10px;">ğŸ‰</span>
                    <div>
                        <div style="font-weight:bold; font-size:1.1rem; color:#0097a7;">ê²ŒìŠ¤íŠ¸ ë§¤ì¹˜ (ììœ  ì´ìš©)</div>
                        <div style="font-size:0.8rem; color:#555;">ëˆ„êµ¬ë‚˜ ììœ ë¡­ê²Œ ë§¤ì¹˜ ìƒì„±/ê¸°ë¡ ê°€ëŠ¥</div>
                    </div>
                </div>
            </div>
            <div id="folderList"></div>
            <div id="matchEmptyMsg" style="text-align:center; padding:40px; color:#aaa; display:none;">ê³µì‹ ê¸°ë¡ ì—†ìŒ â˜ï¸</div>
        </div>
    </div>

    <div id="match-list-in-folder" style="display:none;">
        <div class="card">
            <div class="card-title">
                <div style="display:flex; align-items:center; gap:5px;">
                    <span id="currentFolderName">ğŸ“‚</span>
                    <button class="btn-icon" style="width:24px; height:24px; font-size:0.8rem; background:#eee; color:#333;" onclick="renameFolder()">âœï¸</button>
                </div>
                <button class="btn-action bg-gray" style="width:auto; padding:6px 12px; margin:0; font-size:0.9rem;" onclick="closeFolder()">â¬… ë’¤ë¡œ</button>
            </div>
            <div id="matchesInFolderArea"></div>
            <button id="btnCreateMatchInFolder" class="btn-action bg-yellow" onclick="createNewMatchInFolder()">+ ì´ í´ë”ì— ë§¤ì¹˜ ì¶”ê°€</button>
        </div>
    </div>

    <div id="match-setup" style="display:none;">
        <div class="card">
            <div class="card-title">âš™ï¸ ë§¤ì¹˜ ì„¤ì •</div>
            <input type="text" id="matchDate" class="input-full" placeholder="í´ë”ëª… (ì˜ˆ: 2024-01-01 ëª¨ë˜)">
            <input type="text" id="matchTitle" class="input-full" placeholder="ë§¤ì¹˜ëª… (ì˜ˆ: Aì¡° ì˜ˆì„ )">
            
            <div class="seed-section">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-weight:bold; color:#f57f17; font-size:1rem;">ğŸ‘‘ ì‹œë“œ ì‹œìŠ¤í…œ</div>
                    <button id="seedToggleBtn" onclick="toggleSeedSystem()" style="background:#ccc; border:none; color:white; padding:6px 12px; border-radius:12px; font-family:'Jua'; font-size:0.9rem;">OFF</button>
                </div>
                <div id="seedIconSelect" style="display:none; margin-top:10px; text-align:center;">
                    <label style="margin-right:15px; cursor:pointer;">
                        <input type="radio" name="seedIcon" value="ğŸ‘‘" checked> <span style="font-size:1.2rem;">ğŸ‘‘ ì™•ê´€</span>
                    </label>
                    <label style="cursor:pointer;">
                        <input type="radio" name="seedIcon" value="ğŸ¥"> <span style="font-size:1.2rem;">ğŸ¥ ë³‘ì•„ë¦¬</span>
                    </label>
                </div>
                <div id="seedInfoText" style="font-size:0.85rem; color:#666; margin-top:8px; display:none;"></div>
            </div>

            <label style="margin-top:5px; display:block; font-size:1rem;">ì„ ìˆ˜ ë“±ë¡ (4~12ëª…)</label>
            <div style="display:flex; align-items:center; margin-bottom:5px; font-size:0.9rem;">
                <input type="checkbox" id="checkIsSeed" style="margin-right:5px;">
                <label for="checkIsSeed" style="color:#f57f17; font-weight:bold;">ğŸ‘‘ ì‹œë“œ ì„ ìˆ˜ë¡œ ë“±ë¡</label>
            </div>

            <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">ğŸ‘‡ ëª…ë‹¨ì„ í´ë¦­í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”</div>
            <div id="memberSelector" class="member-selector"></div>

            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="text" id="inputPlayerName" class="input-full" placeholder="ì´ë¦„ ì§ì ‘ ì…ë ¥" style="margin:0;" onkeypress="if(event.key==='Enter'){event.preventDefault(); addMatchPlayer();}">
                <button type="button" class="btn-action bg-green" style="width:70px; margin:0;" onclick="addMatchPlayer()">ì¶”ê°€</button>
            </div>
            
            <div style="font-size:0.8rem; color:#888; margin:5px 0;">ğŸ’¡ ì´ë¦„ì„ ëˆ„ë¥´ë©´ ì‹œë“œ/ì¼ë°˜ ìƒíƒœê°€ ë³€ê²½ë©ë‹ˆë‹¤.</div>
            <div class="player-tags" id="matchPlayerList" style="margin-bottom:15px; min-height:40px;"></div>
            
            <button class="btn-action bg-purple" onclick="goToLadder()">ğŸ² ì‚¬ë‹¤ë¦¬(ìˆœì„œ ë½‘ê¸°)</button>
            <button class="btn-action bg-gray" onclick="cancelMatchSetup()">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="match-ladder" style="display:none;">
        <div class="card">
            <div class="card-title">ğŸ² ìˆœì„œ ì¶”ì²¨</div>
            <div style="text-align: center; margin: 10px 0; color: #666; font-size:0.9rem;">
                <div id="ladderStatusText">ë²ˆí˜¸ ì¶”ì²¨ ëŒ€ê¸° ì¤‘...</div>
            </div>
            <div id="ladderDisplayArea" style="min-height:150px; margin-bottom:10px;"></div>
            
            <button id="btnStartLadder" class="btn-action bg-blue" onclick="runLadderAnimation()">ğŸ° ì¶”ì²¨ ì‹œì‘ (í„°ì¹˜)</button>
            <button id="btnConfirmLadder" class="btn-action bg-green" style="display:none;" onclick="startMatchGame()">ğŸš€ ê²½ê¸° ì‹œì‘</button>
            <button class="btn-action bg-gray" style="margin-top:5px;" onclick="cancelLadderAndGoBack()">â¬… ë‹¤ì‹œ ì„¤ì •</button>
        </div>
    </div>

    <div id="match-game" style="display:none;">
        <div class="card">
            <div class="card-title">
                <div style="display:flex; align-items:center; gap:5px;">
                   <span id="gameTitleDisplay" style="font-size:1rem;"></span>
                   <button class="btn-icon" style="width:24px; height:24px; font-size:0.8rem; background:#eee; color:#333;" onclick="renameMatchTitle()">âœï¸</button>
                </div>
                <button class="btn-action bg-gray" style="width:auto; padding:5px 10px; margin:0; font-size:0.8rem;" onclick="saveAndExitMatch()">ë‚˜ê°€ê¸°</button>
            </div>
            
            <table class="result-table" style="margin-bottom:15px;">
                <thead>
                    <tr><th style="border-radius:8px 0 0 8px;">ìœ„</th><th style="text-align:left;">ì´ë¦„</th><th>ìŠ¹</th><th>ë¬´</th><th>íŒ¨</th><th>ë“</th><th>ì‹¤</th><th>ë“ì‹¤</th><th style="border-radius:0 8px 8px 0;">ìŠ¹ì </th></tr>
                </thead>
                <tbody id="gameRankingBody"></tbody>
            </table>
            
            <div id="tieBreakerBox" style="display:none;" class="tie-breaker-box">
                <div style="font-weight:bold; color:#e65100; margin-bottom:5px; font-size:0.9rem;">âš ï¸ ë™ë¥  ë°œìƒ: ë‚˜ì´ ì…ë ¥ í•„ìš”</div>
                <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">ìŠ¹ì /ë“ì‹¤ì´ ê°™ìœ¼ë©´ ì—°ì¥ì(ë‚˜ì´ìˆœ)ê°€ ìƒìœ„ ë­í¬ë©ë‹ˆë‹¤.</div>
                <div id="tieBreakerInputs"></div>
            </div>

            <div id="gameMatchList"></div>
            
            <div style="display:flex; gap:5px; margin-top:10px;">
                <button class="btn-action bg-green" onclick="saveAndExitMatch()">ğŸ’¾ ì €ì¥ ë° ì¢…ë£Œ</button>
                <button class="btn-action bg-red" onclick="resetMatchScores()" style="width:40%; background:#ffcdd2; color:#d32f2f;">â†º ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>
</div>

<div id="page-team" class="container page-section">
    <div class="card" style="background: linear-gradient(145deg, #ffffff, #f0f0f0); border:none; box-shadow: 5px 5px 15px #d1d1d1, -5px -5px 15px #ffffff;">
        <div class="card-title">ğŸ“Š ë‹¨ì²´ì „ ë¶„ì„ ì„¼í„° (3D)</div>
        
        <div style="display:flex; height:200px; gap:10px; margin-bottom:15px;">
            <div style="width:50%; position:relative; padding:5px; background:white; border-radius:15px; box-shadow:inset 2px 2px 5px rgba(0,0,0,0.05);">
                <canvas id="teamWinRateChart"></canvas>
                <div style="text-align:center; font-size:0.8rem; margin-top:5px; font-weight:bold; color:#555;">ë¶€ì„œë³„ ì…ìƒë ¥</div>
            </div>
            <div style="width:50%; position:relative; padding:5px; background:white; border-radius:15px; box-shadow:inset 2px 2px 5px rgba(0,0,0,0.05);">
                <canvas id="teamPartiChart"></canvas>
                <div style="text-align:center; font-size:0.8rem; margin-top:5px; font-weight:bold; color:#555;">ì°¸ì—¬ì™• Top 5</div>
            </div>
        </div>

        <div id="teamFunStats" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:10px;">
            <div class="stat-badge-3d">
                <div class="sb-icon">ğŸ”¥</div>
                <div class="sb-content">
                    <div class="sb-label">ì´ ì¶œì „ ë¶€ì„œ</div>
                    <div class="sb-val" id="statTotalGames">0</div>
                </div>
            </div>
            <div class="stat-badge-3d">
                <div class="sb-icon">ğŸ¤</div>
                <div class="sb-content">
                    <div class="sb-label">ìµœê³ ì˜ ì„±ì  ë“€ì˜¤</div>
                    <div class="sb-val" id="statBestDuo">-</div>
                </div>
            </div>
            <div class="stat-badge-3d" style="grid-column: span 2;">
                <div class="sb-icon">ğŸ‘‘</div>
                <div class="sb-content">
                    <div class="sb-label">ì„±ì  ê¸°ì—¬ì™• (í¬ì¸íŠ¸)</div>
                    <div class="sb-val" id="statMVP">-</div>
                </div>
            </div>
         </div>
        </div>
    <div class="card">
        <div class="card-title">
  <div id="teamListTitle" style="width:100%; display:flex; justify-content:space-between; align-items:center;">
                <span>ğŸ›¡ï¸ ëŒ€íšŒ ì¼ì • ë° ê¸°ë¡</span>
                <div style="display:flex; gap:5px;">
                    <button class="btn-action bg-purple admin-only" style="width:auto; padding:5px 10px; margin:0; font-size:0.8rem;" onclick="openPresetManager()">âš™ï¸ í”„ë¦¬ì…‹ ì„¤ì •</button>
                    <button class="btn-action bg-blue admin-only" style="width:auto; padding:5px 10px; margin:0; font-size:0.8rem;" onclick="openTeamEditor()">+ ë“±ë¡</button>
                </div>
            </div>
            <div id="teamDetailHeader" style="display:none; align-items:center; justify-content:space-between; width:100%;">
                <div style="display:flex; align-items:center; gap:5px;">
                    <span id="teamDetailName" style="font-weight:bold;"></span>
                </div>
                <button class="btn-action bg-gray" style="width:auto; padding:5px 10px; margin:0; font-size:0.9rem;" onclick="closeTeamDetail()">â¬… ëª©ë¡</button>
            </div>
        </div>

        <div id="teamFilterBar" style="background:#f1f8e9; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #c5e1a5;">
            <div style="display:flex; gap:5px;">
                <select id="teamYearFilter" class="input-full" style="margin:0; width:35%; font-size:0.9rem;" onchange="renderTeamTab()">
                    <option value="all">ì „ì²´</option>
                </select>
                <input type="text" id="teamSearchFilter" class="input-full" style="margin:0; font-size:0.9rem;" placeholder="ê²€ìƒ‰..." onkeyup="renderTeamTab()">
            </div>
        </div>

        <div id="teamTourneyList"></div>

        <div id="teamDetailView" style="display:none; padding-top:10px;">
            <div id="teamDetailContent"></div>
            <div style="text-align:center; margin-top:20px;">
                <button id="btnEditCurrentTeam" class="btn-action bg-yellow admin-only" style="width:auto;" onclick="">âœï¸ ì´ ëŒ€íšŒ ìˆ˜ì •í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<div id="teamEditorModal" class="modal-overlay">
    <div class="modal" onclick="event.stopPropagation()" style="max-width:600px;">
        <h3 id="teamEditorTitle" style="text-align:center; margin-top:0;">ëŒ€íšŒ ì„¤ì •</h3>
        
        <div style="background:#e3f2fd; padding:10px; border-radius:10px; margin-bottom:15px;">
            <label style="font-weight:bold;">ê¸°ë³¸ ì •ë³´</label>
            <input type="text" id="tEditName" class="input-full" placeholder="ëŒ€íšŒëª… (ì˜ˆ: 2024 ì „ë°˜ê¸° ì¥ìœ ì—°í•©íšŒ)">
            <input type="date" id="tEditDate" class="input-full">
            <input type="text" id="tEditResult" class="input-full" placeholder="ì¢…í•© ê²°ê³¼ (ì˜ˆ: ê¸ˆë°° ìš°ìŠ¹, ì€ë°° 8ê°•)">
            
            <label style="font-weight:bold; margin-top:10px; display:block;">ğŸ“‹ í”„ë¦¬ì…‹ ë¶ˆëŸ¬ì˜¤ê¸° (6ê°œ)</label>
            <div id="presetButtonsArea" style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:5px;">
                </div>
        </div>

        <div id="tDivisionsArea" style="max-height:400px; overflow-y:auto;"></div>
        
        <button class="btn-action bg-yellow" onclick="addDivisionSlot()">+ ë¶€ì„œ(íŒ€) ìˆ˜ë™ ì¶”ê°€</button>
        
        <div style="display:flex; gap:5px; margin-top:15px;">
            <button class="btn-action bg-green" onclick="saveTeamTournament()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
            <button class="btn-action bg-red" onclick="deleteTeamTournament()" id="btnDelTeam" style="display:none;">ì‚­ì œ</button>
            <button class="btn-action bg-gray" onclick="closeModal('teamEditorModal')">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<div id="presetManagerModal" class="modal-overlay" onclick="closeModal('presetManagerModal')">
    <div class="modal" onclick="event.stopPropagation()" style="max-width:600px;">
        <h3 style="text-align:center; margin-top:0;">âš™ï¸ ëŒ€íšŒ í”„ë¦¬ì…‹ ê´€ë¦¬ (ìµœëŒ€ 6ê°œ)</h3>
        <div style="font-size:0.8rem; color:#666; margin-bottom:10px; text-align:center;">
            ìì£¼ ì“°ëŠ” ëŒ€íšŒ êµ¬ì„±ì„ ë¯¸ë¦¬ ì €ì¥í•´ë‘ì„¸ìš”.<br>
            ì˜ˆ: "ê¸ˆë°°,ì€ë°°,ë™ë°° (ê° 3ë³µì‹)"
        </div>
        
        <div id="presetEditList" style="max-height:60vh; overflow-y:auto;"></div>
        
        <div style="display:flex; gap:5px; margin-top:15px;">
            <button class="btn-action bg-green" onclick="saveAllPresets()">ğŸ’¾ í”„ë¦¬ì…‹ ì „ì²´ ì €ì¥</button>
            <button class="btn-action bg-gray" onclick="closeModal('presetManagerModal')">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<div id="teamMemberSelectModal" class="modal-overlay" onclick="closeModal('teamMemberSelectModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <h3 style="text-align:center;">ì¶œì „ ì„ ìˆ˜ ì„ íƒ</h3>
        <input type="text" id="teamMemSearch" class="input-full" placeholder="ì´ë¦„ ê²€ìƒ‰..." onkeyup="renderTeamMemberSelector()">
        <div id="teamMemberGrid" class="member-selector" style="max-height:300px;"></div>
        <button class="btn-action bg-gray" onclick="closeModal('teamMemberSelectModal')">ë‹«ê¸°</button>
    </div>
</div>

<div id="page-history" class="container page-section">
    <div class="card">
        <div class="card-title">ğŸ“œ ë“±ê¸‰ ë³€ê²½ ë° ëŒ€íšŒ ê¸°ë¡</div>
        <div class="card-subtitle">ëª¨ë˜ í…Œë‹ˆìŠ¤ í´ëŸ½ì˜ ë°œìì·¨</div>
        <div id="historyListArea"><div style="text-align:center; padding:30px; color:#aaa;">ê¸°ë¡ ì—†ìŒ â˜ï¸</div></div>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" onclick="goTab('rank')">
        <span class="nav-icon">ğŸ†</span><span class="nav-text">ë“±ê¸‰í˜„í™©</span>
    </div>
    <div class="nav-item" onclick="goTab('match')">
        <span class="nav-icon">ğŸ¾</span><span class="nav-text">ë§¤ì¹˜</span>
    </div>
    <div class="nav-item" onclick="goTab('team')">
        <span class="nav-icon">ğŸ›¡ï¸</span><span class="nav-text">ë‹¨ì²´ì „</span>
    </div>
    <div class="nav-item" onclick="goTab('history')">
        <span class="nav-icon">ğŸ“œ</span><span class="nav-text">íˆìŠ¤í† ë¦¬</span>
    </div>
</div>
<div id="fullPhotoModal" class="modal-overlay" onclick="closeFullPhoto()">
    <div style="text-align:center; width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
        <img id="fullPhotoImg" src="" style="max-width:95vw; max-height:85vh; border-radius:10px; box-shadow:0 0 30px rgba(0,0,0,0.9); border:4px solid white;">
    </div>
</div>

<div id="detailStatsModal" class="modal-overlay" onclick="closeModal('detailStatsModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <h3 id="detailTitle" style="text-align:center; margin-top:0; border-bottom:2px solid #eee; padding-bottom:10px;">ğŸ“‹ ìƒì„¸ ì„±ì í‘œ</h3>
        <div id="detailContent" style="overflow-x:auto;"></div>
        <button class="btn-action bg-gray" onclick="closeModal('detailStatsModal')">ë‹«ê¸°</button>
    </div>
</div>

<div id="playerModal" class="modal-overlay" onclick="closeModal('playerModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <div style="text-align:center;">
            <div style="position:relative; display:inline-block;">
                <img id="pModalImg" class="profile-large" src="" onclick="openFullPhoto()" style="cursor:zoom-in;">
                <div class="photo-edit-overlay" onclick="triggerPhotoUpload()">ğŸ“·</div>
            </div>
            <div style="font-size:0.8rem; color:blue; margin-bottom:5px; cursor:pointer;" onclick="triggerPhotoUpload()">ğŸ“¸ ì‚¬ì§„ ë³€ê²½</div>
            <input type="file" id="pModalFile" style="display:none;" accept="image/*" onchange="updatePlayerPhoto(this)">
            <h3 id="pModalName" style="margin:0; color:var(--court-dark);"></h3>
            <div id="pModalTier" style="font-weight:bold; color:#666; margin-bottom:10px;"></div>
        </div>
        
        <div class="admin-only" style="background:#f5f5f5; padding:10px; border-radius:10px; margin-bottom:15px;">
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:5px;">
                <button onclick="manualSetTier('A')" style="padding:8px; border:none; border-radius:5px; background:var(--tier-a); color:white;">A</button>
                <button onclick="manualSetTier('A(-)')" style="padding:8px; border:none; border-radius:5px; background:var(--tier-am); color:#d84315;">A-</button>
                <button onclick="manualSetTier('B')" style="padding:8px; border:none; border-radius:5px; background:var(--tier-b); color:#333;">B</button>
                <button onclick="manualSetTier('B(-)')" style="padding:8px; border:none; border-radius:5px; background:var(--tier-bm); color:#333;">B-</button>
                <button onclick="manualSetTier('C')" style="padding:8px; border:none; border-radius:5px; background:var(--tier-c); color:white;">C</button>
                <button onclick="manualSetTier('C(-)')" style="padding:8px; border:none; border-radius:5px; background:var(--tier-cm); color:#333;">C-</button>
                <button onclick="manualSetTier('D')" style="padding:8px; border:none; border-radius:5px; background:var(--tier-d); color:white;">D</button>
                <button onclick="manualSetTier(null)" style="padding:8px; border:none; border-radius:5px; background:#999; color:white;">X</button>
            </div>
        </div>
        
        <input type="hidden" id="pModalPhone">
        
        <div class="chart-3d-box">
            <h4 style="margin:0 0 10px 0; color:#555;">ğŸ“Š ìŠ¹ë¥  ë° ì›”ë³„ íë¦„</h4>
            <div style="font-size:0.9rem; margin-bottom:10px;" id="playerStatsText"></div>
            <div style="display:flex; height:160px; gap:5px;">
                 <div style="width:40%; position:relative;"><canvas id="winRateChart"></canvas></div>
                 <div style="width:60%; position:relative;"><canvas id="rankLineChart"></canvas></div>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:end; margin:15px 0 5px 0;">
            <h4 style="margin:0;">ğŸ… ìµœê·¼ ëŒ€íšŒ ìˆœìœ„</h4>
            <span style="font-size:0.75rem; color:#888; font-weight:normal;">(ğŸ‘‡ ê¸°ë¡ì„ ëˆ„ë¥´ë©´ ìƒì„¸ê²°ê³¼ê°€ ë‚˜ì˜µë‹ˆë‹¤)</span>
        </div>
        <div id="pHistoryList" style="height:180px; overflow-y:auto; padding:2px;"></div>
        <button class="btn-action bg-gray" onclick="closeModal('playerModal')">ë‹«ê¸°</button>
    </div>
</div>

<div id="backupModal" class="modal-overlay" onclick="closeModal('backupModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <h3 style="text-align:center;">ë°ì´í„° ë°±ì—… & ì €ì¥</h3>
        <button class="btn-action bg-teal" style="margin-top:0;" onclick="exportExcel()">ğŸ“Š ì—‘ì…€ë¡œ ëª…ë‹¨ ì €ì¥</button>
        <button class="btn-action bg-blue" onclick="openPrintPreview()">ğŸ–¨ï¸ A4ë“±ê¸‰í‘œ ì¸ì‡„ ë° ì‚¬ì§„ ì €ì¥</button>      
        <button class="btn-action bg-gray" onclick="exportData()">ğŸ’¾ ë°±ì—… íŒŒì¼(JSON) ë‹¤ìš´</button>
        <div style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
    <div style="font-weight:bold; margin-bottom:5px;">ğŸ”„ ë°ì´í„° ë³µêµ¬</div>
    
    <input type="file" id="restoreFile" accept=".json,application/json,text/plain" style="width:100%; margin-bottom:5px;">
    <button class="btn-action bg-red" onclick="importData()" style="margin-bottom:10px;">1. íŒŒì¼ë¡œ ë³µêµ¬</button>
    
    <div style="text-align:center; font-size:0.8rem; color:#888; margin-bottom:5px;">ë˜ëŠ” (í¬ë¡¬ ê¶Œì¥)</div>
    
    <textarea id="restoreText" class="input-full" placeholder="ë°±ì—… íŒŒì¼ ë‚´ìš©ì„ ë³µì‚¬í•´ì„œ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”" style="height:80px; font-size:0.8rem; font-family:'sans-serif';"></textarea>
    <button class="btn-action bg-purple" onclick="importDataByText()">2. í…ìŠ¤íŠ¸ë¡œ ë³µêµ¬í•˜ê¸°</button>
</div>
        <button class="btn-action bg-gray" onclick="closeModal('backupModal')">ë‹«ê¸°</button>
    </div>
</div>

<div id="adminSettingsModal" class="modal-overlay" onclick="closeModal('adminSettingsModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <h3 style="text-align:center;">âš™ï¸ ê´€ë¦¬ì ì„¤ì •</h3>
        <div style="margin-bottom:15px;">
            <label style="font-weight:bold;">ğŸ”‘ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</label>
            <input type="text" id="newAdminPwd" class="input-full" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            <button class="btn-action bg-green" onclick="changeAdminPassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
        </div>
        <button class="btn-action bg-gray" onclick="closeModal('adminSettingsModal')">ë‹«ê¸°</button>
    </div>
</div>

<div id="memberManagerModal" class="modal-overlay" onclick="closeModal('memberManagerModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <h3 style="text-align:center;">ğŸ‘¥ íšŒì› ê´€ë¦¬</h3>
        <div style="background:#e8f5e9; padding:10px; border-radius:10px; margin-bottom:15px;">
            <div style="font-size:0.9rem; margin-bottom:5px; font-weight:bold;" id="memberActionTitle">íšŒì› ë“±ë¡</div>
            <input type="hidden" id="currentEditPhone"> <input type="text" id="newMemberName" class="input-full" placeholder="ì´ë¦„ (í•„ìˆ˜)" style="margin-bottom:5px;">
            <input type="text" id="newMemberPhone" class="input-full" placeholder="ì „í™”ë²ˆí˜¸ (ì„ íƒ)" style="margin-bottom:5px;">
            <div style="margin-bottom:5px;">
                <span style="font-size:0.8rem;">ğŸ“¸ í”„ë¡œí•„ ì‚¬ì§„: </span>
                <input type="file" id="newMemberPhoto" accept="image/*" style="font-size:0.8rem;">
            </div>
            <button class="btn-action bg-green" onclick="addNewMember()">ë“±ë¡ / ìˆ˜ì •</button>
            <button class="btn-action bg-red admin-only" id="btnDeleteMember" onclick="deleteMember()" style="margin-top:5px; display:none;">ğŸ—‘ï¸ íšŒì› ì‚­ì œ</button>
        </div>
        <div id="memberListForAdmin" style="height:250px; overflow-y:auto; border:1px solid #eee; border-radius:5px;"></div>
        <button class="btn-action bg-gray" style="margin-top:10px;" onclick="closeModal('memberManagerModal')">ë‹«ê¸°</button>
    </div>
</div>
<div id="mvpModal" class="modal-overlay" onclick="closeModal('mvpModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <h3 style="text-align:center; margin-top:0; border-bottom:2px solid #eee; padding-bottom:10px;">ğŸ† ì‹œì¦Œ MVP ë­í‚¹</h3>
        
        <div style="background:#f5f5f5; padding:10px; border-radius:8px; font-size:0.8rem; color:#555; margin-bottom:10px;">
            <b>[ì ìˆ˜ ì‚°ì • ê¸°ì¤€]</b><br>
            â€¢ ì›”ë¡€ëŒ€íšŒ/ë‹¨ì²´ì „ ì°¸ê°€: <b style="color:blue">+10ì </b><br>
            â€¢ ì›”ë¡€ëŒ€íšŒ ì„±ì  (ê°™ì€ ë“±ê¸‰ ë‚´):<br>
            &nbsp;&nbsp;ğŸ¥‡1ìœ„(+10), ğŸ¥ˆ2ìœ„(+5), ğŸ¥‰3ìœ„(+3)
        </div>

        <div id="mvpListArea" style="max-height:50vh; overflow-y:auto; border:1px solid #eee; border-radius:8px; margin-bottom:10px;">
            </div>

        <button class="btn-action bg-gray" onclick="closeModal('mvpModal')">ë‹«ê¸°</button>
    </div>
</div>

<div id="mvpDetailModal" class="modal-overlay" onclick="closeModal('mvpDetailModal')" style="z-index:3200;">
    <div class="modal" onclick="event.stopPropagation()">
        <h3 id="mvpDetailName" style="text-align:center; margin-top:0;"></h3>
        <div id="mvpDetailContent" style="max-height:300px; overflow-y:auto; margin-bottom:10px;"></div>
        <button class="btn-action bg-gray" onclick="closeModal('mvpDetailModal')">ë’¤ë¡œê°€ê¸°</button>
    </div>
</div>
<div id="printReportModal" class="report-modal">
    <div class="report-btns">
        <button class="btn-rep btn-print" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„ / PDF ì €ì¥</button>
        <button class="btn-rep btn-print" style="background:#e67e22; margin-left:5px;" onclick="saveReportAsImage()">ğŸ“¸ ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
        <button class="btn-rep btn-close" onclick="document.getElementById('printReportModal').style.display='none'">ë‹«ê¸°</button>
    </div>
    <div class="a4-paper">
        <div class="report-header">
            <div class="report-title" id="reportTitleDisplay"></div>
            <div class="report-date" id="reportDateDisplay"></div>
        </div>
        <div id="reportContent"></div>
    </div>
</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Firebase ì„¤ì • (ê¸°ì¡´ ê²ƒ ìœ ì§€)
    const firebaseConfig = {
      apiKey: "AIzaSyBDdJpn7gkb_8mnHaQpp3olHuE_Un_Aj7A",
      authDomain: "lsytennis.firebaseapp.com",
      databaseURL: "https://lsytennis-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "lsytennis",
      storageBucket: "lsytennis.firebasestorage.app",
      messagingSenderId: "1020734955594",
      appId: "1:1020734955594:web:e458c058cad48f313ec6b3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // [ìˆ˜ì •] ì£¼ì†Œ ë’¤ ?id=ê°’ ì— ë”°ë¼ ë°ì´í„° ì €ì¥ ê²½ë¡œ ë¶„ë¦¬
  const urlParams = new URLSearchParams(window.location.search);
const USER_ID = urlParams.get('id') || 'default'; 
const ROOT = `users/${USER_ID}/`; 
const ADMIN_STORAGE_KEY = 'rankAdmin_' + USER_ID;

    // ì´í•˜ ê¸°ì¡´ ìƒìˆ˜ ë° ë³€ìˆ˜ ì„ ì–¸ (TIERS, FIXED_SCHEDULES ë“±)ì€ ê·¸ëŒ€ë¡œ ë‘ì„¸ìš”.

    const TIERS = ['A', 'A(-)', 'B', 'B(-)', 'C', 'C(-)', 'D'];
    const TIER_STYLES = { 'A':'col-A', 'A(-)':'col-Am', 'B':'col-B', 'B(-)':'col-Bm', 'C':'col-C', 'C(-)':'col-Cm', 'D':'col-D' };
    const GUEST_FOLDER = "Guest Zone";
    const TIER_SCORES = { 'A':7, 'A(-)':6, 'B':5, 'B(-)':4, 'C':3, 'C(-)':2, 'D':1 };
    
    const REVERSE_TIER_MAP = { 'A': 'A(-)', 'A(-)': 'B', 'B': 'B(-)', 'B(-)': 'C', 'C': 'C(-)', 'C(-)': 'D', 'D': 'D' };
    const PROMOTE_TIER_MAP = { 'A(-)': 'A', 'B': 'A(-)', 'B(-)': 'B', 'C': 'B(-)', 'C(-)': 'C', 'D': 'C(-)' };
    const DOWN_TIER_MAP = { 'A': 'A(-)', 'A(-)': 'B', 'B': 'B(-)', 'B(-)': 'C', 'C': 'C(-)', 'C(-)': 'D', 'D': 'D' };

    const FIXED_SCHEDULES = {
        4: [ [1,2,3,4], [1,3,2,4], [1,4,2,3] ],
        5: [ [1,2,3,4], [1,3,2,5], [1,4,3,5], [1,5,2,4], [2,3,4,5] ],
        6: [ [1,2,3,4], [1,5,4,6], [2,3,5,6], [1,4,2,5], [2,4,3,6], [1,6,3,5] ],
        7: [ [1,2,3,4], [5,6,1,7], [3,5,2,4], [1,4,6,7], [2,3,5,7], [1,6,2,5], [4,6,3,7] ],
        8: [ [1,2,3,4], [5,6,7,8], [1,3,5,7], [2,4,6,8], [3,7,4,8], [1,5,2,6], [1,6,3,8], [2,5,4,7] ],
        9: [ [1,2,3,4], [5,6,7,8], [1,9,5,7], [2,3,6,8], [4,9,3,8], [1,5,2,6], [1,7,8,9], [3,6,4,5], [2,4,7,9] ],
        10: [ [1,2,3,4], [5,6,7,8], [2,3,6,10], [1,9,5,8], [3,10,4,5], [2,7,8,9], [4,10,6,8], [1,3,7,9], [4,6,5,9], [1,7,2,10] ],
        11: [ [1,2,3,4], [5,6,7,8], [1,11,9,10], [2,3,6,8], [4,10,5,7], [2,6,9,11], [1,3,5,11], [4,9,8,10], [1,7,2,8], [5,10,6,11], [3,9,4,7] ],
        12: [ [1,2,3,4], [5,6,7,8], [9,10,11,12], [1,5,2,6], [3,9,4,10], [7,11,8,12], [1,3,5,9], [2,4,6,10], [7,12,1,4], [8,11,2,3], [6,7,9,11], [5,8,10,12] ]
    };
    const AUTO_SEEDS = {
        4: [], 5: [], 6: [1,3], 7: [1,5], 8: [1,7], 9: [1,4,8], 10: [1,8,10], 11: [1,5,8,9], 12: [1,6,9,12]
    };
    const ALL_SEED_INFO = "6ëª…:1,3 / 7ëª…:1,5 / 8ëª…:1,7 / 9ëª…:1,4,8 / 10ëª…:1,8,10";
    const MIN_PLAYERS=4; const MAX_PLAYERS=12;

    window.allMembers = [];
    window.matchHistory = [];
    window.rankingData = { tiers: {}, history: [], settings: { adminPwd: '1234' } };
    window.isAdmin = false;
    window.analysisTemp = null;
    window.currentFolder = null; 
    window.chartInstances = { win:null, rank:null };

    window.currentMatch = { id: null, players: [], matches: [], useSeed: false, seedIcon: 'ğŸ‘‘', date: '', title: '' };

    // ì•± ì¢…ë£Œ/ìƒˆë¡œê³ ì¹¨ ë°©ì§€ ì½”ë“œ 
    window.addEventListener('beforeunload', (event) => {
        event.preventDefault();
        event.returnValue = '';
    });
    history.pushState(null, null, location.href);

    window.onpopstate = function () {
        history.pushState(null, null, location.href); 
        alert("âš ï¸ ë’¤ë¡œê°€ê¸° ë²„íŠ¼ì„ í•œë²ˆ ë” ëˆ„ë¥´ë©´ ì•±ì€ ì¢…ë£Œ ë©ë‹ˆë‹¤.");
    };
    
    window.onload = () => {
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);

        // Firebase ë°ì´í„° ë¡œë“œ
        onValue(ref(db, ROOT + 'clubData/members'), (snap) => {
            window.allMembers = snap.val() || [];
            let shouldSave = false;

            // [FIX: 3ë‹¨ê³„] phone í•„ë“œê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆëŠ” ê¸°ì¡´ íšŒì›ì—ê²Œ ID ê°•ì œ ë¶€ì—¬
            window.allMembers.forEach(m => {
                if (!m.phone || m.phone.trim() === '') {
                    // m_fix + timestamp + random ID ë¶€ì—¬
                    m.phone = 'm_fix' + Date.now().toString().slice(-8) + Math.floor(Math.random() * 1000);
                    shouldSave = true;
                }
            });

            if (shouldSave) {
                // IDê°€ ì—†ë˜ íšŒì› ì •ë³´ë¥¼ Firebaseì— ì¦‰ì‹œ ì—…ë°ì´íŠ¸í•˜ì—¬ ì˜¤ë¥˜ ìˆ˜ì •
                set(ref(db, ROOT + 'clubData/members'), window.allMembers);
            }
        });
        
        onValue(ref(db, ROOT + 'tennisHistory'), (snap) => {
            const val = snap.val();
            window.matchHistory = val ? Object.values(val) : [];
            populateFolderSelect();
            
            if(document.getElementById('match-game').style.display === 'block') return;
            
            if(document.getElementById('page-match').classList.contains('active')) {
                if(window.currentFolder) renderMatchesInFolder();
                else renderMatchFolderView();
            }
        });

        onValue(ref(db, ROOT + 'rankingData'), (snap) => {
            if(snap.val()) window.rankingData = snap.val();
            if(!window.rankingData.tiers) window.rankingData.tiers = {};
            if(!window.rankingData.history) window.rankingData.history = [];
            if(!window.rankingData.settings) window.rankingData.settings = { adminPwd: '1234' };
            renderBoard();
            renderHistoryTab();
        });
        if(localStorage.getItem('rankAdmin') === 'true') { window.isAdmin = true; updateAdminUI(); }
    };
    
    function updateCurrentTime() {
        const now = new Date();
        const str = `${now.getMonth()+1}ì›” ${now.getDate()}ì¼ ${now.getHours()}ì‹œ ${now.getMinutes()}ë¶„`;
        document.getElementById('realTimeClock').innerText = str;
    }

    window.goTab = (tab) => {
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`page-${tab}`).classList.add('active');
        const idx = tab === 'rank' ? 0 : tab === 'match' ? 1 : 2;
        document.querySelectorAll('.nav-item')[idx].classList.add('active');
        if(tab === 'rank') renderBoard();
        if(tab === 'match') { window.currentFolder = null; renderMatchFolderView(); }
        if(tab === 'history') renderHistoryTab();
    }

    // --- íšŒì› ê´€ë¦¬ ê¸°ëŠ¥ ìˆ˜ì •/ì¶”ê°€ (ëª©ë¡ í´ë¦­ ìˆ˜ì •/ì‚­ì œ í™œì„±í™”) ---
    window.openMemberManager = () => { 
        document.getElementById('memberManagerModal').style.display='flex'; 
        // ëª¨ë‹¬ ì—´ ë•Œ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” (ë“±ë¡ ëª¨ë“œ ì¤€ë¹„)
        document.getElementById('memberActionTitle').innerText = "íšŒì› ë“±ë¡";
        document.getElementById('currentEditPhone').value = "";
        document.getElementById('newMemberName').value = "";
        document.getElementById('newMemberPhone').value = "";
        document.getElementById('newMemberPhoto').value = "";
        document.getElementById('btnDeleteMember').style.display = 'none';

        renderMemberListForAdmin();
    }
    
    function renderMemberListForAdmin() {
        const listDiv = document.getElementById('memberListForAdmin');
        listDiv.innerHTML = window.allMembers.map(m => {
            const isInternalId = m.phone && m.phone.startsWith('m');
            const displayPhone = (m.phone && !isInternalId) ? `(${m.phone})` : '<span style="color:#aaa;">(ID)</span>';

            // [FIX: 1ë‹¨ê³„] ëª©ë¡ í´ë¦­ ì‹œ loadMemberToManager í˜¸ì¶œ
            return `<div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;" onclick="loadMemberToManager('${m.phone}')">
                        <span style="font-weight:bold;">${m.name}</span> <span style="font-size:0.8rem; color:#666;">${displayPhone}</span>
                    </div>`;
        }).join('');
    }

    // [FIX: 2ë‹¨ê³„] Manager ëª¨ë‹¬ ì „ìš© ë¡œë” í•¨ìˆ˜
    window.loadMemberToManager = (phoneId) => {
        const member = window.allMembers.find(m => m.phone === phoneId);
        if(!member) return;

        document.getElementById('memberActionTitle').innerText = "íšŒì› ìˆ˜ì •/ì‚­ì œ";
        document.getElementById('currentEditPhone').value = member.phone;
        document.getElementById('newMemberName').value = member.name;
        
        const isInternalId = member.phone && member.phone.startsWith('m');
        // ë‚´ë¶€ IDê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ phone í•„ë“œì— ê°’ì„ ì±„ì›Œë„£ìŒ
        document.getElementById('newMemberPhone').value = isInternalId ? '' : (member.phone || ''); 
        
        document.getElementById('btnDeleteMember').style.display = 'block';
    }


    // [FIX: 2ë‹¨ê³„] ì‚­ì œ í•¨ìˆ˜
    window.deleteMember = () => {
        const phoneId = document.getElementById('currentEditPhone').value;
        const name = document.getElementById('newMemberName').value;
        
        if (!phoneId) return alert("ì‚­ì œí•  íšŒì›ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ëª©ë¡ì—ì„œ íšŒì›ì„ í´ë¦­í•´ ì£¼ì„¸ìš”.");

        if (confirm(`ì •ë§ ${name} íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë“±ê¸‰ ì •ë³´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)`)) {
            // phoneIdëŠ” ì´ì œ m_fixì´ë“ , ì‹¤ì œ ì „í™”ë²ˆí˜¸ì´ë“  ê³ ìœ í•¨ì´ ë³´ì¥ë¨
            window.allMembers = window.allMembers.filter(m => m.phone !== phoneId);
            
            if(window.rankingData.tiers[phoneId]) delete window.rankingData.tiers[phoneId];

            set(ref(db, ROOT + 'clubData/members'), window.allMembers)
                .then(() => set(ref(db, ROOT + 'rankingData/tiers'), window.rankingData.tiers))
                .then(() => {
                    alert("íšŒì› ë° ë“±ê¸‰ ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    openMemberManager(); 
                    renderBoard(); 
                    renderMemberSelector(); 
                });
        }
    }
    
    // [FIX: 2ë‹¨ê³„] ë“±ë¡/ìˆ˜ì • í•¨ìˆ˜
    window.addNewMember = async () => { 
        const name = document.getElementById('newMemberName').value.trim();
        let phone = document.getElementById('newMemberPhone').value.trim();
        const fileInput = document.getElementById('newMemberPhoto');
        const currentEditPhone = document.getElementById('currentEditPhone').value; 
        
        if(!name) return alert("ì´ë¦„ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.");
        
        let memberToUpdate = null;
        let isNewMember = true;
        
        if (currentEditPhone) { // ìˆ˜ì • ëª¨ë“œ
            memberToUpdate = window.allMembers.find(m => m.phone === currentEditPhone);
            isNewMember = false;
        } else { // ì‹ ê·œ ë“±ë¡ ëª¨ë“œ
            if (!phone) {
                // ì „í™”ë²ˆí˜¸ ì—†ìœ¼ë©´ m + timestamp + random ID ê°•ì œ ìƒì„±
                phone = 'm' + Date.now().toString().slice(-10) + Math.floor(Math.random() * 100);
            } else {
                if(window.allMembers.some(m => m.phone === phone)) {
                    return alert("ì…ë ¥í•˜ì‹  ì „í™”ë²ˆí˜¸ê°€ ì´ë¯¸ ë‹¤ë¥¸ íšŒì›ì˜ IDë¡œ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. ìˆ˜ì •í•˜ë ¤ë©´ ëª©ë¡ì—ì„œ í•´ë‹¹ íšŒì›ì„ í´ë¦­í•˜ì„¸ìš”.");
                }
            }
            memberToUpdate = { phone, status:'ì •íšŒì›', name: name }; 
        }
        
        // ë°ì´í„° ì—…ë°ì´íŠ¸ ë° ID ê´€ë¦¬
        memberToUpdate.name = name;
        
        if(isNewMember) {
            memberToUpdate.phone = phone; 
        } else if (phone) {
             memberToUpdate.phone = phone; // ì „í™”ë²ˆí˜¸ê°€ ì…ë ¥ë˜ë©´ ì—…ë°ì´íŠ¸
        }
        
        let photo = '';
        if(fileInput.files[0]) { 
            photo = await resizeImage(fileInput.files[0], 300); 
            memberToUpdate.photo = photo;
        } 
        
        if (isNewMember) {
            window.allMembers.push(memberToUpdate);
        } else {
            const index = window.allMembers.findIndex(m => m.phone === currentEditPhone);
            if(index !== -1) window.allMembers[index] = memberToUpdate;
        }

        set(ref(db, ROOT + 'clubData/members'), window.allMembers);
        alert(`íšŒì› ì •ë³´ê°€ ${isNewMember ? 'ë“±ë¡' : 'ìˆ˜ì •'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        openMemberManager(); 
        renderBoard(); 
        renderMemberSelector();
    }


    // --- ë‚˜ë¨¸ì§€ ê¸°ì¡´ í•¨ìˆ˜ë“¤ ---
    
    function renderBoard() {
        const board = document.getElementById('tierBoard');
        const unassignedList = document.getElementById('unassignedList');
        board.innerHTML = ''; unassignedList.innerHTML = '';
        
        const lastHistory = window.rankingData.history.length > 0 
            ? window.rankingData.history[window.rankingData.history.length - 1] : null;

        const groups = {};
        TIERS.forEach(t => {
            groups[t] = [];
            const col = document.createElement('div');
            col.className = `tier-column ${TIER_STYLES[t]}`;
            col.innerHTML = `<div class="tier-header" onclick="showTierHistory('${t}')" id="header-${t.replace(/[(-)]/g, '')}">${t} ì¡°</div><div class="player-list" id="list-${t.replace(/[(-)]/g, '')}"></div>`;
            board.appendChild(col);
        });

        let assignedCount = 0;
        window.allMembers.forEach(m => {
            if(m.status === 'íƒˆíšŒ') return;
            const tier = window.rankingData.tiers[m.phone];
            if (tier && TIERS.includes(tier)) { groups[tier].push(m); assignedCount++; }
            else {
                const btn = document.createElement('button');
                btn.className = 'btn-action';
                btn.style.cssText='width:auto; padding:6px 10px; background:#eee; color:#333; font-size:0.8rem; margin:2px;';
                btn.innerText = m.name;
                btn.onclick = () => openPlayerModal(m);
                unassignedList.appendChild(btn);
            }
        });
        
        document.getElementById('unassignedArea').style.display = (unassignedList.children.length > 0) ? 'block' : 'none';
        document.getElementById('totalMemberCnt').innerText = `ì´ ${assignedCount}ëª…`;

        TIERS.forEach(t => {
            const container = document.getElementById(`list-${t.replace(/[(-)]/g, '')}`);
            const header = document.getElementById(`header-${t.replace(/[(-)]/g, '')}`);
            header.innerText = `${t}ì¡° (${groups[t].length})`;
            const members = groups[t].sort((a,b) => a.name.localeCompare(b.name));
            
            members.forEach(m => {
                const card = document.createElement('div');
                card.className = 'player-card';
                card.onclick = () => openPlayerModal(m);
                
                let rankSign = '';
                if(lastHistory) {
                    const ch = lastHistory.changes.find(c => c.phone === m.phone);
                    if(ch) {
                        if(ch.type === 'up') { 
                            card.classList.add('promo-target'); 
                            rankSign = '<span class="rank-sign" style="color:var(--danger)">â–²</span>'; 
                        } else { 
                            card.classList.add('demo-target'); 
                            rankSign = '<span class="rank-sign" style="color:blue">â–¼</span>'; 
                        }
                    }
                }

                const imgSrc = m.photo || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NjYyI+PGNpcmNsZSBjeD0iMTIiIGN5PSI4IiByPSI0Ii8+PHBhdGggZD0iTTEyIDE0Yy01IDAtOSAzLjExLTkgOHgxOCIvPjwvc3ZnPg==';
                card.innerHTML = `<img src="${imgSrc}" class="player-img-small"><div class="player-name-wrap"><span class="p-name">${m.name}${rankSign}</span></div>`;
                container.appendChild(card);
            });
        });
    }

    window.goToMatchSetup = () => {
        window.currentMatch = { id: Date.now(), players: [], matches: [], useSeed: false, seedIcon: 'ğŸ‘‘', date: '', title: '' };
        document.getElementById('match-folders').style.display='none';
        document.getElementById('match-list-in-folder').style.display='none';
        document.getElementById('match-setup').style.display='block';
        
        const dateInput = document.getElementById('matchDate');
        if(window.currentFolder) {
            dateInput.value = window.currentFolder;
            dateInput.disabled = true; 
            if(window.currentFolder === GUEST_FOLDER) dateInput.style.backgroundColor = "#e0f7fa";
        } else {
            const today = new Date();
            dateInput.value = `${today.getMonth()+1}ì›” ${today.getDate()}ì¼ ëª¨ë˜`;
            dateInput.disabled = false;
        }
        document.getElementById('matchTitle').value = '';
        document.getElementById('inputPlayerName').value = '';
        renderSeedToggleUI();
        renderMatchPlayers();
        renderMemberSelector(); 
    }

    function renderMemberSelector() {
        const div = document.getElementById('memberSelector');
        div.innerHTML = '';
        
        TIERS.forEach(t => {
            const tierMembers = window.allMembers.filter(m => window.rankingData.tiers[m.phone] === t).sort((a,b)=>a.name.localeCompare(b.name));
            if(tierMembers.length > 0) {
                const groupTitle = document.createElement('div');
                groupTitle.style.cssText = "grid-column: 1/-1; font-size:0.8rem; font-weight:bold; margin-top:5px; color:#777;";
                groupTitle.innerText = `${t}ì¡°`;
                div.appendChild(groupTitle);
                
                tierMembers.forEach(m => {
                    const chip = document.createElement('div');
                    chip.className = 'select-chip';
                    chip.innerText = m.name;
                    chip.onclick = () => addMatchPlayer(m.name);
                    div.appendChild(chip);
                });
            }
        });
    }
    
    window.addMatchPlayer = (manualName = null) => {
        const name = manualName || document.getElementById('inputPlayerName').value.trim();
        const isSeedCheck = document.getElementById('checkIsSeed');
        const isSeed = window.currentMatch.useSeed && isSeedCheck.checked;
        
        if(!name) return;
        if(window.currentMatch.players.some(p=>p.name===name)) return alert("ì´ë¯¸ ìˆìŠµë‹ˆë‹¤.");
        if(window.currentMatch.players.length >= MAX_PLAYERS) return alert(`ìµœëŒ€ ${MAX_PLAYERS}ëª…ê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);

        window.currentMatch.players.push({ 
            name, isSeed: isSeed, id: Date.now()+Math.random(), 
            wins:0, draws:0, losses:0, scored:0, conceded:0, pts:0, diff:0, num:0, age:0 
        });
        
        document.getElementById('inputPlayerName').value = '';
        if(!manualName) isSeedCheck.checked = false; 
        renderMatchPlayers();
    }

    function renderMatchPlayers() {
        const iconRadios = document.getElementsByName('seedIcon');
        let selectedIcon = 'ğŸ‘‘';
        iconRadios.forEach(r => { if(r.checked) selectedIcon = r.value; });
        window.currentMatch.seedIcon = selectedIcon;

        document.getElementById('matchPlayerList').innerHTML = window.currentMatch.players.map((p,i) => `
            <div class="tag ${p.isSeed?'is-seed':''}" onclick="togglePlayerSeedStatus(${i})">
                ${p.isSeed ? selectedIcon : ''} ${p.name}
                <span style="margin-left:8px; color:#ff6b6b; font-weight:bold;" onclick="removeMatchPlayer(${i}, event)">&times;</span>
            </div>
        `).join('');
    }

    window.removeMatchPlayer = (idx, e) => {
        e.stopPropagation();
        window.currentMatch.players.splice(idx,1);
        renderMatchPlayers();
    }

    window.togglePlayerSeedStatus = (idx) => {
        if(!window.currentMatch.useSeed) return;
        window.currentMatch.players[idx].isSeed = !window.currentMatch.players[idx].isSeed;
        renderMatchPlayers();
    }

    window.toggleSeedSystem = () => {
        window.currentMatch.useSeed = !window.currentMatch.useSeed;
        renderSeedToggleUI();
        if(!window.currentMatch.useSeed) {
            window.currentMatch.players.forEach(p => p.isSeed = false);
            renderMatchPlayers();
        }
    }

    function renderSeedToggleUI() {
        const btn = document.getElementById('seedToggleBtn');
        const info = document.getElementById('seedInfoText');
        const check = document.getElementById('checkIsSeed');
        const iconSelect = document.getElementById('seedIconSelect');
        
        if(window.currentMatch.useSeed) {
            btn.innerText = "ON"; btn.style.background = "#f57f17";
            info.style.display = "block"; info.innerText = ALL_SEED_INFO;
            check.disabled = false;
            iconSelect.style.display = "block"; 
        } else {
            btn.innerText = "OFF"; btn.style.background = "#ccc";
            info.style.display = "none";
            check.disabled = true; check.checked = false;
            iconSelect.style.display = "none";
        }
    }

    window.goToLadder = () => {
        const cnt = window.currentMatch.players.length;
        if(cnt < MIN_PLAYERS || cnt > MAX_PLAYERS) return alert(`${MIN_PLAYERS}~${MAX_PLAYERS}ëª…ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
        
        if(window.currentMatch.useSeed) {
            const req = (AUTO_SEEDS[cnt]||[]).length;
            const curr = window.currentMatch.players.filter(p=>p.isSeed).length;
            if(req > 0 && req !== curr) return alert(`${cnt}ëª…ì¼ ê²½ìš° ì‹œë“œ ë°°ì •ìëŠ” ì •í™•íˆ ${req}ëª…ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
        }

        document.getElementById('match-setup').style.display='none';
        document.getElementById('match-ladder').style.display='block';
        document.getElementById('btnStartLadder').style.display='block';
        document.getElementById('btnConfirmLadder').style.display='none';
        
        const displayArea = document.getElementById('ladderDisplayArea');
        displayArea.innerHTML = '';
        const statusText = document.getElementById('ladderStatusText');
        
        const allNums = Array.from({length: cnt}, (_, i) => i + 1);
        const seedNums = window.currentMatch.useSeed ? (AUTO_SEEDS[cnt] || []) : [];
        const seedIcon = window.currentMatch.seedIcon || 'ğŸ‘‘';

        if(window.currentMatch.useSeed && seedNums.length > 0) {
            statusText.innerText = `${seedIcon} ì‹œë“œ ê·¸ë£¹ê³¼ ì¼ë°˜ ê·¸ë£¹ì„ ë‚˜ëˆ„ì–´ ì¶”ì²¨í•©ë‹ˆë‹¤.`;
            let html = `<div class="ladder-group"><div class="ladder-group-title" style="color:#e65100">${seedIcon} ì‹œë“œ ê·¸ë£¹ (ìë¦¬: ${seedNums.join(',')})</div>`;
            seedNums.forEach(num => html += createSlotHTML(num, 'seed-slot'));
            html += `</div>`;
            
            html += `<div class="ladder-group"><div class="ladder-group-title">ì¼ë°˜ ê·¸ë£¹</div>`;
            allNums.forEach(num => {
                if(!seedNums.includes(num)) html += createSlotHTML(num, 'normal-slot');
            });
            html += `</div>`;
            displayArea.innerHTML = html;
        } else {
            statusText.innerText = "ğŸ² ì „ì²´ ë¬´ì‘ìœ„ ì¶”ì²¨ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.";
            let html = `<div class="ladder-group">`;
            allNums.forEach(num => html += createSlotHTML(num, 'normal-slot'));
            html += `</div>`;
            displayArea.innerHTML = html;
        }
    }

    function createSlotHTML(num, type) {
        return `<div class="ladder-slot ${type}" id="slot-${num}">
            <div class="slot-num">${num}</div><div class="slot-name" id="slot-name-${num}">?</div>
        </div>`;
    }

    window.runLadderAnimation = async () => {
        document.getElementById('btnStartLadder').style.display='none';
        
        const players = window.currentMatch.players;
        const pCount = players.length;
        const seedNums = window.currentMatch.useSeed ? (AUTO_SEEDS[pCount] || []) : [];
        
        let seedPlayers = [], normalPlayers = [];
        
        if(window.currentMatch.useSeed && seedNums.length > 0) {
            seedPlayers = shuffleArray(players.filter(p => p.isSeed));
            normalPlayers = shuffleArray(players.filter(p => !p.isSeed));
        } else {
            normalPlayers = shuffleArray([...players]);
        }
        
        const promises = [];
        seedNums.forEach((num, i) => {
            promises.push(animateSlot(num, seedPlayers, seedPlayers[i]));
        });
        
        let nIdx = 0;
        for(let i=1; i<=pCount; i++) {
            if(!seedNums.includes(i)) {
                promises.push(animateSlot(i, normalPlayers, normalPlayers[nIdx]));
                nIdx++;
            }
        }
        
        await Promise.all(promises);
        
        if(window.currentMatch.useSeed && seedNums.length > 0) {
            seedPlayers.forEach((p, i) => p.num = seedNums[i]);
            let k = 0;
            for(let i=1; i<=pCount; i++) {
                if(!seedNums.includes(i)) { normalPlayers[k].num = i; k++; }
            }
        } else {
            normalPlayers.forEach((p, i) => p.num = i + 1);
        }
        window.currentMatch.players.sort((a,b) => a.num - b.num);

        document.getElementById('ladderStatusText').innerText = "âœ… ì¶”ì²¨ ì™„ë£Œ! ê²½ê¸°ë¥¼ ì‹œì‘í•˜ì„¸ìš”.";
        document.getElementById('btnConfirmLadder').style.display='block';
    }

    function animateSlot(num, pool, finalP) {
        return new Promise(resolve => {
            const el = document.getElementById(`slot-name-${num}`);
            const duration = 1500 + Math.random() * 1500;
            el.classList.add('spinning');
            
            const timer = setInterval(() => {
                const rnd = pool[Math.floor(Math.random()*pool.length)];
                el.innerText = rnd.name;
            }, 80);
            
            setTimeout(() => {
                clearInterval(timer);
                el.classList.remove('spinning');
                el.innerText = finalP.name;
                el.style.fontWeight = "900";
                el.style.color = "#333";
                resolve();
            }, duration);
        });
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    window.cancelLadderAndGoBack = () => {
        document.getElementById('match-ladder').style.display = 'none';
        document.getElementById('match-setup').style.display = 'block';
    }

    window.startMatchGame = () => {
        window.currentMatch.date = document.getElementById('matchDate').value || 'ë‚ ì§œë¯¸ì •';
        window.currentMatch.title = document.getElementById('matchTitle').value || 'ë¬´ëª… ë§¤ì¹˜';
        const cnt = window.currentMatch.players.length;
        
        const schedule = FIXED_SCHEDULES[cnt];
        window.currentMatch.matches = schedule.map((s, i) => ({
            id: i, 
            t1: [window.currentMatch.players[s[0]-1], window.currentMatch.players[s[1]-1]], 
            t2: [window.currentMatch.players[s[2]-1], window.currentMatch.players[s[3]-1]], 
            s1:0, s2:0, played:false
        }));
        
        saveMatchToFirebase();
        document.getElementById('match-ladder').style.display='none';
        document.getElementById('match-game').style.display='block';
        document.getElementById('gameTitleDisplay').innerText = `${window.currentMatch.date} / ${window.currentMatch.title}`;
        renderGameUI();
    }

    function renderGameUI() {
        const div = document.getElementById('gameMatchList');
        const disabledAttr = ''; 
        const seedIcon = window.currentMatch.seedIcon || 'ğŸ‘‘';

        div.innerHTML = window.currentMatch.matches.map(m => {
            const p1 = m.t1[0], p2 = m.t1[1], p3 = m.t2[0], p4 = m.t2[1];
            
            const renderLeft = (p) => {
                const iconHtml = p.isSeed ? `<span class="seed-box">${seedIcon}</span>` : `<span class="seed-box"></span>`;
                return `<div class="match-p-line p-left">${iconHtml}<span class="name-box">${p.name}</span></div>`;
            };

            const renderRight = (p) => {
                const iconHtml = p.isSeed ? `<span class="seed-box">${seedIcon}</span>` : `<span class="seed-box"></span>`;
                return `<div class="match-p-line p-right"><span class="name-box">${p.name}</span>${iconHtml}</div>`;
            };

            return `
            <div class="match-card ${m.played?'played':''}">
                <div style="text-align:center; font-size:0.7rem; color:#aaa; margin-bottom:5px;">GAME ${m.id+1}</div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="text-align:left; width:42%; font-size:0.9rem;">
                        ${renderLeft(p1)}
                        ${renderLeft(p2)}
                    </div>
                    <div style="display:flex; align-items:center; gap:3px;">
                        <select class="score-select" onchange="updateScore(${m.id}, 1, this.value)" ${disabledAttr}>${[0,1,2,3,4,5,6].map(n=>`<option value="${n}" ${m.s1==n?'selected':''}>${n}</option>`).join('')}</select>
                        <span>:</span>
                        <select class="score-select" onchange="updateScore(${m.id}, 2, this.value)" ${disabledAttr}>${[0,1,2,3,4,5,6].map(n=>`<option value="${n}" ${m.s2==n?'selected':''}>${n}</option>`).join('')}</select>
                    </div>
                    <div style="text-align:right; width:42%; font-size:0.9rem;">
                        ${renderRight(p3)}
                        ${renderRight(p4)}
                    </div>
                </div>
            </div>
        `}).join('');
        updateGameRanking();
    }

    window.updateScore = (mid, team, val) => {
        const m = window.currentMatch.matches.find(x=>x.id===mid);
        if(team===1) m.s1 = parseInt(val); else m.s2 = parseInt(val);
        m.played = (m.s1>0 || m.s2>0);
        
        if(window.currentMatch.id) set(ref(db, ROOT + 'tennisHistory/' + window.currentMatch.id), window.currentMatch);
        renderGameUI();
    }
    
    window.resetMatchScores = () => {
        if(!confirm("í˜„ì¬ ë§¤ì¹˜ì˜ ëª¨ë“  ì ìˆ˜ë¥¼ 0:0ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        window.currentMatch.matches.forEach(m => {
            m.s1 = 0; m.s2 = 0; m.played = false;
        });
        window.currentMatch.players.forEach(p => {
             p.wins=0; p.draws=0; p.losses=0; p.scored=0; p.conceded=0; p.pts=0; p.diff=0;
        });
        saveMatchToFirebase();
        renderGameUI();
    }

    function updateGameRanking() {
        const ps = window.currentMatch.players;
        ps.forEach(p => { p.pts=0; p.diff=0; p.scored=0; p.conceded=0; p.wins=0; p.losses=0; p.draws=0; });
        
        let allPlayed = true;
        window.currentMatch.matches.forEach(m => {
            if(!m.played) { allPlayed = false; return; }
            const diff = m.s1 - m.s2;
            const apply = (team, s, c, res) => team.forEach(tp => {
                const p = ps.find(x=>x.id===tp.id);
                p.scored+=s; p.conceded+=c; p.diff+=(s-c);
                if(res === 'win') { p.pts+=2; p.wins++; }
                else if(res === 'draw') { p.pts+=1; p.draws++; }
                else { p.losses++; }
            });

            if(diff > 0) { 
                apply(m.t1, m.s1, m.s2, 'win'); 
                apply(m.t2, m.s2, m.s1, 'loss'); 
            } else if(diff < 0) { 
                apply(m.t1, m.s1, m.s2, 'loss'); 
                apply(m.t2, m.s2, m.s1, 'win'); 
            } else { 
                apply(m.t1, m.s1, m.s2, 'draw'); 
                apply(m.t2, m.s2, m.s1, 'draw'); 
            }
        });
        
        const sorted = [...ps].sort((a,b) => {
            if(b.pts !== a.pts) return b.pts - a.pts;
            if(b.diff !== a.diff) return b.diff - a.diff;
            return (b.age || 0) - (a.age || 0);
        });

        const tieBox = document.getElementById('tieBreakerBox');
        const tieInputs = document.getElementById('tieBreakerInputs');
        tieInputs.innerHTML = '';
        
        if (allPlayed) {
            const tieGroups = {};
            ps.forEach(p => {
                const key = `${p.pts}_${p.diff}`;
                if(!tieGroups[key]) tieGroups[key] = [];
                tieGroups[key].push(p);
            });
            
            let hasTie = false;
            Object.values(tieGroups).forEach(group => {
                if(group.length > 1) {
                    hasTie = true;
                    const div = document.createElement('div');
                    div.style.marginBottom = "8px";
                    div.style.fontSize = "0.9rem";
                    div.innerHTML = `<span style="color:#e65100; font-weight:bold;">[${group[0].pts}ì  / ë“ì‹¤ ${group[0].diff}]</span> ë™ë¥  ë©¤ë²„: `;
                    
                    group.forEach(p => {
                        div.innerHTML += `
                            <span style="display:inline-block; margin:2px; white-space:nowrap;">
                                ${p.name}
                                <input type="number" class="tie-input" placeholder="ë‚˜ì´" value="${p.age||''}" onchange="updatePlayerAge(${p.id}, this.value)">
                            </span>
                        `;
                    });
                    tieInputs.appendChild(div);
                }
            });
            tieBox.style.display = hasTie ? 'block' : 'none';
        } else {
            tieBox.style.display = 'none';
        }

        const seedIcon = window.currentMatch.seedIcon || 'ğŸ‘‘';
        document.getElementById('gameRankingBody').innerHTML = sorted.map((p,i) => {
            const nameDisp = p.isSeed ? `${seedIcon} ${p.name}` : p.name;
            return `
            <tr class="${i<1?'rank-1':i<2?'rank-2':i<3?'rank-3':''}">
                <td>${i+1}</td><td>${nameDisp}<span style="font-size:0.7rem; color:#666;">${p.age ? '('+p.age+')' : ''}</span></td>
                <td>${p.wins}</td><td>${p.draws}</td><td>${p.losses}</td><td>${p.scored}</td><td>${p.conceded}</td><td style="color:${p.diff>0?'red':p.diff<0?'blue':'#333'}">${p.diff}</td><td style="font-weight:bold;">${p.pts}</td>
            </tr>
        `}).join('');
    }

    window.updatePlayerAge = (pid, val) => {
        const p = window.currentMatch.players.find(x => x.id === pid);
        if(p) {
            p.age = parseInt(val) || 0;
            saveMatchToFirebase(); 
            renderGameUI(); 
        }
    }

    function saveMatchToFirebase() {
        if(window.currentMatch.id) set(ref(db, ROOT + 'tennisHistory/' + window.currentMatch.id), window.currentMatch);
    }

    // [ìˆ˜ì •] ì €ì¥ í›„ ë·° ì „í™˜ ì‹œ ë°ì´í„° ë™ê¸°í™” ë³´ì¥
    window.saveAndExitMatch = () => { 
        if(!window.currentMatch.date && window.currentFolder) window.currentMatch.date = window.currentFolder;
        
        set(ref(db, ROOT + 'tennisHistory/' + window.currentMatch.id), window.currentMatch).then(() => {
            document.getElementById('match-game').style.display='none';
            if(window.currentMatch.date) {
                window.currentFolder = window.currentMatch.date;
                document.getElementById('match-list-in-folder').style.display='block';
                const isGuest = (window.currentFolder === GUEST_FOLDER);
                document.getElementById('currentFolderName').innerText = isGuest ? `ğŸ‰ ${window.currentFolder}` : `ğŸ“‚ ${window.currentFolder}`;
                renderMatchesInFolder();
            } else { closeFolder(); }
        });
    }

    function renderHistoryTab() {
        const list = document.getElementById('historyListArea');
        if(!window.rankingData.history.length) return list.innerHTML = '<div style="text-align:center; padding:30px;">ê¸°ë¡ ì—†ìŒ</div>';
        
        list.innerHTML = [...window.rankingData.history].reverse().map((h, i) => `
            <div class="card" style="padding:15px; cursor:pointer;" onclick="openHistoryDetail(${window.rankingData.history.length-1-i})">
                <div style="font-weight:bold;">${h.title} <span style="font-weight:normal; font-size:0.8rem; color:#888;">(${h.dateString})</span></div>
                <div style="font-size:0.85rem; margin-top:5px;">${h.changes.length}ëª… ë³€ë™ / ê²°ê³¼í‘œ ë³´ê¸°</div>
                
                <div class="hist-changes-container">
                  ${h.changes.map(c => {
                      if(c.type === 'up') return `<div class="hist-badge hist-badge-up">${c.name} â–²</div>`;
                      else return `<div class="hist-badge hist-badge-down">${c.name} â–¼</div>`;
                  }).join('')}
                </div>
                
                ${window.isAdmin ? `<button class="btn-action bg-red" style="width:auto; padding:4px 10px; font-size:0.8rem; float:right; margin-top:5px;" onclick="revertHistory(event, ${window.rankingData.history.length-1-i})">â†º ë˜ëŒë¦¬ê¸°</button>` : ''}
            </div>
        `).join('');
    }

    window.revertHistory = (e, idx) => {
        e.stopPropagation();
        if(!confirm("ì´ ëŒ€íšŒì˜ ìŠ¹ê°• ê²°ê³¼ë¥¼ ì·¨ì†Œí•˜ê³ , ë“±ê¸‰ì„ ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const h = window.rankingData.history[idx];
        if(!h || !h.changes) return;

        h.changes.forEach(c => {
            const currentTier = window.rankingData.tiers[c.phone];
            if(c.type === 'up') {
                const prev = REVERSE_TIER_MAP[currentTier];
                if(prev) window.rankingData.tiers[c.phone] = prev;
            } else {
                const prev = PROMOTE_TIER_MAP[currentTier];
                if(prev) window.rankingData.tiers[c.phone] = prev;
            }
        });

        window.rankingData.history.splice(idx, 1);
        set(ref(db, ROOT + 'rankingData'), window.rankingData);
        alert("ë˜ëŒë¦¬ê¸° ì™„ë£Œ! ë“±ê¸‰ì´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        renderBoard();
        renderHistoryTab();
    }

    function renderMatchFolderView() {
        document.getElementById('match-folders').style.display = 'block';
        document.getElementById('match-list-in-folder').style.display = 'none';
        document.getElementById('match-setup').style.display = 'none';
        document.getElementById('match-ladder').style.display = 'none';
        document.getElementById('match-game').style.display = 'none';
        
        const folderListDiv = document.getElementById('folderList');
        const emptyMsg = document.getElementById('matchEmptyMsg');
        const folders = {};
        window.matchHistory.forEach(m => {
            const key = m.date || "ë‚ ì§œë¯¸ì •";
            if(key === GUEST_FOLDER) return;
            if(!folders[key]) folders[key] = [];
            folders[key].push(m);
        });

        if(Object.keys(folders).length === 0) {
            folderListDiv.innerHTML = ''; emptyMsg.style.display = 'block'; 
        } else {
            emptyMsg.style.display = 'none';
            folderListDiv.innerHTML = Object.keys(folders).sort().reverse().map(date => `
                <div class="folder-item" onclick="openFolder('${date}')">
                    <div style="display:flex; align-items:center;">
                        <span style="font-size:1.8rem; margin-right:10px;">ğŸ“‚</span>
                        <div>
                            <div style="font-weight:bold; font-size:1rem;">${date}</div>
                            <div style="font-size:0.8rem; color:#888;">${folders[date].length}ê°œ ë§¤ì¹˜</div>
                        </div>
                    </div>
                    ${window.isAdmin ? `<button class="btn-icon" style="background:#ffebee; color:red;" onclick="deleteFolder(event, '${date}')">ğŸ—‘ï¸</button>` : ''}
                </div>
            `).join('');
        }
    }
    window.openFolder = (date) => {
        window.currentFolder = date;
        document.getElementById('match-folders').style.display = 'none';
        document.getElementById('match-list-in-folder').style.display = 'block';
        const isGuest = (date === GUEST_FOLDER);
        document.getElementById('currentFolderName').innerText = isGuest ? `ğŸ‰ ${date}` : `ğŸ“‚ ${date}`;
        document.getElementById('btnCreateMatchInFolder').style.display = 'block';
        renderMatchesInFolder();
    }
    window.closeFolder = () => { window.currentFolder = null; renderMatchFolderView(); }
    window.cancelMatchSetup = () => {
         if(window.currentFolder) {
            document.getElementById('match-list-in-folder').style.display='block';
            document.getElementById('match-setup').style.display='none';
        } else { renderMatchFolderView(); }
    }

    function renderMatchesInFolder() {
        const listDiv = document.getElementById('matchesInFolderArea');
        const matches = window.matchHistory.filter(m => m.date === window.currentFolder).sort((a,b) => b.id - a.id);
        const canEdit = window.isAdmin || (window.currentFolder === GUEST_FOLDER);
        
        listDiv.innerHTML = matches.length ? matches.map(m => `
            <div class="card" style="padding:12px; margin-bottom:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;" onclick="loadMatchAndShowResult(${m.id})">
                <div>
                    <div style="font-weight:bold; font-size:1rem; margin-bottom:3px;">${m.title || 'ë¬´ì œ'}</div>
                    <div style="font-size:0.8rem; color:#666;">${m.players.length}ëª… / ${(m.matches||[]).filter(x=>x.played).length}ê²Œì„ ì™„ë£Œ</div>
                </div>
                ${canEdit ? `<button class="btn-icon" style="background:#ffebee; color:red;" onclick="deleteMatch(event, ${m.id})">ğŸ—‘ï¸</button>` : ''}
            </div>
        `).join('') : '<div style="text-align:center; padding:20px;">ë§¤ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    // [ìˆ˜ì •] í”„ë¡œí•„ ëª¨ë‹¬ (ë‹¨ì²´ì „ ê¸°ë¡ ì—°ë™ ì¶”ê°€)
    window.openPlayerModal=(m)=>{ 
        const modal = document.getElementById('playerModal');
        modal.style.display='flex'; 
        document.getElementById('pModalName').innerText=m.name; 
        document.getElementById('pModalPhone').value=m.phone; 
        document.getElementById('pModalTier').innerText=window.rankingData.tiers[m.phone]||'ë¯¸ë°°ì •'; 
        document.getElementById('pModalImg').src=m.photo||''; 

        // 1. ê¸°ì¡´ ê°œì¸ ë§¤ì¹˜ ê¸°ë¡ ë¶„ì„ ë¡œì§
        let totalGames = 0, totalWins = 0;
        let historyHtml = '';
        const myMatches = window.matchHistory.filter(h => h.players.some(p => p.name === m.name));
        myMatches.sort((a,b) => b.id - a.id); 

        let graphMap = new Map();
        myMatches.forEach(h => {
            const pData = h.players.find(p => p.name === m.name);
            if(pData) {
                totalWins += (pData.wins || 0);
                totalGames += ((pData.wins||0) + (pData.draws||0) + (pData.losses||0));
                
                // ìŠ¹ê°• ë±ƒì§€ ë¡œì§
                let badge = '';
                const hist = window.rankingData.history.find(hist => hist.title.includes(h.date));
                if (hist) {
                    const change = hist.changes.find(c => c.phone === m.phone);
                    if (change) badge = change.type === 'up' ? '<span class="p-badge up">â–² ìŠ¹ê¸‰</span>' : '<span class="p-badge down">â–¼ ê°•ë“±</span>';
                }

                historyHtml += `
                    <div class="history-item-3d" onclick="loadMatchAndShowResult(${h.id}, true)">
                        <div><div class="history-date">${h.date}</div><div class="history-title">${h.title}</div></div>
                        <div style="text-align:right;"><span class="history-score">${pData.pts}ì </span><div style="font-size:0.75rem; color:#666;">${pData.wins}ìŠ¹ ${pData.losses}íŒ¨${badge}</div></div>
                    </div>`;
                
                let dateKey = h.date.substring(0, 7).replace('-', '.'); 
                if(dateKey.length < 6) dateKey = 'Others';
                const currentTier = window.rankingData.tiers[m.phone] || 'D';
                graphMap.set(dateKey, TIER_SCORES[currentTier] || 1);
            }
        });

        // 2. [ì¶”ê°€] ë‹¨ì²´ì „ ê¸°ë¡ ë¶„ì„ ë° ì¶”ê°€
        // 2. [ìˆ˜ì •] ì˜¬í•´ ë‹¨ì²´ì „ ê¸°ë¡ë§Œ ë¶„ì„ (í˜„ì¬ ì—°ë„ í•„í„° ì ìš©)
        const currentYear = new Date().getFullYear().toString(); // ì‹¤í–‰ ì‹œì ì˜ ì—°ë„ ì¶”ì¶œ (ì˜ˆ: "2025")
        const myTeamEvents = Object.values(window.teamData).filter(t => {
            // ëŒ€íšŒ ë‚ ì§œ(YYYY-MM-DD)ì—ì„œ ì—°ë„ë§Œ ì¶”ì¶œ
            const eventYear = t.date ? t.date.substring(0, 4) : "";
            
            // 1) ì˜¬í•´ ì—°ë„ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
            const isThisYear = (eventYear === currentYear);
            
            // 2) í•´ë‹¹ ì‚¬ìš©ìê°€ ì°¸ê°€(ì •ë©¤ë²„ ë˜ëŠ” ì˜ˆë¹„)í–ˆëŠ”ì§€ í™•ì¸
            const isParticipant = (t.divisions||[]).some(d => 
                (d.pairs||[]).some(pair => pair.p1 === m.name || pair.p2 === m.name) ||
                (d.reserves||[]).includes(m.name)
            );
            
            return isThisYear && isParticipant; // ë‘ ì¡°ê±´ ëª¨ë‘ ë§Œì¡±í•´ì•¼ í•¨
        }).sort((a,b) => new Date(b.date) - new Date(a.date));

        if(myTeamEvents.length > 0) {
            // ì œëª© ë¶€ë¶„ì— ì—°ë„ë¥¼ í‘œì‹œí•˜ì—¬ ëª…í™•í•˜ê²Œ ë³€ê²½
            historyHtml = `<h4 style="margin:10px 0 5px; color:#3E7C38; border-bottom:1px solid #ddd;">ğŸ›¡ï¸ ${currentYear}ë…„ ë‹¨ì²´ì „ ì„±ì </h4>` + historyHtml;
            let teamHtml = '';
            myTeamEvents.forEach(t => {
                let myDiv = t.divisions.find(d => 
                    (d.pairs||[]).some(p => p.p1 === m.name || p.p2 === m.name) || (d.reserves||[]).includes(m.name)
                );
                if(myDiv) {
                    teamHtml += `<div class="history-item-3d" style="background:#f1f8e9; border:1px solid #c5e1a5;">
                        <div><div class="history-date">${t.date}</div><div class="history-title">${t.name}</div></div>
                        <div style="text-align:right;">
                            <span style="font-weight:bold; color:#333;">${myDiv.name}</span>
                            <div style="font-size:0.8rem; color:#d32f2f;">${myDiv.teamResult || '-'}</div>
                        </div>
                    </div>`;
                }
            });
            historyHtml = teamHtml + `<h4 style="margin:15px 0 5px; color:#555; border-bottom:1px solid #ddd;">ğŸ¾ ê°œì¸ ë§¤ì¹˜ ê¸°ë¡ (ì „ì²´)</h4>` + historyHtml;
        }

        const winRate = totalGames > 0 ? Math.round((totalWins/totalGames)*100) : 0;
        document.getElementById('playerStatsText').innerText = `ì´ ${totalGames}ê²Œì„ ${totalWins}ìŠ¹ (ìŠ¹ë¥  ${winRate}%)`;
        document.getElementById('pHistoryList').innerHTML = historyHtml || '<div style="padding:10px; color:#999;">ê¸°ë¡ ì—†ìŒ</div>';
        
        // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        if(window.chartInstances.win) window.chartInstances.win.destroy();
        const ctxWin = document.getElementById('winRateChart').getContext('2d');
        window.chartInstances.win = new Chart(ctxWin, {
            type: 'doughnut', data: { labels: ['ìŠ¹','íŒ¨'], datasets: [{ data: [totalWins, totalGames-totalWins], backgroundColor:['#ff6b6b','#eee'] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}} }
        });
        if(window.chartInstances.rank) window.chartInstances.rank.destroy();
        const ctxRank = document.getElementById('rankLineChart').getContext('2d');
        const sortedKeys = Array.from(graphMap.keys()).sort();
        const graphLabels = sortedKeys.length > 0 ? sortedKeys : ['í˜„ì¬'];
        const graphData = sortedKeys.length > 0 ? sortedKeys.map(k => graphMap.get(k)) : [TIER_SCORES[window.rankingData.tiers[m.phone]||'D']];
        window.chartInstances.rank = new Chart(ctxRank, {
            type: 'line', data: { labels: graphLabels, datasets: [{ label: 'ë“±ê¸‰ ì ìˆ˜', data: graphData, borderColor: '#68A658', backgroundColor: 'rgba(104, 166, 88, 0.2)', tension: 0.1, fill: true }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 8, ticks: { callback: function(value) { return Object.keys(TIER_SCORES).find(key => TIER_SCORES[key] === value) || ''; } } } }, plugins: { legend: { display: false } } }
        });
    }

    window.loadMatchAndShowResult = (id, readOnly = false) => {
        // [ìˆ˜ì •] ID íƒ€ì… ì•ˆì „ ë¹„êµ (ë¬¸ìì—´/ìˆ«ì ëª¨ë‘ í—ˆìš©)
        const m = window.matchHistory.find(x => x.id == id); 
        if(!m) return;
        const modal = document.getElementById('detailStatsModal');
        document.getElementById('detailTitle').innerText = `${m.date} - ${m.title}`;
        
        const sorted = [...m.players].sort((a,b) => {
             if(b.pts !== a.pts) return b.pts - a.pts;
             if(b.diff !== a.diff) return b.diff - a.diff;
             return (b.age || 0) - (a.age || 0);
        });
        
        let html = `<h4 style="margin:5px 0 10px;">ğŸ† ìµœì¢… ìˆœìœ„</h4>
                    <table class="result-table" style="margin-bottom:15px;">
                        <thead><tr><th>ìœ„</th><th>ì´ë¦„</th><th>ìŠ¹ì </th><th>ë“ì‹¤</th><th>ìŠ¹</th><th>ë¬´</th><th>íŒ¨</th></tr></thead>
                        <tbody>`;
        sorted.forEach((p, i) => {
            let rankClass = (i===0)?'rank-1':(i===1)?'rank-2':(i===2)?'rank-3':'';
            html += `<tr class="${rankClass}"><td>${i+1}</td><td>${p.name}${p.age?` <small>(${p.age})</small>`:''}</td><td>${p.pts}</td><td>${p.diff}</td><td>${p.wins||0}</td><td>${p.draws||0}</td><td>${p.losses}</td></tr>`;
        });
        html += `</tbody></table>`;
        html += `<h4 style="margin:15px 0 10px;">ğŸ¾ ê²½ê¸° ê¸°ë¡</h4>`;
        m.matches.forEach((g, idx) => {
            if(!g.played) return;
            html += `<div style="background:#f9f9f9; padding:8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; font-size:0.9rem;">
                        <span style="width:40%; text-align:left;">${g.t1[0].name},${g.t1[1].name}</span>
                        <span style="font-weight:bold;">${g.s1} : ${g.s2}</span>
                        <span style="width:40%; text-align:right;">${g.t2[0].name},${g.t2[1].name}</span>
                     </div>`;
        });
        
        if (!readOnly) {
            html += `<div style="text-align:center; margin-top:20px;">
                        <button class="btn-action bg-yellow" onclick="loadMatchToEdit(${id})">âœï¸ ì´ ë§¤ì¹˜ ìˆ˜ì •/ì…ë ¥í•˜ê¸°</button>
                     </div>`;
        }
        
        document.getElementById('detailContent').innerHTML = html;
        modal.style.display = 'flex';
    }

    window.loadMatchToEdit = (id) => {
        closeModal('detailStatsModal');
        const m = window.matchHistory.find(x => x.id == id);
        if(m) {
            window.currentMatch = JSON.parse(JSON.stringify(m));
            document.getElementById('match-folders').style.display='none';
            document.getElementById('match-list-in-folder').style.display='none';
            document.getElementById('match-game').style.display='block';
            document.getElementById('gameTitleDisplay').innerText = `${m.date} / ${m.title}`;
            renderGameUI();
        }
    }

    window.deleteFolder = (e, date) => { e.stopPropagation(); if(confirm("í´ë” ì‚­ì œ?")) { const u={}; window.matchHistory.forEach(m=>{if(m.date===date)u[`/tennisHistory/${m.id}`]=null;}); update(ref(db), u); } }
    window.deleteFolder = (e, date) => { 
    e.stopPropagation(); 
    if(confirm(`'${date}' í´ë”ì™€ ê·¸ ì•ˆì˜ ëª¨ë“  ë§¤ì¹˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { 
        const updates = {}; 
        window.matchHistory.forEach(m => {
            if(m.date === date) {
                // í•µì‹¬: ROOT + ê°€ ë°˜ë“œì‹œ ë“¤ì–´ê°€ì•¼ í•©ë‹ˆë‹¤.
                updates[ROOT + `tennisHistory/${m.id}`] = null;
            }
        }); 
        
        update(ref(db), updates).then(() => {
            alert("í´ë”ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }).catch(err => {
            alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message);
        }); 
    } 
}
window.deleteMatch = (e, id) => { 
    e.stopPropagation(); 
    if(confirm("ì´ ë§¤ì¹˜ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        // [ìˆ˜ì •] ROOT + ë¥¼ ì¶”ê°€í•˜ì—¬ ì‚¬ìš©ì ê²½ë¡œì—ì„œ ì‚­ì œë˜ë„ë¡ í•©ë‹ˆë‹¤.
        remove(ref(db, ROOT + `tennisHistory/${id}`)).then(() => {
            alert("ë§¤ì¹˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }).catch(err => {
            alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message);
        });
    }
}
    window.createNewFolderMatch = () => { if(!window.isAdmin) return alert("ê´€ë¦¬ìë§Œ"); window.currentFolder=null; goToMatchSetup(); }
    window.createNewMatchInFolder = () => { goToMatchSetup(); }

    window.openHistoryDetail = (idx) => { 
        const h = window.rankingData.history[idx];
        if(h) showDetailStats(h); 
    }
    
    window.showDetailStats = (data) => {
        if(!data.fullStats) return alert("ì €ì¥ëœ ìƒì„¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        const modal = document.getElementById('detailStatsModal');
        document.getElementById('detailTitle').innerText = data.title;
        let html = '';
        
        const allSorted = [...data.fullStats].sort((a,b) => b.pts - a.pts || b.diff - a.diff);
        
        TIERS.forEach(t => {
            const group = allSorted.filter(s => s.tier === t);
            if(!group.length) return;
            
            html += `<h4 style="margin:10px 0 5px; color:var(--court-dark); border-bottom:1px solid #eee;">${t}ì¡° ê²°ê³¼</h4>
                     <table class="result-table"><thead><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ìŠ¹ì </th><th>ë“ì‹¤</th><th>ìŠ¹</th><th>ë¬´</th><th>íŒ¨</th></tr></thead><tbody>`;
            
            group.forEach((p, index) => {
                 const isP = (data.promos||[]).find(x=>x.phone===p.phone);
                 const isD = (data.demos||[]).find(x=>x.phone===p.phone);
                 let nameHtml = p.name;
                 let rowStyle = '';
                 
                 if(isP) { nameHtml += ' <span style="color:red; font-weight:bold;">â–²</span>'; rowStyle = 'background:#e3f2fd;'; }
                 if(isD) { nameHtml += ' <span style="color:blue; font-weight:bold;">â–¼</span>'; rowStyle = 'background:#ffebee;'; }

                 html += `<tr style="${rowStyle}">
                    <td>${index+1}</td>
                    <td>${nameHtml}</td>
                    <td style="font-weight:bold;">${p.pts}</td>
                    <td>${p.diff}</td>
                    <td>${p.wins||0}</td>
                    <td>${p.draws||0}</td>
                    <td>${p.losses||0}</td>
                 </tr>`;
            });
            html += `</tbody></table>`;
        });

        document.getElementById('detailContent').innerHTML = html;
        modal.style.display='flex';
    }

    function populateFolderSelect() {
        const select = document.getElementById('targetFolderSelect');
        const folders = new Set();
        window.matchHistory.forEach(m => {
            if(m.date && m.date !== GUEST_FOLDER) folders.add(m.date);
        });
        
        const sorted = Array.from(folders).sort().reverse();
        select.innerHTML = sorted.map(f => `<option value="${f}">${f}</option>`).join('');
    }

    window.analyzeFolder = () => { 
        if(!window.isAdmin) return alert("ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); 
        const targetFolder = document.getElementById('targetFolderSelect').value;
        if(!targetFolder) return alert("ì„ íƒëœ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.");
        
        const targetMatches = window.matchHistory.filter(h => h.date === targetFolder);
        if(!targetMatches.length) return alert("í•´ë‹¹ í´ë”ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        
        let stats = {};
        targetMatches.forEach(match => {
            match.players.forEach(p => {
                const mem = window.allMembers.find(x => x.name === p.name);
                // ì „í™”ë²ˆí˜¸ê°€ ì—†ëŠ” íšŒì›ë„ ë¶„ì„ ê°€ëŠ¥í•˜ê²Œ ìˆ˜ì • (ë‹¤ë§Œ ë“±ê¸‰ ë§¤ì¹­ì€ phone ê¸°ì¤€ìœ¼ë¡œë§Œ ê°€ëŠ¥)
                const phone = mem ? mem.phone : `NO_PHONE_${p.name}`;
                if(!stats[phone]) stats[phone] = { 
                    name: p.name, phone: phone, 
                    wins:0, draws:0, losses:0, pts:0, diff:0, 
                    tier: window.rankingData.tiers[phone] || 'ë¯¸ë°°ì •' 
                };
                stats[phone].wins += (p.wins||0);
                stats[phone].draws += (p.draws||0);
                stats[phone].losses += (p.losses||0);
                stats[phone].pts += p.pts;
                stats[phone].diff += p.diff;
            });
        });
        
        window.analysisTemp = Object.values(stats).filter(s => s.tier !== 'ë¯¸ë°°ì •');
        if(!window.analysisTemp.length) return alert("ë¶„ì„í•  ì°¸ê°€ì ë°ì´í„°ê°€ ë“±ê¸‰ ë¯¸ë°°ì • ìƒíƒœì…ë‹ˆë‹¤.");

        let html = `<div style="max-height:300px; overflow-y:auto;">`;
        
        TIERS.forEach(t => {
            const group = window.analysisTemp.filter(s => s.tier === t)
                                            .sort((a,b) => b.pts - a.pts || b.diff - a.diff || b.wins - a.wins);
            
            if (group.length > 0) {
                html += `<h4 style="margin:10px 0 5px; border-bottom:2px solid #eee;">${t}ì¡°</h4>
                         <table class="result-table">
                            <thead><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ìŠ¹ì </th><th>ìŠ¹/ê°•</th></tr></thead>
                            <tbody>`;
                
                // [ìˆ˜ì •] 2ëª… ë¯¸ë§Œì¼ ê²½ìš° ìŠ¹ê°• ì œì™¸ ë¡œì§
                const canPromote = group.length >= 2;

                group.forEach((p, idx) => {
                    let isPromoteCand = (canPromote && idx === 0 && t !== 'A'); 
                    let isDemoteCand = (canPromote && idx === group.length - 1 && t !== 'D'); 

                    let rowBg = '';
                    let checkHtml = '';

                    if (isPromoteCand) {
                        rowBg = 'background:#ffebee;'; 
                        checkHtml = `<input type="checkbox" class="promo-check" data-phone="${p.phone}" data-type="up" checked> <span style="color:red; font-weight:bold;">â–²</span>`;
                    } else if (isDemoteCand) {
                        rowBg = 'background:#e3f2fd;'; 
                        checkHtml = `<input type="checkbox" class="promo-check" data-phone="${p.phone}" data-type="down" checked> <span style="color:blue; font-weight:bold;">â–¼</span>`;
                    } else {
                        checkHtml = `
                            <label><input type="checkbox" class="promo-check" data-phone="${p.phone}" data-type="up"><small>â–²</small></label>
                            <label><input type="checkbox" class="promo-check" data-phone="${p.phone}" data-type="down"><small>â–¼</small></label>
                        `;
                    }

                    html += `<tr style="${rowBg}">
                                <td>${idx + 1}</td>
                                

<td><span class="clickable-name" onclick="findAndOpenMatchResult('${p.name}', '${targetFolder}')">${p.name}</span></td>                                <td>${p.pts}</td>
                                <td>${checkHtml}</td>
                             </tr>`;
                });
                html += `</tbody></table>`;
            }
        });

        html += `</div>`;
        document.getElementById('analysisContent').innerHTML = html;
        document.getElementById('analysisResult').style.display='block';
    }

    window.applyPromotion = () => {
        if(!confirm("ì²´í¬ëœ ì¸ì›ë“¤ì˜ ë“±ê¸‰ì„ ë³€ê²½í•˜ê³  íˆìŠ¤í† ë¦¬ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const checkboxes = document.querySelectorAll('.promo-check:checked');
        const changes = []; 
        const targetFolder = document.getElementById('targetFolderSelect').value;

        checkboxes.forEach(chk => {
            const phone = chk.dataset.phone;
            const type = chk.dataset.type; 
            const member = window.analysisTemp.find(m => m.phone === phone);
            
            if (member) {
                const currentTier = member.tier;
                let newTier = currentTier;

                if (type === 'up') {
                    newTier = PROMOTE_TIER_MAP[currentTier];
                } else if (type === 'down') {
                    newTier = DOWN_TIER_MAP[currentTier];
                }

                if (newTier && newTier !== currentTier) {
                    window.rankingData.tiers[phone] = newTier;
                    changes.push({
                        name: member.name,
                        phone: phone,
                        type: type, 
                        from: currentTier,
                        to: newTier
                    });
                }
            }
        });

        if (changes.length === 0) return alert("ë³€ê²½ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.");

        const historyItem = {
            id: Date.now(),
            dateString: new Date().toLocaleDateString(),
            title: `${targetFolder} ìŠ¹ê°• ê²°ê³¼`,
            changes: changes,
            fullStats: window.analysisTemp, 
            promos: changes.filter(c => c.type === 'up'),
            demos: changes.filter(c => c.type === 'down')
        };
        
        window.rankingData.history.push(historyItem);

        set(ref(db, ROOT + 'rankingData'), window.rankingData)
            .then(() => {
                alert(`ì´ ${changes.length}ëª…ì˜ ë“±ê¸‰ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                document.getElementById('analysisResult').style.display='none';
                renderBoard(); 
            })
            .catch(err => alert("ì €ì¥ ì‹¤íŒ¨: " + err));
    }
    
    window.cancelAnalysis = () => { document.getElementById('analysisResult').style.display='none'; }
    
    window.triggerPhotoUpload=()=>{ document.getElementById('pModalFile').click(); }
    
    window.updatePlayerPhoto=async(input)=>{ if(!input.files[0])return; const f=input.files[0]; const p=document.getElementById('pModalPhone').value; const resized=await resizeImage(f,300); const idx=window.allMembers.findIndex(m=>m.phone===p); if(idx>=0){ window.allMembers[idx].photo=resized; set(ref(db,'clubData/members'), window.allMembers); document.getElementById('pModalImg').src=resized; renderBoard(); } }
    
    function resizeImage(file, max=300){ return new Promise(r=>{ const reader=new FileReader(); reader.onload=e=>{ const img=new Image(); img.onload=()=>{ const cvs=document.createElement('canvas'); const ctx=cvs.getContext('2d'); let w=img.width, h=img.height; if(w>h){if(w>max){h*=max/w; w=max;}}else{if(h>max){w*=max/h; h=max;}} cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h); r(cvs.toDataURL('image/jpeg',0.8)); }; img.src=e.target.result; }; reader.readAsDataURL(file); }); }
    
    window.openFullPhoto=()=>{ 
        const src = document.getElementById('pModalImg').src;
        if(!src) return;
        document.getElementById('fullPhotoImg').src=src; 
        document.getElementById('fullPhotoModal').style.display='flex'; 
    }
    window.closeFullPhoto=()=>{ document.getElementById('fullPhotoModal').style.display='none'; }
    window.closeModal=(id)=>document.getElementById(id).style.display='none';
    window.openBackupModal=()=>document.getElementById('backupModal').style.display='flex';
    window.toggleAdmin=()=>{ if(window.isAdmin){if(confirm("ë¡œê·¸ì•„ì›ƒ?")){window.isAdmin=false; localStorage.removeItem('rankAdmin'); location.reload();}} else{if(prompt("ë¹„ë²ˆ:")===window.rankingData.settings.adminPwd){window.isAdmin=true; localStorage.setItem('rankAdmin','true'); updateAdminUI();}} }
    function updateAdminUI(){ document.querySelectorAll('.admin-only').forEach(e=>e.classList.toggle('admin-show', window.isAdmin)); document.getElementById('btnLogin').innerText=window.isAdmin?'ğŸ”“':'ğŸ”’'; }
    
    
    window.openAdminSettings=()=>{ document.getElementById('adminSettingsModal').style.display='flex'; }
    window.changeAdminPassword=()=>{ const p=document.getElementById('newAdminPwd').value; window.rankingData.settings.adminPwd=p; set(ref(db,'rankingData'), window.rankingData); alert("ë³€ê²½ì™„ë£Œ"); }
    window.manualSetTier = (tier) => {
        const phone = document.getElementById('pModalPhone').value;
        if(!phone) return;
        if(tier) window.rankingData.tiers[phone] = tier;
        else delete window.rankingData.tiers[phone]; 
        
        set(ref(db, ROOT + 'rankingData/tiers'), window.rankingData.tiers);
        document.getElementById('pModalTier').innerText = tier || 'ë¯¸ë°°ì •';
        renderBoard();
    }

    window.renameFolder = () => {
        if(!window.currentFolder) return;
        const newName = prompt("ë³€ê²½í•  í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", window.currentFolder);
        if(!newName || newName === window.currentFolder) return;
        
        const updates = {};
        window.matchHistory.forEach(m => {
            if(m.date === window.currentFolder) {
                updates[`/tennisHistory/${m.id}/date`] = newName;
            }
        });
        update(ref(db), updates).then(() => {
            alert("í´ë”ëª…ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            window.currentFolder = newName;
            document.getElementById('currentFolderName').innerText = `ğŸ“‚ ${newName}`;
            renderMatchFolderView(); 
        });
    }

    window.renameMatchTitle = () => {
        const newTitle = prompt("ë³€ê²½í•  ë§¤ì¹˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", window.currentMatch.title);
        if(!newTitle) return;
        window.currentMatch.title = newTitle;
        update(ref(db, ROOT + 'tennisHistory/' + window.currentMatch.id), { title: newTitle });
        document.getElementById('gameTitleDisplay').innerText = `${window.currentMatch.date} / ${newTitle}`;
    }

    window.exportExcel=()=>{ 
        const ws = XLSX.utils.json_to_sheet(window.allMembers);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Members");
        XLSX.writeFile(wb, "members_backup.xlsx");
    }
    window.exportImage=()=>{ 
        html2canvas(document.getElementById('boardCaptureArea')).then(canvas => {
            const link = document.createElement('a');
            link.download = 'rank_board.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }
    // [ìˆ˜ì •] ì „ì²´ ë°ì´í„° ë°±ì—… (ë‹¨ì²´ì „, í”„ë¦¬ì…‹, MVP ë¡œê·¸ í¬í•¨)
   window.exportData = () => {
    const data = {
        members: window.allMembers,
        tennisHistory: window.matchHistory,
        rankingData: window.rankingData,
        teamTournaments: window.teamData, // ë‹¨ì²´ì „ ë°ì´í„° ì¶”ê°€
        teamPresets: window.teamPresets,      // í”„ë¦¬ì…‹ ì¶”ê°€
        mvpManualLogs: window.mvpManualLogs   // MVP ë¡œê·¸ ì¶”ê°€
    };
    const blob = new Blob([JSON.stringify(data)], {type : 'application/json'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `backup_${USER_ID}_${new Date().toISOString().slice(0,10)}.json`;
    link.click();
};

// [3] ëª¨ë°”ì¼ ì™„ë²½ ëŒ€ì‘ ë³µêµ¬ ë¡œì§ (ë‹¨ì²´ì „/ë§¤ì¹˜ ê¸°ë¡ í†µí•©)
// [ìˆ˜ì •] êµ¬ë²„ì „ ë°±ì—… íŒŒì¼(history, rank)ë„ ì™„ë²½í•˜ê²Œ ì¸ì‹í•˜ëŠ” ë³µêµ¬ ë¡œì§
    window.importData = () => {
    const fileInput = document.getElementById('restoreFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert("íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
    }

    if (!confirm("ë°ì´í„°ë¥¼ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ê¸°ë¡ì´ ëª¨ë‘ êµì²´ë©ë‹ˆë‹¤.")) return;

    const reader = new FileReader();

    // íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ì½ì—ˆì„ ë•Œ ì‹¤í–‰
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            const data = JSON.parse(content);
            const updates = {};

            // ë°ì´í„° êµ¬ì¡° í™•ì¸ ë° ë§¤í•‘
            if (data.members) updates['clubData/members'] = data.members;
            if (data.rankingData || data.rank) updates['rankingData'] = data.rankingData || data.rank;
            if (data.teamTournaments) updates['clubData/teamTournaments'] = data.teamTournaments;
            if (data.teamPresets) updates['clubData/teamPresets'] = data.teamPresets;
            if (data.mvpManualLogs) updates['clubData/mvpManualLogs'] = data.mvpManualLogs;
            
            const historySource = data.tennisHistory || data.history;
            if (historySource) {
                const hObj = {};
                if (Array.isArray(historySource)) {
                    historySource.forEach(m => { if(m.id) hObj[m.id] = m; });
                } else {
                    Object.assign(hObj, historySource);
                }
                updates['tennisHistory'] = hObj;
            }

            // Firebase ì—…ë°ì´íŠ¸
            update(ref(db, ROOT), updates).then(() => {
                alert("âœ… í¬ë¡¬ì—ì„œ ë³µêµ¬ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                location.reload();
            }).catch(err => {
                alert("ì €ì¥ ì‹¤íŒ¨: " + err.message);
            });

        } catch (err) {
            console.error("JSON Parse Error:", err);
            alert("íŒŒì¼ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ JSON íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        }
    };

    // ì—ëŸ¬ ë°œìƒ ì‹œ
    reader.onerror = function() {
        alert("íŒŒì¼ì„ ì½ëŠ” ë„ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (í¬ë¡¬ ë³´ì•ˆ ì •ì±… ë˜ëŠ” íŒŒì¼ ì†ìƒ)");
    };

    // íŒŒì¼ ì½ê¸° ì‹œì‘
    reader.readAsText(file, "UTF-8");
};
    // [ì‹ ê·œ] ë‹¨ì²´ì „ ê´€ë¦¬ ì‹œìŠ¤í…œ (Team Manager)
    // ==========================================
    
    window.teamData = {};  // í”„ë¦¬ì…‹ ë°ì´í„°
window.mvpManualLogs = []; // MVP ìˆ˜ë™ ì ìˆ˜ ë¡œê·¸
    
    // MVP ìˆ˜ë™ ì ìˆ˜ ë¡œë“œ
    onValue(ref(db, ROOT + 'clubData/mvpManualLogs'), (snap) => {
        window.mvpManualLogs = snap.val() || [];
    });
    window.currentTeamEditId = null; 
    window.targetPairInfo = null; 

    // Firebase ë¡œë“œ (ëŒ€íšŒì •ë³´ + í”„ë¦¬ì…‹)
    onValue(ref(db, ROOT + 'clubData/teamTournaments'), (snap) => {
        window.teamData = snap.val() || {};
        updateTeamYearFilter();
        if(document.getElementById('page-team').classList.contains('active')) renderTeamTab();
    });
    
    onValue(ref(db, ROOT + 'clubData/teamPresets'), (snap) => {
        const val = snap.val();
        if(val && Array.isArray(val)) {
            window.teamPresets = val;
        } else {
            // ì´ˆê¸° í”„ë¦¬ì…‹ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ 6ê°œ ë¹ˆ ìŠ¬ë¡¯ ìƒì„±
            window.teamPresets = Array(6).fill().map((_, i) => ({ 
                name: `í”„ë¦¬ì…‹ ${i+1}`, 
                divisions: [{name:'Aì¡°', type:'3ë³µì‹'}] 
            }));
        }
    });

    // íƒ­ ì „í™˜ ì—°ê²°
    const originalGoTab = window.goTab;
    window.goTab = (tab) => {
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`page-${tab}`).classList.add('active');
        const navItems = document.querySelectorAll('.nav-item');
        if(tab==='rank') navItems[0].classList.add('active');
        if(tab==='match') navItems[1].classList.add('active');
        if(tab==='team') navItems[2].classList.add('active');
        if(tab==='history') navItems[3].classList.add('active');

        if(tab === 'team') renderTeamTab();
        else if(tab === 'rank') renderBoard();
        else if(tab === 'match') { window.currentFolder = null; renderMatchFolderView(); }
        else if(tab === 'history') renderHistoryTab();
    }

    // --- í†µê³„ ë° ë©”ì¸ ë Œë”ë§ ---

    window.renderTeamTab = () => {
        renderTeamStats();
        
        // ë·° ì œì–´
        document.getElementById('teamTourneyList').style.display = 'block';
        document.getElementById('teamDetailView').style.display = 'none';
        document.getElementById('teamListTitle').style.display = 'flex';
        document.getElementById('teamDetailHeader').style.display = 'none';
        document.getElementById('teamFilterBar').style.display = 'block';

        const listDiv = document.getElementById('teamTourneyList');
        let list = Object.values(window.teamData).sort((a,b) => new Date(b.date) - new Date(a.date));
        
        const yearFilter = document.getElementById('teamYearFilter').value;
        const searchFilter = document.getElementById('teamSearchFilter').value.toLowerCase();

        if(yearFilter !== 'all') list = list.filter(t => t.date.startsWith(yearFilter));
        if(searchFilter) {
            list = list.filter(t => t.name.toLowerCase().includes(searchFilter) || (t.divisions || []).some(d => d.name.toLowerCase().includes(searchFilter)));
        }

        if(list.length === 0) {
            listDiv.innerHTML = '<div style="text-align:center; padding:30px; color:#aaa;">ì¡°ê±´ì— ë§ëŠ” ëŒ€íšŒ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        listDiv.innerHTML = list.map(t => {
            return `<div class="team-folder" onclick="openTeamDetail('${t.id}')">
                        <div style="display:flex; align-items:center;">
                            <span style="font-size:1.8rem; margin-right:10px;">ğŸ“</span>
                            <div>
                                <div style="font-weight:bold; font-size:1rem; color:#333;">${t.name}</div>
                                <div style="font-size:0.8rem; color:#666;">${t.date} <span style="margin:0 5px; color:#ddd;">|</span> ${t.result || 'ì§„í–‰ì¤‘'}</div>
                            </div>
                        </div>
                        <span style="font-size:1.2rem; color:#ccc;">â€º</span>
                    </div>`;
        }).join('');
        updateAdminUI(); 
    }

    window.renderTeamStats = () => {
        const partiCounts = {}; // { ì´ë¦„: {play:0, point:0} }
        const duoScores = {};   // { "ì´ë¦„1 & ì´ë¦„2": ì ìˆ˜ }
        const divResultCounts = {}; // { ë¶€ì„œëª…: {total:0, good:0} }
        
        let totalEvents = 0; // ì´ ëŒ€íšŒ ì°¸ì—¬ íšŸìˆ˜ (ëŒ€íšŒ ìˆ˜ x ë¶€ì„œ ìˆ˜)

        // ì„±ì ë³„ ê°€ì¤‘ì¹˜ ì ìˆ˜ (ìš°ìŠ¹=5ì , ì¤€ìš°ìŠ¹=3ì , 3ìœ„/4ê°•=1ì )
        const getResultPoint = (res) => {
            if(!res) return 0;
            if(res.includes('ìš°ìŠ¹')) return 5;
            if(res.includes('ì¤€ìš°ìŠ¹')) return 3;
            if(res.includes('3ìœ„') || res.includes('4ê°•') || res.includes('ì…ìƒ')) return 1;
            return 0;
        };

        Object.values(window.teamData).forEach(t => {
            (t.divisions || []).forEach(d => {
                totalEvents++;
                const rPoint = getResultPoint(d.teamResult);
                const dName = d.name || 'ê¸°íƒ€';
                
                // ë¶€ì„œë³„ í†µê³„
                if(!divResultCounts[dName]) divResultCounts[dName] = {total:0, score:0};
                divResultCounts[dName].total++;
                divResultCounts[dName].score += rPoint;

                // í•´ë‹¹ ë¶€ì„œì— ì°¸ê°€í•œ ëª¨ë“  ë©¤ë²„ ì¶”ì¶œ
                const membersInDiv = new Set();
                
                // ì •ë©¤ë²„ (í˜ì–´)
                (d.pairs || []).forEach(p => {
                    if(p.p1 && p.p1!=='ë¯¸ì •') membersInDiv.add(p.p1);
                    if(p.p2 && p.p2!=='ë¯¸ì •') membersInDiv.add(p.p2);
                    
                    // ë“€ì˜¤ ì ìˆ˜ ê³„ì‚° (ê°™ì€ ì¡°ì˜€ë˜ íŒŒíŠ¸ë„ˆë¼ë¦¬ ì„±ì  ê³µìœ )
                    if(p.p1 && p.p2 && p.p1!=='ë¯¸ì •' && p.p2!=='ë¯¸ì •') {
                        const duoKey = [p.p1, p.p2].sort().join(' & ');
                        duoScores[duoKey] = (duoScores[duoKey] || 0) + rPoint; // ì„±ì  ì ìˆ˜ ëˆ„ì 
                    }
                });
                
                // ì˜ˆë¹„ ë©¤ë²„ (ì„±ì  ì ìˆ˜ëŠ” 50%ë§Œ ë°˜ì˜)
                (d.reserves || []).forEach(r => {
                    if(r && r!=='ë¯¸ì •') {
                        // ì˜ˆë¹„ëŠ” ë“€ì˜¤ ì ìˆ˜ì—ì„œëŠ” ì œì™¸í•˜ê³  ê°œì¸ ê¸°ì—¬ë„ë§Œ ì²´í¬
                        if(!partiCounts[r]) partiCounts[r] = {play:0, point:0};
                        partiCounts[r].play++;
                        partiCounts[r].point += (rPoint * 0.5); 
                    }
                });

                // ì •ë©¤ë²„ ê°œì¸ í†µê³„ ë°˜ì˜
                membersInDiv.forEach(m => {
                    if(!partiCounts[m]) partiCounts[m] = {play:0, point:0};
                    partiCounts[m].play++;
                    partiCounts[m].point += rPoint;
                });
            });
        });

        // 1. ì´ ì°¸ì—¬ ë¶€ì„œ ìˆ˜
        document.getElementById('statTotalGames').innerText = totalEvents + "ê°œ ë¶€ì„œ";
        
        // 2. ìµœê°• ë“€ì˜¤ (ì„±ì  í¬ì¸íŠ¸ê°€ ê°€ì¥ ë†’ì€ í˜ì–´)
        const bestDuo = Object.entries(duoScores).sort((a,b) => b[1] - a[1])[0];
        document.getElementById('statBestDuo').innerText = bestDuo ? `${bestDuo[0]}` : "ê¸°ë¡ ì—†ìŒ";
        // (ë¼ë²¨ ë³€ê²½ì„ ìœ„í•´ HTML ìˆ˜ì • í•„ìš” ì—†ìŒ)

        // 3. ì„±ì  ê¸°ì—¬ì™• (MVP) - ì„±ì  í¬ì¸íŠ¸ê°€ ê°€ì¥ ë†’ì€ ê°œì¸
        const mvp = Object.entries(partiCounts).sort((a,b) => b[1].point - a[1].point)[0];
        document.getElementById('statMVP').innerText = mvp ? `${mvp[0]} (ê¸°ì—¬ë„ ${mvp[1].point}ì )` : "ê¸°ë¡ ì—†ìŒ";

        // 4. ì°¨íŠ¸ 1: ìµœë‹¤ ì°¸ì—¬ì (ê¸°ì¡´ ìœ ì§€)
        const sortedParti = Object.entries(partiCounts).sort((a,b) => b[1].play - a[1].play).slice(0, 5);
        const ctxParti = document.getElementById('teamPartiChart').getContext('2d');
        if(window.chartInstances.teamParti) window.chartInstances.teamParti.destroy();
        
        const gradBlue = ctxParti.createLinearGradient(0, 0, 0, 200);
        gradBlue.addColorStop(0, '#42a5f5'); gradBlue.addColorStop(1, '#1976d2');

        window.chartInstances.teamParti = new Chart(ctxParti, { 
            type: 'bar', 
            data: { 
                labels: sortedParti.map(x=>x[0]), 
                datasets: [{ 
                    label:'ì°¸ì—¬ íšŸìˆ˜', 
                    data: sortedParti.map(x=>x[1].play), 
                    backgroundColor: gradBlue, 
                    borderRadius: 5,
                    borderWidth: 0
                }] 
            }, 
            options: { 
                responsive:true, maintainAspectRatio:false, 
                plugins:{legend:{display:false}}, 
                scales:{y:{beginAtZero:true, ticks:{stepSize:1}, grid:{display:false}}, x:{grid:{display:false}}} 
            } 
        });

        // 5. ì°¨íŠ¸ 2: ë¶€ì„œë³„ ì„±ì  í¼í¬ë¨¼ìŠ¤ (ìŠ¹ë¥  -> ì„±ì  ì ìˆ˜ í‰ê· )
        const labels = Object.keys(divResultCounts).slice(0, 5);
        const performanceData = labels.map(k => { 
            const s = divResultCounts[k]; 
            // í‰ê·  ì ìˆ˜ (ë†’ì„ìˆ˜ë¡ ìš°ìŠ¹/ì…ìƒì„ ë§ì´ í•¨)
            return s.total > 0 ? (s.score / s.total).toFixed(1) : 0; 
        });
        
        const ctxWin = document.getElementById('teamWinRateChart').getContext('2d');
        if(window.chartInstances.teamWin) window.chartInstances.teamWin.destroy();
        
        window.chartInstances.teamWin = new Chart(ctxWin, { 
            type: 'radar', 
            data: { 
                labels: labels, 
                datasets: [{ 
                    label:'ì„±ì  í¼í¬ë¨¼ìŠ¤', 
                    data: performanceData, 
                    backgroundColor:'rgba(255, 159, 64, 0.5)', 
                    borderColor:'rgb(255, 159, 64)', 
                    pointBackgroundColor:'#fff',
                    pointBorderColor:'rgb(255, 159, 64)',
                    fill: true
                }] 
            }, 
            options: { 
                responsive:true, maintainAspectRatio:false, 
                scales:{r:{beginAtZero:true, ticks:{display:false}, grid:{color:'#ddd'}}},
                plugins:{legend:{display:false}}
            } 
        });
    }

    function updateTeamYearFilter() {
        const years = new Set();
        Object.values(window.teamData).forEach(t => { if(t.date) years.add(t.date.substring(0,4)); });
        const select = document.getElementById('teamYearFilter');
        const currentVal = select.value;
        let html = '<option value="all">ì „ì²´ ë…„ë„</option>';
        Array.from(years).sort().reverse().forEach(y => html += `<option value="${y}">${y}ë…„</option>`);
        select.innerHTML = html;
        select.value = currentVal;
    }

    // --- ëŒ€íšŒ ìƒì„¸ ë° ì—ë””í„° ---

window.openTeamDetail = (id) => {
        const t = window.teamData[id];
        if(!t) return;
        document.getElementById('teamTourneyList').style.display = 'none';
        document.getElementById('teamFilterBar').style.display = 'none';
        document.getElementById('teamDetailView').style.display = 'block';
        document.getElementById('teamListTitle').style.display = 'none';
        document.getElementById('teamDetailHeader').style.display = 'flex';
        document.getElementById('teamDetailName').innerText = `${t.name} (${t.date})`;
        document.getElementById('btnEditCurrentTeam').onclick = () => openTeamEditor(id);

        document.getElementById('teamDetailContent').innerHTML = (t.divisions || []).map(d => {
            // [ìˆ˜ì •] ìŠ¹/íŒ¨ ê²°ê³¼ í‘œì‹œ ë° ë°°ê²½ìƒ‰(win/loss) ë¡œì§ ì œê±°
            const pairsHtml = (d.pairs || []).map((p, idx) => {
                return `<div class="pair-row">
                            <span class="pair-badge">${idx+1}ë³µ</span>
                            <span class="pair-player">${p.p1||'ë¯¸ì •'} / ${p.p2||'ë¯¸ì •'}</span>
                        </div>`;
            }).join('');
            
            const resHtml = (d.reserves && d.reserves.some(r=>r)) ? `<div style="font-size:0.8rem; margin-top:5px; color:#666;">ì˜ˆë¹„: ${d.reserves.filter(r=>r).join(', ')}</div>` : '';
            return `<div class="div-box"><div class="div-title"><span>${d.name}</span><span style="font-size:0.9rem;">${d.teamResult||'-'}</span></div><div>${pairsHtml}</div>${resHtml}</div>`;
        }).join('');
    }
    window.closeTeamDetail = () => { renderTeamTab(); }

    window.openTeamEditor = (id = null) => {
        window.currentTeamEditId = id;
        const modal = document.getElementById('teamEditorModal');
        const container = document.getElementById('tDivisionsArea');
        container.innerHTML = '';
        
        // í”„ë¦¬ì…‹ ë²„íŠ¼ ë Œë”ë§
        const presetArea = document.getElementById('presetButtonsArea');
        presetArea.innerHTML = window.teamPresets.map((p, idx) => 
            `<button class="btn-action bg-teal" style="margin:0; font-size:0.8rem; padding:8px;" onclick="applyPreset(${idx})">${p.name}</button>`
        ).join('');

        if(id) {
            const data = window.teamData[id];
            document.getElementById('teamEditorTitle').innerText = "ëŒ€íšŒ ì •ë³´ ìˆ˜ì •";
            document.getElementById('tEditName').value = data.name;
            document.getElementById('tEditDate').value = data.date;
            document.getElementById('tEditResult').value = data.result || '';
            document.getElementById('btnDelTeam').style.display = 'inline-block';
            (data.divisions || []).forEach((d, dIdx) => renderDivisionInput(container, d, dIdx));
        } else {
            document.getElementById('teamEditorTitle').innerText = "ìƒˆ ëŒ€íšŒ ë“±ë¡";
            document.getElementById('tEditName').value = "";
            document.getElementById('tEditDate').value = new Date().toISOString().slice(0,10);
            document.getElementById('tEditResult').value = "";
            document.getElementById('btnDelTeam').style.display = 'none';
        }
        modal.style.display = 'flex';
    }

    // í”„ë¦¬ì…‹ ì ìš© í•¨ìˆ˜
    window.applyPreset = (idx) => {
        const preset = window.teamPresets[idx];
        if(!preset) return;
        const container = document.getElementById('tDivisionsArea');
        container.innerHTML = ''; // ì´ˆê¸°í™”
        
        (preset.divisions || []).forEach((d, i) => {
            // í”„ë¦¬ì…‹ì— ì •ì˜ëœ ëŒ€ë¡œ ìŠ¬ë¡¯ ìƒì„± (3ë³µì‹/5ë³µì‹ ë“±)
            const type = d.type || '3ë³µì‹';
            const count = type === '5ë³µì‹' ? 5 : 3;
            const pairs = Array(count).fill().map(() => ({ p1:'', p2:'', result:'-' }));
            renderDivisionInput(container, { name:d.name, type:type, teamResult:'', pairs: pairs, reserves:['',''] }, i);
        });
    }

function renderDivisionInput(container, data, idx) {
        const divId = `div-${Date.now()}-${idx}`;
        let pairsData = data.pairs || [];
        const requiredCount = data.type === '3ë³µì‹' ? 3 : 5;
        if (pairsData.length > requiredCount) pairsData = pairsData.slice(0, requiredCount);
        else if (pairsData.length < requiredCount) {
             const diff = requiredCount - pairsData.length;
             for(let i=0; i<diff; i++) pairsData.push({ p1:'', p2:'', result:'-' });
        }
        const reserves = data.reserves || ['', ''];

        // [ìˆ˜ì •] ìŠ¹íŒ¨ ì„ íƒ ì‚­ì œ, readonly ì‚­ì œ, onclick -> ondblclick ë³€ê²½
        const html = `
        <div class="div-box" id="${divId}">
            <div style="display:flex; gap:5px; margin-bottom:5px;">
<input type="text" class="input-full d-name" value="${data.name}" placeholder="ë¶€ì„œëª… (ì˜ˆ: ê¸ˆë°°)" style="flex:1; margin:0;" oninput="updateOverallTeamResult()">
                <select class="input-full d-type" style="width:80px; margin:0;" onchange="adjustPairs('${divId}', this.value)">
                    <option value="3ë³µì‹" ${data.type==='3ë³µì‹'?'selected':''}>3ë³µ</option>
                    <option value="5ë³µì‹" ${data.type==='5ë³µì‹'?'selected':''}>5ë³µ</option>
                </select>
                <button class="btn-action bg-red" style="width:30px; margin:0; padding:0;" onclick="this.closest('.div-box').remove()">x</button>
            </div>
<input type="text" class="input-full d-res" value="${data.teamResult||''}" placeholder="ë¶€ì„œ ê²°ê³¼ (ì˜ˆ: ìš°ìŠ¹)" style="margin-bottom:5px;" oninput="updateOverallTeamResult()">
            <div class="pairs-container">
                ${pairsData.map((p, pIdx) => `
                    <div class="pair-row editing">
                        <span class="pair-badge">${pIdx+1}ë³µ</span>
                        <input type="text" class="pair-p1" value="${p.p1||''}" placeholder="ì„ ìˆ˜1 (ë”ë¸”í´ë¦­ ê²€ìƒ‰)" ondblclick="openTeamMemberSelect(this)">
                        <input type="text" class="pair-p2" value="${p.p2||''}" placeholder="ì„ ìˆ˜2 (ë”ë¸”í´ë¦­ ê²€ìƒ‰)" ondblclick="openTeamMemberSelect(this)">
                    </div>`).join('')}
            </div>
            <div class="reserve-row">
                <span style="font-size:0.8rem; align-self:center;">ì˜ˆë¹„</span>
                <input type="text" class="res-input res-1" value="${reserves[0]||''}" placeholder="ì˜ˆë¹„1" ondblclick="openTeamMemberSelect(this)">
                <input type="text" class="res-input res-2" value="${reserves[1]||''}" placeholder="ì˜ˆë¹„2" ondblclick="openTeamMemberSelect(this)">
            </div>
        </div>`;
        container.insertAdjacentHTML('beforeend', html);
    }

window.adjustPairs = (divId, type) => {
        const box = document.getElementById(divId);
        const container = box.querySelector('.pairs-container');
        const count = type === '3ë³µì‹' ? 3 : 5;
        
        // ê¸°ì¡´ ê°’ ë³´ì¡´ (ìŠ¹íŒ¨ ê°’ì€ ì´ì œ ì €ì¥í•˜ì§€ ì•ŠìŒ)
        const currentInputs = Array.from(container.querySelectorAll('.pair-row')).map(row => ({
            p1: row.querySelector('.pair-p1').value, 
            p2: row.querySelector('.pair-p2').value
        }));
        
        let newHtml = '';
        for(let i=0; i<count; i++) {
            const p = currentInputs[i] || { p1:'', p2:'' };
            // [ìˆ˜ì •] ìŠ¹íŒ¨ ì„ íƒ ì‚­ì œ ë° ì…ë ¥ ë°©ì‹ ë³€ê²½
            newHtml += `<div class="pair-row editing">
                            <span class="pair-badge">${i+1}ë³µ</span>
                            <input type="text" class="pair-p1" value="${p.p1}" placeholder="ì„ ìˆ˜1" ondblclick="openTeamMemberSelect(this)">
                            <input type="text" class="pair-p2" value="${p.p2}" placeholder="ì„ ìˆ˜2" ondblclick="openTeamMemberSelect(this)">
                        </div>`;
        }
        container.innerHTML = newHtml;
    }

    // ì œí•œ(6ê°œ) ì œê±°ë¨: ë¬´ì œí•œ ì¶”ê°€ ê°€ëŠ¥
    window.addDivisionSlot = () => {
        const container = document.getElementById('tDivisionsArea');
        renderDivisionInput(container, { name:'', type:'3ë³µì‹', teamResult:'', pairs:[{result:'-'},{result:'-'},{result:'-'}] }, 999);
    }

    window.openTeamMemberSelect = (inputElem) => {
        window.targetPairInfo = inputElem;
        document.getElementById('teamMemberSelectModal').style.display = 'flex';
        renderTeamMemberSelector();
    }
    
    // ë“±ê¸‰ë³„ë¡œ ì„ ìˆ˜ ë³´ì—¬ì£¼ê¸°
    window.renderTeamMemberSelector = () => {
        const key = document.getElementById('teamMemSearch').value;
        const grid = document.getElementById('teamMemberGrid');
        grid.innerHTML = '';

        if (key) {
            grid.innerHTML = window.allMembers.filter(m => m.name.includes(key)).sort((a,b) => a.name.localeCompare(b.name))
                .map(m => `<div class="select-chip" onclick="selectTeamMember('${m.name}')">${m.name}</div>`).join('');
            return;
        }

        TIERS.forEach(t => {
            const members = window.allMembers.filter(m => window.rankingData.tiers[m.phone] === t).sort((a,b) => a.name.localeCompare(b.name));
            if(members.length > 0) {
                const header = document.createElement('div'); header.className = 'selector-group-title'; header.innerText = `${t}ì¡°`; grid.appendChild(header);
                members.forEach(m => {
                    const chip = document.createElement('div'); chip.className = 'select-chip'; chip.innerText = m.name; chip.onclick = () => selectTeamMember(m.name); grid.appendChild(chip);
                });
            }
        });
        const unranked = window.allMembers.filter(m => !window.rankingData.tiers[m.phone]).sort((a,b) => a.name.localeCompare(b.name));
        if(unranked.length > 0) {
             const header = document.createElement('div'); header.className = 'selector-group-title'; header.innerText = 'ë¯¸ë°°ì •'; grid.appendChild(header);
             unranked.forEach(m => {
                const chip = document.createElement('div'); chip.className = 'select-chip'; chip.innerText = m.name; chip.onclick = () => selectTeamMember(m.name); grid.appendChild(chip);
            });
        }
    }
    window.selectTeamMember = (name) => {
        if(window.targetPairInfo) { window.targetPairInfo.value = name; closeModal('teamMemberSelectModal'); }
    }

    window.saveTeamTournament = () => {
        const id = window.currentTeamEditId || ('team_' + Date.now());
        const name = document.getElementById('tEditName').value;
        const date = document.getElementById('tEditDate').value;
        const result = document.getElementById('tEditResult').value;
        if(!name) return alert("ëŒ€íšŒëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        const divisions = [];
        document.querySelectorAll('#tDivisionsArea .div-box').forEach(divBox => {
            const dName = divBox.querySelector('.d-name').value;
            const dType = divBox.querySelector('.d-type').value;
            const dRes = divBox.querySelector('.d-res').value;
            const pairs = [];
            divBox.querySelectorAll('.pair-row').forEach(row => {
                // [ìˆ˜ì •] resultëŠ” í™”ë©´ì— ì—†ìœ¼ë¯€ë¡œ ë¬´ì¡°ê±´ '-'ë¡œ ì €ì¥
                pairs.push({ 
                    p1: row.querySelector('.pair-p1').value, 
                    p2: row.querySelector('.pair-p2').value, 
                    result: '-' 
                });
            });
            const res1 = divBox.querySelector('.res-1').value;
            const res2 = divBox.querySelector('.res-2').value;
            if(dName) divisions.push({ name:dName, type:dType, teamResult:dRes, pairs:pairs, reserves:[res1, res2] });
        });

        const newMatch = { id, name, date, result, divisions };
        update(ref(db, ROOT + 'clubData/teamTournaments/' + id), newMatch).then(() => {
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            closeModal('teamEditorModal');
            if(window.currentTeamEditId) openTeamDetail(id); else renderTeamTab();
        });
    }

    window.deleteTeamTournament = () => {
        if(confirm("ì •ë§ ì´ ëŒ€íšŒ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            remove(ref(db, ROOT + 'clubData/teamTournaments/' + window.currentTeamEditId)).then(() => {
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeModal('teamEditorModal');
                renderTeamTab();
            });
        }
    }

    // --- [ì‹ ê·œ] í”„ë¦¬ì…‹ ê´€ë¦¬ ë¡œì§ ---

    window.openPresetManager = () => {
        const modal = document.getElementById('presetManagerModal');
        const listDiv = document.getElementById('presetEditList');
        listDiv.innerHTML = '';

        // 6ê°œ ìŠ¬ë¡¯ ë Œë”ë§
        window.teamPresets.forEach((p, idx) => {
            // ë¶€ì„œ êµ¬ì„± í…ìŠ¤íŠ¸í™” (ì˜ˆ: "ê¸ˆë°°,ì€ë°°")
            const divStr = (p.divisions||[]).map(d => `${d.name}(${d.type})`).join(', ');
            
            const html = `
            <div class="preset-card">
                <div style="font-weight:bold; margin-bottom:5px;">ìŠ¬ë¡¯ ${idx+1}</div>
                <input type="text" id="pName-${idx}" class="input-full" value="${p.name}" placeholder="í”„ë¦¬ì…‹ ë²„íŠ¼ ì´ë¦„ (ì˜ˆ: ì¥ìœ ëŒ€íšŒ)" style="margin-bottom:5px;">
                <div id="pDivs-${idx}">
                    ${(p.divisions||[]).map((d, dIdx) => `
                        <div class="preset-div-row">
                            <input type="text" class="input-full pd-name" value="${d.name}" placeholder="ë¶€ì„œëª…" style="margin:0;">
                            <select class="input-full pd-type" style="width:80px; margin:0;">
                                <option value="3ë³µì‹" ${d.type==='3ë³µì‹'?'selected':''}>3ë³µ</option>
                                <option value="5ë³µì‹" ${d.type==='5ë³µì‹'?'selected':''}>5ë³µ</option>
                            </select>
                            <button class="btn-action bg-red" style="width:30px; margin:0;" onclick="this.parentElement.remove()">x</button>
                        </div>
                    `).join('')}
                </div>
                <button class="btn-action bg-blue" style="margin-top:5px; font-size:0.8rem; padding:5px;" onclick="addPresetDivSlot(${idx})">+ ë¶€ì„œ ì¶”ê°€</button>
            </div>`;
            listDiv.insertAdjacentHTML('beforeend', html);
        });
        modal.style.display = 'flex';
    }

    window.addPresetDivSlot = (pIdx) => {
        const container = document.getElementById(`pDivs-${pIdx}`);
        const html = `
            <div class="preset-div-row">
                <input type="text" class="input-full pd-name" placeholder="ë¶€ì„œëª…" style="margin:0;">
                <select class="input-full pd-type" style="width:80px; margin:0;">
                    <option value="3ë³µì‹">3ë³µ</option>
                    <option value="5ë³µì‹">5ë³µ</option>
                </select>
                <button class="btn-action bg-red" style="width:30px; margin:0;" onclick="this.parentElement.remove()">x</button>
            </div>`;
        container.insertAdjacentHTML('beforeend', html);
    }

    window.saveAllPresets = () => {
        const newPresets = [];
        for(let i=0; i<6; i++) {
            const name = document.getElementById(`pName-${i}`).value;
            const divRows = document.querySelectorAll(`#pDivs-${i} .preset-div-row`);
            const divisions = [];
            divRows.forEach(row => {
                const dName = row.querySelector('.pd-name').value;
                const dType = row.querySelector('.pd-type').value;
                if(dName) divisions.push({ name:dName, type:dType });
            });
            newPresets.push({ name: name || `í”„ë¦¬ì…‹ ${i+1}`, divisions: divisions });
        }
        
        set(ref(db, ROOT + 'clubData/teamPresets'), newPresets).then(() => {
            alert("í”„ë¦¬ì…‹ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            window.teamPresets = newPresets;
            closeModal('presetManagerModal');
        });
    }
// ================= MVP ë¡œì§ (ì—¬ê¸°ì„œë¶€í„°) =================
// [ì‹ ê·œ] ë‚ ì§œ ë¬¸ìì—´ì—ì„œ ì—°ë„(YYYY)ë§Œ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
   function extractYear(dateStr) {
    if (!dateStr || typeof dateStr !== 'string') return new Date().getFullYear().toString();
    const match = dateStr.match(/\d{4}/); // 4ìë¦¬ ìˆ«ì(ì—°ë„) ì°¾ê¸°
    
    // ì—°ë„ ìˆ«ìê°€ ìˆìœ¼ë©´ ê·¸ ìˆ«ìë¥¼ ì“°ê³ , ì—†ìœ¼ë©´ ì‹œìŠ¤í…œì˜ í˜„ì¬ ì—°ë„ë¥¼ ë°˜í™˜
    return match ? match[0] : new Date().getFullYear().toString();
}

// [ìˆ˜ì •] MVP ì ìˆ˜ ê³„ì‚° í•¨ìˆ˜: ì°¸ê°€ ì ìˆ˜ ë°˜ì˜ ë¡œì§ ê°•í™”
window.calculateMVP = function(targetYear) {
    if (!targetYear) targetYear = new Date().getFullYear().toString();
    
    const scores = {}; 
    
    const addPoint = (name, pts, reason, date) => {
        if(!name || name === 'ë¯¸ì •' || name.trim() === '') return;
        
        // ë°ì´í„°ì˜ ì—°ë„ì™€ íƒ€ê²Ÿ ì—°ë„ ë¹„êµ (ë³´ê°•ëœ extractYear ì‚¬ìš©)
        if (extractYear(date) !== targetYear) return;

        if(!scores[name]) scores[name] = { total: 0, logs: [] };
        scores[name].total += pts;
        scores[name].logs.push({ reason, pts, date });
    };

    // A. ì›”ë¡€ëŒ€íšŒ (ë§¤ì¹˜ ê¸°ë¡) ë¶„ì„
    window.matchHistory.forEach(m => {
        // ê²ŒìŠ¤íŠ¸ ì¡´ì€ ì ìˆ˜ ì œì™¸
        if(m.date === 'Guest Zone') return; 
        
        const matchTitle = m.title || "ì›”ë¡€ëŒ€íšŒ";
        const matchDate = m.date || targetYear;

        // 1. [í•µì‹¬] ì°¸ê°€ ì ìˆ˜ ë°˜ì˜ (10ì )
        if (m.players && Array.isArray(m.players)) {
            m.players.forEach(p => {
                addPoint(p.name, 10, `[ì°¸ê°€] ${matchTitle}`, matchDate);
            });
        }
        
        // 2. ì„±ì  ì ìˆ˜ (1, 2, 3ìœ„)
        const tierGroups = {};
        if (m.players) {
            m.players.forEach(p => {
                const mem = window.allMembers.find(x => x.name === p.name);
                const tier = (mem && window.rankingData.tiers[mem.phone]) ? window.rankingData.tiers[mem.phone] : 'ê¸°íƒ€';
                if(!tierGroups[tier]) tierGroups[tier] = [];
                tierGroups[tier].push(p);
            });

            Object.keys(tierGroups).forEach(tier => {
                const group = tierGroups[tier];
                // ìŠ¹ì  -> ë“ì‹¤ ìˆœìœ¼ë¡œ ì •ë ¬
                group.sort((a,b) => (b.pts - a.pts) || (b.diff - a.diff));
                
                if(group.length >= 2) { // ìµœì†Œ 2ëª… ì´ìƒì¼ ë•Œë§Œ ì„±ì  ì¸ì •
                    if(group[0]) addPoint(group[0].name, 10, `[1ìœ„] ${matchTitle} (${tier}ì¡°)`, matchDate);
                    if(group[1]) addPoint(group[1].name, 5,  `[2ìœ„] ${matchTitle} (${tier}ì¡°)`, matchDate);
                    if(group[2]) addPoint(group[2].name, 3,  `[3ìœ„] ${matchTitle} (${tier}ì¡°)`, matchDate);
                }
            });
        }
    });

    // B. ë‹¨ì²´ì „ ì°¸ê°€ ì ìˆ˜ (10ì )
    Object.values(window.teamData).forEach(t => {
        const participants = new Set();
        (t.divisions || []).forEach(d => {
            (d.pairs || []).forEach(p => {
                if(p.p1 && p.p1 !== 'ë¯¸ì •') participants.add(p.p1);
                if(p.p2 && p.p2 !== 'ë¯¸ì •') participants.add(p.p2);
            });
            (d.reserves || []).forEach(r => { if(r && r !== 'ë¯¸ì •') participants.add(r); });
        });
        participants.forEach(name => addPoint(name, 10, `[ë‹¨ì²´ì „ ì°¸ê°€] ${t.name}`, t.date));
    });

    // C. ê´€ë¦¬ì ìˆ˜ë™ ì ìˆ˜ ë°˜ì˜
    window.mvpManualLogs.forEach(log => {
        addPoint(log.name, parseInt(log.points), `[ê´€ë¦¬ì] ${log.reason}`, log.date);
    });

    return Object.entries(scores)
        .map(([name, data]) => ({ name, ...data }))
        .sort((a, b) => b.total - a.total);
}
    // [ìˆ˜ì •] MVP ëª¨ë‹¬ ì—´ê¸° (ì‹œì¦Œ ì„ íƒ ê¸°ëŠ¥ ì¶”ê°€)
    window.openMVPModal = () => {
        const container = document.getElementById('mvpListArea');
        const currentYear = new Date().getFullYear().toString();
        
        // ë°ì´í„°ì— ì¡´ì¬í•˜ëŠ” ëª¨ë“  ì—°ë„ ìˆ˜ì§‘
        const years = new Set([currentYear]); 
        window.matchHistory.forEach(m => { if(extractYear(m.date)) years.add(extractYear(m.date)); });
        Object.values(window.teamData).forEach(t => { if(extractYear(t.date)) years.add(extractYear(t.date)); });
        
        const sortedYears = Array.from(years).sort().reverse(); 

        let headerHtml = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; background:#fff8e1; padding:8px; border-radius:8px;">
                <span style="font-weight:bold; color:#f57f17;">ğŸ“… ì‹œì¦Œ ì„ íƒ:</span>
                <select id="mvpYearSelector" onchange="renderMVPList(this.value)" style="font-size:1rem; padding:5px; border-radius:5px; border:1px solid #fbc02d; font-family:'Jua';">
                    ${sortedYears.map(y => `<option value="${y}">${y} ì‹œì¦Œ</option>`).join('')}
                </select>
            </div>
            <div style="text-align:right; margin-bottom:5px;">
                <button class="btn-action bg-teal" style="width:auto; padding:6px 12px; font-size:0.85rem;" onclick="openMVPFullReport()">ğŸ“‹ ì „ì²´ ë¦¬í¬íŠ¸</button>
            </div>
            <div id="mvpListContent"></div>
        `;
        
        container.innerHTML = headerHtml;
        window.renderMVPList(currentYear);
        document.getElementById('mvpModal').style.display = 'flex';
    }

    // [ì‹ ê·œ] ì„ íƒëœ ì—°ë„ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    window.renderMVPList = (year) => {
        const listContent = document.getElementById('mvpListContent');
        const list = window.calculateMVP(year); 

        if(list.length === 0) {
            listContent.innerHTML = `<div style="padding:20px; text-align:center; color:#888;">${year}ë…„ë„ MVP ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        } else {
            const listHtml = list.map((item, idx) => {
                const rank = idx + 1;
                let rankClass = '';
                if(rank === 1) rankClass = 'mvp-1';
                else if(rank === 2) rankClass = 'mvp-2';
                else if(rank === 3) rankClass = 'mvp-3';
                
                return `
                <div class="mvp-row ${rankClass}" onclick="showMVPDetail('${item.name}', '${year}')">
                    <div style="display:flex; align-items:center;">
                        <div class="mvp-rank-badge">${rank}</div>
                        <div style="font-weight:bold;">${item.name}</div>
                    </div>
                    <div class="mvp-score">${item.total}ì </div>
                </div>`;
            }).join('');
            listContent.innerHTML = listHtml;
        }
    }

    // [ìˆ˜ì •] MVP ìƒì„¸ ë‚´ì—­ ë³´ê¸°
    window.showMVPDetail = (name, year) => {
        if(!year) {
            const selector = document.getElementById('mvpYearSelector');
            year = selector ? selector.value : new Date().getFullYear().toString();
        }

        const list = window.calculateMVP(year);
        const target = list.find(x => x.name === name);
        
        const logs = target ? target.logs : [];
        const total = target ? target.total : 0;

        document.getElementById('mvpDetailName').innerText = `[${year} ì‹œì¦Œ] ${name} (${total}ì )`;
        
        let html = logs.map(log => `
            <div class="mvp-detail-item">
                <div>
                    <div style="color:#333;">${log.reason}</div>
                    <div style="font-size:0.75rem; color:#888;">${log.date}</div>
                </div>
                <div style="font-weight:bold; color:${log.pts >= 0 ? 'blue' : 'red'};">${log.pts > 0 ? '+' : ''}${log.pts}</div>
            </div>
        `).join('');
        
        if(window.isAdmin) {
            html = `<div style="background:#fff3e0; padding:10px; border-radius:8px; margin-bottom:10px; border:1px dashed #ffb74d;">
                        <div style="font-weight:bold; font-size:0.9rem; margin-bottom:5px; color:#e65100;">ğŸ‘® ${year} ì‹œì¦Œ ì ìˆ˜ ì¡°ì •</div>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <input type="text" id="manualMvpReason" class="input-full" placeholder="ì‚¬ìœ " style="margin:0;">
                            <input type="number" id="manualMvpScore" class="input-full" placeholder="ì ìˆ˜" style="width:60px; margin:0;">
                        </div>
                        <button class="btn-action bg-yellow" onclick="addManualMVPPoint('${name}')">ì ìˆ˜ ë¶€ì—¬/ì°¨ê°</button>
                    </div>` + html;
        }

        document.getElementById('mvpDetailContent').innerHTML = html || '<div style="text-align:center; padding:10px;">ê¸°ë¡ ì—†ìŒ</div>';
        document.getElementById('mvpDetailModal').style.display = 'flex';
    }
// ================= [ì‹ ê·œ] ì•± ì œëª© ìˆ˜ì • & A4 ì¶œë ¥ ë¡œì§ =================
    
    // 1. ì•± ì œëª© ë¶ˆëŸ¬ì˜¤ê¸° (ì €ì¥ëœ ì œëª©ì´ ìˆìœ¼ë©´ ì ìš©)
    const settingsRef = ref(db, ROOT + 'clubData/settings');
    onValue(settingsRef, (snap) => {
        const val = snap.val();
        if(val && val.appTitle) {
            document.getElementById('appTitleText').innerText = val.appTitle;
        }
    });

    // 2. ì œëª© ìˆ˜ì • ê¸°ëŠ¥ (ê´€ë¦¬ìë§Œ ê°€ëŠ¥)
    window.editAppTitle = () => {
        if(!window.isAdmin) return alert("ê´€ë¦¬ìë§Œ ì œëª©ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        
        const currentTitle = document.getElementById('appTitleText').innerText;
        const newTitle = prompt("ë³€ê²½í•  ì•± ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:", currentTitle);
        
        if(newTitle && newTitle.trim() !== "") {
            update(ref(db, ROOT + 'clubData/settings'), { appTitle: newTitle }).then(() => {
                document.getElementById('appTitleText').innerText = newTitle;
            });
        }
    }

    // 3. A4 ë¯¸ë¦¬ë³´ê¸° ë° ì¶œë ¥ ê¸°ëŠ¥
    window.openPrintPreview = () => {
        // ëª¨ë°”ì¼ ì¤Œ í—ˆìš© ì„¤ì • (í™”ë©´ í™•ëŒ€ ê°€ëŠ¥í•˜ê²Œ)
        const meta = document.querySelector('meta[name="viewport"]');
        if(meta) meta.content = "width=1024, user-scalable=yes";

        const modal = document.getElementById('printReportModal');
        const content = document.getElementById('reportContent');
        
        // ì œëª© ê°€ì ¸ì˜¤ê¸°
        const titleText = document.getElementById('appTitleText').innerText;
        document.getElementById('reportTitleDisplay').innerText = titleText + " ë“±ê¸‰ í˜„í™©";
        document.getElementById('reportDateDisplay').innerText = "ì¶œë ¥ì¼: " + new Date().toLocaleDateString();
        
        let html = `<table class="report-table">
                        <thead>
                            <tr>
                                <th width="8%">No</th>
                                <th width="15%">ì´ë¦„</th>
                                <th width="12%">ë“±ê¸‰</th>
                                <th width="30%">ì „í™”ë²ˆí˜¸</th>
                                <th>ë¹„ê³ </th>
                            </tr>
                        </thead>
                        <tbody>`;
        
        // ì •ë ¬: ë“±ê¸‰ìˆœ(A->B->C->D) -> ì´ë¦„ìˆœ
        const sortedMembers = [...window.allMembers].sort((a,b) => {
            const tierA = window.rankingData.tiers[a.phone] || 'Z';
            const tierB = window.rankingData.tiers[b.phone] || 'Z';
            if(tierA !== tierB) return tierA.localeCompare(tierB);
            return a.name.localeCompare(b.name);
        });

        sortedMembers.forEach((m, i) => {
            const tier = window.rankingData.tiers[m.phone] || '-';
            
            // ì „í™”ë²ˆí˜¸ í¬ë§·íŒ… (01012345678 -> 010-1234-5678)
            let phone = m.phone;
            if(phone && phone.length === 11 && !phone.startsWith('m_') && !phone.includes('-')) {
                phone = phone.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            } else if (phone.startsWith('m_')) {
                phone = "(ID ê³„ì •)";
            }

            // ë“±ê¸‰ë³„ ë°°ê²½ìƒ‰ (ë³´ê¸° ì¢‹ê²Œ)
            let bg = "";
            if(tier.includes('A')) bg = "#ffebee";      // ì—°í•œ ë¹¨ê°•
            else if(tier.includes('B')) bg = "#fffde7"; // ì—°í•œ ë…¸ë‘
            else if(tier.includes('C')) bg = "#e8f5e9"; // ì—°í•œ ì´ˆë¡
            else if(tier.includes('D')) bg = "#e3f2fd"; // ì—°í•œ íŒŒë‘

            html += `<tr style="background:${bg}">
                        <td>${i+1}</td>
                        <td style="font-weight:bold;">${m.name}</td>
                        <td style="font-weight:bold; text-align:center;">${tier}</td>
                        <td style="text-align:center;">${phone}</td>
                        <td></td>
                     </tr>`;
        });
        
        html += `</tbody></table>`;
        html += `<div style="margin-top:20px; text-align:right; font-weight:bold; font-size:1.1rem;">ì´ ì¸ì›: ${sortedMembers.length}ëª…</div>`;

        content.innerHTML = html;
        modal.style.display = 'block';
    }
// [ì‹ ê·œ] ë³´ê³ ì„œ ì´ë¯¸ì§€ ì €ì¥ ê¸°ëŠ¥
    window.saveReportAsImage = () => {
        const element = document.querySelector('#printReportModal .a4-paper');
        if(!element) return;

        // ê³ í•´ìƒë„(scale:2)ë¡œ ìº¡ì²˜
        html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
            const link = document.createElement('a');
            link.download = `ë“±ê¸‰í˜„í™©_ë³´ê³ ì„œ_${new Date().toLocaleDateString()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    }
// [ì‹ ê·œ] ê´€ë¦¬ì ìˆ˜ë™ ì ìˆ˜ ì¶”ê°€ ì‹¤í–‰
    window.addManualMVPPoint = (name) => {
        const reason = document.getElementById('manualMvpReason').value;
        const score = document.getElementById('manualMvpScore').value;
        
        if(!reason || !score) return alert("ì‚¬ìœ ì™€ ì ìˆ˜ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        
        const newLog = {
            id: Date.now(),
            name: name,
            reason: reason,
            points: score,
            date: new Date().toLocaleDateString()
        };
        
        window.mvpManualLogs.push(newLog);
        set(ref(db, ROOT + 'clubData/mvpManualLogs'), window.mvpManualLogs).then(() => {
            alert("ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
            showMVPDetail(name); // ìƒì„¸ì°½ ê°±ì‹ 
            // ë¦¬ìŠ¤íŠ¸ì°½ë„ ê°±ì‹  í•„ìš”í•˜ë¯€ë¡œ ë‹«ì•˜ë‹¤ ì—¬ëŠ” íš¨ê³¼ í˜¹ì€ ë°ì´í„° ë¦¬ë¡œë“œ
        });
    }

   // [ìˆ˜ì •] MVP ì „ì²´ ë³´ê³ ì„œ ì—´ê¸° (ì„ íƒëœ ì—°ë„ ë°˜ì˜)
    window.openMVPFullReport = () => {
        const selector = document.getElementById('mvpYearSelector');
        const year = selector ? selector.value : new Date().getFullYear().toString();
        
        const list = window.calculateMVP(year);
        document.getElementById('mvpReportDate').innerText = `ëŒ€ìƒ ì‹œì¦Œ: ${year}ë…„ | ì¶œë ¥ì¼: ` + new Date().toLocaleDateString();
        
        let html = `<table class="mvp-full-table">
                        <thead>
                            <tr>
                                <th width="10%">ìˆœìœ„</th>
                                <th width="15%">ì´ë¦„</th>
                                <th width="15%">ì´ì </th>
                                <th>ìƒì„¸ íšë“ ë‚´ì—­ (${year})</th>
                            </tr>
                        </thead>
                        <tbody>`;
        
        list.forEach((item, idx) => {
            let details = item.logs.map(l => 
                `<div class="mvp-sub-log">
                    <span>- ${l.reason}</span>
                    <span style="font-weight:bold; color:${l.pts>=0?'blue':'red'}">${l.pts>0?'+':''}${l.pts}</span>
                 </div>`
            ).join('');
            
            html += `<tr>
                        <td style="text-align:center; font-weight:bold;">${idx+1}</td>
                        <td style="text-align:center; font-weight:bold;">${item.name}</td>
                        <td style="text-align:center; font-weight:bold; color:#d32f2f; font-size:1.1rem;">${item.total}</td>
                        <td>${details}</td>
                     </tr>`;
        });
        
        html += `</tbody></table>`;
        document.getElementById('mvpFullContent').innerHTML = html;
        document.getElementById('mvpFullReportModal').style.display = 'block';
    }

    // [ìˆ˜ì •] MVP ë³´ê³ ì„œ ì—‘ì…€ ì €ì¥ (ì„ íƒëœ ì—°ë„ ë°˜ì˜)
    window.saveMVPReportExcel = () => {
        const selector = document.getElementById('mvpYearSelector');
        const year = selector ? selector.value : new Date().getFullYear().toString();

        const list = window.calculateMVP(year);
        const excelData = [];
        
        list.forEach((item, idx) => {
            excelData.push({
                'ìˆœìœ„': idx + 1,
                'ì´ë¦„': item.name,
                'ì´ì ': item.total,
                'ë‚´ì—­': '(ìƒì„¸ë‚´ì—­ ì•„ë˜ ì°¸ì¡°)'
            });
            item.logs.forEach(l => {
                excelData.push({
                    'ìˆœìœ„': '',
                    'ì´ë¦„': '',
                    'ì´ì ': '',
                    'ë‚´ì—­': `[${l.date}] ${l.reason} : ${l.pts}ì `
                });
            });
            excelData.push({}); 
        });

        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, `MVP_${year}`);
        XLSX.writeFile(wb, `MVP_ë­í‚¹_${year}.xlsx`);
    }

    // [ìˆ˜ì •] MVP ë³´ê³ ì„œ ì´ë¯¸ì§€ ì €ì¥
    window.saveMVPReportImage = () => {
        const selector = document.getElementById('mvpYearSelector');
        const year = selector ? selector.value : new Date().getFullYear().toString();
        
        const element = document.getElementById('mvpPaperArea');
        html2canvas(element, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `MVP_ë³´ê³ ì„œ_${year}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    // [ì‹ ê·œ] ìŠ¹ê°•ê¸‰ ëª…ë‹¨ í´ë¦­ ì‹œ í•´ë‹¹ í´ë”ì˜ ê°œì¸ ê²½ê¸° ê¸°ë¡ íŒì—…
    window.showPlayerMatchesInFolder = (playerName, folderName) => {
        const matches = window.matchHistory.filter(m => m.date === folderName);
        if(matches.length === 0) return alert("í•´ë‹¹ ëŒ€íšŒì˜ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        let html = `<h4 style="margin:0 0 10px; color:#333;">${playerName} - ${folderName} ê¸°ë¡</h4>`;
        let totalStats = { w:0, d:0, l:0, pts:0, diff:0 };

        matches.forEach(m => {
            const p = m.players.find(x => x.name === playerName);
            if(p) {
                totalStats.w += p.wins; totalStats.d += p.draws; totalStats.l += p.losses;
                totalStats.pts += p.pts; totalStats.diff += p.diff;

                // í•´ë‹¹ ë§¤ì¹˜ì˜ ì„¸ë¶€ ê²Œì„ ì°¾ê¸°
                m.matches.forEach(g => {
                    if(!g.played) return;
                    const inT1 = g.t1.some(x => x.name === playerName);
                    const inT2 = g.t2.some(x => x.name === playerName);
                    
                    if(inT1 || inT2) {
                        const myTeam = inT1 ? g.t1 : g.t2;
                        const opTeam = inT1 ? g.t2 : g.t1;
                        const myScore = inT1 ? g.s1 : g.s2;
                        const opScore = inT1 ? g.s2 : g.s1;
                        const result = myScore > opScore ? 'ìŠ¹' : myScore < opScore ? 'íŒ¨' : 'ë¬´';
                        const resColor = result === 'ìŠ¹' ? 'blue' : result === 'íŒ¨' ? 'red' : '#666';

                        html += `<div style="padding:8px; border-bottom:1px solid #eee; font-size:0.9rem; background:#fff;">
                                    <div style="margin-bottom:2px; font-weight:bold;">${m.title}</div>
                                    <div style="display:flex; justify-content:space-between;">
                                        <span>íŒŒíŠ¸ë„ˆ: ${myTeam.find(x=>x.name!==playerName)?.name || '-'}</span>
                                        <span style="font-weight:bold; color:${resColor}">${result} (${myScore}:${opScore})</span>
                                    </div>
                                    <div style="font-size:0.8rem; color:#888;">vs ${opTeam.map(x=>x.name).join(', ')}</div>
                                 </div>`;
                    }
                });
            }
        });

        html = `<div style="background:#e3f2fd; padding:10px; margin-bottom:10px; border-radius:8px; text-align:center;">
                    <b>ì¢…í•©: ${totalStats.w}ìŠ¹ ${totalStats.d}ë¬´ ${totalStats.l}íŒ¨</b> 
                    (ìŠ¹ì  ${totalStats.pts}, ë“ì‹¤ ${totalStats.diff})
                </div>` + html;

        document.getElementById('detailContent').innerHTML = html;
        document.getElementById('detailTitle').innerText = "ê°œì¸ ìƒì„¸ ê¸°ë¡ ì¡°íšŒ";
        document.getElementById('detailStatsModal').style.display = 'flex';
    }
// [ì‹ ê·œ] ìŠ¹ê°• ë¶„ì„ì—ì„œ ì´ë¦„ í´ë¦­ ì‹œ, í•´ë‹¹ ì„ ìˆ˜ê°€ ì†í•œ ë§¤ì¹˜ì˜ 'ì „ì²´ ê²°ê³¼í‘œ' ì—´ê¸°
    window.findAndOpenMatchResult = (playerName, folderName) => {
        // 1. í•´ë‹¹ í´ë”(ë‚ ì§œ)ì˜ ëª¨ë“  ë§¤ì¹˜ë¥¼ ì°¾ìŒ
        const matchesInFolder = window.matchHistory.filter(m => m.date === folderName);
        
        if(matchesInFolder.length === 0) return alert("ë§¤ì¹˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        // 2. ê·¸ ì¤‘ì—ì„œ í•´ë‹¹ ì„ ìˆ˜ê°€ ëª…ë‹¨ì— ìˆëŠ” ë§¤ì¹˜ë¥¼ ì°¾ìŒ
        const targetMatch = matchesInFolder.find(m => m.players.some(p => p.name === playerName));

        if (targetMatch) {
            // 3. ì°¾ì•˜ìœ¼ë©´ ì „ì²´ ê²°ê³¼í‘œ ëª¨ë‹¬ ì‹¤í–‰ (trueëŠ” ì½ê¸° ì „ìš© ëª¨ë“œ)
            loadMatchAndShowResult(targetMatch.id, true);
        } else {
            alert(`${playerName}ë‹˜ì˜ í•´ë‹¹ ëŒ€íšŒ ë§¤ì¹˜ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        }
    }
// [ì‹ ê·œ] ê° ë¶€ì„œ ê²°ê³¼ë¥¼ ì¢…í•© ê²°ê³¼ì— ìë™ ë°˜ì˜í•˜ëŠ” í•¨ìˆ˜
    window.updateOverallTeamResult = () => {
        const results = [];
        // ëª¨ë“  ë¶€ì„œ ë°•ìŠ¤ë¥¼ ëŒë©´ì„œ ì´ë¦„ê³¼ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜´
        document.querySelectorAll('#tDivisionsArea .div-box').forEach(box => {
            const name = box.querySelector('.d-name').value.trim();
            const res = box.querySelector('.d-res').value.trim();
            
            // ì´ë¦„ê³¼ ê²°ê³¼ê°€ ëª¨ë‘ ìˆì„ ë•Œë§Œ í•©ì¹¨ (ì˜ˆ: "ê¸ˆë°° ìš°ìŠ¹")
            if(name && res) {
                results.push(`${name} ${res}`);
            }
        });
        
        // ì‰¼í‘œë¡œ ì—°ê²°í•´ì„œ ì¢…í•© ê²°ê³¼ ì¹¸ì— ë„£ìŒ
        document.getElementById('tEditResult').value = results.join(', ');
    }
// ==========================================
    // [ì‹ ê·œ ê¸°ëŠ¥] PC ë²„ì „ / ëª¨ë°”ì¼ ë²„ì „ í† ê¸€ ë¡œì§
    // ==========================================


// í…ìŠ¤íŠ¸ ë³µêµ¬ìš© í•¨ìˆ˜ (í¬ë¡¬ ì „ìš©)
window.importDataByText = () => {
    const jsonText = document.getElementById('restoreText').value.trim();
    if (!jsonText) return alert("ë³µêµ¬í•  ë‚´ìš©ì„ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”.");

    if (!confirm("ì…ë ¥ëœ ë°ì´í„°ë¡œ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ê¸°ë¡ì´ ëª¨ë‘ êµì²´ë©ë‹ˆë‹¤.")) return;

    try {
        const data = JSON.parse(jsonText);
        // ê³µí†µ ë³µêµ¬ ì‹¤í–‰ í•¨ìˆ˜ í˜¸ì¶œ
        window.executeRestore(data);
    } catch (err) {
        alert("ë°ì´í„° í˜•ì‹ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤. íŒŒì¼ ë‚´ìš©ì„ ì „ë¶€ ë³µì‚¬í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
};

// ëª¨ë“  ë³µêµ¬ ë°©ì‹ì—ì„œ ê³µí†µìœ¼ë¡œ ì“°ëŠ” ì €ì¥ ë¡œì§
window.executeRestore = (data) => {
    const updates = {};
    if (data.members) updates['clubData/members'] = data.members;
    if (data.rankingData || data.rank) updates['rankingData'] = data.rankingData || data.rank;
    if (data.teamTournaments) updates['clubData/teamTournaments'] = data.teamTournaments;
    if (data.teamPresets) updates['clubData/teamPresets'] = data.teamPresets;
    if (data.mvpManualLogs) updates['clubData/mvpManualLogs'] = data.mvpManualLogs;
    
    const historySource = data.tennisHistory || data.history;
    if (historySource) {
        const hObj = {};
        if (Array.isArray(historySource)) {
            historySource.forEach(m => { if(m.id) hObj[m.id] = m; });
        } else {
            Object.assign(hObj, historySource);
        }
        updates['tennisHistory'] = hObj;
    }

    // ROOT ë³€ìˆ˜ëŠ” ê¸°ì¡´ ì½”ë“œì— ì •ì˜ëœ ê²½ë¡œë¥¼ ë”°ë¦„
    update(ref(db, ROOT), updates).then(() => {
        alert("âœ… ë³µêµ¬ ì™„ë£Œ! ì•±ì´ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤.");
        location.reload();
    }).catch(err => alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message));
};
</script>
<div id="mvpFullReportModal" class="report-modal">
    <div class="report-btns">
        <button class="btn-rep btn-print" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„/PDF</button>
        <button class="btn-rep btn-print" style="background:#e67e22; margin-left:5px;" onclick="saveMVPReportImage()">ğŸ“¸ ì´ë¯¸ì§€ ì €ì¥</button>
        <button class="btn-rep btn-print" style="background:#009688; margin-left:5px;" onclick="saveMVPReportExcel()">ğŸ“Š ì—‘ì…€ ì €ì¥</button>
        <button class="btn-rep btn-close" onclick="document.getElementById('mvpFullReportModal').style.display='none'">ë‹«ê¸°</button>
    </div>
    <div class="a4-paper" id="mvpPaperArea">
        <div class="report-header">
            <div class="report-title">ğŸ† ì‹œì¦Œ MVP ì „ì²´ ìƒì„¸ ë‚´ì—­</div>
            <div class="report-date" id="mvpReportDate"></div>
        </div>
        <div id="mvpFullContent"></div>
    </div>
</div>
</body>
</html>